<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GeoInzicht">
<link rel="manifest" href="manifest.json">
<title>GeoInzicht — CBS Buurtdata</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 48'%3E%3Crect y='0' width='64' height='16' fill='%23AE1C28'/%3E%3Crect y='16' width='64' height='16' fill='%23FFF'/%3E%3Crect y='32' width='64' height='16' fill='%2321468B'/%3E%3C/svg%3E">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.min.js"></script>
<script>
// Patch VectorGrid 1.3.0: fix TypeError op point-feature clicks met Leaflet 1.9+
// Probleem: punt-features (type=1) missen getLatLng, crash bij click-event propagatie
// Oplossing: override _createLayer op L.VectorGrid.prototype
(function(){
  var VG = L.VectorGrid;
  if(!VG || !VG.prototype || !VG.prototype._createLayer) return;
  var orig = VG.prototype._createLayer;
  VG.prototype._createLayer = function(feat, pxPerExtent, layerStyle){
    var layer = orig.call(this, feat, pxPerExtent, layerStyle);
    // Punt-features (type=1) erven van CircleMarker maar missen _latlng → getLatLng crasht
    if(feat.type === 1 && layer && !layer.getLatLng){
      layer.getLatLng = function(){ return this._latlng || L.latLng(0,0); };
    }
    return layer;
  };
})();
</script>
<style>
:root{--bg:#0a0f1a;--p:rgba(15,20,35,.85);--p2:rgba(25,32,52,.7);--bd:rgba(55,65,90,.5);--tx:#e2e8f0;--mt:#64748b;--ac:#39ff14;--ac2:#22c55e;--up:#22c55e;--dn:#ef4444;--pu:#39ff14;--ai:#38bdf8;--wn:#fbbf24;--cyan:#06b6d4;--radius:12px;--glass:rgba(20,28,50,.6);--glass-bd:rgba(80,100,140,.15);--shadow:0 8px 32px rgba(0,0,0,.4)}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--tx);overflow:hidden;height:100vh;height:100dvh}
.app{display:flex;height:100vh;height:100dvh}

/* Material Icons */
.mi{font-family:'Material Symbols Rounded';font-weight:normal;font-style:normal;font-size:18px;line-height:1;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;-webkit-font-smoothing:antialiased;font-variation-settings:'FILL' 1,'wght' 400,'GRAD' 0,'opsz' 24}
.mi-sm{font-size:14px}
.mi-lg{font-size:22px}

/* Sidebar with glass effect */
.sidebar{width:360px;background:var(--p);backdrop-filter:blur(20px) saturate(1.5);-webkit-backdrop-filter:blur(20px) saturate(1.5);display:flex;flex-direction:column;overflow:hidden;z-index:100;transition:transform .4s cubic-bezier(.4,0,.2,1)}
.sidebar.hidden{transform:translateX(-100%);position:absolute;height:100%}
.sidebar-footer{padding:14px 16px;text-align:center;flex-shrink:0;background:rgba(10,15,26,.5)}
.neon-text{font:900 15px 'Space Mono',monospace;color:#39ff14;text-shadow:0 0 7px #39ff14,0 0 10px #39ff14,0 0 21px #39ff14,0 0 42px #0fa,0 0 82px #0fa;letter-spacing:3px;animation:neonPulse 2s ease-in-out infinite alternate}
@keyframes neonPulse{from{text-shadow:0 0 5px #39ff14,0 0 10px #39ff14,0 0 20px #39ff14,0 0 40px #0fa}to{text-shadow:0 0 10px #39ff14,0 0 20px #39ff14,0 0 40px #39ff14,0 0 80px #0fa,0 0 120px #0fa}}

.map-wrap{flex:1;position:relative}
#map{width:100%;height:100%}

/* Header */
.header{padding:14px 16px;display:flex;align-items:center;gap:12px;background:rgba(10,15,26,.4)}
.sb-logo{font-family:'Space Mono',monospace;font-size:17px;font-weight:700;background:linear-gradient(135deg,#39ff14 0%,#22c55e 50%,#06b6d4 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.header-right{margin-left:auto;display:flex;gap:6px;align-items:center}

/* Search */
.search-wrap{padding:10px 14px;position:relative}
.search-wrap input{background:var(--glass);color:var(--tx);border:none;border-radius:10px;padding:10px 12px 10px 36px;font:400 13px 'DM Sans',sans-serif;width:100%;outline:none;transition:all .3s cubic-bezier(.4,0,.2,1);backdrop-filter:blur(10px)}
.search-wrap input:focus{box-shadow:0 0 0 2px rgba(57,255,20,.2),0 0 20px rgba(57,255,20,.05)}
.search-wrap input::placeholder{color:var(--mt);transition:opacity .2s}
.search-wrap input:focus::placeholder{opacity:.5}
.search-wrap .s-icon{position:absolute;left:24px;top:50%;transform:translateY(-50%);color:var(--mt);transition:color .3s}
.search-wrap input:focus ~ .s-icon,.search-wrap input:focus + .s-icon{color:var(--ac)}
.search-results{display:none;position:absolute;left:14px;right:14px;top:50px;background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:10px;max-height:220px;overflow-y:auto;z-index:200;box-shadow:var(--shadow);animation:slideDown .2s ease-out}
@keyframes slideDown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.search-item{padding:10px 12px;cursor:pointer;font-size:12px;border-bottom:1px solid var(--glass-bd);transition:all .15s ease}
.search-item:hover{background:rgba(57,255,20,.08);padding-left:16px}
.search-item:last-child{border:none}

/* Multi-select dropdowns */
.ms-wrap{position:relative}
.ms-box{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--glass);border-radius:8px;cursor:pointer;transition:all .2s;font-size:12px;color:var(--tx);border:1px solid transparent}
.ms-box:hover{border-color:rgba(57,255,20,.2)}
.ms-dropdown{display:none;position:absolute;left:0;right:0;top:100%;margin-top:4px;background:var(--p);backdrop-filter:blur(20px);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,.6);z-index:500;max-height:260px;overflow:hidden;border:1px solid var(--glass-bd);animation:slideDown .15s ease-out}
.ms-dropdown.open{display:block}
.ms-search{width:100%;padding:8px 12px;background:rgba(255,255,255,.04);border:none;border-bottom:1px solid var(--glass-bd);font:400 12px 'DM Sans',sans-serif;color:var(--tx);outline:none}
.ms-search::placeholder{color:var(--mt)}
.ms-search:focus{background:rgba(57,255,20,.04)}
.ms-options{max-height:200px;overflow-y:auto}
.ms-options::-webkit-scrollbar{width:4px}
.ms-options::-webkit-scrollbar-thumb{background:var(--glass-bd);border-radius:4px}
.ms-opt{display:flex;align-items:center;gap:8px;padding:7px 12px;cursor:pointer;font-size:11px;color:var(--tx);transition:background .1s;border-bottom:1px solid rgba(255,255,255,.03)}
.ms-opt:hover{background:rgba(57,255,20,.06)}
.ms-opt.selected{background:rgba(57,255,20,.1);color:var(--ac)}
.ms-opt .ms-check{width:14px;height:14px;border:1.5px solid var(--mt);border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;transition:all .15s}
.ms-opt.selected .ms-check{border-color:var(--ac);background:var(--ac);color:var(--bg)}
.ms-chips{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
.ms-chip{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;background:rgba(57,255,20,.1);color:var(--ac);font:600 10px 'DM Sans',sans-serif;border-radius:12px;cursor:pointer;transition:background .15s}
.ms-chip:hover{background:rgba(57,255,20,.2)}
.ms-chip .mi{font-size:12px}
.ms-loadbtn{width:100%;margin-top:8px;padding:9px 12px;background:linear-gradient(135deg,rgba(57,255,20,.15),rgba(6,182,212,.1));color:var(--ac);border:1px solid rgba(57,255,20,.2);border-radius:8px;font:600 12px 'DM Sans',sans-serif;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all .2s}
.ms-loadbtn:hover{background:linear-gradient(135deg,rgba(57,255,20,.25),rgba(6,182,212,.15));transform:translateY(-1px)}
/* Tabs */
.tabs{display:flex;background:rgba(10,15,26,.3)}
.tab{flex:1;padding:12px 8px;text-align:center;font-size:11px;font-weight:600;color:var(--mt);cursor:pointer;border-bottom:2px solid transparent;transition:all .3s cubic-bezier(.4,0,.2,1);letter-spacing:.3px;text-transform:uppercase;position:relative}
.tab.active{color:var(--ac);border-bottom-color:var(--ac)}
.tab:hover{color:var(--tx);background:rgba(255,255,255,.02)}
.tab.active::after{content:'';position:absolute;bottom:-1px;left:20%;right:20%;height:2px;background:var(--ac);filter:blur(4px)}

/* Panes */
.pane{display:none;flex:1;overflow-y:auto;padding:16px;scroll-behavior:smooth}
.pane::-webkit-scrollbar{width:4px}
.pane::-webkit-scrollbar-track{background:transparent}
.pane::-webkit-scrollbar-thumb{background:var(--glass-bd);border-radius:4px}
.pane::-webkit-scrollbar-thumb:hover{background:var(--ac)}
.pane.active{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* Section headers */
.sh{font:700 11px 'Space Mono',monospace;color:var(--ac);text-transform:uppercase;letter-spacing:1px;margin:16px 0 8px;display:flex;align-items:center;gap:6px}
.sh:first-child{margin-top:0}
.sh .mi{font-size:16px;color:var(--ac)}

/* Glass cards */
.card{background:var(--glass);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:none;border-radius:var(--radius);padding:14px;margin-bottom:10px;transition:all .3s cubic-bezier(.4,0,.2,1)}
.card:hover{box-shadow:0 4px 20px rgba(0,0,0,.2)}

/* Stats */
.stat-row{display:flex;gap:10px;margin-bottom:10px}
.stat{flex:1;background:var(--glass);backdrop-filter:blur(8px);border:none;border-radius:10px;padding:12px 8px;text-align:center;transition:all .3s ease}
.stat:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(57,255,20,.1)}
.stat b{display:block;font:700 20px 'Space Mono',monospace;color:var(--ac);transition:transform .2s}
.stat:hover b{transform:scale(1.05)}
.stat small{font-size:10px;color:var(--mt);letter-spacing:.3px}

/* Buttons */
.btn{border:none;border-radius:8px;padding:7px 14px;font:600 11px 'DM Sans',sans-serif;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);display:inline-flex;align-items:center;gap:5px;position:relative;overflow:hidden}
.btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.05),transparent);opacity:0;transition:opacity .2s}
.btn:hover::before{opacity:1}
.btn:active{transform:scale(.96)}
.btn-p{background:linear-gradient(135deg,var(--ac),var(--ac2));color:#000;font-weight:700}.btn-p:hover{box-shadow:0 4px 20px rgba(57,255,20,.3)}
.btn-o{background:transparent;color:var(--ac)}.btn-o:hover{background:rgba(57,255,20,.08);box-shadow:0 0 20px rgba(57,255,20,.1)}
.btn-s{background:var(--glass);color:var(--tx)}.btn-s:hover{background:rgba(255,255,255,.08)}
.btn-s.active{color:var(--ac);background:rgba(57,255,20,.1);box-shadow:0 0 12px rgba(57,255,20,.08)}

/* Select */
select{background:var(--glass);color:var(--tx);border:none;border-radius:10px;padding:10px 12px;font:500 13px 'DM Sans',sans-serif;width:100%;outline:none;appearance:none;-webkit-appearance:none;cursor:pointer;transition:all .3s ease;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2364748b'%3E%3Cpath d='M2 4l4 4 4-4'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
select:focus{box-shadow:0 0 0 2px rgba(57,255,20,.15)}
select:hover{background:rgba(30,40,65,.7)}
select option{background:var(--bg);color:var(--tx)}

/* Legend */
.legend{display:flex;flex-direction:column;gap:3px;margin-top:8px}
.legend-row{display:flex;align-items:center;gap:8px;font-size:11px;padding:2px 0;transition:opacity .2s}
.legend-row:hover{opacity:.8}
.legend-color{width:28px;height:14px;border-radius:4px;transition:transform .2s}
.legend-row:hover .legend-color{transform:scaleX(1.1)}

/* Progress */
.progress{height:4px;background:rgba(45,58,77,.5);border-radius:4px;overflow:hidden;margin:6px 0}
.progress-bar{height:100%;background:linear-gradient(90deg,var(--ac),var(--ac2));border-radius:4px;transition:width .4s cubic-bezier(.4,0,.2,1)}

/* Toast */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);color:var(--tx);border:1px solid var(--glass-bd);border-radius:12px;padding:12px 24px;font-size:13px;font-weight:500;z-index:999;opacity:0;transition:all .4s cubic-bezier(.4,0,.2,1);pointer-events:none;box-shadow:var(--shadow)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* Info panel */
.info-panel{position:absolute;top:12px;right:12px;background:var(--glass);backdrop-filter:blur(20px) saturate(1.5);-webkit-backdrop-filter:blur(20px) saturate(1.5);border:none;border-radius:var(--radius);padding:18px;z-index:500;min-width:320px;max-width:420px;max-height:calc(100vh - 40px);overflow-y:scroll;display:none;box-shadow:var(--shadow);animation:slideIn .3s cubic-bezier(.4,0,.2,1);overscroll-behavior:contain}
@keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.info-panel.show{display:block}
.info-panel::-webkit-scrollbar{width:6px}
.info-panel::-webkit-scrollbar-track{background:transparent}
.info-panel::-webkit-scrollbar-thumb{background:rgba(57,255,20,.15);border-radius:3px}
.info-panel::-webkit-scrollbar-thumb:hover{background:rgba(57,255,20,.3)}
.info-panel h3{font:700 14px 'Space Mono',monospace;color:var(--ac);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.info-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px;border-bottom:1px solid rgba(55,65,90,.3);transition:background .15s}
.info-row:hover{background:rgba(255,255,255,.02);padding-left:4px}
.info-row:last-child{border:none}
.info-val{font:700 12px 'Space Mono',monospace;color:var(--ai)}
.info-compare{font-size:10px;color:var(--mt);margin-top:2px;display:flex;align-items:center;gap:4px}
.info-compare .up{color:var(--up)}
.info-compare .dn{color:var(--dn)}
.info-bar{height:4px;background:rgba(45,58,77,.5);border-radius:2px;margin-top:3px;position:relative;overflow:visible}
.info-bar-fill{height:100%;border-radius:2px;transition:width .3s}
.info-bar-marker{position:absolute;top:-3px;width:2px;height:10px;background:var(--ac);border-radius:1px;transform:translateX(-1px)}
.info-dist{font:400 9px 'Space Mono',monospace;color:var(--mt);padding:2px 5px;border-radius:3px;background:rgba(45,58,77,.3);display:inline-block;margin-top:2px}

/* Sidebar toggle */
.sidebar-toggle{position:absolute;top:12px;left:12px;z-index:600;background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:none;border-radius:10px;width:40px;height:40px;display:none;place-items:center;cursor:pointer;color:var(--ac);font-size:20px;transition:all .3s;box-shadow:var(--shadow)}
.sidebar-toggle:hover{background:rgba(57,255,20,.1)}

/* Loading */
.loading-overlay{position:fixed;inset:0;background:rgba(10,15,26,.97);z-index:9999;display:grid;place-items:center}
.loading-overlay .inner{text-align:center}
.loading-overlay .spinner{width:52px;height:52px;border:3px solid var(--glass-bd);border-top-color:var(--ac);border-radius:50%;animation:spin .8s cubic-bezier(.4,0,.2,1) infinite;margin:0 auto 20px;filter:drop-shadow(0 0 8px rgba(57,255,20,.3))}
.loading-overlay .msg{font:600 15px 'DM Sans',sans-serif;color:var(--tx)}
.loading-overlay .sub{font-size:12px;color:var(--mt);margin-top:8px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Responsive */
@media(max-width:900px){
  .sidebar{width:100%;position:absolute;height:100%;z-index:500}
  .sidebar.hidden{transform:translateX(-100%)}
  .sidebar-toggle{display:grid}
}
@media(max-width:600px){.sidebar{width:100%}.stat-row{flex-wrap:wrap}.stat{min-width:calc(50% - 5px)}}

/* Indicator list */
.indicator-list{display:flex;flex-direction:column;gap:3px;max-height:320px;overflow-y:auto;padding-right:4px}
.indicator-list::-webkit-scrollbar{width:3px}
.indicator-list::-webkit-scrollbar-thumb{background:var(--glass-bd);border-radius:3px}
.ind-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:8px;cursor:pointer;transition:all .2s ease;border:none;font-size:12px;user-select:none;-webkit-user-select:none}
.ind-item:hover{background:rgba(255,255,255,.04)}
.ind-item.active{background:rgba(57,255,20,.06)}
.ind-item.primary{background:rgba(57,255,20,.1);box-shadow:0 0 12px rgba(57,255,20,.08)}
.ind-item .ind-icon{width:28px;height:28px;border-radius:7px;display:grid;place-items:center;background:var(--glass);border:none;flex-shrink:0;transition:all .2s}
.ind-item.active .ind-icon{background:rgba(57,255,20,.1);color:var(--ac)}
.ind-item.primary .ind-icon{background:rgba(57,255,20,.2);color:var(--ac)}
.ind-item .ind-icon .mi{font-size:15px;color:var(--mt);transition:color .2s}
.ind-item.active .ind-icon .mi,.ind-item.primary .ind-icon .mi{color:var(--ac)}
.ind-item .ind-name{font-weight:500;color:var(--mt);transition:color .2s;flex:1}
.ind-item.active .ind-name,.ind-item.primary .ind-name{color:var(--tx)}
.ind-item .ind-unit{font:400 9px 'Space Mono',monospace;color:var(--mt);opacity:.6}
.ind-item .ind-badge{font:700 8px 'Space Mono',monospace;padding:2px 5px;border-radius:4px;background:rgba(57,255,20,.15);color:var(--ac);display:none;letter-spacing:.5px;flex-shrink:0}
.ind-item.primary .ind-badge{display:block}

/* Kaart hover-tooltip */
.map-tooltip{background:rgba(10,15,26,.92)!important;backdrop-filter:blur(12px);border:1px solid rgba(57,255,20,.25)!important;border-radius:10px!important;padding:0!important;box-shadow:0 8px 32px rgba(0,0,0,.5)!important;color:#e2e8f0!important;font-family:'DM Sans',sans-serif!important;min-width:200px;max-width:320px}
.map-tooltip .leaflet-tooltip-content{padding:0!important}
.map-tooltip::before{border-right-color:rgba(10,15,26,.92)!important}
.tt-header{padding:8px 12px 6px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:6px}
.tt-name{font:700 12px 'DM Sans',sans-serif;color:#39ff14;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tt-type{font:400 9px 'Space Mono',monospace;color:#64748b;flex-shrink:0}
.tt-body{padding:6px 12px 8px}
.tt-row{display:flex;justify-content:space-between;align-items:center;padding:2px 0;gap:8px}
.tt-label{font:400 10px 'DM Sans',sans-serif;color:#94a3b8;display:flex;align-items:center;gap:4px;white-space:nowrap}
.tt-val{font:700 10px 'Space Mono',monospace;text-align:right;white-space:nowrap}
.tt-prim{color:#39ff14}
.tt-sec{color:#38bdf8}

/* Zoom level indicator op kaart */
.zoom-indicator{background:rgba(10,15,26,.85);backdrop-filter:blur(12px);border:1px solid rgba(57,255,20,.2);border-radius:8px;padding:4px 8px;display:flex;align-items:center;gap:5px;margin-bottom:6px!important;cursor:default;user-select:none}
.zi-label{font:400 9px 'DM Sans',sans-serif;color:#64748b}
.zi-val{font:700 13px 'Space Mono',monospace;color:#39ff14;min-width:18px;text-align:center}

/* Animated gradient border on active buttons */
@property --angle{syntax:'<angle>';initial-value:0deg;inherits:false}
@keyframes borderSpin{to{--angle:360deg}}
.btn-s.active{position:relative;background:rgba(57,255,20,.08)}
.btn-s.active::after{content:'';position:absolute;inset:-1px;border-radius:9px;padding:1px;background:conic-gradient(from var(--angle),transparent 40%,#39ff14 50%,transparent 60%);-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;animation:borderSpin 3s linear infinite;pointer-events:none}

/* Shimmer on stat cards */
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
.stat:hover{background:linear-gradient(90deg,var(--glass) 0%,rgba(57,255,20,.06) 50%,var(--glass) 100%);background-size:200% 100%;animation:shimmer 2s ease-in-out}

/* Glow pulse on section headers */
.sh .mi{transition:all .3s;filter:drop-shadow(0 0 0px transparent)}
.sh:hover .mi{filter:drop-shadow(0 0 6px rgba(57,255,20,.5));transform:scale(1.1)}

/* Glasmorphism hover lift */
.card{transition:all .3s cubic-bezier(.4,0,.2,1)}
.card:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,.3),0 0 0 1px rgba(57,255,20,.06);background:rgba(25,35,55,.65)}

/* Active tab glow */
.tab.active{text-shadow:0 0 10px rgba(57,255,20,.3)}

/* Search glow when typing */
.search-wrap input:not(:placeholder-shown){box-shadow:0 0 0 1px rgba(57,255,20,.12),0 0 20px rgba(57,255,20,.04)}

/* Info panel entrance */
.info-panel.show{animation:slideIn .3s cubic-bezier(.4,0,.2,1),infoPulse .4s ease-out}
@keyframes infoPulse{0%{box-shadow:0 0 0 0 rgba(57,255,20,.2)}100%{box-shadow:var(--shadow)}}

/* Indicator list items - micro interaction */
.ind-item{transition:all .2s cubic-bezier(.4,0,.2,1)}
.ind-item:hover{transform:translateX(4px)}
.ind-item.primary{border-left:2px solid var(--ac);animation:glowIn .4s ease-out}
@keyframes glowIn{from{border-left-color:transparent;box-shadow:none}to{border-left-color:var(--ac);box-shadow:0 0 12px rgba(57,255,20,.08)}}

/* Sidebar separator lines with gradient fade */
.sh::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--glass-bd),transparent);margin-left:8px}

/* Loading dot animation for toasts */
@keyframes dotPulse{0%,100%{opacity:.3}50%{opacity:1}}
@keyframes logoSpin{0%{transform:scale(1) rotate(0deg);opacity:1}50%{transform:scale(1.08) rotate(180deg);opacity:.85}100%{transform:scale(1) rotate(360deg);opacity:1}}

/* Leaflet overrides */
.leaflet-control-zoom a{background:var(--glass) !important;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);color:var(--tx) !important;border-color:var(--glass-bd) !important;transition:all .2s !important}
.leaflet-control-zoom a:hover{background:rgba(57,255,20,.15) !important;color:var(--ac) !important}

/* Upload markers */
.upload-marker{background:transparent !important;border:none !important}
.upload-tooltip{background:var(--glass);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--glass-bd);color:var(--tx);font:500 11px 'DM Sans',sans-serif;padding:4px 8px;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.3);white-space:nowrap}
.upload-tooltip::before{border:none !important}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="inner">
    <img src="logo.svg" alt="Data Consultants" style="width:160px;height:160px;margin:0 auto 20px;display:block;filter:drop-shadow(0 0 30px rgba(57,255,20,.3))">
    <div class="sb-logo" style="font-size:24px;text-align:center;margin-bottom:4px">GeoInzicht</div>
    <div style="font:600 11px 'Space Mono',monospace;color:var(--mt);text-align:center;letter-spacing:2px;margin-bottom:20px">DATA CONSULTANTS</div>
    <div class="msg" id="loadMsg">Laden...</div>
    <div class="sub" id="loadSub">Gemeentedata ophalen</div>
    <div class="progress" style="width:260px;margin-top:14px"><div class="progress-bar" id="loadProgress" style="width:0%"></div></div>
  </div>
</div>

<div class="app">
  <div class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()"><span class="mi">menu</span></div>

  <div class="sidebar" id="sidebar">
    <div class="header">
      <div style="display:flex;align-items:center;gap:10px">
        <img src="logo.svg" alt="DC" style="width:52px;height:52px;filter:drop-shadow(0 0 12px rgba(57,255,20,.3))">
        <div>
          <div class="sb-logo">GeoInzicht</div>
          <span style="font-size:9px;color:var(--mt);letter-spacing:.5px">CBS buurtdata op de kaart</span>
        </div>
      </div>
      <div class="header-right">
        <button class="btn btn-s" onclick="toggleSidebar()" style="display:none;padding:6px 10px" id="closeSidebar"><span class="mi mi-sm">close</span></button>
      </div>
    </div>

    <!-- Zoekbalk -->
    <div class="search-wrap">
      <span class="mi mi-sm s-icon">search</span>
      <input type="text" id="searchInput" placeholder="Zoek adres, buurt, gemeente..." autocomplete="off">
      <div class="search-results" id="searchResults"></div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="kaart" onclick="switchTab('kaart')"><span class="mi mi-sm" style="vertical-align:-3px">map</span> Kaart</div>
      <div class="tab" data-tab="upload" onclick="switchTab('upload')"><span class="mi mi-sm" style="vertical-align:-3px">upload_file</span> Upload</div>
      <div class="tab" data-tab="info" onclick="switchTab('info')"><span class="mi mi-sm" style="vertical-align:-3px">info</span> Info</div>
      <div class="tab" data-tab="log" id="tabLog" style="display:none" onclick="switchTab('log');renderLogView()"><span class="mi mi-sm" style="vertical-align:-3px">admin_panel_settings</span> Log</div>
    </div>

    <!-- KAART TAB -->
    <div class="pane active" id="p-kaart">
      <div class="sh"><span class="mi">layers</span> Lagen</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-s active" data-layer="gemeenten" onclick="toggleLayer('gemeenten')"><span class="mi mi-sm">domain</span> Gemeenten</button>
        <button class="btn btn-s" data-layer="buurten" onclick="toggleLayer('buurten')"><span class="mi mi-sm">grid_on</span> Buurten</button>
        <button class="btn btn-s" data-layer="wijken" onclick="toggleLayer('wijken')"><span class="mi mi-sm">grid_view</span> Wijken</button>
        <button class="btn btn-s" data-layer="bag" onclick="toggleLayer('bag')"><span class="mi mi-sm">location_on</span> BAG Adressen <span id="bagBtnCount" style="font:700 9px 'Space Mono',monospace;color:var(--ai)"></span></button>
      </div>

      <div class="sh" id="bagStatusSection" style="display:none"><span class="mi">filter_alt</span> BAG Status filter</div>
      <div id="bagStatusBtns" style="display:none;gap:5px;flex-wrap:wrap;margin-bottom:4px"></div>
      <!-- BAG Filters: Gebruiksdoel, Bouwjaar, Oppervlakte -->
      <div id="bagFiltersSection" style="display:none;margin-bottom:8px">
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:4px">
          <select id="bagFilterGebruiksdoel" onchange="applyBagFilters()" style="flex:1;font-size:10px;padding:6px 8px;min-width:100px">
            <option value="">Alle gebruiksdoelen</option>
            <option value="woonfunctie">Woonfunctie</option>
            <option value="kantoorfunctie">Kantoorfunctie</option>
            <option value="winkelfunctie">Winkelfunctie</option>
            <option value="industriefunctie">Industriefunctie</option>
            <option value="bijeenkomstfunctie">Bijeenkomstfunctie</option>
            <option value="onderwijsfunctie">Onderwijsfunctie</option>
            <option value="sportfunctie">Sportfunctie</option>
            <option value="gezondheidszorgfunctie">Gezondheidszorgfunctie</option>
            <option value="logiesfunctie">Logiesfunctie</option>
            <option value="overige gebruiksfunctie">Overig</option>
          </select>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:4px">
          <div style="flex:1;min-width:90px">
            <label style="font:600 9px 'DM Sans',sans-serif;color:var(--mt);display:block;margin-bottom:2px">Bouwjaar</label>
            <div style="display:flex;gap:3px">
              <input id="bagFilterBouwjaarMin" type="number" placeholder="Van" min="1600" max="2030" onchange="applyBagFilters()" style="width:50%;font-size:10px;padding:5px 6px;background:var(--glass);color:var(--tx);border:none;border-radius:6px;outline:none">
              <input id="bagFilterBouwjaarMax" type="number" placeholder="Tot" min="1600" max="2030" onchange="applyBagFilters()" style="width:50%;font-size:10px;padding:5px 6px;background:var(--glass);color:var(--tx);border:none;border-radius:6px;outline:none">
            </div>
          </div>
          <div style="flex:1;min-width:90px">
            <label style="font:600 9px 'DM Sans',sans-serif;color:var(--mt);display:block;margin-bottom:2px">Oppervlakte (m2)</label>
            <div style="display:flex;gap:3px">
              <input id="bagFilterOppMin" type="number" placeholder="Van" min="0" onchange="applyBagFilters()" style="width:50%;font-size:10px;padding:5px 6px;background:var(--glass);color:var(--tx);border:none;border-radius:6px;outline:none">
              <input id="bagFilterOppMax" type="number" placeholder="Tot" min="0" onchange="applyBagFilters()" style="width:50%;font-size:10px;padding:5px 6px;background:var(--glass);color:var(--tx);border:none;border-radius:6px;outline:none">
            </div>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span id="bagFilterCount" style="font:400 9px 'Space Mono',monospace;color:var(--mt)"></span>
          <button class="btn btn-s" onclick="resetBagFilters()" style="font-size:9px;padding:2px 8px"><span class="mi mi-sm" style="font-size:11px">filter_alt_off</span> Reset</button>
        </div>
      </div>
      <div id="bagCacheInfo" style="display:none;font:400 9px 'Space Mono',monospace;color:var(--mt);margin-bottom:8px;align-items:center;gap:6px">
        <span class="mi mi-sm" style="color:var(--ai)">sd_storage</span>
        <span id="bagCacheText">Totaal: tellen...</span>
        <button class="btn btn-s" onclick="if(_bagVectorLayer){_map.removeLayer(_bagVectorLayer);_bagVectorLayer=null;createBagVectorTileLayer();toast('BAG tiles herladen')}" style="font-size:9px;padding:2px 8px;margin-left:auto"><span class="mi mi-sm" style="font-size:11px">refresh</span> Herlaad tiles</button>
      </div>
      <div id="bagZoomHint" style="display:none;font:400 9px 'DM Sans',sans-serif;color:var(--wn);margin-bottom:6px;padding:4px 8px;background:rgba(251,191,36,.06);border-radius:6px;border-left:3px solid var(--wn);align-items:center;gap:6px">
        <span class="mi mi-sm" style="font-size:13px">zoom_in</span>
        <span id="bagZoomHintText">Zoom in voor BAG adressen</span>
      </div>
      <div id="bagLoadProgress" style="display:none;margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px">
          <span style="font:500 10px 'DM Sans',sans-serif;color:var(--ai);display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="font-size:13px">downloading</span> <span id="bagLoadText">Adressen laden...</span></span>
          <span id="bagLoadPct" style="font:700 10px 'Space Mono',monospace;color:var(--ac)">0%</span>
        </div>
        <div style="height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden">
          <div id="bagLoadBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--ac),var(--ai));border-radius:3px;transition:width .3s ease"></div>
        </div>
      </div>
      <!-- BAG achtergrond laden wordt automatisch gestart -->
      <!-- Achtergrond BAG progress -->
      <div id="bagBgProgress" style="display:none;margin-bottom:8px;padding:8px 10px;background:rgba(56,189,248,.04);border-radius:8px;border-left:3px solid var(--ai)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <span style="font:600 10px 'DM Sans',sans-serif;color:var(--ai);display:flex;align-items:center;gap:4px">
            <span class="mi mi-sm" style="font-size:13px;animation:spin 1.5s linear infinite">sync</span>
            <span id="bagBgText">Achtergrond laden...</span>
          </span>
          <span style="display:flex;align-items:center;gap:6px">
            <span id="bagBgPct" style="font:700 10px 'Space Mono',monospace;color:var(--ac)">0%</span>
            <button class="btn btn-s" onclick="cancelBagBackgroundLoad()" style="font-size:9px;padding:1px 6px;color:var(--dn)"><span class="mi mi-sm" style="font-size:11px">stop</span></button>
          </span>
        </div>
        <div style="height:5px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden">
          <div id="bagBgBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--ai),var(--ac));border-radius:3px;transition:width .4s ease"></div>
        </div>
        <div id="bagBgDetail" style="font:400 9px 'Space Mono',monospace;color:var(--mt);margin-top:3px">Gemeenten: 0/0</div>
      </div>

      <div class="sh"><span class="mi">filter_alt</span> Filter</div>
      <!-- Multi-select Gemeente -->
      <div class="ms-wrap" id="msGemeente">
        <div class="ms-box" onclick="toggleMsDropdown('msGemeente')">
          <span class="ms-label" id="msGemLabel">Alle gemeenten</span>
          <span class="mi mi-sm" style="color:var(--mt)">expand_more</span>
        </div>
        <div class="ms-dropdown" id="msGemDropdown">
          <input class="ms-search" placeholder="Zoek gemeente..." oninput="filterMsOptions('msGemeente',this.value)">
          <div class="ms-options" id="msGemOptions"></div>
        </div>
        <div class="ms-chips" id="msGemChips"></div>
      </div>
      <!-- Multi-select Wijk -->
      <div class="ms-wrap" id="msWijk" style="margin-top:6px">
        <div class="ms-box" onclick="toggleMsDropdown('msWijk')">
          <span class="ms-label" id="msWijkLabel">Alle wijken</span>
          <span class="mi mi-sm" style="color:var(--mt)">expand_more</span>
        </div>
        <div class="ms-dropdown" id="msWijkDropdown">
          <input class="ms-search" placeholder="Zoek wijk..." oninput="filterMsOptions('msWijk',this.value)">
          <div class="ms-options" id="msWijkOptions"></div>
        </div>
        <div class="ms-chips" id="msWijkChips"></div>
      </div>
      <!-- Multi-select Buurt -->
      <div class="ms-wrap" id="msBuurt" style="margin-top:6px">
        <div class="ms-box" onclick="toggleMsDropdown('msBuurt')">
          <span class="ms-label" id="msBuurtLabel">Alle buurten</span>
          <span class="mi mi-sm" style="color:var(--mt)">expand_more</span>
        </div>
        <div class="ms-dropdown" id="msBuurtDropdown">
          <input class="ms-search" placeholder="Zoek buurt..." oninput="filterMsOptions('msBuurt',this.value)">
          <div class="ms-options" id="msBuurtOptions"></div>
        </div>
        <div class="ms-chips" id="msBuurtChips"></div>
      </div>
      <div id="bagSelectionInfo" style="display:none;font:400 9px 'Space Mono',monospace;color:var(--ai);padding:4px 8px;margin-bottom:2px;background:rgba(56,189,248,.04);border-radius:6px;display:flex;align-items:center;gap:4px">
        <span class="mi mi-sm" style="font-size:11px">location_on</span>
        <span id="bagSelectionText"></span>
      </div>
      <div style="display:flex;gap:6px">
        <button class="ms-loadbtn" id="loadSelectionBtn" onclick="loadSelection()" style="display:none;flex:1"><span class="mi mi-sm">download</span> Laad selectie</button>
        <button class="ms-loadbtn" id="compareBtn" onclick="showComparisonReport()" style="display:none;flex:1;background:linear-gradient(135deg,rgba(56,189,248,.15),rgba(6,182,212,.1));color:var(--ai);border-color:rgba(56,189,248,.2)"><span class="mi mi-sm">compare_arrows</span> Vergelijk</button>
      </div>

      <!-- Achtergrond CBS data laden statusbalk -->
      <div id="cbsBgProgress" style="display:none;margin:8px 0;padding:8px 10px;background:rgba(57,255,20,.04);border-radius:8px;border-left:3px solid var(--ac)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <span style="font:600 10px 'DM Sans',sans-serif;color:var(--ac);display:flex;align-items:center;gap:4px">
            <span class="mi mi-sm" style="font-size:13px;animation:spin 1.5s linear infinite">sync</span>
            <span id="cbsBgText">CBS data laden...</span>
          </span>
          <span id="cbsBgPct" style="font:700 10px 'Space Mono',monospace;color:var(--ac)">0%</span>
        </div>
        <div style="height:5px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden">
          <div id="cbsBgBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--ac),var(--cyan));border-radius:3px;transition:width .4s ease"></div>
        </div>
        <div id="cbsBgDetail" style="font:400 9px 'Space Mono',monospace;color:var(--mt);margin-top:3px"></div>
      </div>

      <div class="sh"><span class="mi">palette</span> Basemap</div>
      <div style="display:flex;gap:5px;flex-wrap:wrap" id="basemapBtns"></div>

      <div class="sh"><span class="mi">calendar_month</span> CBS Jaar <span id="yearActive" style="font:700 10px 'Space Mono',monospace;color:var(--ac);text-transform:none;letter-spacing:0"></span></div>
      <div class="card" style="padding:8px 10px;margin-bottom:6px">
        <div style="display:flex;gap:4px;flex-wrap:wrap" id="yearBtns"></div>
        <div id="yearInfo" style="font:400 9px 'Space Mono',monospace;color:var(--mt);margin-top:4px"></div>
      </div>

      <div class="sh"><span class="mi">bar_chart</span> Indicatoren <span style="font:400 9px 'DM Sans',sans-serif;color:var(--mt);text-transform:none;letter-spacing:0">(klik om aan/uit te zetten)</span></div>
      <div class="indicator-list" id="indicatorList"></div>

      <div class="sh"><span class="mi">gradient</span> Legenda</div>
      <div class="legend" id="legend"></div>

      <div class="sh" style="margin-top:12px"><span class="mi">analytics</span> Overzicht</div>
      <div class="stat-row">
        <div class="stat"><b id="sBuurten">0</b><small>Gebieden</small></div>
        <div class="stat"><b id="sGemeenten">0</b><small>Gemeenten</small></div>
      </div>
    </div>

    <!-- INFO TAB -->
    <div class="pane" id="p-info">
      <div class="sh"><span class="mi">info</span> Over GeoInzicht</div>
      <div class="card">
        <p style="font-size:12px;line-height:1.7;color:var(--mt)">
          CBS buurtdata op de kaart. Geometrie en statistieken vooraf samengevoegd
          vanuit PDOK WFS (CBS Wijken &amp; Buurten).
        </p>
      </div>

      <div class="sh"><span class="mi">database</span> Datasets</div>
      <div class="card" id="datasetInfo">
        <div style="font-size:11px;color:var(--mt);line-height:1.9">
          <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--glass-bd);padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ac)">domain</span> Gemeenten</span>
            <span style="font-family:'Space Mono',monospace;color:var(--ac);font-size:10px" id="dsGemeenten">&#8212;</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--glass-bd);padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ac)">grid_on</span> Buurten</span>
            <span style="font-family:'Space Mono',monospace;color:var(--ac);font-size:10px" id="dsBuurten">&#8212;</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--glass-bd);padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ac)">grid_view</span> Wijken</span>
            <span style="font-family:'Space Mono',monospace;color:var(--ac);font-size:10px" id="dsWijken">&#8212;</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--glass-bd);padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ai)">location_on</span> BAG Adressen</span>
            <span style="font-family:'Space Mono',monospace;color:var(--ai);font-size:10px">WMS live (dagelijks)</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--glass-bd);padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ai)">apartment</span> BAG Panden</span>
            <span style="font-family:'Space Mono',monospace;color:var(--ai);font-size:10px">WMS live (dagelijks)</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--glass-bd);padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--wn)">calendar_today</span> CBS Jaar</span>
            <span style="font-family:'Space Mono',monospace;color:var(--wn);font-size:10px" id="dsJaar">&#8212;</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--glass-bd);padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--mt)">schedule</span> Gegenereerd</span>
            <span style="font-family:'Space Mono',monospace;color:var(--mt);font-size:10px" id="dsGenerated">&#8212;</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ac)">bar_chart</span> Indicatoren</span>
            <span style="font-family:'Space Mono',monospace;color:var(--ac);font-size:10px">24</span>
          </div>
        </div>
      </div>

      <div class="sh"><span class="mi">hub</span> Databronnen</div>
      <div class="card">
        <div style="font-size:11px;color:var(--mt);line-height:1.7">
          <div style="padding:5px 0;border-bottom:1px solid var(--glass-bd)">
            <div style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ac)">query_stats</span> CBS Kerncijfers wijken en buurten</div>
            <div>Bron: CBS via PDOK WFS &middot; Frequentie: jaarlijks &middot; Peildatum: 1 jan 2022</div>
            <div>Indicatoren: bevolking, woningen, inkomen, energie, arbeid, voorzieningen</div>
            <div>API: <code style="font-family:'Space Mono',monospace;font-size:9px;color:var(--ai);background:rgba(56,189,248,.08);padding:1px 4px;border-radius:3px">service.pdok.nl/cbs/wijkenbuurten</code></div>
          </div>
          <div style="padding:5px 0;border-bottom:1px solid var(--glass-bd)">
            <div style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--cyan)">domain</span> BAG Basisregistratie Adressen en Gebouwen</div>
            <div>Bron: Kadaster via PDOK WMS &middot; Frequentie: <span style="color:var(--ac)">dagelijks</span></div>
            <div>9.9M verblijfsobjecten &middot; Panden met bouwjaar, oppervlakte, status</div>
            <div>API: <code style="font-family:'Space Mono',monospace;font-size:9px;color:var(--ai);background:rgba(56,189,248,.08);padding:1px 4px;border-radius:3px">service.pdok.nl/lv/bag/wms/v2_0</code></div>
          </div>
          <div style="padding:5px 0;border-bottom:1px solid var(--glass-bd)">
            <div style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ac)">search</span> PDOK Locatieserver</div>
            <div>Bron: Kadaster &middot; Frequentie: <span style="color:var(--ac)">continu</span></div>
            <div>Adres zoeken, geocodering, autocomplete</div>
            <div>API: <code style="font-family:'Space Mono',monospace;font-size:9px;color:var(--ai);background:rgba(56,189,248,.08);padding:1px 4px;border-radius:3px">api.pdok.nl/bzk/locatieserver</code></div>
          </div>
          <div style="padding:5px 0">
            <div style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--wn)">map</span> Basemaps</div>
            <div>CARTO (donker/licht) &middot; OpenStreetMap &middot; Esri Satelliet &middot; BRT Topo (Kadaster)</div>
            <div>Frequentie: <span style="color:var(--ac)">continu (live tiles)</span></div>
          </div>
        </div>
      </div>

      <div class="sh"><span class="mi">timeline</span> CBS data per jaar</div>
      <div class="card">
        <div style="font-size:11px;color:var(--mt);line-height:1.7">
          <div style="color:var(--tx);font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--wn)">help</span> Waarom jaar 2022?</div>
          CBS publiceert kerncijfers per jaar, maar niet alle indicatoren zijn
          meteen beschikbaar in het nieuwste jaar. De data wordt gefaseerd
          toegevoegd:
          <div style="margin-top:8px">
            <div style="padding:4px 0;display:flex;align-items:center;gap:6px"><span style="width:8px;height:8px;border-radius:50%;background:var(--ac);display:inline-block;flex-shrink:0"></span> <b style="color:var(--tx)">2024</b> &#8212; Alleen bevolking (inwoners, leeftijd, huishoudens)</div>
            <div style="padding:4px 0;display:flex;align-items:center;gap:6px"><span style="width:8px;height:8px;border-radius:50%;background:var(--wn);display:inline-block;flex-shrink:0"></span> <b style="color:var(--tx)">2023</b> &#8212; + WOZ, koopwoningen, woningvoorraad</div>
            <div style="padding:4px 0;display:flex;align-items:center;gap:6px"><span style="width:8px;height:8px;border-radius:50%;background:var(--up);display:inline-block;flex-shrink:0"></span> <b style="color:var(--tx)">2022</b> &#8212; + gas, elektriciteit, arbeidsparticipatie <span style="color:var(--ac);font-weight:600">(meest compleet)</span></div>
          </div>
          <div style="margin-top:8px;padding:8px 10px;background:rgba(251,191,36,.05);border-radius:8px;border-left:3px solid var(--wn);display:flex;align-items:flex-start;gap:6px">
            <span class="mi mi-sm" style="color:var(--wn);flex-shrink:0;margin-top:1px">warning</span>
            <span>Zodra CBS meer indicatoren publiceert voor een nieuwer jaar, kun je de data verversen met het build script.</span>
          </div>
        </div>
      </div>

      <div class="sh"><span class="mi">tune</span> Indicatoren</div>
      <div class="card" id="indicatorDefs" style="font-size:11px;color:var(--mt)"></div>

      <div class="sh"><span class="mi">refresh</span> Data verversen</div>
      <div class="card">
        <div style="font-size:11px;color:var(--mt);line-height:1.9">
          <div style="color:var(--tx);font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--wn)">calendar_month</span> Beschikbare CBS jaren</div>
          <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px">
            <span style="font:700 10px 'Space Mono',monospace;padding:3px 8px;background:rgba(57,255,20,.1);color:var(--ac);border-radius:4px">2012</span>
            <span style="font:700 10px 'Space Mono',monospace;padding:3px 8px;background:rgba(57,255,20,.1);color:var(--ac);border-radius:4px">2017</span>
            <span style="font:700 10px 'Space Mono',monospace;padding:3px 8px;background:rgba(57,255,20,.1);color:var(--ac);border-radius:4px">2018</span>
            <span style="font:700 10px 'Space Mono',monospace;padding:3px 8px;background:rgba(57,255,20,.1);color:var(--ac);border-radius:4px">2019</span>
            <span style="font:700 10px 'Space Mono',monospace;padding:3px 8px;background:rgba(57,255,20,.15);color:var(--ac);border-radius:4px;box-shadow:0 0 8px rgba(57,255,20,.2)">2022</span>
            <span style="font:700 10px 'Space Mono',monospace;padding:3px 8px;background:rgba(57,255,20,.1);color:var(--ac);border-radius:4px">2023</span>
            <span style="font:700 10px 'Space Mono',monospace;padding:3px 8px;background:rgba(57,255,20,.1);color:var(--ac);border-radius:4px">2024</span>
          </div>
          <div style="margin-bottom:6px">Selecteer een jaar via de <b style="color:var(--tx)">CBS Jaar</b> knoppen in het kaart-tabblad. De app laadt automatisch de juiste GeoJSON data.</div>

          <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
            <button onclick="rebuildAllYears()" class="btn btn-s" style="flex:1;background:linear-gradient(135deg,rgba(57,255,20,.12),rgba(6,182,212,.08));border-color:rgba(57,255,20,.25)"><span class="mi mi-sm">refresh</span> Alle jaren herbouwen</button>
          </div>
          <div id="rebuildInfo" style="display:none;margin-top:6px;font:400 9px 'Space Mono',monospace;color:var(--mt);padding:6px 8px;background:rgba(10,15,26,.4);border-radius:6px"></div>

          <div style="margin-top:8px;padding:8px 10px;background:rgba(57,255,20,.04);border-radius:8px;border-left:3px solid var(--ac);display:flex;align-items:flex-start;gap:6px">
            <span class="mi mi-sm" style="color:var(--ac);flex-shrink:0;margin-top:1px">info</span>
            <span>Gemeenten: alle 7 jaren (2012-2024). Buurten/wijken: 2022 en 2024. De knop herlaadt alle CBS GeoJSON bestanden vanuit PDOK.</span>
          </div>
        </div>
      </div>

      <div class="sh"><span class="mi">verified</span> Bron &amp; Versie</div>
      <div class="card">
        <div style="font:700 14px 'Space Mono',monospace;color:var(--ac);display:flex;align-items:center;gap:6px"><span class="mi" style="color:var(--ac)">public</span> GeoInzicht v7.4</div>
        <div style="font-size:11px;color:var(--mt);margin-top:8px;line-height:1.7">
          Buurten + Wijken + BAG Adressen + BAG Panden + Zoeken
          <div style="margin-top:6px">
            <div style="display:flex;align-items:center;gap:4px;padding:2px 0"><span class="mi mi-sm" style="color:var(--ac)">query_stats</span> <b style="color:var(--tx)">CBS</b> &#8212; Kerncijfers wijken en buurten</div>
            <div style="display:flex;align-items:center;gap:4px;padding:2px 0"><span class="mi mi-sm" style="color:var(--cyan)">public</span> <b style="color:var(--tx)">PDOK</b> &#8212; Geometrie, BAG WMS, Locatieserver</div>
            <div style="display:flex;align-items:center;gap:4px;padding:2px 0"><span class="mi mi-sm" style="color:var(--ai)">domain</span> <b style="color:var(--tx)">Kadaster</b> &#8212; BAG verblijfsobjecten &amp; panden</div>
          </div>
        </div>
      </div>
    </div>

    <!-- UPLOAD TAB -->
    <div class="pane" id="p-upload">
      <div class="sh"><span class="mi">upload_file</span> Eigen Data Uploaden</div>
      <div class="card">
        <div style="font-size:11px;color:var(--mt);margin-bottom:10px;line-height:1.6">
          Upload een <b>CSV</b> of <b>Excel</b> bestand met locatiedata. Vereiste kolommen: <b>lat</b> + <b>lng</b> (of <b>latitude</b>/<b>longitude</b>), of <b>adres</b>/<b>postcode</b>.<br>
          Extra kolommen worden als popup-info getoond.
        </div>
        <div id="uploadDropZone" style="border:2px dashed var(--br);border-radius:10px;padding:24px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(57,255,20,.02)"
             ondragover="event.preventDefault();this.style.borderColor='#39ff14';this.style.background='rgba(57,255,20,.08)'"
             ondragleave="this.style.borderColor='var(--br)';this.style.background='rgba(57,255,20,.02)'"
             ondrop="event.preventDefault();this.style.borderColor='var(--br)';this.style.background='rgba(57,255,20,.02)';handleUploadDrop(event)"
             onclick="document.getElementById('uploadFileInput').click()">
          <span class="mi" style="font-size:32px;color:var(--ac);display:block;margin-bottom:6px">cloud_upload</span>
          <div style="font:600 12px 'DM Sans',sans-serif;color:var(--tx)">Sleep bestand hierheen</div>
          <div style="font-size:10px;color:var(--mt);margin-top:4px">of klik om te selecteren &middot; .csv .xlsx .xls</div>
        </div>
        <input type="file" id="uploadFileInput" accept=".csv,.xlsx,.xls,.tsv" style="display:none" onchange="handleUploadFile(this.files[0])">
      </div>

      <!-- Upload icoon keuze -->
      <div id="uploadIconSection" style="display:none">
        <div class="sh"><span class="mi">palette</span> Icoon &amp; Kleur</div>
        <div class="card">
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <label style="font-size:10px;color:var(--mt);width:50px">Icoon:</label>
            <div id="iconPicker" style="display:flex;gap:4px;flex-wrap:wrap"></div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <label style="font-size:10px;color:var(--mt);width:50px">Kleur:</label>
            <div id="colorPicker" style="display:flex;gap:4px;flex-wrap:wrap"></div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <label style="font-size:10px;color:var(--mt);width:50px">Label:</label>
            <select id="uploadLabelCol" style="flex:1;background:var(--s2);border:1px solid var(--br);border-radius:6px;padding:4px 8px;color:var(--tx);font-size:10px">
              <option value="">Geen label</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Dataset info -->
      <div id="uploadInfoSection" style="display:none">
        <div class="sh"><span class="mi">edit_note</span> Dataset Informatie</div>
        <div class="card">
          <div style="margin-bottom:8px">
            <label style="font:600 9px 'DM Sans',sans-serif;color:var(--mt);display:block;margin-bottom:3px">Naam *</label>
            <input id="uploadDatasetName" type="text" placeholder="Bijv. Bijentellingen juni 2024" style="width:100%;font-size:11px;padding:7px 10px;background:var(--glass);color:var(--tx);border:1px solid var(--br);border-radius:6px;outline:none;box-sizing:border-box" onfocus="this.style.borderColor='#39ff14'" onblur="this.style.borderColor='var(--br)'">
          </div>
          <div>
            <label style="font:600 9px 'DM Sans',sans-serif;color:var(--mt);display:block;margin-bottom:3px">Beschrijving</label>
            <textarea id="uploadDatasetDesc" placeholder="Wat voor data is dit? Waar komt het vandaan? Wat is het doel?" rows="3" style="width:100%;font-size:10px;padding:7px 10px;background:var(--glass);color:var(--tx);border:1px solid var(--br);border-radius:6px;outline:none;resize:vertical;box-sizing:border-box;font-family:'DM Sans',sans-serif;line-height:1.5" onfocus="this.style.borderColor='#39ff14'" onblur="this.style.borderColor='var(--br)'"></textarea>
          </div>
        </div>
      </div>

      <!-- Upload preview -->
      <div id="uploadPreview" style="display:none">
        <div style="display:flex;gap:6px;margin-bottom:8px">
          <button class="btn btn-p" onclick="addUploadToMap()" style="flex:1;font-size:12px;padding:10px 16px"><span class="mi mi-sm">add_location</span> Toon op kaart</button>
          <button class="btn btn-s" onclick="clearUploadData()" style="font-size:11px;padding:10px 12px"><span class="mi mi-sm">delete</span> Wissen</button>
        </div>
        <div class="sh"><span class="mi">table_view</span> Preview <span id="uploadRowCount" style="font-size:10px;color:var(--mt);font-weight:400"></span></div>
        <div class="card" style="padding:0;overflow-x:auto;max-height:180px">
          <table id="uploadPreviewTable" style="font-size:9px;width:100%"></table>
        </div>
      </div>

      <!-- Actieve uploads op kaart -->
      <div id="uploadActiveSection" style="display:none">
        <div class="sh"><span class="mi">layers</span> Op Kaart</div>
        <div id="uploadLayerList" class="card" style="font-size:10px"></div>
      </div>

      <!-- Opgeslagen uploads (persistent) -->
      <div id="uploadSavedSection" style="display:none">
        <div class="sh"><span class="mi">save</span> Opgeslagen Uploads</div>
        <div id="uploadSavedList" class="card" style="font-size:10px"></div>
      </div>
    </div>

    <!-- LOG TAB -->
    <div class="pane" id="p-log">
      <div class="sh"><span class="mi">history</span> Gebruikslog</div>
      <div class="card" style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:11px;color:var(--mt)" id="logCount">0 events</span>
          <div style="display:flex;gap:4px">
            <button class="btn btn-s" onclick="exportLog()" style="font-size:9px;padding:2px 8px"><span class="mi mi-sm" style="font-size:11px">download</span> Export</button>
            <button class="btn btn-s" onclick="clearLog()" style="font-size:9px;padding:2px 8px"><span class="mi mi-sm" style="font-size:11px">delete</span> Wissen</button>
          </div>
        </div>
      </div>
      <div id="logEntries" style="font-size:10px;color:var(--mt)"></div>
    </div>

    <div class="sidebar-footer">
      <div class="neon-text">DATA CONSULTANTS</div>
    </div>
  </div>

  <div class="map-wrap">
    <div id="map"></div>
    <!-- BAG laad-overlay met logo -->
    <div id="bagLoadOverlay" style="display:none;position:absolute;inset:0;z-index:800;pointer-events:none;background:rgba(10,15,26,.45);backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px);transition:opacity .4s ease">
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center">
        <img src="logo.svg" alt="Laden..." style="width:100px;height:100px;filter:drop-shadow(0 0 24px rgba(57,255,20,.4));animation:logoSpin 2.5s cubic-bezier(.4,0,.2,1) infinite">
        <div style="margin-top:12px;font:600 13px 'DM Sans',sans-serif;color:var(--ac);text-shadow:0 0 12px rgba(57,255,20,.5)" id="bagOverlayText">BAG adressen laden...</div>
        <div style="margin-top:6px;font:700 11px 'Space Mono',monospace;color:var(--ai)" id="bagOverlayPct">0%</div>
        <div style="width:180px;height:4px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden;margin:8px auto 0">
          <div id="bagOverlayBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--ac),var(--ai));border-radius:2px;transition:width .3s ease"></div>
        </div>
      </div>
    </div>
    <div class="info-panel" id="infoPanel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <h3 id="infoBuurtNaam" style="margin:0;flex:1"><span class="mi mi-sm">place</span> -</h3>
        <div style="display:flex;gap:4px;flex-shrink:0">
          <button class="btn-s" onclick="printInfoPanel()" title="Exporteer als rapport" style="padding:4px 10px;font-size:10px;cursor:pointer;border:1px solid var(--glass-bd);background:var(--glass);color:var(--tx);border-radius:6px;display:flex;align-items:center;gap:3px"><span class="mi" style="font-size:14px">print</span>Rapport</button>
          <button class="btn-s" onclick="_infoPinned=false;document.getElementById('infoPanel').classList.remove('show')" title="Sluiten" style="padding:4px 8px;cursor:pointer;border:1px solid var(--glass-bd);background:var(--glass);color:var(--mt);border-radius:6px"><span class="mi" style="font-size:14px">close</span></button>
        </div>
      </div>
      <div id="infoContent"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Feedback popup na 30 minuten -->
<div id="feedbackOverlay" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(10,15,26,.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);animation:fadeIn .4s ease">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--p);backdrop-filter:blur(20px);border-radius:16px;padding:28px;max-width:420px;width:90%;box-shadow:0 16px 64px rgba(0,0,0,.6);border:1px solid var(--glass-bd)">
    <div style="text-align:center;margin-bottom:16px">
      <span class="mi" style="font-size:36px;color:var(--ac);display:block;margin-bottom:8px">favorite</span>
      <div style="font:700 16px 'Space Mono',monospace;color:var(--ac)">Bedankt dat je GeoInzicht gebruikt!</div>
      <div style="font-size:12px;color:var(--mt);margin-top:6px">We waarderen je feedback enorm</div>
    </div>
    <div style="margin-bottom:12px">
      <label style="font:600 11px 'DM Sans',sans-serif;color:var(--tx);display:block;margin-bottom:4px">Wat vind je van GeoInzicht?</label>
      <textarea id="feedbackText" rows="4" style="width:100%;background:var(--glass);color:var(--tx);border:1px solid var(--glass-bd);border-radius:8px;padding:10px;font:400 12px 'DM Sans',sans-serif;resize:vertical;outline:none" placeholder="Je mening, suggesties, bugs..."></textarea>
    </div>
    <div style="margin-bottom:16px">
      <label style="font:600 11px 'DM Sans',sans-serif;color:var(--tx);display:block;margin-bottom:4px">E-mailadres (optioneel, zodat we kunnen reageren)</label>
      <input id="feedbackEmail" type="email" style="width:100%;background:var(--glass);color:var(--tx);border:1px solid var(--glass-bd);border-radius:8px;padding:10px;font:400 12px 'DM Sans',sans-serif;outline:none" placeholder="je@email.nl">
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-p" onclick="submitFeedback()" style="flex:1"><span class="mi mi-sm">send</span> Verstuur</button>
      <button class="btn btn-s" onclick="closeFeedback()" style="flex:0"><span class="mi mi-sm">close</span> Sluiten</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// CONFIG
// ============================================================
var _cacheBust = '?v=' + Date.now();
var CBS_YEARS = [2012, 2017, 2018, 2019, 2022, 2023, 2024];
var _activeYear = 2022;  // Start met meest complete jaar (alle 24 indicatoren)
function gemUrl(y){ return 'gemeenten_'+(y||_activeYear)+'.geojson'+_cacheBust; }
function buurtUrl(y){ return 'buurten_'+(y||_activeYear)+'.geojson'+_cacheBust; }
function wijkUrl(y){ return 'wijken_'+(y||_activeYear)+'.geojson'+_cacheBust; }
var GEMEENTEN_URL = gemUrl();
var BUURTEN_URL   = buurtUrl();
var WIJKEN_URL    = wijkUrl();
var PDOK_BAG_WMS  = 'https://service.pdok.nl/lv/bag/wms/v2_0';
var PDOK_BAG_WFS  = 'https://service.pdok.nl/lv/bag/wfs/v2_0';
var PDOK_BAG_MVT  = 'https://api.pdok.nl/kadaster/bag/ogc/v2/tiles/WebMercatorQuad/{z}/{y}/{x}?f=mvt';
var _bagIndex = null; // bag_index.json: {GM0363: {naam, count, size_mb}}
var PDOK_SUGGEST = 'https://api.pdok.nl/bzk/locatieserver/search/v3_1/suggest?q=';
var PDOK_LOOKUP  = 'https://api.pdok.nl/bzk/locatieserver/search/v3_1/lookup?id=';

var BASEMAPS = {
  dark:  {url:'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', naam:'Donker', icon:'dark_mode', sub:'abcd'},
  light: {url:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', naam:'Licht', icon:'light_mode', sub:'abcd'},
  osm:   {url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', naam:'OSM', icon:'map', sub:'abc'},
  sat:   {url:'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', naam:'Satelliet', icon:'satellite_alt'},
  brt:   {url:'https://service.pdok.nl/brt/achtergrondkaart/wmts/v2_0/standaard/EPSG:3857/{z}/{x}/{y}.png', naam:'BRT Topo', icon:'terrain'}
};

var INDICATORS = [
  {key:'aantal_inwoners',       naam:'Aantal inwoners',         eenheid:'personen', icon:'groups'},
  {key:'gem_woz_waarde',        naam:'Gem. WOZ-waarde',         eenheid:'x1000',    icon:'home'},
  {key:'gem_inkomen_inwoner',   naam:'Gem. inkomen/inwoner',    eenheid:'x1000',    icon:'payments'},
  {key:'koopwoningen',          naam:'Koopwoningen',            eenheid:'%',        icon:'key'},
  {key:'65plus',                naam:'65-plussers',             eenheid:'%',        icon:'elderly'},
  {key:'bevolkingsdichtheid',   naam:'Bevolkingsdichtheid',     eenheid:'/km\u00b2',icon:'density_small'},
  {key:'gem_aardgas',           naam:'Gem. aardgas',            eenheid:'m\u00b3',  icon:'local_fire_department'},
  {key:'gem_elektriciteit',     naam:'Gem. elektriciteit',      eenheid:'kWh',      icon:'bolt'},
  {key:'huishoudens',           naam:'Huishoudens',             eenheid:'aantal',   icon:'family_restroom'},
  {key:'woningvoorraad',        naam:'Woningvoorraad',          eenheid:'aantal',   icon:'location_city'},
  {key:'gem_huishouden_grootte',naam:'Gem. huishoudensgrootte', eenheid:'pers.',    icon:'group'},
  {key:'arbeidsparticipatie',   naam:'Arbeidsparticipatie',     eenheid:'%',        icon:'work'},
  {key:'bedrijfsvestigingen',   naam:'Bedrijfsvestigingen',     eenheid:'aantal',   icon:'business'},
  {key:'afstand_huisarts',      naam:'Afstand huisarts',        eenheid:'km',       icon:'local_hospital'},
  {key:'afstand_supermarkt',    naam:'Afstand supermarkt',      eenheid:'km',       icon:'shopping_cart'},
  {key:'mannen',                naam:'Mannen',                  eenheid:'personen', icon:'man'},
  {key:'vrouwen',               naam:'Vrouwen',                 eenheid:'personen', icon:'woman'},
  {key:'0_15',                  naam:'0-15 jaar',               eenheid:'%',        icon:'child_care'},
  {key:'15_25',                 naam:'15-25 jaar',              eenheid:'%',        icon:'school'},
  {key:'25_45',                 naam:'25-45 jaar',              eenheid:'%',        icon:'person'},
  {key:'45_65',                 naam:'45-65 jaar',              eenheid:'%',        icon:'person_4'},
  {key:'huurwoningen',          naam:'Huurwoningen',            eenheid:'%',        icon:'real_estate_agent'},
  {key:'pct_eengezins',         naam:'Eengezinswoningen',       eenheid:'%',        icon:'cottage'},
  {key:'personenautos',         naam:"Personenauto's",          eenheid:'aantal',   icon:'directions_car'}
];

// Actieve indicatoren (toggle aan/uit), eerste = primair (kaartkleur)
var _activeIndicators = ['gem_woz_waarde','aantal_inwoners','gem_inkomen_inwoner'];

var REVERSE_KEYS = ['afstand_huisarts','afstand_supermarkt'];
var COLORS = ['#1a2332','#1e3a5f','#1d6fa5','#22a7d3','#5ec69b','#a3d65c','#f5c842'];
var COLORS_REVERSE = COLORS.slice().reverse();

// ============================================================
// STATE
// ============================================================
var _map, _currentBasemap;
var _gemeenteData = null, _gemeenteLayer = null;
var _buurtData = null, _buurtLayer = null;
var _wijkData = null, _wijkLayer = null;
var _bagWmsLayer = null;
var _bagVectorLayer = null;
var _bagVectorData = null; // raw WFS features cache
var _bagLoading = false;
var _bagForceReload = false;
var _pandWmsLayer = null;
var _searchMarker = null;
var _infoPinned = false; // Panel vastzetten bij klik
var _gemeenteNamen = new Set();
var _layerState = {gemeenten: true, buurten: false, wijken: false, bag: false, panden: false};
var _nationalStats = {}; // Cache: {key: {min, max, avg, median, stddev, count, skewness, distType}}

// ============================================================
// MAP
// ============================================================
function initMap(){
  _map = L.map('map',{center:[52.1,5.1],zoom:8,zoomControl:false,preferCanvas:true});
  L.control.zoom({position:'bottomright'}).addTo(_map);
  // Zoom level indicator naast zoom controls
  var ZoomIndicator = L.Control.extend({
    options: {position:'bottomright'},
    onAdd: function(map){
      var div = L.DomUtil.create('div','zoom-indicator');
      div.id = 'zoomIndicator';
      div.innerHTML = '<span class="zi-label">Zoom</span><span class="zi-val" id="zoomLevelText">'+map.getZoom()+'</span>';
      L.DomEvent.disableClickPropagation(div);
      map.on('zoomend', function(){ document.getElementById('zoomLevelText').textContent = map.getZoom(); });
      return div;
    }
  });
  new ZoomIndicator().addTo(_map);
  setBasemap('dark');
  // Voorkom dat scrollen in het infopanel de kaart zoomt
  var infoPanel = document.getElementById('infoPanel');
  L.DomEvent.disableScrollPropagation(infoPanel);
  L.DomEvent.disableClickPropagation(infoPanel);

  _map.on('click', function(e){
    if(_map.getZoom() >= 16 && _pandWmsLayer && !_bagVectorLayer){
      _infoPinned = true;
      pandGetFeatureInfo(e);
    }
  });
}

function setBasemap(id){
  if(_currentBasemap) _map.removeLayer(_currentBasemap);
  var bm = BASEMAPS[id];
  var opts = {maxZoom:19, attribution:'&copy; OSM &copy; CARTO | PDOK'};
  if(bm.sub) opts.subdomains = bm.sub;
  _currentBasemap = L.tileLayer(bm.url, opts).addTo(_map);
  fixLayerOrder();
  document.querySelectorAll('[data-bm]').forEach(function(b){
    b.classList.toggle('active', b.dataset.bm === id);
  });
  logEvent('basemap', bm.naam || id);
}

function buildBasemapButtons(){
  var el = document.getElementById('basemapBtns');
  var html = '';
  for(var id in BASEMAPS){
    var bm = BASEMAPS[id];
    html += '<button class="btn btn-s'+(id==='dark'?' active':'')+'" data-bm="'+id+'" onclick="setBasemap(\''+id+'\')"><span class="mi mi-sm">'+bm.icon+'</span> '+bm.naam+'</button>';
  }
  el.innerHTML = html;
}

// ============================================================
// JAAR SELECTIE
// ============================================================
var _yearIndicators = {}; // Cache: {2022: ['aantal_inwoners','gem_woz_waarde',...]}

function buildYearButtons(){
  var el = document.getElementById('yearBtns');
  var html = '';
  CBS_YEARS.forEach(function(y){
    var cls = y === _activeYear ? 'btn btn-s active' : 'btn btn-s';
    html += '<button class="'+cls+'" data-year="'+y+'" onclick="switchYear('+y+')" style="font:700 11px \'Space Mono\',monospace;min-width:42px">'+y+'</button>';
  });
  el.innerHTML = html;
  var ya = document.getElementById('yearActive');
  if(ya) ya.textContent = '— ' + _activeYear + ' actief';
}

function switchYear(year){
  if(year === _activeYear) return;
  _activeYear = year;
  GEMEENTEN_URL = gemUrl(year);
  BUURTEN_URL = buurtUrl(year);
  WIJKEN_URL = wijkUrl(year);

  // Update knop-actief state
  document.querySelectorAll('#yearBtns button').forEach(function(b){
    b.classList.toggle('active', parseInt(b.dataset.year) === year);
  });
  var ya = document.getElementById('yearActive');
  if(ya) ya.textContent = '— ' + year + ' actief';

  // Reset alle geladen data
  if(_gemeenteLayer){_map.removeLayer(_gemeenteLayer);_gemeenteLayer=null}
  if(_buurtLayer){_map.removeLayer(_buurtLayer);_buurtLayer=null}
  if(_wijkLayer){_map.removeLayer(_wijkLayer);_wijkLayer=null}
  _gemeenteData = null;
  _buurtData = null;
  _wijkData = null;
  _nationalStats = {};

  toast('CBS '+year+' laden...');

  // Herlaad gemeentedata voor het nieuwe jaar
  fetch(GEMEENTEN_URL).then(function(r){
    if(!r.ok) throw new Error('Jaar '+year+' niet beschikbaar ('+r.status+')');
    return r.json();
  }).then(function(d){
    _gemeenteData = d;
    _gemeenteNamen = new Set();
    d.features.forEach(function(f){
      if(f.properties.gemeentenaam) _gemeenteNamen.add(f.properties.gemeentenaam);
    });
    buildGemeenteFilter();

    // Haal beschikbare indicatoren uit metadata
    var meta = d.metadata || {};
    var availableIndicators = meta.indicators || [];
    _yearIndicators[year] = availableIndicators;
    updateYearInfo(year, meta);
    filterIndicatorsByYear(availableIndicators);

    // Render kaart
    renderChoropleth('gemeenten');
    computeNationalStats();

    // Update indicator definities op Info tab
    renderIndicatorDefs();

    // Herlaad buurten en wijken op achtergrond (altijd, voor filters en stats)
    setTimeout(function(){ loadBackgroundCbsData(); }, 500);

    // BAG aantallen per gemeente prefetchen (lichtgewicht hits queries)
    setTimeout(function(){ loadBagIndex().then(function(){ prefetchBagCounts(); }); }, 2000);

    document.getElementById('dsJaar').textContent = year;
    toast('CBS '+year+' geladen \u2714 ('+availableIndicators.length+' indicatoren)');
  }).catch(function(e){
    toast('Fout: '+e.message, 'error');
    console.error('switchYear error:', e);
  });
}

function updateYearInfo(year, meta){
  var el = document.getElementById('yearInfo');
  var n = (meta.indicators || []).length;
  var total = INDICATORS.length;
  el.textContent = year+': '+n+'/'+total+' indicatoren met data';
  if(n < total){
    el.style.color = 'var(--wn)';
  } else {
    el.style.color = 'var(--ac)';
  }
}

// Herbouw alle jaren: laad elke CBS GeoJSON opnieuw
function rebuildAllYears(){
  var el = document.getElementById('rebuildInfo');
  el.style.display = 'block';
  el.innerHTML = '<span class="mi mi-sm" style="font-size:11px;animation:spin 1.5s linear infinite;vertical-align:-2px">sync</span> Alle jaren herladen...';
  var years = CBS_YEARS.slice();
  var idx = 0;
  var results = [];
  function doNext(){
    if(idx >= years.length){
      el.innerHTML = '<span class="mi mi-sm" style="font-size:11px;color:var(--ac);vertical-align:-2px">check_circle</span> Klaar! '+results.length+' jaren gecontroleerd. Selecteer een jaar om de data te activeren.';
      toast('Alle jaren gecontroleerd \u2714');
      return;
    }
    var y = years[idx];
    var url = gemUrl(y);
    el.innerHTML = '<span class="mi mi-sm" style="font-size:11px;animation:spin 1.5s linear infinite;vertical-align:-2px">sync</span> '+y+' laden... ('+(idx+1)+'/'+years.length+')';
    fetch(url).then(function(r){
      if(!r.ok) throw new Error(r.status);
      return r.json();
    }).then(function(d){
      var meta = d.metadata || {};
      var n = (meta.indicators || []).length;
      results.push({year:y, count:d.features.length, indicators:n, ok:true});
      idx++;
      doNext();
    }).catch(function(e){
      results.push({year:y, ok:false, error:e.message});
      idx++;
      doNext();
    });
  }
  doNext();
}

function filterIndicatorsByYear(availableKeys){
  // Toon alleen indicatoren die data hebben voor het geselecteerde jaar
  var avSet = new Set(availableKeys);
  // Zorg dat actieve indicatoren nog geldig zijn
  _activeIndicators = _activeIndicators.filter(function(k){ return avSet.has(k); });
  if(_activeIndicators.length === 0){
    // Fallback: eerste 3 beschikbare
    _activeIndicators = availableKeys.slice(0, 3);
  }
  buildIndicatorList();
}

// ============================================================
// CHOROPLETH RENDERING
// ============================================================
var LAYER_CONFIG = {
  gemeenten: {data:function(){return _gemeenteData}, nameField:'gemeentenaam', codeField:'gemeentecode', borderWeight:2, borderColor:'rgba(255,255,255,0.4)'},
  buurten:   {data:function(){return _buurtData},    nameField:'buurtnaam',    codeField:'buurtcode',    borderWeight:0.5, borderColor:'rgba(255,255,255,0.15)'},
  wijken:    {data:function(){return _wijkData},     nameField:'wijknaam',     codeField:'wijkcode',     borderWeight:1.5, borderColor:'rgba(255,255,255,0.3)'}
};

// Z-volgorde: basemap → gemeenten → wijken → buurten → BAG panden → BAG WMS → BAG vectors
function fixLayerOrder(){
  if(_currentBasemap) _currentBasemap.bringToBack();
  if(_gemeenteLayer) _gemeenteLayer.bringToFront();
  if(_wijkLayer) _wijkLayer.bringToFront();
  if(_buurtLayer) _buurtLayer.bringToFront();
  if(_pandWmsLayer) _pandWmsLayer.bringToFront();
  if(_bagWmsLayer) _bagWmsLayer.bringToFront();
  if(_bagVectorLayer) _bagVectorLayer.bringToFront();
}

// Bouw compacte tooltip-inhoud voor hover op kaart
function buildMapTooltip(p, cfg, type){
  var name = p[cfg.nameField] || '-';
  var typeLabel = {gemeenten:'Gemeente', wijken:'Wijk', buurten:'Buurt'}[type] || type;
  var html = '<div class="tt-header">';
  html += '<span class="tt-name">'+name+'</span>';
  html += '<span class="tt-type">'+typeLabel+'</span>';
  html += '</div><div class="tt-body">';
  // Toon actieve indicatoren met waarden
  var indLookup = {};
  INDICATORS.forEach(function(ind){ indLookup[ind.key] = ind; });
  _activeIndicators.forEach(function(key, i){
    var ind = indLookup[key];
    if(!ind) return;
    var v = p[key];
    var valStr = (v !== undefined && v !== null && v >= 0) ? v.toLocaleString('nl-NL') : '-';
    var cls = i === 0 ? 'tt-prim' : 'tt-sec';
    html += '<div class="tt-row">';
    html += '<span class="tt-label"><span class="mi" style="font-size:12px">'+ind.icon+'</span> '+ind.naam+'</span>';
    html += '<span class="tt-val '+cls+'">'+valStr;
    if(ind.eenheid && v !== undefined && v !== null && v >= 0) html += ' <span style="font-weight:400;opacity:.5;font-size:8px">'+ind.eenheid+'</span>';
    html += '</span></div>';
  });
  // BAG adressen als beschikbaar
  var bagCount = null;
  if(type === 'gemeenten' && _bagIndex && p.gemeentecode && _bagIndex[p.gemeentecode]){
    bagCount = _bagIndex[p.gemeentecode].count;
  } else if(type === 'wijken' && _bagWijkIndex && p.wijkcode && _bagWijkIndex[p.wijkcode]){
    bagCount = _bagWijkIndex[p.wijkcode].count;
  } else if(type === 'buurten' && _bagBuurtIndex && p.buurtcode && _bagBuurtIndex[p.buurtcode]){
    bagCount = _bagBuurtIndex[p.buurtcode].count;
  }
  if(bagCount !== null){
    html += '<div class="tt-row" style="border-top:1px solid rgba(255,255,255,.06);margin-top:2px;padding-top:4px">';
    html += '<span class="tt-label"><span class="mi" style="font-size:12px;color:#38bdf8">location_on</span> BAG Adressen</span>';
    html += '<span class="tt-val tt-sec">'+bagCount.toLocaleString('nl-NL')+'</span></div>';
  }
  html += '</div>';
  return html;
}

function renderChoropleth(type){
  try {
  var cfg = LAYER_CONFIG[type];
  if(!cfg){console.warn('renderChoropleth: no config for',type);return}
  var data = cfg.data();
  if(!data || !_map){console.warn('renderChoropleth: no data or map',type,!!data,!!_map);return}

  // Verwijder oude laag
  if(type === 'gemeenten' && _gemeenteLayer){ _map.removeLayer(_gemeenteLayer); _gemeenteLayer = null; }
  if(type === 'buurten' && _buurtLayer){ _map.removeLayer(_buurtLayer); _buurtLayer = null; }
  if(type === 'wijken' && _wijkLayer){ _map.removeLayer(_wijkLayer); _wijkLayer = null; }

  var indicator = _activeIndicators.length > 0 ? _activeIndicators[0] : 'aantal_inwoners';
  var gemFilter = getSelectedGemeenteFilter();
  var wijkFilter = getSelectedWijkFilter();
  var buurtFilter = getSelectedBuurtFilter();

  function featureMatchesFilter(p){
    if(gemFilter !== 'all' && !gemFilter.has(p.gemeentenaam)) return false;
    if(wijkFilter !== 'all' && p.wijknaam && !wijkFilter.has(p.wijknaam)) return false;
    if(buurtFilter !== 'all' && p.buurtnaam && !buurtFilter.has(p.buurtnaam)) return false;
    return true;
  }

  var vals = [];
  data.features.forEach(function(f){
    var p = f.properties;
    if(!featureMatchesFilter(p)) return;
    var v = p[indicator];
    if(v !== undefined && v !== null && v >= 0) vals.push(v);
  });
  console.log('renderChoropleth',type,'indicator='+indicator,'vals='+vals.length,'features='+data.features.length);
  if(!vals.length){console.warn('renderChoropleth: geen waarden voor',indicator);return}

  vals.sort(function(a,b){return a-b});
  var breaks = quantileBreaks(vals, 7);
  var colors = REVERSE_KEYS.indexOf(indicator) >= 0 ? COLORS_REVERSE : COLORS;

  var newLayer = L.geoJSON(data, {
    style: function(feature){
      var p = feature.properties;
      if(!featureMatchesFilter(p))
        return {fillColor:'#111',fillOpacity:0.05,weight:0.2,color:'#222',opacity:0.2};
      var v = p[indicator];
      if(v === undefined || v === null || v < 0)
        return {fillColor:'#111',fillOpacity:0.1,weight:0.3,color:'#333',opacity:0.3};
      return {fillColor:getColor(v,breaks,colors),fillOpacity:0.65,weight:cfg.borderWeight,color:cfg.borderColor,opacity:0.5};
    },
    onEachFeature: function(feature, layer){
      // Tooltip voor hover: compacte info direct op de kaart
      layer.bindTooltip('', {
        className: 'map-tooltip',
        direction: 'right',
        offset: [12, 0],
        opacity: 1,
        sticky: true
      });
      layer.on('mouseover', function(e){
        // Skip hover als BAG/panden actief zijn (choropleth is gedimd)
        if(_layerState.bag || _layerState.panden) return;
        e.target.setStyle({weight:2.5,color:'#39ff14',fillOpacity:0.9});
        e.target.bringToFront();
        // Tooltip updaten met actuele indicator waarden
        var ttHtml = buildMapTooltip(feature.properties, cfg, type);
        layer.setTooltipContent(ttHtml);
      });
      layer.on('mouseout', function(e){
        if(_layerState.bag || _layerState.panden) return;
        // Herstel stijl, maar bewaar selectie-highlight als dit gebied geselecteerd is
        if(_selectionHighlights.indexOf(e.target) >= 0){
          // Geselecteerd: herstel highlight-stijl (niet de choropleth-stijl)
          e.target.setStyle({weight:3.5, color:'#39ff14', opacity:1, fillOpacity:0.8});
          e.target.bringToFront();
        } else {
          newLayer.resetStyle(e.target);
        }
        if(!_infoPinned) document.getElementById('infoPanel').classList.remove('show');
      });
      layer.on('click', function(e){
        // Altijd: toggle selectie voor vergelijking
        toggleMapSelection(feature.properties, type, layer, newLayer);
        // Toon volledig info panel en pin het vast
        _infoPinned = true;
        showFeatureInfo(feature.properties, cfg, type, true, feature);
      });
    }
  }).addTo(_map);

  if(type === 'gemeenten'){ _gemeenteLayer = newLayer; }
  if(type === 'buurten'){ _buurtLayer = newLayer; }
  if(type === 'wijken'){ _wijkLayer = newLayer; }

  // Z-ordering herstellen
  fixLayerOrder();

  // Primaire laag bepaalt legenda/stats (de meest gedetailleerde actieve laag)
  var primaryType = _layerState.buurten ? 'buurten' : (_layerState.wijken ? 'wijken' : 'gemeenten');
  if(type === primaryType){
    updateLegend(breaks, colors);
    updateActiveStats();
  }
  // Herstel selectie-highlights na re-render
  reapplySelectionHighlights();
  } catch(err){console.error('renderChoropleth ERROR:',err)}
}

// ============================================================
// LAYER TOGGLES
// ============================================================
function toggleLayer(type){
  _layerState[type] = !_layerState[type];
  var btn = document.querySelector('[data-layer="'+type+'"]');
  if(btn) btn.classList.toggle('active', _layerState[type]);

  if(type === 'gemeenten'){
    if(_layerState.gemeenten) renderChoropleth('gemeenten');
    else if(_gemeenteLayer){_map.removeLayer(_gemeenteLayer);_gemeenteLayer=null}
  }
  else if(type === 'buurten'){
    if(_layerState.buurten){
      if(!_buurtData){
        toast('Buurtdata laden (14.4 MB)...');
        fetch(BUURTEN_URL).then(function(r){return r.json()}).then(function(d){
          _buurtData = d;
          toast(d.features.length.toLocaleString('nl-NL') + ' buurten geladen');
          document.getElementById('dsBuurten').textContent = d.features.length.toLocaleString('nl-NL') + ' features';
          renderChoropleth('buurten');
          updateActiveStats();
        }).catch(function(e){toast('Fout laden buurten: '+e.message);_layerState.buurten=false;document.querySelector('[data-layer="buurten"]').classList.remove('active')});
      } else renderChoropleth('buurten');
    } else if(_buurtLayer){_map.removeLayer(_buurtLayer);_buurtLayer=null;updateMap()}
  }
  else if(type === 'wijken'){
    if(_layerState.wijken){
      if(!_wijkData){
        toast('Wijkdata laden (4.4 MB)...');
        fetch(WIJKEN_URL).then(function(r){return r.json()}).then(function(d){
          _wijkData = d;
          toast(d.features.length.toLocaleString('nl-NL') + ' wijken geladen');
          document.getElementById('dsWijken').textContent = d.features.length.toLocaleString('nl-NL') + ' features';
          renderChoropleth('wijken');
          updateActiveStats();
        }).catch(function(e){toast('Fout laden wijken: '+e.message);_layerState.wijken=false;document.querySelector('[data-layer="wijken"]').classList.remove('active')});
      } else renderChoropleth('wijken');
    } else if(_wijkLayer){_map.removeLayer(_wijkLayer);_wijkLayer=null;updateMap()}
  }
  else if(type === 'bag') toggleBagLayer(_layerState.bag);
  else if(type === 'panden') togglePandLayer(_layerState.panden);
}

// ============================================================
// BAG WMS
// ============================================================
var BAG_STATUSES = [
  {id:'all',     label:'Alle',              color:'#e2e8f0', match:null},
  {id:'gebruik', label:'In gebruik',        color:'#39ff14', match:['Verblijfsobject in gebruik','Verblijfsobject in gebruik (niet ingemeten)']},
  {id:'verbouw', label:'Verbouwing',        color:'#fbbf24', match:['Verbouwing verblijfsobject']},
  {id:'gevormd', label:'Gevormd',           color:'#38bdf8', match:['Verblijfsobject gevormd']},
  {id:'buiten',  label:'Buiten gebruik',    color:'#f97316', match:['Verblijfsobject buiten gebruik']},
  {id:'ingetrokken', label:'Ingetrokken',   color:'#ef4444', match:['Verblijfsobject ingetrokken']},
  {id:'niet',    label:'Niet gerealiseerd', color:'#64748b', match:['Niet gerealiseerd verblijfsobject']}
];
var _bagStatusFilter = 'all';

function bagStatusToColor(status){
  for(var i=1;i<BAG_STATUSES.length;i++){
    if(BAG_STATUSES[i].match && BAG_STATUSES[i].match.indexOf(status) >= 0) return BAG_STATUSES[i].color;
  }
  return '#64748b';
}

function buildBagStatusButtons(){
  var el = document.getElementById('bagStatusBtns');
  var html = '';
  BAG_STATUSES.forEach(function(s){
    html += '<button class="btn btn-s'+(s.id==='all'?' active':'')+'" data-bagstatus="'+s.id+'" onclick="setBagStatus(\''+s.id+'\')" style="font-size:10px;padding:5px 10px">';
    html += '<span style="width:8px;height:8px;border-radius:50%;background:'+s.color+';display:inline-block"></span> '+s.label;
    html += '</button>';
  });
  el.innerHTML = html;
}

function setBagStatus(id){
  _bagStatusFilter = id;
  document.querySelectorAll('[data-bagstatus]').forEach(function(b){
    b.classList.toggle('active', b.dataset.bagstatus === id);
  });
  // Herteken vector markers met nieuw filter
  if(_layerState.bag) redrawBagVectorTiles();
}

function matchesBagFilter(status){
  if(_bagStatusFilter === 'all') return true;
  var s = BAG_STATUSES.filter(function(b){return b.id === _bagStatusFilter})[0];
  return s && s.match && s.match.indexOf(status) >= 0;
}

// BAG uitgebreide filters: gebruiksdoel, bouwjaar, oppervlakte
var _bagFilterGebruiksdoel = '';
var _bagFilterBouwjaarMin = null;
var _bagFilterBouwjaarMax = null;
var _bagFilterOppMin = null;
var _bagFilterOppMax = null;

function applyBagFilters(){
  _bagFilterGebruiksdoel = (document.getElementById('bagFilterGebruiksdoel').value || '').toLowerCase();
  _bagFilterBouwjaarMin = parseInt(document.getElementById('bagFilterBouwjaarMin').value) || null;
  _bagFilterBouwjaarMax = parseInt(document.getElementById('bagFilterBouwjaarMax').value) || null;
  _bagFilterOppMin = parseInt(document.getElementById('bagFilterOppMin').value) || null;
  _bagFilterOppMax = parseInt(document.getElementById('bagFilterOppMax').value) || null;
  if(_layerState.bag) redrawBagVectorTiles();
  logEvent('bag_filter', 'doel='+(_bagFilterGebruiksdoel||'alle')+' bj='+(_bagFilterBouwjaarMin||'')+'-'+(_bagFilterBouwjaarMax||'')+' opp='+(_bagFilterOppMin||'')+'-'+(_bagFilterOppMax||''));
}

function resetBagFilters(){
  document.getElementById('bagFilterGebruiksdoel').value = '';
  document.getElementById('bagFilterBouwjaarMin').value = '';
  document.getElementById('bagFilterBouwjaarMax').value = '';
  document.getElementById('bagFilterOppMin').value = '';
  document.getElementById('bagFilterOppMax').value = '';
  _bagFilterGebruiksdoel = '';
  _bagFilterBouwjaarMin = null;
  _bagFilterBouwjaarMax = null;
  _bagFilterOppMin = null;
  _bagFilterOppMax = null;
  if(_layerState.bag) redrawBagVectorTiles();
}

function matchesBagExtendedFilters(p){
  // Gebruiksdoel
  if(_bagFilterGebruiksdoel){
    var doel = (p.gebruiksdoel || '').toLowerCase();
    if(doel.indexOf(_bagFilterGebruiksdoel) < 0) return false;
  }
  // Bouwjaar
  if(_bagFilterBouwjaarMin && p.bouwjaar && p.bouwjaar < _bagFilterBouwjaarMin) return false;
  if(_bagFilterBouwjaarMax && p.bouwjaar && p.bouwjaar > _bagFilterBouwjaarMax) return false;
  // Als filter actief maar feature geen bouwjaar heeft: filteren we die eruit
  if((_bagFilterBouwjaarMin || _bagFilterBouwjaarMax) && !p.bouwjaar) return false;
  // Oppervlakte
  if(_bagFilterOppMin && p.oppervlakte && p.oppervlakte < _bagFilterOppMin) return false;
  if(_bagFilterOppMax && p.oppervlakte && p.oppervlakte > _bagFilterOppMax) return false;
  if((_bagFilterOppMin || _bagFilterOppMax) && !p.oppervlakte) return false;
  return true;
}

function createBagWmsLayer(){
  _bagWmsLayer = L.tileLayer.wms(PDOK_BAG_WMS, {
    layers:'verblijfsobject',format:'image/png',transparent:true,
    version:'1.1.1',opacity:0.4,maxZoom:22,tileSize:256,minZoom:13
  }).addTo(_map);
  fixLayerOrder();
}

// Dynamische Panden WMS opacity: fade in bij hogere zoom
function updatePandWmsOpacity(){
  if(!_map) return;
  var z = _map.getZoom();
  if(_pandWmsLayer) _pandWmsLayer.setOpacity(z >= 16 ? 0.6 : (z >= 14 ? 0.3 : (z >= 13 ? 0.15 : 0)));
}

// ============================================================
// BAG CACHE — IndexedDB (onbeperkt) + in-memory Map (snel)
// ============================================================
var BAG_IDB_NAME = 'geoinzicht_bag';
var BAG_IDB_VERSION = 1;
var BAG_IDB_STORE = 'adressen';
var _bagIdb = null;        // IndexedDB database handle
var _bagMem = {};          // In-memory: identificatie -> feature (snelle lookup)
var _bagMemCount = 0;      // Aantal unieke adressen in memory
var _bagCacheReady = false; // Is IDB klaar?

// Open IndexedDB
function openBagIDB(){
  return new Promise(function(resolve, reject){
    if(_bagIdb){ resolve(_bagIdb); return; }
    var req = indexedDB.open(BAG_IDB_NAME, BAG_IDB_VERSION);
    req.onupgradeneeded = function(e){
      var db = e.target.result;
      if(!db.objectStoreNames.contains(BAG_IDB_STORE)){
        var store = db.createObjectStore(BAG_IDB_STORE, {keyPath:'id'});
        store.createIndex('lat','lat',{unique:false});
        store.createIndex('lng','lng',{unique:false});
      }
    };
    req.onsuccess = function(e){ _bagIdb = e.target.result; resolve(_bagIdb); };
    req.onerror = function(e){ console.warn('IndexedDB open error:',e); reject(e); };
  });
}

// Laad ALLE adressen uit IndexedDB naar in-memory cache
function loadBagFromIDB(){
  return openBagIDB().then(function(db){
    return new Promise(function(resolve){
      var tx = db.transaction(BAG_IDB_STORE, 'readonly');
      var store = tx.objectStore(BAG_IDB_STORE);
      var req = store.getAll();
      req.onsuccess = function(){
        var items = req.result || [];
        _bagMem = {};
        _bagMemCount = 0;
        items.forEach(function(item){
          _bagMem[item.id] = item.feature;
          _bagMemCount++;
        });
        _bagCacheReady = true;
        console.log('BAG cache geladen uit IndexedDB:', _bagMemCount, 'adressen');
        updateBagCacheUI();
        resolve(_bagMemCount);
      };
      req.onerror = function(){ _bagCacheReady = true; resolve(0); };
    });
  }).catch(function(){ _bagCacheReady = true; return 0; });
}

// Sla features op in IndexedDB (batch put)
function saveBagToIDB(features){
  if(!features || !features.length) return Promise.resolve();
  // Eerst in-memory opslaan
  var newItems = [];
  features.forEach(function(f){
    var id = f.properties.identificatie || f.properties.id;
    if(!id) return;
    if(!_bagMem[id]){
      _bagMem[id] = f;
      _bagMemCount++;
      var c = f.geometry.coordinates;
      newItems.push({id:id, lat:c[1], lng:c[0], feature:f});
    }
  });
  updateBagCacheUI();
  if(newItems.length === 0) return Promise.resolve();

  // Schrijf naar IndexedDB in batches van 5000
  return openBagIDB().then(function(db){
    return new Promise(function(resolve){
      var batchSize = 5000;
      var idx = 0;
      function writeBatch(){
        if(idx >= newItems.length){ resolve(); return; }
        var batch = newItems.slice(idx, idx + batchSize);
        idx += batchSize;
        var tx = db.transaction(BAG_IDB_STORE, 'readwrite');
        var store = tx.objectStore(BAG_IDB_STORE);
        batch.forEach(function(item){ store.put(item); });
        tx.oncomplete = writeBatch;
        tx.onerror = function(e){ console.warn('IDB write error:',e); writeBatch(); };
      }
      writeBatch();
    });
  }).catch(function(e){ console.warn('IDB save error:',e); });
}

// Haal alle gecachte features in de huidige viewport uit memory
function getCachedBagFeatures(){
  if(!_map) return [];
  var b = _map.getBounds();
  var s = b.getSouth(), n = b.getNorth(), w = b.getWest(), e = b.getEast();
  var features = [];
  for(var id in _bagMem){
    var f = _bagMem[id];
    var c = f.geometry.coordinates;
    if(c[1] >= s && c[1] <= n && c[0] >= w && c[0] <= e){
      features.push(f);
    }
  }
  return features;
}

// Wis de BAG cache
function clearBagCache(){
  _bagMem = {};
  _bagMemCount = 0;
  _bagBgLoaded = {};  // Reset geladen gemeenten tracker
  openBagIDB().then(function(db){
    var tx = db.transaction(BAG_IDB_STORE, 'readwrite');
    tx.objectStore(BAG_IDB_STORE).clear();
  }).catch(function(){});
  updateBagCacheUI();
  // Oude localStorage cache ook opruimen
  try{localStorage.removeItem('geoinzicht_bag_cache');localStorage.removeItem('geoinzicht_bag_meta')}catch(e){}
}

function updateBagCacheUI(){
  var el = document.getElementById('bagCacheText');
  var btnEl = document.getElementById('bagBtnCount');
  // Bereken totaal BAG adressen uit prefetch index (server-side tellingen)
  var totalAdressen = 0;
  var gemGeteld = 0;
  var gemTotaal = _gemeenteData ? _gemeenteData.features.length : 342;
  if(_bagIndex && Object.keys(_bagIndex).length > 0){
    for(var k in _bagIndex){
      totalAdressen += (_bagIndex[k].count || 0);
      gemGeteld++;
    }
  }
  var wijkGeteld = Object.keys(_bagWijkIndex).length;
  var buurtGeteld = Object.keys(_bagBuurtIndex).length;
  // Cache info tekst
  if(el){
    if(gemGeteld > 0){
      var parts = [];
      parts.push(totalAdressen.toLocaleString('nl-NL')+' adressen totaal');
      if(gemGeteld < gemTotaal){
        parts.push(gemGeteld+'/'+gemTotaal+' gemeenten geteld');
      } else {
        parts.push(gemGeteld+' gemeenten');
      }
      if(wijkGeteld > 0) parts.push(wijkGeteld+' wijken');
      if(buurtGeteld > 0) parts.push(buurtGeteld+' buurten');
      if(_bagPrefetching) parts.push('⏳ telt...');
      if(_bagSubPrefetching) parts.push('⏳ sub-areas...');
      el.textContent = parts.join(' · ');
    } else if(_bagPrefetching){
      el.textContent = 'Adressen tellen per gemeente...';
    } else {
      el.textContent = 'Totaal: tellen...';
    }
  }
  // Update badge op BAG knop: totaal adressen
  if(btnEl){
    if(totalAdressen > 0){
      var suffix = (gemGeteld < gemTotaal) ? '+' : '';
      btnEl.textContent = '('+totalAdressen.toLocaleString('nl-NL')+suffix+')';
    } else if(_bagPrefetching){
      btnEl.textContent = '(tellen...)';
    } else {
      btnEl.textContent = '';
    }
  }
}

// ---------------------------------------------------------------------------
// BAG telling per gebied — snel tellen hoeveel adressen geladen/gecached zijn
// ---------------------------------------------------------------------------
function getBagStatsForFeature(feature, type){
  // Returns {total: number|null} — met vector tiles is er geen in-memory data meer
  // Alle BAG aantallen komen uit de prefetch indexes
  var result = {total: null};
  if(!feature) return result;
  var p = feature.properties || {};

  if(type === 'gemeenten' && _bagIndex){
    var code = p.gemeentecode || '';
    if(_bagIndex[code] && _bagIndex[code].count !== undefined) result.total = _bagIndex[code].count;
  } else if(type === 'wijken' && _bagWijkIndex){
    var wCode = p.wijkcode || '';
    if(_bagWijkIndex[wCode] && _bagWijkIndex[wCode].count !== undefined) result.total = _bagWijkIndex[wCode].count;
  } else if(type === 'buurten' && _bagBuurtIndex){
    var bCode = p.buurtcode || '';
    if(_bagBuurtIndex[bCode] && _bagBuurtIndex[bCode].count !== undefined) result.total = _bagBuurtIndex[bCode].count;
  }
  return result;
}

// On-demand BAG telling: als prefetch nog niet klaar is, doe een directe WFS hits query
function fetchBagCountOnDemand(feature, type, callback){
  if(!feature || !feature.geometry) return;
  var p = feature.properties || {};

  // Check of we het al hebben in de index
  var existing = getBagStatsForFeature(feature, type);
  if(existing.total !== null){ callback(existing.total); return; }

  // Bereken bbox van de feature
  var coords = [];
  function extractCoords(g){
    if(!g) return;
    if(g.type==='Polygon') g.coordinates.forEach(function(r){r.forEach(function(c){coords.push(c)})});
    else if(g.type==='MultiPolygon') g.coordinates.forEach(function(pg){pg.forEach(function(r){r.forEach(function(c){coords.push(c)})})});
    else if(g.type==='Point') coords.push(g.coordinates);
  }
  extractCoords(feature.geometry);
  if(coords.length === 0) return;

  var mnLng=Infinity,mxLng=-Infinity,mnLat=Infinity,mxLat=-Infinity;
  coords.forEach(function(c){if(c[0]<mnLng)mnLng=c[0];if(c[0]>mxLng)mxLng=c[0];if(c[1]<mnLat)mnLat=c[1];if(c[1]>mxLat)mxLat=c[1]});
  var bbox = mnLat.toFixed(5)+','+mnLng.toFixed(5)+','+mxLat.toFixed(5)+','+mxLng.toFixed(5)+',EPSG:4326';
  var url = PDOK_BAG_WFS+'?service=WFS&version=2.0.0&request=GetFeature&typeName=bag:verblijfsobject&resultType=hits&srsName=EPSG:4326&BBOX='+bbox;

  fetch(url).then(function(r){ return r.text(); }).then(function(xml){
    var m = xml.match(/numberMatched="(\d+)"/);
    var count = m ? parseInt(m[1]) : 0;

    // Sla op in de juiste index zodat het niet opnieuw hoeft
    if(type === 'gemeenten'){
      var code = p.gemeentecode || '';
      if(code){
        if(!_bagIndex) _bagIndex = {};
        _bagIndex[code] = {naam: p.gemeentenaam||'', count: count, source:'ondemand'};
      }
    } else if(type === 'wijken'){
      var wCode = p.wijkcode || '';
      if(wCode) _bagWijkIndex[wCode] = {naam: p.wijknaam||'', count: count, gemeente: p.gemeentenaam||''};
    } else if(type === 'buurten'){
      var bCode = p.buurtcode || '';
      if(bCode) _bagBuurtIndex[bCode] = {naam: p.buurtnaam||'', count: count, gemeente: p.gemeentenaam||''};
    }
    updateBagCacheUI();
    callback(count);
  }).catch(function(){ /* stille fout */ });
}

// Laad BAG vectordata via WFS — alle adressen in viewport
var BAG_PAGE_SIZE = 1000;    // PDOK hard server-limiet
var BAG_CONCURRENCY = 6;     // Max gelijktijdige requests (browser limit per domain)
var BAG_MIN_ZOOM = 11;       // Minimale zoom voor BAG laden
var _bagLastBbox = '';
var _bagLastBounds = null;
var _bagAbort = null;

function loadBagVectors(){
  if(!_map) return;

  var zoom = _map.getZoom();
  var b = _map.getBounds();

  // Toon altijd gecachte data direct
  var cached = getCachedBagFeatures();
  if(cached.length > 0){
    _bagVectorData = cached;
    renderBagVectors();
    updateBagStatusCountsFromData();
  }

  // Zoom-check: bij lage zoom geen WFS laden, alleen cache tonen
  if(zoom < BAG_MIN_ZOOM){
    if(cached.length === 0){
      toast('Zoom in om BAG adressen te laden (zoom ≥ '+BAG_MIN_ZOOM+')','info');
    }
    return;
  }

  // Skip als vorige bbox nog grotendeels geldig is (>70% overlap)
  if(_bagLastBounds && !_bagForceReload){
    var overlap = boundsOverlap(b, _bagLastBounds);
    if(overlap > 0.7) return;
  }
  _bagForceReload = false;

  // Abort lopende load
  if(_bagLoading && _bagAbort){ _bagAbort.abort(); _bagAbort = null; _bagLoading = false; }

  _bagLoading = true;
  _bagAbort = new AbortController();
  var signal = _bagAbort.signal;

  var bbox = b.getSouth().toFixed(5)+','+b.getWest().toFixed(5)+','+b.getNorth().toFixed(5)+','+b.getEast().toFixed(5)+',EPSG:4326';

  // Max features afhankelijk van zoom
  var maxFeatures = zoom >= 15 ? 500000 : (zoom >= 13 ? 100000 : 30000);

  // UI elementen
  var progEl = document.getElementById('bagLoadProgress');
  var progText = document.getElementById('bagLoadText');
  var progPct = document.getElementById('bagLoadPct');
  var progBar = document.getElementById('bagLoadBar');
  var overlay = document.getElementById('bagLoadOverlay');
  var overlayText = document.getElementById('bagOverlayText');
  var overlayPct = document.getElementById('bagOverlayPct');
  var overlayBar = document.getElementById('bagOverlayBar');
  if(progEl) progEl.style.display = 'block';
  if(overlay){ overlay.style.display = 'block'; overlay.style.opacity = '1'; }

  var totalLoaded = 0;
  var allFeatures = [];
  var aborted = false;
  var startTime = Date.now();

  function updateProgress(loaded, total, pagesComplete, totalPages){
    var pct = total > 0 ? Math.min(100, Math.round(loaded/total*100)) : 0;
    var elapsed = (Date.now() - startTime) / 1000;
    var speed = elapsed > 0 ? Math.round(loaded / elapsed) : 0;
    var eta = speed > 0 ? Math.ceil((total - loaded) / speed) : '?';
    var txt = loaded.toLocaleString('nl-NL')+' / '+total.toLocaleString('nl-NL')+' adressen';
    var detail = '';
    if(totalPages > 1) detail = ' · pagina '+pagesComplete+'/'+totalPages;
    if(speed > 0 && pct < 95) detail += ' · ~'+eta+'s';
    if(progText){ progText.textContent = txt + detail; progPct.textContent = pct+'%'; progBar.style.width = pct+'%'; }
    if(overlayText){ overlayText.textContent = txt; overlayPct.textContent = pct+'%' + (detail ? '\n'+detail : ''); overlayBar.style.width = pct+'%'; }
  }

  function renderResults(){
    // Sla op in cache en render direct allFeatures
    saveBagToIDB(allFeatures);
    // Combineer: cache (eerder geladen gebieden) + nieuw geladen
    var combined = getCachedBagFeatures();
    _bagVectorData = combined.length > allFeatures.length ? combined : allFeatures;
    renderBagVectors();
    updateBagStatusCountsFromData();
  }

  function finishLoading(){
    _bagLoading = false;
    _bagLastBbox = bbox;
    _bagLastBounds = b;
    if(progEl) progEl.style.display = 'none';
    if(overlay){ overlay.style.opacity = '0'; setTimeout(function(){ overlay.style.display = 'none'; }, 400); }
    updateBagCacheUI();
    var elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
    toast(allFeatures.length.toLocaleString('nl-NL')+' adressen geladen in '+elapsed+'s · '+_bagMemCount.toLocaleString('nl-NL')+' in cache ✔');
    logEvent('bag_klaar', allFeatures.length + ' in ' + elapsed + 's, cache: ' + _bagMemCount);
  }

  // Fetch één pagina met retry en exponential backoff
  function fetchPage(startIdx, retries){
    if(aborted) return Promise.resolve([]);
    var url = PDOK_BAG_WFS+'?service=WFS&version=2.0.0&request=GetFeature&typeName=bag:verblijfsobject&outputFormat=application/json&count='+BAG_PAGE_SIZE+'&startIndex='+startIdx+'&sortBy=identificatie&srsName=EPSG:4326&BBOX='+bbox;
    return fetch(url,{signal:signal}).then(function(r){
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }).then(function(d){
      return d.features || [];
    }).catch(function(e){
      if(e.name === 'AbortError'){ aborted = true; return []; }
      if(retries > 0){
        var delay = 1000 * Math.pow(2, 2 - retries) + Math.random()*500;
        return new Promise(function(res){ setTimeout(res, delay); }).then(function(){ return fetchPage(startIdx, retries - 1); });
      }
      console.warn('BAG pagina startIndex='+startIdx+' mislukt:', e.message);
      return [];
    });
  }

  // Pool: laad pagina's met beperkte concurrency
  function loadAllPages(totalToLoad){
    var totalPages = Math.ceil(totalToLoad / BAG_PAGE_SIZE);
    var nextPage = 0;
    var pagesComplete = 0;
    var lastRenderAt = 0;
    var renderInterval = Math.max(3000, Math.min(10000, totalToLoad / 5)); // Render elke ~20%

    updateProgress(0, totalToLoad, 0, totalPages);

    return new Promise(function(resolve){
      var runningCount = 0;
      function startNext(){
        if(aborted){ resolve(); return; }
        while(nextPage < totalPages && runningCount < BAG_CONCURRENCY){
          (function(pageIdx){
            var startIdx = pageIdx * BAG_PAGE_SIZE;
            runningCount++;
            fetchPage(startIdx, 3).then(function(features){
              runningCount--;
              if(features.length > 0){
                // Push ipv concat (sneller bij grote arrays)
                for(var i=0;i<features.length;i++) allFeatures.push(features[i]);
                totalLoaded += features.length;
              }
              pagesComplete++;
              updateProgress(totalLoaded, totalToLoad, pagesComplete, totalPages);
              // Tussentijds renderen (niet te vaak — vertraagt browser)
              if(totalLoaded - lastRenderAt >= renderInterval || pagesComplete === totalPages){
                lastRenderAt = totalLoaded;
                renderResults();
              }
              if(pagesComplete >= totalPages){
                resolve();
              } else {
                startNext();
              }
            });
          })(nextPage);
          nextPage++;
        }
      }
      startNext();
    });
  }

  // Start: haal eerst totaal op via hits
  var hitsUrl = PDOK_BAG_WFS+'?service=WFS&version=2.0.0&request=GetFeature&typeName=bag:verblijfsobject&resultType=hits&srsName=EPSG:4326&BBOX='+bbox;
  updateProgress(0, 0, 0, 0);

  fetch(hitsUrl,{signal:signal}).then(function(r){ return r.text(); }).then(function(xml){
    var m = xml.match(/numberMatched="(\d+)"/);
    var totalExpected = m ? parseInt(m[1]) : 0;
    if(totalExpected === 0){
      toast('Geen BAG adressen gevonden in dit gebied');
      finishLoading(); return;
    }

    var loadTotal = Math.min(totalExpected, maxFeatures);
    if(totalExpected > maxFeatures){
      toast(totalExpected.toLocaleString('nl-NL')+' adressen in beeld — zoom in voor alle data, laadt eerste '+loadTotal.toLocaleString('nl-NL'));
    } else {
      toast(totalExpected.toLocaleString('nl-NL')+' adressen gevonden, laden...');
    }

    return loadAllPages(loadTotal).then(function(){
      renderResults();
      finishLoading();
    });

  }).catch(function(e){
    if(e.name === 'AbortError') return;
    console.warn('BAG WFS hits error:',e);
    _bagLoading = false;
    if(progEl) progEl.style.display = 'none';
    if(overlay){ overlay.style.opacity = '0'; setTimeout(function(){ overlay.style.display = 'none'; }, 400); }
    toast('BAG laden mislukt: '+e.message, 'error');
  });
}

// Bereken overlap percentage van twee Leaflet bounds (0-1)
function boundsOverlap(b1, b2){
  var s = Math.max(b1.getSouth(), b2.getSouth());
  var n = Math.min(b1.getNorth(), b2.getNorth());
  var w = Math.max(b1.getWest(), b2.getWest());
  var e = Math.min(b1.getEast(), b2.getEast());
  if(s >= n || w >= e) return 0;
  var overlapArea = (n-s)*(e-w);
  var area1 = (b1.getNorth()-b1.getSouth())*(b1.getEast()-b1.getWest());
  return area1 > 0 ? overlapArea/area1 : 0;
}

function updateBagStatusCountsFromData(){
  var counts = {};
  (_bagVectorData||[]).forEach(function(f){
    var s = f.properties.status || 'Onbekend';
    counts[s] = (counts[s]||0) + 1;
  });
  updateBagStatusCounts(counts);
}

function renderBagVectors(){
  // Als hybride WMS+VT actief is, niet overschrijven met GeoJSON
  if(_bagWmsLayer) return;
  if(_bagVectorLayer){_map.removeLayer(_bagVectorLayer);_bagVectorLayer=null}
  if(!_bagVectorData || !_bagVectorData.length) return;
  // Gemeente-filter: alleen adressen tonen binnen geselecteerde gemeenten
  // BAG data wordt per bbox geladen (rechthoek) maar gemeentegrenzen zijn onregelmatig
  // Filter door punt-in-gemeente-polygoon check te doen
  var gemFilter = getSelectedGemeenteFilter();
  var useGemFilter = gemFilter !== 'all' && _gemeenteLayer;
  var gemBoundsCache = null;
  if(useGemFilter){
    gemBoundsCache = [];
    _gemeenteLayer.eachLayer(function(sub){
      if(!sub.feature) return;
      var naam = sub.feature.properties.gemeentenaam;
      if(gemFilter.has(naam)){
        gemBoundsCache.push({naam:naam, layer:sub, bounds:sub.getBounds()});
      }
    });
  }
  var filtered = _bagVectorData.filter(function(f){
    if(!matchesBagFilter(f.properties.status) || !matchesBagExtendedFilters(f.properties)) return false;
    // Spatial filter: check of punt binnen een geselecteerde gemeente-bbox valt
    if(useGemFilter && gemBoundsCache.length > 0){
      var coords = f.geometry && f.geometry.coordinates;
      if(!coords) return false;
      var pt = L.latLng(coords[1], coords[0]);
      for(var i=0;i<gemBoundsCache.length;i++){
        if(gemBoundsCache[i].bounds.contains(pt)) return true;
      }
      return false;
    }
    return true;
  });
  // Update filter count
  var countEl = document.getElementById('bagFilterCount');
  if(countEl){
    var hasFilter = _bagFilterGebruiksdoel || _bagFilterBouwjaarMin || _bagFilterBouwjaarMax || _bagFilterOppMin || _bagFilterOppMax;
    countEl.textContent = hasFilter ? filtered.length + '/' + _bagVectorData.length + ' adressen na filter' : '';
  }
  var zoom = _map.getZoom();
  // Performance limiet bij lage zoom: sampling
  var maxMarkers = zoom >= 16 ? Infinity : (zoom >= 14 ? 5000 : (zoom >= 12 ? 2000 : 800));
  if(filtered.length > maxMarkers){
    var step = Math.ceil(filtered.length / maxMarkers);
    var sampled = [];
    for(var i = 0; i < filtered.length; i += step) sampled.push(filtered[i]);
    filtered = sampled;
  }
  // Adaptive marker grootte: continu van zoom 9 tot 20
  var radius = Math.max(0.5, Math.min(6, (zoom - 9) * 0.6));
  var weight = zoom >= 17 ? 0.8 : (zoom >= 14 ? 0.3 : 0);
  var fillOp = zoom >= 16 ? 0.85 : (zoom >= 13 ? 0.7 : 0.5);
  _bagVectorLayer = L.geoJSON({type:'FeatureCollection',features:filtered},{
    pointToLayer: function(feature, latlng){
      return L.circleMarker(latlng, {
        radius: radius,
        fillColor: bagStatusToColor(feature.properties.status),
        color: '#fff',
        weight: weight,
        fillOpacity: fillOp
      });
    },
    onEachFeature: function(feature, layer){
      layer.on('click', function(e){
        L.DomEvent.stopPropagation(e);
        _infoPinned = true;
        showBagFeatureInfo(feature.properties, e.latlng);
      });
    }
  }).addTo(_map);
  fixLayerOrder();
}

function showBagFeatureInfo(p, latlng){
  // Zorg dat nationalStats berekend is voor AI interpretatie
  if(!_nationalStats || Object.keys(_nationalStats).length === 0) computeNationalStats();
  // Normaliseer property-namen (WFS: openbare_ruimte, VT: openbare_ruimte_naam)
  var straat = p.openbare_ruimte_naam || p.openbare_ruimte || '';
  var woonplaats = p.woonplaats_naam || p.woonplaats || '';
  var hnr = (p.huisnummer||'') + (p.huisletter||'') + (p.toevoeging?' '+p.toevoeging:'');
  document.getElementById('infoBuurtNaam').innerHTML = '<span class="mi mi-sm">location_on</span> '+((straat+' '+hnr).trim() || 'BAG Object');
  var html = '';
  // Basisgegevens
  if(p.postcode) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">mail</span> Postcode</span><span class="info-val">'+p.postcode+'</span></div>';
  if(woonplaats) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">location_city</span> Woonplaats</span><span class="info-val">'+woonplaats+'</span></div>';
  if(p.gebruiksdoel) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">category</span> Gebruiksdoel</span><span class="info-val">'+p.gebruiksdoel+'</span></div>';
  if(p.oppervlakte) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">straighten</span> Oppervlakte</span><span class="info-val">'+p.oppervlakte+' m²</span></div>';
  if(p.status) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">info</span> Status</span><span class="info-val" style="color:'+bagStatusToColor(p.status)+'">'+p.status+'</span></div>';
  if(p.pandstatus) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px;color:#8B5E3C">apartment</span> Pand</span><span class="info-val" style="font-size:10px">'+p.pandstatus+'</span></div>';
  // Pand uitleg
  html += '<div style="font:400 9px \'Space Mono\',monospace;color:var(--mt);padding:4px 8px;margin:2px 0 6px;background:rgba(139,94,60,.08);border-radius:6px;border-left:2px solid #8B5E3C;line-height:1.5"><span class="mi mi-sm" style="font-size:11px;vertical-align:-2px;color:#8B5E3C">info</span> Panden (bruin op de kaart) kunnen meerdere verblijfsobjecten (adressen) bevatten.</div>';

  // === VERGELIJKING: dit adres vs buurt ===
  html += buildBagCompareHtml(p, latlng);

  // === CBS STATISTIEKEN: alle niveaus (buurt, wijk, gemeente, landelijk) ===
  html += buildMultiLevelStatsHtml(latlng);

  document.getElementById('infoContent').innerHTML = html;
  document.getElementById('infoPanel').classList.add('show');
  logEvent('adres_klik', (straat+' '+hnr).trim() + (p.woonplaats ? ', '+p.woonplaats : ''));
}

// Bereken volledige descriptive statistics van een gesorteerde array
function calcStats(sorted){
  var n = sorted.length;
  if(!n) return null;
  var sum = sorted.reduce(function(a,b){return a+b},0);
  var mean = sum/n;
  var median = n%2===0 ? (sorted[n/2-1]+sorted[n/2])/2 : sorted[Math.floor(n/2)];
  var variance = sorted.reduce(function(a,b){return a+(b-mean)*(b-mean)},0)/n;
  var stddev = Math.sqrt(variance);
  var p10 = sorted[Math.floor(n*0.10)];
  var p25 = sorted[Math.floor(n*0.25)];
  var p75 = sorted[Math.floor(n*0.75)];
  var p90 = sorted[Math.floor(n*0.90)];
  var iqr = p75 - p25;
  var skewSum = stddev > 0 ? sorted.reduce(function(a,b){var d=(b-mean)/stddev;return a+d*d*d},0)/n : 0;
  // Coefficient of variation
  var cv = mean > 0 ? (stddev/mean*100) : 0;
  return {n:n,min:sorted[0],max:sorted[n-1],mean:mean,median:median,stddev:stddev,p10:p10,p25:p25,p75:p75,p90:p90,iqr:iqr,skewness:skewSum,cv:cv};
}

// Bereken percentielrang van een waarde in een gesorteerde array
function percentileRank(sorted, val){
  var count = 0;
  for(var i=0;i<sorted.length;i++){if(sorted[i]<=val)count++;else break}
  return Math.round(count/sorted.length*100);
}

// Controleer of een punt in een polygoon valt (ray-casting)
function pointInPolygon(lat, lng, latlngs){
  var inside = false;
  // latlngs kan genest zijn (multipolygon), pak de buitenste ring
  var ring = latlngs;
  if(ring[0] && ring[0][0] && typeof ring[0][0] !== 'number' && ring[0][0].lat !== undefined) ring = ring[0];
  for(var i=0,j=ring.length-1; i<ring.length; j=i++){
    var yi = ring[i].lat, xi = ring[i].lng;
    var yj = ring[j].lat, xj = ring[j].lng;
    if(((yi>lat)!==(yj>lat))&&(lng<(xj-xi)*(lat-yi)/(yj-yi)+xi)) inside=!inside;
  }
  return inside;
}

// Filter BAG features die in een buurt-polygoon vallen
// Gebruikt zowel viewport data als de volledige in-memory cache
function getBagFeaturesInBuurt(buurtLayer){
  if(!buurtLayer) return [];
  var latlngs;
  try{ latlngs = buurtLayer.getLatLngs ? buurtLayer.getLatLngs() : null; }catch(e){ return []; }
  if(!latlngs) return [];
  var bounds;
  try{ bounds = buurtLayer.getBounds(); }catch(e){ return []; }
  var s = bounds.getSouth(), n = bounds.getNorth(), w = bounds.getWest(), e = bounds.getEast();
  var result = [];
  var seen = {};
  // Bron 1: volledige in-memory cache (alle ooit geladen adressen)
  for(var id in _bagMem){
    var f = _bagMem[id];
    var c = f.geometry.coordinates;
    if(c[1] >= s && c[1] <= n && c[0] >= w && c[0] <= e){
      if(pointInPolygon(c[1], c[0], latlngs)){ result.push(f); seen[id] = true; }
    }
  }
  // Bron 2: viewport data (bevat mogelijk nog niet gecachte features)
  if(_bagVectorData && _bagVectorData.length){
    _bagVectorData.forEach(function(f){
      var fid = f.properties.identificatie || f.properties.id;
      if(fid && seen[fid]) return;
      var c = f.geometry.coordinates;
      if(c[1] >= s && c[1] <= n && c[0] >= w && c[0] <= e){
        if(pointInPolygon(c[1], c[0], latlngs)) result.push(f);
      }
    });
  }
  return result;
}

// Vergelijk BAG adres met statistieken — eerst buurt, dan alle geladen
function buildBagCompareHtml(p, latlng){
  var html = '';
  var hasBagData = _layerState.bag; // Vector tiles actief

  // Zoek de buurt waar dit adres in ligt — zoek in buurtlaag OF in buurtdata
  var buurtFeature = null;
  var buurtLayerObj = null;
  var buurtNaam = null;
  var buurtFeatures = null;

  // Methode 1: via actieve buurtlaag
  if(_buurtLayer){
    buurtFeature = findFeatureAtPoint(_buurtLayer, latlng);
    if(buurtFeature){
      _buurtLayer.eachLayer(function(sub){
        if(sub.feature === buurtFeature) buurtLayerObj = sub;
      });
    }
  }
  // Methode 2: als buurtlaag niet actief maar buurtdata wel geladen, zoek in data
  if(!buurtFeature && _buurtData){
    buurtFeature = findFeatureInData(_buurtData, latlng);
    if(buurtFeature){
      try { var tempL = L.geoJSON(buurtFeature); tempL.eachLayer(function(s){ buurtLayerObj = s; }); } catch(e){}
    }
  }

  if(buurtFeature){
    buurtNaam = buurtFeature.properties.buurtnaam || buurtFeature.properties.buurtcode || 'buurt';
    // BAG aantallen uit prefetch index
    if(buurtFeature.properties.buurtcode && _bagBuurtIndex && _bagBuurtIndex[buurtFeature.properties.buurtcode]){
      buurtFeatures = {length: _bagBuurtIndex[buurtFeature.properties.buurtcode].count};
    }
  }

  // === Buurt kerncijfers (CBS + BAG gecombineerd) — toon altijd als buurt gevonden ===
  if(buurtFeature && buurtFeature.properties){
    var bp = buurtFeature.properties;
    html += '<div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--glass-bd)">';
    html += '<div style="font:700 12px \'Space Mono\',monospace;color:var(--ac);margin-bottom:8px;display:flex;align-items:center;gap:5px"><span class="mi" style="font-size:16px">grid_on</span> Buurt: '+(buurtNaam||'onbekend')+'</div>';
    var buurtRows = [];
    // BAG verblijfsobjecten in deze buurt (uit cache + viewport)
    if(buurtFeatures && buurtFeatures.length > 0){
      buurtRows.push({icon:'location_on', label:'BAG verblijfsobjecten', val:buurtFeatures.length.toLocaleString('nl-NL'), color:'var(--ai)'});
    }
    // CBS woningvoorraad
    if(bp.woningvoorraad && bp.woningvoorraad > 0) buurtRows.push({icon:'location_city', label:'Woningvoorraad (CBS)', val:bp.woningvoorraad.toLocaleString('nl-NL'), color:'var(--tx)'});
    // Koop en huur
    var koop = bp.koopwoningen, huur = bp.huurwoningen;
    var voorraad = bp.woningvoorraad || 0;
    if(koop !== undefined && koop !== null && voorraad > 0){
      var koopAantal = Math.round(voorraad * koop / 100);
      buurtRows.push({icon:'key', label:'Koopwoningen', val:koopAantal.toLocaleString('nl-NL')+' ('+koop+'%)', color:'var(--ac)'});
    }
    if(huur !== undefined && huur !== null && voorraad > 0){
      var huurAantal = Math.round(voorraad * huur / 100);
      buurtRows.push({icon:'real_estate_agent', label:'Huurwoningen', val:huurAantal.toLocaleString('nl-NL')+' ('+huur+'%)', color:'var(--wn)'});
    }
    if(koop !== undefined && huur !== undefined && voorraad > 0){
      buurtRows.push({icon:'home', label:'Koop + huur totaal', val:voorraad.toLocaleString('nl-NL'), color:'var(--cyan)'});
    }
    // Huishoudens
    if(bp.huishoudens && bp.huishoudens > 0) buurtRows.push({icon:'family_restroom', label:'Huishoudens', val:bp.huishoudens.toLocaleString('nl-NL'), color:'var(--tx)'});
    // Inwoners
    if(bp.aantal_inwoners && bp.aantal_inwoners > 0) buurtRows.push({icon:'groups', label:'Inwoners', val:bp.aantal_inwoners.toLocaleString('nl-NL'), color:'var(--tx)'});

    if(buurtRows.length > 0){
      html += '<div style="margin-bottom:10px;padding:8px 10px;background:rgba(57,255,20,.03);border-radius:8px">';
      buurtRows.forEach(function(r){
        html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.04)">';
        html += '<span style="font-size:11px;color:var(--mt);display:flex;align-items:center;gap:5px"><span class="mi mi-sm" style="font-size:13px;color:'+r.color+'">'+r.icon+'</span>'+r.label+'</span>';
        html += '<span style="font:700 11px Space Mono,monospace;color:'+r.color+'">'+r.val+'</span>';
        html += '</div>';
      });
      html += '</div>';
    }
    html += '</div>';
  }

  // === BAG statistieken: niet beschikbaar bij vector tiles (geen bulk data in geheugen) ===
  // Bouwjaar/oppervlakte vergelijking is alleen mogelijk met in-memory features
  // Met vector tiles tonen we alleen de CBS kerncijfers en BAG counts
  return html;
  /* Uitgeschakeld — vector tiles benadering heeft geen feature data in geheugen
  if(!hasBagData) return html;

  var compareFeatures = [];
  if(!compareFeatures || !compareFeatures.length) return html;

  var compareLabel = (buurtFeatures && buurtFeatures.length > 5)
    ? buurtNaam+' ('+buurtFeatures.length+' adressen)'
    : (buurtNaam ? buurtNaam+' (te weinig BAG — '+compareFeatures.length+' geladen gebruikt)' : 'Zichtbare adressen ('+compareFeatures.length+')');

  html += '<div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--glass-bd)">';
  html += '<div style="font:700 12px \'Space Mono\',monospace;color:var(--ai);margin-bottom:8px;display:flex;align-items:center;gap:5px"><span class="mi" style="font-size:16px">analytics</span> Vergelijking: '+compareLabel+'</div>';

  var bouwjaren = [], oppervlaktes = [];
  compareFeatures.forEach(function(f){
    var fp = f.properties;
    if(fp.bouwjaar && fp.bouwjaar > 1000) bouwjaren.push(fp.bouwjaar);
    if(fp.oppervlakte && fp.oppervlakte > 0) oppervlaktes.push(fp.oppervlakte);
  });

  if(p.bouwjaar && bouwjaren.length > 5){
    bouwjaren.sort(function(a,b){return a-b});
    var st = calcStats(bouwjaren);
    var z = st.stddev > 0 ? (p.bouwjaar - st.mean)/st.stddev : 0;
    var pRank = percentileRank(bouwjaren, p.bouwjaar);
    html += buildFullStatCard('event','Bouwjaar',p.bouwjaar,'',st,z,pRank,'bouwjaar');
  }

  if(p.oppervlakte && oppervlaktes.length > 5){
    oppervlaktes.sort(function(a,b){return a-b});
    var st = calcStats(oppervlaktes);
    var z = st.stddev > 0 ? (p.oppervlakte - st.mean)/st.stddev : 0;
    var pRank = percentileRank(oppervlaktes, p.oppervlakte);
    html += buildFullStatCard('square_foot','Oppervlakte',p.oppervlakte,'m\u00b2',st,z,pRank,'oppervlakte');
  }

  if(bouwjaren.length <= 5 && oppervlaktes.length <= 5){
    html += '<div style="font-size:11px;color:var(--mt);padding:6px 0">Te weinig adressen ('+compareFeatures.length+') in deze buurt voor statistieken. Zoom in en laad meer adressen.</div>';
  }

  html += '</div>';
  return html;
  // Einde uitgeschakelde code */
}

// Uitgebreide statistiekkaart
function buildFullStatCard(icon,label,val,unit,st,z,pRank,type){
  var h = '<div style="margin-bottom:14px;padding:12px;background:rgba(15,20,35,.5);border-radius:10px;border-left:3px solid '+getBarColor(z)+'">';
  // Header: naam + waarde
  h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
  h += '<span style="font:600 13px \'DM Sans\',sans-serif;color:var(--tx);display:flex;align-items:center;gap:5px"><span class="mi" style="font-size:16px;color:var(--ai)">'+icon+'</span>'+label+'</span>';
  h += '<span style="font:700 17px \'Space Mono\',monospace;color:var(--ac)">'+val+' <span style="font-size:11px;color:var(--mt)">'+unit+'</span></span>';
  h += '</div>';

  // Normaalverdeling SVG
  var distType = Math.abs(st.skewness)<0.5?'normaal':(st.skewness>0?'rechts scheef':'links scheef');
  h += buildDistSvg(z, distType);

  // Percentiel + z-score badges
  h += '<div style="display:flex;gap:8px;margin:6px 0;align-items:center">';
  h += '<div style="padding:4px 10px;border-radius:6px;background:rgba(57,255,20,.08);font:700 12px Space Mono,monospace;color:var(--ac)">P'+pRank+'</div>';
  h += '<div style="font-size:11px;color:var(--mt);line-height:1.4">';
  if(type==='bouwjaar'){
    h += pRank>=50 ? 'Nieuwer dan '+pRank+'% van de panden' : 'Ouder dan '+(100-pRank)+'% van de panden';
  } else {
    h += pRank>=50 ? 'Groter dan '+pRank+'% van de adressen' : 'Kleiner dan '+(100-pRank)+'% van de adressen';
  }
  h += '</div></div>';

  // Statistieken tabel
  h += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:5px;margin:8px 0;font-size:10px">';
  var cells = [
    {l:'Gemiddeld',v:Math.round(st.mean),c:'var(--ai)'},
    {l:'Mediaan',v:Math.round(st.median),c:'var(--ai)'},
    {l:'Std.dev (\u03c3)',v:st.stddev<10?st.stddev.toFixed(1):Math.round(st.stddev),c:'var(--wn)'},
    {l:'z-score',v:z.toFixed(2),c:getBarColor(z)},
    {l:'P10',v:Math.round(st.p10),c:'var(--mt)'},
    {l:'P25 (Q1)',v:Math.round(st.p25),c:'var(--mt)'},
    {l:'P75 (Q3)',v:Math.round(st.p75),c:'var(--mt)'},
    {l:'P90',v:Math.round(st.p90),c:'var(--mt)'},
    {l:'Min',v:st.min,c:'var(--mt)'},
    {l:'Max',v:st.max,c:'var(--mt)'},
    {l:'IQR',v:Math.round(st.iqr),c:'var(--mt)'},
    {l:'CV',v:st.cv.toFixed(0)+'%',c:'var(--mt)'}
  ];
  cells.forEach(function(c){
    h += '<div style="text-align:center;padding:4px 3px;background:rgba(255,255,255,.03);border-radius:5px">';
    h += '<div style="color:var(--mt);font-size:9px;white-space:nowrap">'+c.l+'</div>';
    h += '<div style="font:700 11px Space Mono,monospace;color:'+c.c+'">'+c.v+'</div></div>';
  });
  h += '</div>';

  // Interpretatie blok
  h += '<div style="padding:8px 10px;background:rgba(56,189,248,.04);border-radius:8px;border-left:2px solid var(--ai);margin-top:6px">';
  h += '<div style="font:600 11px \'DM Sans\',sans-serif;color:var(--ai);margin-bottom:4px;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="font-size:15px">school</span> Wat betekent dit?</div>';
  h += '<div style="font-size:11px;color:var(--mt);line-height:1.7">';

  // Z-score uitleg
  h += '<b style="color:var(--tx)">z-score = '+z.toFixed(2)+'</b>: ';
  if(Math.abs(z)<0.5) h += 'Deze waarde is <b style="color:var(--ai)">heel gemiddeld</b>. ';
  else if(Math.abs(z)<1) h += 'Licht '+(z>0?'boven':'onder')+' gemiddeld, maar <b style="color:var(--ai)">binnen normaal bereik</b> (68% van alle waarden). ';
  else if(Math.abs(z)<2) h += '<b style="color:var(--wn)">'+(z>0?'Boven':'Onder')+'gemiddeld</b>. Valt buiten het bereik waar 68% van de waarden ligt. ';
  else h += '<b style="color:var(--dn)">Uitzonderlijk '+(z>0?'hoog':'laag')+'</b>. Valt buiten 95% van alle waarden. ';

  // Standaarddeviatie uitleg
  h += '<br>\u03c3 = '+Math.round(st.stddev)+': ';
  if(st.cv < 15) h += 'Lage spreiding \u2014 de '+label.toLowerCase()+'s in deze buurt zijn <b style="color:var(--ai)">heel uniform</b>. ';
  else if(st.cv < 30) h += 'Gemiddelde spreiding \u2014 er is een <b style="color:var(--ai)">normale variatie</b> in '+label.toLowerCase()+'s. ';
  else h += 'Hoge spreiding \u2014 er is <b style="color:var(--wn)">veel variatie</b> in '+label.toLowerCase()+'s (CV='+st.cv.toFixed(0)+'%). ';

  // Verdeling
  h += '<br>Verdeling: <b style="color:var(--tx)">'+distType+'</b>';
  if(distType==='rechts scheef') h += ' \u2014 er zijn enkele uitschieters naar boven.';
  else if(distType==='links scheef') h += ' \u2014 er zijn enkele uitschieters naar beneden.';
  else h += ' \u2014 de waarden zijn symmetrisch verdeeld rond het gemiddelde.';

  // Context-specifieke uitleg
  if(type==='bouwjaar'){
    h += '<br><b style="color:var(--tx)">IQR = '+Math.round(st.iqr)+' jaar</b>: de middelste 50% van de panden is gebouwd tussen '+Math.round(st.p25)+' en '+Math.round(st.p75)+'.';
  } else {
    h += '<br><b style="color:var(--tx)">IQR = '+Math.round(st.iqr)+' m\u00b2</b>: de middelste 50% van de adressen heeft '+Math.round(st.p25)+'\u2013'+Math.round(st.p75)+' m\u00b2.';
  }

  h += '</div></div>';
  h += '</div>';
  return h;
}

function updateBagStatusCounts(counts){
  document.querySelectorAll('[data-bagstatus]').forEach(function(btn){
    var id = btn.dataset.bagstatus;
    var s = BAG_STATUSES.filter(function(b){return b.id===id})[0];
    var n = 0;
    if(id === 'all'){
      for(var k in counts) n += counts[k];
    } else if(s && s.match){
      s.match.forEach(function(m){n += counts[m]||0});
    }
    // Voeg count badge toe
    var badge = btn.querySelector('.bag-count');
    if(!badge){badge = document.createElement('span');badge.className='bag-count';badge.style.cssText='font:700 9px Space Mono,monospace;opacity:.6;margin-left:3px';btn.appendChild(badge);}
    badge.textContent = n > 0 ? '('+n+')' : '';
  });
}

function dimChoroplethLayers(dim){
  // Bij BAG actief: choropleth subtiel dimmen maar duidelijk zichtbaar houden
  // Hogere waarden dan voorheen zodat buurten/wijken ook op satellite goed zichtbaar zijn
  var opacity = dim ? 0.5 : 0.65;
  var borderOp = dim ? 0.6 : 0.5;
  var borderWeight = dim ? 2.0 : 1.0;
  [_gemeenteLayer, _wijkLayer, _buurtLayer].forEach(function(layer){
    if(!layer) return;
    layer.eachLayer(function(sub){
      try{
        sub.setStyle({fillOpacity:opacity, opacity:borderOp, weight:borderWeight});
      }catch(e){}
    });
  });
}

function toggleBagLayer(on){
  if(!_map) return;
  var statusSection = document.getElementById('bagStatusSection');
  var statusBtns = document.getElementById('bagStatusBtns');
  if(on){
    if(_bagWmsLayer) return;
    // === HYBRIDE: WMS (alle zoom levels) + Vector Tiles (zoom 17+, klikbaar) ===
    // WMS: server-gerenderde rasterafbeeldingen — werkt op elk zoom level
    // Vector Tiles: alleen zoom 17 beschikbaar bij PDOK, voor klikbare punten
    createBagWmsLayer();
    createBagVectorTileLayer();
    _map.on('zoomend', onBagZoomChange);
    onBagZoomChange(); // Initiele opacity
    statusSection.style.display = '';
    statusBtns.style.display = 'flex';
    document.getElementById('bagFiltersSection').style.display = 'block';
    document.getElementById('bagCacheInfo').style.display = 'flex';
    updateBagCacheUI();
    dimChoroplethLayers(true);
    // Panden automatisch als context
    if(!_layerState.panden){
      _layerState.panden = true;
      togglePandLayer(true);
    }
    // Buurtdata op achtergrond laden (nodig voor kerncijfers bij adres-klik)
    if(!_buurtData){
      fetch(BUURTEN_URL).then(function(r){return r.json()}).then(function(d){
        _buurtData = d;
        document.getElementById('dsBuurten').textContent = d.features.length.toLocaleString('nl-NL') + ' features';
        console.log('Buurtdata geladen op achtergrond:', d.features.length, 'buurten');
      }).catch(function(e){ console.warn('Buurtdata achtergrond laden mislukt:', e); });
    }
    logEvent('bag_toggle', 'aan (WMS + VT)');
  } else {
    _map.off('zoomend', onBagZoomChange);
    if(_bagVectorLayer){_map.removeLayer(_bagVectorLayer);_bagVectorLayer=null}
    if(_bagWmsLayer){_map.removeLayer(_bagWmsLayer);_bagWmsLayer=null}
    statusSection.style.display = 'none';
    statusBtns.style.display = 'none';
    document.getElementById('bagFiltersSection').style.display = 'none';
    document.getElementById('bagCacheInfo').style.display = 'none';
    document.getElementById('bagZoomHint').style.display = 'none';
    document.getElementById('bagBgProgress').style.display = 'none';
    // Panden ook uit zetten
    if(_layerState.panden){
      _layerState.panden = false;
      togglePandLayer(false);
    }
    dimChoroplethLayers(false);
    logEvent('bag_toggle', 'uit');
  }
}

// WMS/VT opacity afhankelijk van zoom + zoom-hint updaten
function onBagZoomChange(){
  if(!_map) return;
  var z = _map.getZoom();
  // WMS: altijd zichtbaar, faden naar onzichtbaar bij hoge zoom waar VT overneemt
  if(_bagWmsLayer){
    _bagWmsLayer.setOpacity(z >= 17 ? 0.12 : (z >= 16 ? 0.35 : (z >= 14 ? 0.55 : 0.4)));
  }
  // Panden WMS ook bijwerken
  updatePandWmsOpacity();
  // Zoom-hint: toon waarschuwing als zoom te laag is voor klikbare adressen
  var hintEl = document.getElementById('bagZoomHint');
  if(hintEl){
    if(z < 13){
      hintEl.style.display = 'flex';
      document.getElementById('bagZoomHintText').innerHTML = '<b>Zoom in om BAG adressen te zien</b> (nu zoom '+z+', zichtbaar vanaf 13, klikbaar vanaf 16)';
    } else if(z < 16){
      hintEl.style.display = 'flex';
      document.getElementById('bagZoomHintText').innerHTML = 'Adressen zichtbaar (WMS) · <b>Zoom in voor klikbare punten</b> (nu zoom '+z+', klikbaar vanaf 16)';
    } else {
      hintEl.style.display = 'none';
    }
  }
}

// === BAG VECTOR TILE LAYER ===
function createBagVectorTileLayer(){
  if(_bagVectorLayer){ _map.removeLayer(_bagVectorLayer); _bagVectorLayer = null; }

  _bagVectorLayer = L.vectorGrid.protobuf(PDOK_BAG_MVT, {
    rendererFactory: L.canvas.tile,
    maxNativeZoom: 17,
    minNativeZoom: 17,
    minZoom: 16,
    maxZoom: 22,
    interactive: true,
    getFeatureId: function(f){ return f.properties.identificatie; },
    vectorTileLayerStyles: {
      verblijfsobject: function(properties, zoom){
        // Filters toepassen
        if(!matchesBagVtFilter(properties)) return {radius:0, fillOpacity:0, opacity:0, fill:false, stroke:false};
        var radius = zoom >= 18 ? 5 : (zoom >= 17 ? 3.5 : 2);
        return {
          radius: radius,
          fillColor: bagStatusToColor(properties.status),
          color: '#fff',
          weight: zoom >= 17 ? 0.5 : 0,
          fillOpacity: zoom >= 17 ? 0.85 : 0.6,
          fill: true
        };
      },
      pand: function(properties, zoom){
        return {
          fill: true,
          fillColor: '#8B5E3C',
          fillOpacity: zoom >= 17 ? 0.25 : 0.15,
          color: '#654321',
          weight: zoom >= 17 ? 0.8 : 0.4
        };
      },
      // Andere layers in de tile verbergen
      adres: {fill:false, stroke:false, radius:0, fillOpacity:0, opacity:0},
      ligplaats: function(p,z){
        if(z<15) return {fill:false,stroke:false};
        return {fill:true,fillColor:'#06b6d4',fillOpacity:0.4,color:'#0891b2',weight:1};
      },
      standplaats: function(p,z){
        if(z<15) return {fill:false,stroke:false};
        return {fill:true,fillColor:'#a855f7',fillOpacity:0.4,color:'#7c3aed',weight:1};
      },
      woonplaats: {fill:false, stroke:false}
    }
  }).addTo(_map);

  // Klik-handler voor feature info
  _bagVectorLayer.on('click', function(e){
    if(!e.layer || !e.layer.properties) return;
    var p = e.layer.properties;
    var layerName = e.layer._layerName || e.layerName || '';
    // Latlng bepalen: VectorGrid geeft soms geen latlng mee bij punt-features
    var latlng = e.latlng;
    if(!latlng && e.originalEvent && _map){
      latlng = _map.mouseEventToLatLng(e.originalEvent);
    }
    if(!latlng) latlng = _map.getCenter(); // fallback
    L.DomEvent.stopPropagation(e);
    _infoPinned = true;
    if(layerName === 'pand'){
      showPandFeatureInfo(p, latlng);
    } else {
      showBagFeatureInfo(p, latlng);
    }
  });

  fixLayerOrder();
  toast('BAG Vector Tiles geladen · Zoom in voor meer detail');
}

// Filter check voor vector tile features (verblijfsobjecten)
function matchesBagVtFilter(p){
  // Status filter
  if(!matchesBagFilter(p.status)) return false;
  // Gebruiksdoel filter
  if(_bagFilterGebruiksdoel){
    var doel = (p.gebruiksdoel || '').toLowerCase();
    if(doel.indexOf(_bagFilterGebruiksdoel) < 0) return false;
  }
  // Oppervlakte filter (beschikbaar in verblijfsobject tiles)
  if(_bagFilterOppMin && p.oppervlakte && p.oppervlakte < _bagFilterOppMin) return false;
  if(_bagFilterOppMax && p.oppervlakte && p.oppervlakte > _bagFilterOppMax) return false;
  if((_bagFilterOppMin || _bagFilterOppMax) && !p.oppervlakte) return false;
  // Bouwjaar niet beschikbaar in verblijfsobject tile — skip bouwjaar filter bij VT
  return true;
}

// Pand info popup (klik op pand in vector tile)
function showPandFeatureInfo(p, latlng){
  document.getElementById('infoBuurtNaam').innerHTML = '<span class="mi mi-sm">apartment</span> Pand ' + (p.identificatie || '');
  var html = '';
  if(p.bouwjaar) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">calendar_month</span> Bouwjaar</span><span class="info-val" style="color:var(--ai)">'+p.bouwjaar+'</span></div>';
  if(p.status) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">info</span> Status</span><span class="info-val">'+p.status+'</span></div>';
  if(p.gebruiksdoel) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">category</span> Gebruiksdoel</span><span class="info-val">'+p.gebruiksdoel+'</span></div>';
  if(p.aantal_verblijfsobjecten) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">home</span> Verblijfsobjecten</span><span class="info-val">'+p.aantal_verblijfsobjecten+'</span></div>';
  document.getElementById('infoContent').innerHTML = html;
  document.getElementById('infoPanel').classList.add('show');
}

// Herrender vector tiles met bijgewerkte filters
function redrawBagVectorTiles(){
  if(_bagVectorLayer) _bagVectorLayer.redraw();
}

// ============================================================
// BAG PRE-BUILT LADEN (per gemeente GeoJSON)
// ============================================================

// Laad bag_index.json (bevat beschikbare gemeenten + aantal adressen)
function loadBagIndex(){
  if(_bagIndex) return Promise.resolve(_bagIndex);
  return fetch('bag/bag_index.json'+_cacheBust).then(function(r){
    if(!r.ok) return {};
    return r.json();
  }).then(function(d){
    _bagIndex = d || {};
    console.log('BAG index geladen:', Object.keys(_bagIndex).length, 'gemeenten');
    // Start prefetch als niet alle gemeenten in index zitten
    if(_gemeenteData){
      var missing = _gemeenteData.features.filter(function(f){
        var code = f.properties.gemeentecode || '';
        return code && !_bagIndex[code];
      });
      if(missing.length > 0){
        console.log('BAG index mist', missing.length, 'gemeenten — start live prefetch');
        prefetchBagCounts();
      }
    }
    return _bagIndex;
  }).catch(function(){ _bagIndex = {}; return _bagIndex; });
}

// Prefetch: haal BAG aantallen per gemeente op via woonplaatsen
// Stap 1: Haal alle woonplaatsen op (met bronhouder = gemeente)
// Stap 2: Tel verblijfsobjecten per woonplaats via WFS OGC Filter
// Stap 3: Sommeer per gemeente
var _bagPrefetching = false;
var _woonplaatsGemeenteMap = {}; // {woonplaatsNaam: gemeentecode}

function prefetchBagCounts(){
  if(_bagPrefetching || !_gemeenteData) return;
  _bagPrefetching = true;
  if(!_bagIndex) _bagIndex = {};

  // Stap 1: Haal alle woonplaatsen op van PDOK
  console.log('BAG prefetch: woonplaatsen ophalen...');
  fetchAllWoonplaatsen().then(function(wpList){
    console.log('BAG prefetch: '+wpList.length+' woonplaatsen gevonden, start tellen...');
    // Stap 2: Tel per woonplaats
    var gemTotals = {}; // {gemeentecode: {naam, count}}
    var total = wpList.length;
    var done = 0;
    var queue = wpList.slice();
    var concurrency = 6;
    var running = 0;

    function processNext(){
      while(queue.length > 0 && running < concurrency){
        var wp = queue.shift();
        running++;
        (function(woonplaats){
          var wpNaam = woonplaats.naam;
          var gemCode = woonplaats.gemeentecode;
          var gemNaam = woonplaats.gemeentenaam;

          // WFS OGC Filter: tel verblijfsobjecten in deze woonplaats
          var filter = '<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc"><ogc:PropertyIsEqualTo><ogc:PropertyName>woonplaats</ogc:PropertyName><ogc:Literal>'+escapeXml(wpNaam)+'</ogc:Literal></ogc:PropertyIsEqualTo></ogc:Filter>';
          var url = PDOK_BAG_WFS+'?service=WFS&version=2.0.0&request=GetFeature&typeName=bag:verblijfsobject&resultType=hits&Filter='+encodeURIComponent(filter);

          fetch(url).then(function(r){ return r.text(); }).then(function(xml){
            var m = xml.match(/numberMatched="(\d+)"/);
            var count = m ? parseInt(m[1]) : 0;
            if(!gemTotals[gemCode]) gemTotals[gemCode] = {naam:gemNaam, count:0};
            gemTotals[gemCode].count += count;
          }).catch(function(){}).finally(function(){
            running--;
            done++;
            if(done % 50 === 0 || done === total){
              // Tussentijds updaten
              for(var gc in gemTotals){
                _bagIndex[gc] = {naam:gemTotals[gc].naam, count:gemTotals[gc].count, source:'woonplaats'};
              }
              updateBagCacheUI();
              console.log('BAG prefetch: '+done+'/'+total+' woonplaatsen ('+Object.keys(gemTotals).length+' gemeenten)');
            }
            processNext();
          });
        })(wp);
      }

      if(queue.length === 0 && running === 0){
        // Klaar — definitief updaten
        for(var gc in gemTotals){
          _bagIndex[gc] = {naam:gemTotals[gc].naam, count:gemTotals[gc].count, source:'woonplaats'};
        }
        _bagPrefetching = false;
        updateBagCacheUI();
        buildGemeenteFilter();
        console.log('BAG prefetch klaar:', Object.keys(_bagIndex).length, 'gemeenten,', total, 'woonplaatsen');
        setTimeout(function(){ prefetchBagSubareaCounts(); }, 500);
      }
    }
    processNext();
  }).catch(function(e){
    console.warn('BAG prefetch fout:', e);
    _bagPrefetching = false;
    // Fallback: oude BBOX methode
    prefetchBagCountsBbox();
  });
}

// Haal alle woonplaatsen op via PDOK OGC API (paginated)
function fetchAllWoonplaatsen(){
  var allItems = [];
  var baseUrl = 'https://api.pdok.nl/kadaster/bag/ogc/v2/collections/woonplaats/items?f=json&limit=200&status=Woonplaats%20aangewezen';

  function fetchPage(url){
    return fetch(url).then(function(r){ return r.json(); }).then(function(d){
      var features = d.features || [];
      features.forEach(function(f){
        var p = f.properties || {};
        if(p.woonplaats && p.bronhouder_identificatie){
          var gemCode = 'GM' + ('0000'+p.bronhouder_identificatie).slice(-4);
          var gemNaam = p.bronhouder_naam || '';
          allItems.push({naam: p.woonplaats, gemeentecode: gemCode, gemeentenaam: gemNaam});
          _woonplaatsGemeenteMap[p.woonplaats] = gemCode;
        }
      });
      // Volgende pagina
      var nextLink = (d.links || []).filter(function(l){ return l.rel === 'next'; })[0];
      if(nextLink && nextLink.href && features.length > 0){
        return fetchPage(nextLink.href);
      }
      return allItems;
    });
  }
  return fetchPage(baseUrl);
}

// XML-escape helper
function escapeXml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');
}

// Fallback: oude BBOX methode (minder nauwkeurig maar werkt altijd)
function prefetchBagCountsBbox(){
  if(!_gemeenteData) return;
  if(!_bagIndex) _bagIndex = {};
  var features = _gemeenteData.features.filter(function(f){
    var code = f.properties.gemeentecode || '';
    return code && f.geometry && !_bagIndex[code];
  });
  if(features.length === 0) return;
  var total = features.length, done = 0, queue = features.slice(), running = 0;
  function processNext(){
    while(queue.length > 0 && running < 4){
      var f = queue.shift(); running++;
      (function(feat){
        var code = feat.properties.gemeentecode || '';
        var naam = feat.properties.gemeentenaam || '';
        var coords = [];
        function ex(g){ if(!g) return; if(g.type==='Polygon') g.coordinates.forEach(function(r){r.forEach(function(c){coords.push(c)})}); else if(g.type==='MultiPolygon') g.coordinates.forEach(function(p){p.forEach(function(r){r.forEach(function(c){coords.push(c)})})}); }
        ex(feat.geometry);
        if(!coords.length){ running--; done++; processNext(); return; }
        var mnLng=Infinity,mxLng=-Infinity,mnLat=Infinity,mxLat=-Infinity;
        coords.forEach(function(c){if(c[0]<mnLng)mnLng=c[0];if(c[0]>mxLng)mxLng=c[0];if(c[1]<mnLat)mnLat=c[1];if(c[1]>mxLat)mxLat=c[1]});
        var bbox = mnLat.toFixed(5)+','+mnLng.toFixed(5)+','+mxLat.toFixed(5)+','+mxLng.toFixed(5)+',EPSG:4326';
        fetch(PDOK_BAG_WFS+'?service=WFS&version=2.0.0&request=GetFeature&typeName=bag:verblijfsobject&resultType=hits&srsName=EPSG:4326&BBOX='+bbox)
          .then(function(r){ return r.text(); }).then(function(xml){
            var m = xml.match(/numberMatched="(\d+)"/);
            var count = m ? parseInt(m[1]) : 0;
            if(count > 0) _bagIndex[code] = {naam:naam, count:count, source:'bbox'};
          }).catch(function(){}).finally(function(){
            running--; done++;
            if(done % 20 === 0){ updateBagCacheUI(); }
            processNext();
          });
      })(f);
    }
    if(queue.length === 0 && running === 0){
      updateBagCacheUI(); buildGemeenteFilter();
      console.log('BAG prefetch (bbox fallback) klaar:', Object.keys(_bagIndex).length, 'gemeenten');
      setTimeout(function(){ prefetchBagSubareaCounts(); }, 500);
    }
  }
  processNext();
}

// BAG prefetch voor buurten en wijken — lichtgewicht hits queries
var _bagWijkIndex = {};   // {wijkcode: {naam, count, gemeente}}
var _bagBuurtIndex = {};  // {buurtcode: {naam, count, gemeente}}
var _bagSubPrefetching = false;

function prefetchBagSubareaCounts(){
  if(_bagSubPrefetching) return;
  // Alleen als er wijk- of buurtdata geladen is
  if(!_wijkData && !_buurtData) return;
  _bagSubPrefetching = true;

  var items = [];

  // Wijken
  if(_wijkData){
    _wijkData.features.forEach(function(f){
      var p = f.properties;
      var code = p.wijkcode || '';
      var naam = p.wijknaam || '';
      if(!code || !naam || !f.geometry) return;
      if(_bagWijkIndex[code]) return; // Al opgehaald
      items.push({code:code, naam:naam, type:'wijk', gemeente:p.gemeentenaam||'', geom:f.geometry});
    });
  }

  // Buurten
  if(_buurtData){
    _buurtData.features.forEach(function(f){
      var p = f.properties;
      var code = p.buurtcode || '';
      var naam = p.buurtnaam || '';
      if(!code || !naam || !f.geometry) return;
      if(_bagBuurtIndex[code]) return;
      items.push({code:code, naam:naam, type:'buurt', gemeente:p.gemeentenaam||'', geom:f.geometry});
    });
  }

  if(items.length === 0){ _bagSubPrefetching = false; return; }

  console.log('BAG subarea prefetch: '+items.length+' wijken/buurten');
  var total = items.length;
  var done = 0;
  var queue = items.slice();
  var concurrency = 6;
  var running = 0;

  function processNext(){
    while(queue.length > 0 && running < concurrency){
      var item = queue.shift();
      running++;
      (function(it){
        // Bereken bbox
        var coords = [];
        function ex(g){
          if(!g) return;
          if(g.type==='Polygon') g.coordinates.forEach(function(r){r.forEach(function(c){coords.push(c)})});
          else if(g.type==='MultiPolygon') g.coordinates.forEach(function(p){p.forEach(function(r){r.forEach(function(c){coords.push(c)})})});
        }
        ex(it.geom);
        if(coords.length === 0){ running--; done++; processNext(); return; }
        var mnLng=Infinity,mxLng=-Infinity,mnLat=Infinity,mxLat=-Infinity;
        coords.forEach(function(c){if(c[0]<mnLng)mnLng=c[0];if(c[0]>mxLng)mxLng=c[0];if(c[1]<mnLat)mnLat=c[1];if(c[1]>mxLat)mxLat=c[1]});
        var bbox = mnLat.toFixed(5)+','+mnLng.toFixed(5)+','+mxLat.toFixed(5)+','+mxLng.toFixed(5)+',EPSG:4326';
        var url = PDOK_BAG_WFS+'?service=WFS&version=2.0.0&request=GetFeature&typeName=bag:verblijfsobject&resultType=hits&srsName=EPSG:4326&BBOX='+bbox;

        fetch(url).then(function(r){ return r.text(); }).then(function(xml){
          var m = xml.match(/numberMatched="(\d+)"/);
          var count = m ? parseInt(m[1]) : 0;
          if(it.type === 'wijk'){
            _bagWijkIndex[it.code] = {naam:it.naam, count:count, gemeente:it.gemeente};
          } else {
            _bagBuurtIndex[it.code] = {naam:it.naam, count:count, gemeente:it.gemeente};
          }
        }).catch(function(){}).finally(function(){
          running--;
          done++;
          if(done % 50 === 0){
            console.log('BAG subarea prefetch: '+done+'/'+total);
            // Herrender dropdowns tussentijds
            if(_wijkData && Object.keys(_bagWijkIndex).length > 0) buildWijkFilter();
            if(_buurtData && Object.keys(_bagBuurtIndex).length > 0) buildBuurtFilter();
            updateBagCacheUI();
          }
          processNext();
        });
      })(item);
    }

    if(queue.length === 0 && running === 0){
      _bagSubPrefetching = false;
      console.log('BAG subarea prefetch klaar: '+Object.keys(_bagWijkIndex).length+' wijken, '+Object.keys(_bagBuurtIndex).length+' buurten');
      // Definitieve dropdown update
      if(_wijkData) buildWijkFilter();
      if(_buurtData) buildBuurtFilter();
      updateBagCacheUI();
    }
  }

  processNext();
}

// Laad BAG adressen voor een specifieke gemeente uit pre-built bestand
function loadBagForGemeente(code){
  var url = 'bag/bag_'+code+'.geojson'+_cacheBust;
  return fetch(url).then(function(r){
    if(!r.ok) throw new Error('BAG '+code+' niet beschikbaar ('+r.status+')');
    return r.json();
  }).then(function(d){
    var features = d.features || [];
    saveBagToIDB(features);
    return features.length;
  });
}

// Laad BAG voor alle geselecteerde gemeenten (pre-built bestanden)
function loadBagForSelection(){
  if(!_gemeenteData) return Promise.resolve(0);
  var gemFilter = getSelectedGemeenteFilter();
  if(gemFilter === 'all') return Promise.resolve(0); // Niet alles laden

  // Zoek gemeentecodes voor geselecteerde namen
  var targets = [];
  _gemeenteData.features.forEach(function(f){
    var p = f.properties;
    if(!p.gemeentecode || !p.gemeentenaam) return;
    if(gemFilter.has(p.gemeentenaam)){
      targets.push({code: p.gemeentecode, naam: p.gemeentenaam});
    }
  });

  if(targets.length === 0) return Promise.resolve(0);

  // UI
  var progEl = document.getElementById('bagBgProgress');
  progEl.style.display = 'block';
  var bgText = document.getElementById('bagBgText');
  var bgPct = document.getElementById('bagBgPct');
  var bgBar = document.getElementById('bagBgBar');
  var bgDetail = document.getElementById('bagBgDetail');
  bgText.textContent = 'BAG adressen laden...';
  bgPct.textContent = '0%';
  bgBar.style.width = '0%';

  var totalLoaded = 0;
  var completed = 0;

  return targets.reduce(function(chain, gem){
    return chain.then(function(){
      bgText.textContent = gem.naam + '...';
      bgDetail.textContent = (completed+1)+'/'+targets.length+' gemeenten';
      return loadBagForGemeente(gem.code).then(function(n){
        totalLoaded += n;
        completed++;
        var pct = Math.round(completed / targets.length * 100);
        bgPct.textContent = pct + '%';
        bgBar.style.width = pct + '%';
        bgDetail.textContent = completed+'/'+targets.length+' gemeenten \u00b7 '+totalLoaded.toLocaleString('nl-NL')+' adressen';
      }).catch(function(e){
        console.warn('BAG pre-built niet beschikbaar voor '+gem.naam+': '+e.message);
        completed++;
        var pct = Math.round(completed / targets.length * 100);
        bgPct.textContent = pct + '%';
        bgBar.style.width = pct + '%';
      });
    });
  }, Promise.resolve()).then(function(){
    bgText.textContent = 'Klaar!';
    bgPct.textContent = '100%';
    bgBar.style.width = '100%';
    bgDetail.textContent = totalLoaded.toLocaleString('nl-NL')+' adressen geladen voor '+targets.length+' gemeenten';
    updateBagCacheUI();
    // Render op kaart
    _bagVectorData = getCachedBagFeatures();
    renderBagVectors();
    updateBagStatusCountsFromData();
    toast(totalLoaded.toLocaleString('nl-NL')+' BAG adressen geladen \u2714');
    setTimeout(function(){ progEl.style.display = 'none'; }, 5000);
    return totalLoaded;
  });
}

// ============================================================
// ACHTERGROND BAG LADEN (fallback WFS)
// ============================================================
var _bagBgAbort = null;
var _bagBgRunning = false;
var _bagBgLoaded = {};  // Gemeentenamen die al geladen zijn in deze sessie

function cancelBagBackgroundLoad(){
  if(_bagBgAbort){ _bagBgAbort.abort(); _bagBgAbort = null; }
  _bagBgRunning = false;
  document.getElementById('bagBgProgress').style.display = 'none';
  toast('Achtergrond laden gestopt');
}

function startBagBackgroundLoad(){
  if(_bagBgRunning){ toast('Achtergrond laden is al bezig'); return; }

  // Bepaal welke gemeenten: selectie of alles in viewport
  var gemeenteGeoms = [];
  var src = _gemeenteData;
  if(!src){ toast('Geen gemeentedata beschikbaar'); return; }

  var gemFilter = getSelectedGemeenteFilter();
  src.features.forEach(function(f){
    if(!f.geometry) return;
    var naam = f.properties.gemeentenaam;
    if(gemFilter !== 'all' && !gemFilter.has(naam)) return;
    // Skip al geladen gemeenten
    if(_bagBgLoaded[naam]) return;
    // Bereken bbox van de gemeente-geometrie
    var coords = [];
    function extractCoords(geom){
      if(!geom) return;
      if(geom.type === 'Polygon'){
        geom.coordinates.forEach(function(ring){ ring.forEach(function(c){ coords.push(c); }); });
      } else if(geom.type === 'MultiPolygon'){
        geom.coordinates.forEach(function(poly){ poly.forEach(function(ring){ ring.forEach(function(c){ coords.push(c); }); }); });
      }
    }
    extractCoords(f.geometry);
    if(coords.length === 0) return;
    var minLng = Infinity, maxLng = -Infinity, minLat = Infinity, maxLat = -Infinity;
    coords.forEach(function(c){ if(c[0]<minLng)minLng=c[0]; if(c[0]>maxLng)maxLng=c[0]; if(c[1]<minLat)minLat=c[1]; if(c[1]>maxLat)maxLat=c[1]; });
    gemeenteGeoms.push({naam:naam, bbox:minLat.toFixed(5)+','+minLng.toFixed(5)+','+maxLat.toFixed(5)+','+maxLng.toFixed(5)+',EPSG:4326'});
  });

  if(gemeenteGeoms.length === 0){
    // Alle gemeenten in scope zijn al geladen
    console.log('BAG bg: alle gemeenten al geladen ('+Object.keys(_bagBgLoaded).length+')');
    return;
  }

  // Als geen selectie: sorteer op afstand tot viewport-centrum (dichtstbij eerst)
  if(gemFilter === 'all' && gemeenteGeoms.length > 5){
    try {
      var center = _map.getCenter();
      var cLat = center.lat, cLng = center.lng;
      gemeenteGeoms.sort(function(a,b){
        var pa = a.bbox.split(','), pb = b.bbox.split(',');
        var aMidLat = (parseFloat(pa[0])+parseFloat(pa[2]))/2, aMidLng = (parseFloat(pa[1])+parseFloat(pa[3]))/2;
        var bMidLat = (parseFloat(pb[0])+parseFloat(pb[2]))/2, bMidLng = (parseFloat(pb[1])+parseFloat(pb[3]))/2;
        var distA = Math.pow(aMidLat-cLat,2) + Math.pow(aMidLng-cLng,2);
        var distB = Math.pow(bMidLat-cLat,2) + Math.pow(bMidLng-cLng,2);
        return distA - distB;
      });
    } catch(e){}
  }

  _bagBgRunning = true;
  _bagBgAbort = new AbortController();
  var signal = _bagBgAbort.signal;

  // UI
  var progEl = document.getElementById('bagBgProgress');
  progEl.style.display = 'block';
  var bgText = document.getElementById('bagBgText');
  var bgPct = document.getElementById('bagBgPct');
  var bgBar = document.getElementById('bagBgBar');
  var bgDetail = document.getElementById('bagBgDetail');

  var totalGemeenten = gemeenteGeoms.length;
  var completedGemeenten = 0;
  var totalAddresses = 0;
  var startTime = Date.now();

  bgText.textContent = 'Starten... (' + totalGemeenten + ' gemeenten)';
  bgPct.textContent = '0%';
  bgBar.style.width = '0%';

  // Laad alle gemeenten sequentieel (1 tegelijk, 6 pages parallel per gemeente)
  async function loadGemeente(gem){
    if(signal.aborted) return 0;
    bgText.textContent = gem.naam + '...';

    // Hits query voor deze gemeente
    var hitsUrl = PDOK_BAG_WFS+'?service=WFS&version=2.0.0&request=GetFeature&typeName=bag:verblijfsobject&resultType=hits&srsName=EPSG:4326&BBOX='+gem.bbox;
    try {
      var resp = await fetch(hitsUrl, {signal:signal});
      var xml = await resp.text();
      var m = xml.match(/numberMatched="(\d+)"/);
      var total = m ? parseInt(m[1]) : 0;
      if(total === 0) return 0;

      // Laad alle pagina's voor deze gemeente
      var totalPages = Math.ceil(total / BAG_PAGE_SIZE);
      var loaded = 0;
      var nextPage = 0;
      var pagesComplete = 0;

      await new Promise(function(resolve){
        var running = 0;
        function next(){
          if(signal.aborted){ resolve(); return; }
          while(nextPage < totalPages && running < BAG_CONCURRENCY){
            (function(pi){
              var startIdx = pi * BAG_PAGE_SIZE;
              running++;
              var url = PDOK_BAG_WFS+'?service=WFS&version=2.0.0&request=GetFeature&typeName=bag:verblijfsobject&outputFormat=application/json&count='+BAG_PAGE_SIZE+'&startIndex='+startIdx+'&sortBy=identificatie&srsName=EPSG:4326&BBOX='+gem.bbox;
              fetch(url,{signal:signal}).then(function(r){return r.json()}).then(function(d){
                running--;
                var feats = d.features || [];
                if(feats.length > 0){
                  loaded += feats.length;
                  saveBagToIDB(feats);
                }
                pagesComplete++;
                // Update detail
                bgDetail.textContent = gem.naam+': '+loaded.toLocaleString('nl-NL')+'/'+total.toLocaleString('nl-NL')+' · Gemeente '+(completedGemeenten+1)+'/'+totalGemeenten;
                if(pagesComplete >= totalPages) resolve();
                else next();
              }).catch(function(e){
                running--;
                pagesComplete++;
                if(e.name !== 'AbortError') console.warn('BAG bg page error:', e.message);
                if(pagesComplete >= totalPages) resolve();
                else next();
              });
            })(nextPage);
            nextPage++;
          }
        }
        next();
      });

      return loaded;
    } catch(e){
      if(e.name !== 'AbortError') console.warn('BAG bg gemeente error:', gem.naam, e.message);
      return 0;
    }
  }

  // Verwerk gemeenten sequentieel (voorkomt overbelasting PDOK)
  (async function(){
    for(var i = 0; i < gemeenteGeoms.length; i++){
      if(signal.aborted) break;
      var gem = gemeenteGeoms[i];
      var count = await loadGemeente(gem);
      totalAddresses += count;
      completedGemeenten++;
      if(count > 0) _bagBgLoaded[gem.naam] = true;

      var pct = Math.round(completedGemeenten / totalGemeenten * 100);
      var elapsed = ((Date.now() - startTime) / 1000).toFixed(0);
      var eta = completedGemeenten > 0 ? Math.round((totalGemeenten - completedGemeenten) * (elapsed / completedGemeenten)) : '?';
      bgPct.textContent = pct + '%';
      bgBar.style.width = pct + '%';
      bgDetail.textContent = completedGemeenten+'/'+totalGemeenten+' gemeenten · '+totalAddresses.toLocaleString('nl-NL')+' adressen · '+elapsed+'s (±'+eta+'s resterend)';
    }

    // Klaar
    _bagBgRunning = false;
    _bagBgAbort = null;
    var elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
    bgText.textContent = 'Klaar!';
    bgPct.textContent = '100%';
    bgBar.style.width = '100%';
    bgDetail.textContent = totalAddresses.toLocaleString('nl-NL')+' adressen geladen in '+elapsed+'s · '+_bagMemCount.toLocaleString('nl-NL')+' in cache';
    updateBagCacheUI();

    // Herrender de kaart met alle gecachte data
    _bagVectorData = getCachedBagFeatures();
    renderBagVectors();
    updateBagStatusCountsFromData();

    toast(totalAddresses.toLocaleString('nl-NL')+' BAG adressen geladen voor '+completedGemeenten+' gemeenten \u2714');

    // Verberg progress na 5 seconden
    setTimeout(function(){
      if(!_bagBgRunning){
        progEl.style.display = 'none';
      }
    }, 5000);

    // Doorladen: als BAG layer nog actief is en er nog gemeenten te laden zijn
    if(_layerState.bag && totalAddresses > 0){
      setTimeout(function(){
        if(_layerState.bag && !_bagBgRunning){
          // Herstart voor de volgende batch gemeenten (viewport is mogelijk veranderd)
          startBagBackgroundLoad();
        }
      }, 3000);
    }
  })();
}

// bagStatusColor via bagStatusToColor() hierboven

// Zoek feature in een laag via punt-in-polygoon
function findFeatureAtPoint(layer, latlng){
  if(!layer) return null;
  var found = null;
  layer.eachLayer(function(sub){
    if(found) return;
    try{
      if(sub.getBounds && sub.getBounds().contains(latlng)){
        if(sub.getLatLngs) found = sub.feature;
      }
    }catch(e){}
  });
  return found;
}

// Zoek een GeoJSON feature die een punt bevat, direct in een dataset (geen Leaflet laag nodig)
function findFeatureInData(data, latlng){
  if(!data || !data.features) return null;
  var lat = latlng.lat, lng = latlng.lng;
  for(var i = 0; i < data.features.length; i++){
    var f = data.features[i];
    if(!f.geometry) continue;
    // Snelle bbox pre-filter
    var coords = f.geometry.coordinates;
    if(f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon'){
      try {
        var tempLayer = L.geoJSON(f);
        var found = false;
        tempLayer.eachLayer(function(sub){
          if(found) return;
          if(sub.getBounds && sub.getBounds().contains(latlng)){
            var rings = sub.getLatLngs();
            var checkRing = rings;
            if(Array.isArray(rings[0]) && rings[0].length && rings[0][0].lat !== undefined) checkRing = rings[0];
            else if(Array.isArray(rings[0]) && Array.isArray(rings[0][0])) checkRing = rings[0][0];
            if(pointInPolygon(lat, lng, checkRing)) found = true;
          }
        });
        if(found) return f;
      } catch(e){}
    }
  }
  return null;
}

// CBS statistieken voor een locatie — ALLE niveaus met grafieken + AI interpretatie
// Zoekt ook in niet-actieve lagen als de data geladen is
function buildMultiLevelStatsHtml(latlng){
  var html = '';
  var layers = [
    {layer:_buurtLayer, data:_buurtData, name:'Buurt', icon:'grid_on', state:_layerState.buurten, cfg:LAYER_CONFIG.buurten, color:'var(--ac)'},
    {layer:_wijkLayer, data:_wijkData, name:'Wijk', icon:'grid_view', state:_layerState.wijken, cfg:LAYER_CONFIG.wijken, color:'var(--wn)'},
    {layer:_gemeenteLayer, data:_gemeenteData, name:'Gemeente', icon:'domain', state:_layerState.gemeenten, cfg:LAYER_CONFIG.gemeenten, color:'var(--cyan)'}
  ];
  var findings = []; // Verzamel data voor de eindanalyse
  layers.forEach(function(l){
    var feature = null;
    // Methode 1: via actieve laag op de kaart (snel)
    if(l.state && l.layer){
      feature = findFeatureAtPoint(l.layer, latlng);
    }
    // Methode 2: als laag niet actief maar data wel geladen, zoek in GeoJSON
    if(!feature && l.data){
      feature = findFeatureInData(l.data, latlng);
    }
    if(!feature || !feature.properties) return;
    var p = feature.properties;
    var naam = p[l.cfg.nameField] || p[l.cfg.codeField] || '-';
    html += '<div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--glass-bd)">';
    html += '<div style="font:700 12px \'Space Mono\',monospace;color:'+l.color+';margin-bottom:8px;display:flex;align-items:center;gap:5px"><span class="mi" style="font-size:16px;color:'+l.color+'">'+l.icon+'</span> '+l.name+': '+naam+'</div>';
    _activeIndicators.forEach(function(k){
      var v = p[k];
      if(v === undefined || v === null) return;
      html += buildCompareHtml(k, v);
      // Verzamel voor eindanalyse
      var ns = _nationalStats[k];
      if(ns && ns.stddev > 0){
        findings.push({level:l.name, naam:naam, key:k, val:v, z:(v-ns.avg)/ns.stddev, avg:ns.avg, stddev:ns.stddev});
      }
    });
    html += '</div>';
  });

  // === AI DATA-INTERPRETATIE (educatief) ===
  if(findings.length > 0){
    html += buildEducationalAnalysis(findings);
  }
  return html;
}

// Genereer educatieve data-interpretatie
function buildEducationalAnalysis(findings){
  var h = '<div style="margin-top:14px;padding-top:12px;border-top:2px solid rgba(57,255,20,.2)">';
  h += '<div style="font:700 13px \'Space Mono\',monospace;color:var(--ac);margin-bottom:10px;display:flex;align-items:center;gap:6px">';
  h += '<span class="mi" style="font-size:20px;color:var(--ac)">psychology</span> Data-analyse';
  h += '<span style="font:400 10px DM Sans,sans-serif;color:var(--mt);text-transform:none;letter-spacing:0">(automatisch afgeleid uit statistiek)</span>';
  h += '</div>';

  // Stap 1: Opvallende waarden identificeren
  var opvallend = findings.filter(function(f){return Math.abs(f.z)>1});
  var gemiddeld = findings.filter(function(f){return Math.abs(f.z)<=0.5});
  var licht = findings.filter(function(f){return Math.abs(f.z)>0.5 && Math.abs(f.z)<=1});

  h += '<div style="padding:10px 12px;background:rgba(57,255,20,.03);border-radius:10px;border-left:3px solid var(--ac);margin-bottom:10px">';
  h += '<div style="font:600 12px DM Sans,sans-serif;color:var(--ac);margin-bottom:6px;display:flex;align-items:center;gap:5px"><span class="mi mi-sm" style="font-size:15px">looks_one</span> Stap 1: Opvallende waarden identificeren</div>';
  h += '<div style="font-size:11px;color:var(--mt);line-height:1.8">';
  h += 'We vergelijken elke indicator met het <b style="color:var(--tx)">landelijk gemiddelde</b> en berekenen de <b style="color:var(--ai)">z-score</b> = (waarde \u2212 gemiddelde) \u00f7 standaarddeviatie.<br>';
  if(opvallend.length > 0){
    h += '<br><b style="color:var(--wn)">'+opvallend.length+' opvallende waarde'+(opvallend.length>1?'n':'')+'</b> gevonden (|z| > 1):';
    h += '<ul style="margin:4px 0 0 16px;padding:0">';
    opvallend.forEach(function(f){
      var fm = getIndicator(f.key);
      var dir = f.z > 0 ? 'hoger' : 'lager';
      h += '<li style="margin:2px 0"><b style="color:var(--tx)">'+fm.naam+'</b> = '+formatVal(f.val)+' '+fm.eenheid;
      h += ' <span style="color:'+getBarColor(f.z)+'">('+(f.z>0?'+':'')+f.z.toFixed(1)+'\u03c3 '+dir+' dan gemiddeld)</span></li>';
    });
    h += '</ul>';
  }
  if(gemiddeld.length > 0){
    h += '<br><span style="color:var(--ai)">'+gemiddeld.length+' indicator'+(gemiddeld.length>1?'en':'')+' dicht bij het gemiddelde</span> (|z| < 0.5): ';
    h += gemiddeld.map(function(f){return getIndicator(f.key).naam}).join(', ')+'.';
  }
  h += '</div></div>';

  // Stap 2: Patroonherkenning
  h += '<div style="padding:10px 12px;background:rgba(56,189,248,.03);border-radius:10px;border-left:3px solid var(--ai);margin-bottom:10px">';
  h += '<div style="font:600 12px DM Sans,sans-serif;color:var(--ai);margin-bottom:6px;display:flex;align-items:center;gap:5px"><span class="mi mi-sm" style="font-size:15px">looks_two</span> Stap 2: Patronen herkennen</div>';
  h += '<div style="font-size:11px;color:var(--mt);line-height:1.8">';

  // Zoek correlaties/patronen
  var hWoz = findings.find(function(f){return f.key==='gem_woz_waarde'});
  var hInk = findings.find(function(f){return f.key==='gem_inkomen_inwoner'});
  var hBev = findings.find(function(f){return f.key==='aantal_inwoners'});
  var hDicht = findings.find(function(f){return f.key==='bevolkingsdichtheid'});
  var hKoop = findings.find(function(f){return f.key==='koopwoningen'});
  var hGas = findings.find(function(f){return f.key==='gem_aardgas'});
  var hElek = findings.find(function(f){return f.key==='gem_elektriciteit'});
  var h65 = findings.find(function(f){return f.key==='65plus'});
  var hArb = findings.find(function(f){return f.key==='arbeidsparticipatie'});

  var patterns = [];
  // WOZ-inkomen correlatie
  if(hWoz && hInk){
    if(hWoz.z > 0.5 && hInk.z > 0.5) patterns.push('WOZ-waarde en inkomen zijn <b>beide bovengemiddeld</b> \u2014 dit wijst op een <b style="color:var(--ac)">welvarend gebied</b>.');
    else if(hWoz.z < -0.5 && hInk.z < -0.5) patterns.push('WOZ-waarde en inkomen zijn <b>beide ondergemiddeld</b> \u2014 dit wijst op een <b style="color:var(--wn)">sociaal-economisch zwakker gebied</b>.');
    else if(hWoz.z > 1 && hInk.z < 0) patterns.push('Hoge WOZ maar laag inkomen \u2014 mogelijk <b style="color:var(--wn)">gentrificatie</b>: woningen worden duurder terwijl de huidige bewoners minder verdienen.');
  }
  // Vergrijzing
  if(h65 && h65.z > 1) patterns.push('Hoog percentage 65+ ('+(h65.val).toFixed(0)+'%) \u2014 dit is een <b style="color:var(--wn)">vergrijzend gebied</b>.'+(hArb && hArb.z < -0.5 ? ' Dit verklaart ook de lagere arbeidsparticipatie.' : ''));
  // Energie
  if(hGas && hElek){
    if(hGas.z > 1) patterns.push('Hoog gasverbruik ('+formatVal(hGas.val)+' m\u00b3) \u2014 waarschijnlijk <b style="color:var(--wn)">oudere, slecht ge\u00efsoleerde woningen</b>.');
    if(hGas.z < -1) patterns.push('Laag gasverbruik \u2014 wijst op <b style="color:var(--ac)">nieuwbouw of goed ge\u00efsoleerd</b>.');
  }
  // Dichtheid vs koop
  if(hDicht && hKoop){
    if(hDicht.z > 1 && hKoop.z < -0.5) patterns.push('Hoge bevolkingsdichtheid met weinig koopwoningen \u2014 typisch <b>stedelijk huurgebied</b> (flats/appartementen).');
    if(hDicht.z < -1 && hKoop.z > 0.5) patterns.push('Lage dichtheid met veel koopwoningen \u2014 typisch <b>suburbaan</b>/dorps woongebied.');
  }

  if(patterns.length > 0){
    patterns.forEach(function(p){h+='<div style="margin:4px 0;padding-left:8px;border-left:2px solid rgba(56,189,248,.2)">'+p+'</div>'});
  } else {
    h += 'Geen sterke patronen gevonden \u2014 dit gebied scoort vrij gemiddeld op de meeste indicatoren.';
  }
  h += '</div></div>';

  // Stap 3: Conclusie
  h += '<div style="padding:10px 12px;background:rgba(251,191,36,.03);border-radius:10px;border-left:3px solid var(--wn);margin-bottom:10px">';
  h += '<div style="font:600 12px DM Sans,sans-serif;color:var(--wn);margin-bottom:6px;display:flex;align-items:center;gap:5px"><span class="mi mi-sm" style="font-size:15px">looks_3</span> Stap 3: Conclusie formuleren</div>';
  h += '<div style="font-size:11px;color:var(--mt);line-height:1.8">';

  // Gebiedsprofiel samenstellen
  var level = findings[0] ? findings[0].level : 'Gebied';
  var naam = findings[0] ? findings[0].naam : '';
  h += '<b style="color:var(--tx)">Profiel van '+level.toLowerCase()+' '+naam+':</b><br>';

  // Bouw een profiel
  var profiel = [];
  if(hWoz) profiel.push(hWoz.z>0.5?'dure woningen':(hWoz.z<-0.5?'goedkope woningen':'gemiddelde woningwaarde'));
  if(hInk) profiel.push(hInk.z>0.5?'hoge inkomens':(hInk.z<-0.5?'lage inkomens':'gemiddelde inkomens'));
  if(hDicht) profiel.push(hDicht.z>1?'zeer dicht bebouwd':(hDicht.z>0.5?'stedelijk':(hDicht.z<-0.5?'ruim/landelijk':'gemiddelde dichtheid')));
  if(hKoop) profiel.push(hKoop.z>0.5?'veel koopwoningen':(hKoop.z<-0.5?'veel huurwoningen':'mix koop/huur'));
  if(h65) profiel.push(h65.z>1?'vergrijzend':(h65.z<-0.5?'jong/gezinnen':'gemiddelde leeftijdsopbouw'));
  if(profiel.length > 0) h += 'Een gebied met '+profiel.join(', ')+'.';

  // Sterke/zwakke punten
  var sterk = opvallend.filter(function(f){
    var isReverse = REVERSE_KEYS.indexOf(f.key)>=0;
    return isReverse ? f.z<-1 : f.z>1;
  });
  var zwak = opvallend.filter(function(f){
    var isReverse = REVERSE_KEYS.indexOf(f.key)>=0;
    return isReverse ? f.z>1 : f.z<-1;
  });
  if(sterk.length>0){
    h += '<br><span style="color:var(--ac)">Sterk:</span> '+sterk.map(function(f){return getIndicator(f.key).naam}).join(', ')+'.';
  }
  if(zwak.length>0){
    h += '<br><span style="color:var(--dn)">Aandachtspunt:</span> '+zwak.map(function(f){return getIndicator(f.key).naam}).join(', ')+'.';
  }

  h += '</div></div>';

  // Methode-uitleg (educatief) — met analogie en concreet rekenvoorbeeld
  h += '<div style="padding:12px 14px;background:rgba(100,116,139,.05);border-radius:10px;border-left:3px solid var(--mt)">';
  h += '<div style="font:600 12px DM Sans,sans-serif;color:var(--mt);margin-bottom:8px;display:flex;align-items:center;gap:5px"><span class="mi" style="font-size:16px">school</span> Hoe lees je deze analyse?</div>';
  h += '<div style="font-size:11px;color:var(--mt);line-height:1.8">';

  // Analogie eerst — maakt het direct concreet
  h += '<div style="padding:10px 12px;background:rgba(56,189,248,.06);border-radius:8px;margin-bottom:10px;border-left:3px solid var(--ai)">';
  h += '<div style="font:600 11px DM Sans,sans-serif;color:var(--ai);margin-bottom:4px">Stel je een schoolklas voor</div>';
  h += '<div style="font-size:11px;color:var(--tx);line-height:1.8">';
  h += 'In een klas van 30 leerlingen is de gemiddelde lengte 1,75 m. De meeste leerlingen zitten tussen 1,70 en 1,80 m. ';
  h += 'Als jij 1,90 m bent, ben je duidelijk langer dan de rest \u2014 maar h\u00f3\u00e9 bijzonder is dat precies?<br><br>';
  h += 'De <b style="color:var(--ai)">z-score</b> beantwoordt die vraag. Het getal zegt: <b>hoeveel stappen van \u201cnormaal\u201d</b> zit je af? ';
  h += 'E\u00e9n stap (\u03c3) is de \u201cnormale spreiding\u201d \u2014 het verschil dat je verwacht tussen willekeurige buurten.';
  h += '</div></div>';

  // Concreet rekenvoorbeeld met echte data
  var voorbeeld = opvallend.length > 0 ? opvallend[0] : findings[0];
  if(voorbeeld){
    var vfm = getIndicator(voorbeeld.key);
    h += '<div style="padding:10px 12px;background:rgba(57,255,20,.04);border-radius:8px;margin-bottom:10px;border:1px dashed rgba(57,255,20,.2)">';
    h += '<div style="font:600 11px DM Sans,sans-serif;color:var(--ac);margin-bottom:6px">\ud83d\udcdd Concreet voorbeeld met jouw data:</div>';
    h += '<div style="font-size:11px;line-height:1.9;color:var(--tx)">';
    h += '<b>'+vfm.naam+'</b> van dit gebied = <b style="color:var(--ac)">'+formatVal(voorbeeld.val)+' '+vfm.eenheid+'</b><br>';
    h += 'Het Nederlands gemiddelde = <b>'+formatVal(voorbeeld.avg)+' '+vfm.eenheid+'</b><br>';
    h += 'De normale spreiding (\u03c3) = <b>'+formatVal(voorbeeld.stddev)+' '+vfm.eenheid+'</b><br><br>';
    h += '<b>Hoe ver van normaal?</b><br>';
    h += '<div style="padding:8px 12px;background:rgba(57,255,20,.06);border-radius:6px;font:700 12px Space Mono,monospace;color:var(--ac);margin:4px 0">';
    var verschil = voorbeeld.val - voorbeeld.avg;
    h += 'Verschil = '+formatVal(voorbeeld.val)+' \u2212 '+formatVal(voorbeeld.avg)+' = '+(verschil >= 0 ? '+' : '')+formatVal(verschil)+' '+vfm.eenheid+'<br>';
    h += 'Dat is '+formatVal(verschil)+' \u00f7 '+formatVal(voorbeeld.stddev)+' = <span style="color:'+(Math.abs(voorbeeld.z)>1?'var(--wn)':'var(--ai)')+'">'+voorbeeld.z.toFixed(2)+' stappen</span> van normaal';
    h += '</div>';
    h += '<b>Wat betekent dit?</b> ';
    if(Math.abs(voorbeeld.z) < 0.5) h += 'Minder dan een halve stap \u2192 <b style="color:var(--ai)">heel normaal</b>. Dit gebied is typisch Nederlands.';
    else if(Math.abs(voorbeeld.z) < 1) h += 'Minder dan \u00e9\u00e9n stap \u2192 <b style="color:var(--ai)">vrij normaal</b>. 68% van alle gebieden zit binnen deze marge.';
    else if(Math.abs(voorbeeld.z) < 2) h += 'Meer dan \u00e9\u00e9n stap \u2192 <b style="color:var(--wn)">opvallend '+(voorbeeld.z>0?'hoog':'laag')+'</b>. Dit gebied valt buiten de range waar de meeste (68%) gebieden zitten.';
    else h += 'Meer dan twee stappen \u2192 <b style="color:var(--dn)">uitzonderlijk</b>. Slechts 5% van alle gebieden in Nederland wijkt zo ver af.';
    h += '</div></div>';
  }

  // Snelle referentietabel
  h += '<div style="padding:8px 12px;background:rgba(255,255,255,.02);border-radius:8px;margin-bottom:8px">';
  h += '<div style="font:600 11px DM Sans,sans-serif;color:var(--tx);margin-bottom:6px">Snelle leeswijzer z-score:</div>';
  h += '<div style="display:grid;grid-template-columns:70px 1fr;gap:3px 10px;font-size:11px">';
  h += '<span style="color:var(--ai);font-weight:700">0 tot \u00b10.5</span><span>\u2192 Normaal — niets bijzonders, vergelijkbaar met de meeste gebieden</span>';
  h += '<span style="color:var(--ai);font-weight:700">\u00b10.5 tot \u00b11</span><span>\u2192 Licht afwijkend — een klein verschil, maar nog steeds gebruikelijk</span>';
  h += '<span style="color:var(--wn);font-weight:700">\u00b11 tot \u00b12</span><span>\u2192 Opvallend — dit gebied wijkt duidelijk af van het gemiddelde</span>';
  h += '<span style="color:var(--dn);font-weight:700">Meer dan \u00b12</span><span>\u2192 Uitzonderlijk — slechts 5% van Nederland scoort zo afwijkend</span>';
  h += '</div></div>';

  // Waarom nuttig
  h += '<div style="font-size:11px;color:var(--mt);margin-bottom:6px">';
  h += '<b style="color:var(--tx)">Waarom is dit nuttig?</b> ';
  h += 'Getallen alleen zeggen weinig. \u20ac300.000 WOZ klinkt als \u201cveel\u201d, maar in Amsterdam is het goedkoop en in Oost-Groningen extreem duur. ';
  h += 'De z-score zet alles in context: het zegt niet wat de waarde <i>is</i>, maar hoe <i>bijzonder</i> het is vergeleken met de rest van Nederland.';
  h += '</div>';

  // Disclaimer
  h += '<div style="padding:6px 10px;background:rgba(251,191,36,.05);border-radius:6px;border-left:2px solid var(--wn);margin-top:6px">';
  h += '<b style="color:var(--wn);font-size:10px">\u26a0 Disclaimer:</b> <span style="font-size:10px">Dit zijn automatische berekeningen op CBS open data. De conclusies zijn indicatief \u2014 voor een volledig beeld is lokale kennis nodig.</span>';
  h += '</div>';

  h += '</div></div>';

  h += '</div>';
  return h;
}

// Uitgebreide AI analyse — beschrijft de situatie als een verhaal
function buildFullAnalysis(findings, props, typeLabel, name){
  var h = '<div style="margin-top:14px;padding-top:12px;border-top:2px solid rgba(57,255,20,.2)">';
  h += '<div style="font:700 13px Space Mono,monospace;color:var(--ac);margin-bottom:10px;display:flex;align-items:center;gap:6px">';
  h += '<span class="mi" style="font-size:20px;color:var(--ac)">psychology</span> AI Gebiedsanalyse';
  h += '</div>';

  // Verzamel alle data
  var f = function(k){return findings.find(function(x){return x.key===k})};
  var fWoz=f('gem_woz_waarde'),fInk=f('gem_inkomen_inwoner'),fDicht=f('bevolkingsdichtheid');
  var fKoop=f('koopwoningen'),fHuur=f('huurwoningen'),fGas=f('gem_aardgas'),fElek=f('gem_elektriciteit');
  var f65=f('65plus'),f015=f('0_15'),f1525=f('15_25'),f2545=f('25_45');
  var fArb=f('arbeidsparticipatie'),fBedr=f('bedrijfsvestigingen'),fAuto=f('personenautos');
  var fHuis=f('afstand_huisarts'),fSuper=f('afstand_supermarkt'),fEen=f('pct_eengezins');
  var fInw=f('aantal_inwoners'),fHh=f('huishoudens'),fHhg=f('gem_huishouden_grootte');
  var fWv=f('woningvoorraad');

  // === GEBIEDSPROFIEL ===
  h += '<div style="padding:12px 14px;background:rgba(57,255,20,.03);border-radius:10px;border-left:3px solid var(--ac);margin-bottom:10px">';
  h += '<div style="font:600 12px DM Sans,sans-serif;color:var(--ac);margin-bottom:8px;display:flex;align-items:center;gap:5px"><span class="mi mi-sm" style="font-size:15px">place</span> Gebiedsprofiel: '+name+'</div>';
  h += '<div style="font-size:11px;color:var(--tx);line-height:1.9">';

  // Beschrijf het type gebied
  var gebiedType = '';
  if(fDicht && fDicht.z > 1.5) gebiedType = 'een zeer stedelijk, dichtbebouwd';
  else if(fDicht && fDicht.z > 0.5) gebiedType = 'een stedelijk';
  else if(fDicht && fDicht.z < -1) gebiedType = 'een landelijk, ruim opgezet';
  else if(fDicht && fDicht.z < -0.5) gebiedType = 'een suburbaan';
  else gebiedType = 'een gemiddeld';

  var woningType = '';
  if(fKoop && fKoop.z > 0.5 && fEen && fEen.z > 0.5) woningType = 'voornamelijk eengezinskoopwoningen';
  else if(fHuur && fHuur.z > 0.5) woningType = 'overwegend huurwoningen';
  else if(fKoop && fKoop.z > 0.5) woningType = 'veel koopwoningen';
  else if(fEen && fEen.z < -0.5) woningType = 'veel appartementen en meergezinswoningen';
  else woningType = 'een gemengd woningaanbod';

  h += '<b>'+name+'</b> is '+gebiedType+' gebied met '+woningType+'.';

  // Demografisch profiel
  if(fInw && fInw.val) h += ' Er wonen <b>'+fInw.val.toLocaleString('nl-NL')+'</b> inwoners';
  if(fHh && fHh.val) h += ' in <b>'+fHh.val.toLocaleString('nl-NL')+'</b> huishoudens';
  if(fHhg && fHhg.val) h += ' (gemiddeld '+fHhg.val.toFixed(1)+' personen per huishouden)';
  h += '.<br><br>';

  // Bevolkingsopbouw
  var bevolking = [];
  if(f65 && f65.z > 1) bevolking.push('het gebied is <b style="color:var(--wn)">vergrijsd</b> ('+(f65.val).toFixed(0)+'% is 65+)');
  if(f015 && f015.z > 0.8) bevolking.push('er wonen relatief <b>veel kinderen</b> (0-15 jaar: '+f015.val.toFixed(0)+'%)');
  if(f1525 && f1525.z > 1) bevolking.push('er zijn veel <b>jongeren/studenten</b> (15-25: '+f1525.val.toFixed(0)+'%)');
  if(f2545 && f2545.z > 0.8) bevolking.push('er wonen veel <b>jonge gezinnen/starters</b> (25-45: '+f2545.val.toFixed(0)+'%)');
  if(f65 && f65.z < -1) bevolking.push('het is een <b style="color:var(--ac)">jong gebied</b> (weinig 65+)');
  if(bevolking.length > 0) h += 'Qua demografie: '+bevolking.join('; ')+'. ';

  h += '</div></div>';

  // === WELVAART & WONINGMARKT ===
  var welvaartItems = [];
  if(fWoz) welvaartItems.push(fWoz.z>1?'De <b>WOZ-waarde</b> is fors boven het landelijk gemiddelde (\u20ac'+Math.round(fWoz.val/1000)+'k vs. \u20ac'+Math.round(fWoz.avg/1000)+'k) \u2014 dit is een dure woonomgeving.':(fWoz.z<-1?'De <b>WOZ-waarde</b> is laag (\u20ac'+Math.round(fWoz.val/1000)+'k vs. landelijk \u20ac'+Math.round(fWoz.avg/1000)+'k) \u2014 woningen zijn hier relatief betaalbaar.':'De <b>WOZ-waarde</b> (\u20ac'+Math.round(fWoz.val/1000)+'k) ligt rond het landelijk gemiddelde.'));
  if(fInk) welvaartItems.push(fInk.z>1?'Het <b>gemiddeld inkomen</b> is hoog (\u20ac'+Math.round(fInk.val/1000)+'k vs. landelijk \u20ac'+Math.round(fInk.avg/1000)+'k).':(fInk.z<-1?'Het <b>gemiddeld inkomen</b> is laag (\u20ac'+Math.round(fInk.val/1000)+'k vs. landelijk \u20ac'+Math.round(fInk.avg/1000)+'k).':'Het <b>inkomen</b> is gemiddeld.'));
  if(fArb) welvaartItems.push(fArb.z>0.5?'De <b>arbeidsparticipatie</b> is hoog ('+fArb.val.toFixed(0)+'%).':'');
  if(fArb && fArb.z<-0.5) welvaartItems.push('De <b>arbeidsparticipatie</b> is laag ('+fArb.val.toFixed(0)+'%)'+(f65&&f65.z>0.5?' \u2014 mogelijk verklaard door het hoge aandeel gepensioneerden.':'.'));

  if(welvaartItems.filter(function(x){return x}).length > 0){
    h += '<div style="padding:12px 14px;background:rgba(56,189,248,.03);border-radius:10px;border-left:3px solid var(--ai);margin-bottom:10px">';
    h += '<div style="font:600 12px DM Sans,sans-serif;color:var(--ai);margin-bottom:6px;display:flex;align-items:center;gap:5px"><span class="mi mi-sm" style="font-size:15px">payments</span> Welvaart & Woningmarkt</div>';
    h += '<div style="font-size:11px;color:var(--tx);line-height:1.9">';
    welvaartItems.forEach(function(item){if(item) h+= item + '<br>';});
    // Samenhang WOZ-inkomen
    if(fWoz && fInk){
      if(fWoz.z>0.5 && fInk.z>0.5) h += '<br><span style="color:var(--ac)">Samenhang:</span> Hoge woningwaarde \u00e9n hoog inkomen passen bij elkaar \u2014 dit is een <b>welvarend gebied</b>.';
      else if(fWoz.z<-0.5 && fInk.z<-0.5) h += '<br><span style="color:var(--wn)">Samenhang:</span> Lage woningwaarde \u00e9n laag inkomen \u2014 dit wijst op een <b>sociaal-economisch kwetsbaar gebied</b>.';
      else if(fWoz.z>1 && fInk.z<0) h += '<br><span style="color:var(--wn)">Let op:</span> Hoge WOZ maar laag inkomen \u2014 mogelijk <b>gentrificatie</b>: woningen worden duurder maar bewoners verdienen minder.';
    }
    h += '</div></div>';
  }

  // === ENERGIE & DUURZAAMHEID ===
  if(fGas || fElek){
    h += '<div style="padding:12px 14px;background:rgba(6,182,212,.03);border-radius:10px;border-left:3px solid var(--cyan);margin-bottom:10px">';
    h += '<div style="font:600 12px DM Sans,sans-serif;color:var(--cyan);margin-bottom:6px;display:flex;align-items:center;gap:5px"><span class="mi mi-sm" style="font-size:15px">bolt</span> Energie & Duurzaamheid</div>';
    h += '<div style="font-size:11px;color:var(--tx);line-height:1.9">';
    if(fGas){
      h += '<b>Gasverbruik:</b> '+formatVal(fGas.val)+' m\u00b3/woning (landelijk gem. '+formatVal(fGas.avg)+' m\u00b3). ';
      if(fGas.z>1) h += '<span style="color:var(--wn)">Fors bovengemiddeld</span> \u2014 wijst op oudere, slecht ge\u00efsoleerde woningen of grotere woningen.<br>';
      else if(fGas.z<-1) h += '<span style="color:var(--ac)">Fors ondergemiddeld</span> \u2014 wijst op nieuwbouw, goede isolatie of aansluiting op warmtenet.<br>';
      else h += 'Rond het gemiddelde.<br>';
    }
    if(fElek){
      h += '<b>Elektriciteit:</b> '+formatVal(fElek.val)+' kWh/woning (landelijk gem. '+formatVal(fElek.avg)+' kWh). ';
      if(fElek.z>1) h += '<span style="color:var(--wn)">Hoog</span> \u2014 mogelijk veel elektrische verwarming of grotere huishoudens.';
      else if(fElek.z<-1) h += '<span style="color:var(--ac)">Laag</span> \u2014 zuinig energieverbruik.';
      else h += 'Rond het gemiddelde.';
    }
    h += '</div></div>';
  }

  // === VOORZIENINGEN ===
  if(fHuis || fSuper){
    h += '<div style="padding:12px 14px;background:rgba(245,158,11,.03);border-radius:10px;border-left:3px solid #f59e0b;margin-bottom:10px">';
    h += '<div style="font:600 12px DM Sans,sans-serif;color:#f59e0b;margin-bottom:6px;display:flex;align-items:center;gap:5px"><span class="mi mi-sm" style="font-size:15px">local_hospital</span> Voorzieningen & Bereikbaarheid</div>';
    h += '<div style="font-size:11px;color:var(--tx);line-height:1.9">';
    if(fHuis) h += '<b>Huisarts:</b> gemiddeld '+fHuis.val.toFixed(1)+' km afstand (landelijk '+fHuis.avg.toFixed(1)+' km). '+(fHuis.z>1?'<span style="color:var(--wn)">Relatief ver.</span>':'<span style="color:var(--ac)">Goed bereikbaar.</span>')+'<br>';
    if(fSuper) h += '<b>Supermarkt:</b> gemiddeld '+fSuper.val.toFixed(1)+' km afstand (landelijk '+fSuper.avg.toFixed(1)+' km). '+(fSuper.z>1?'<span style="color:var(--wn)">Relatief ver.</span>':'<span style="color:var(--ac)">Goed bereikbaar.</span>');
    h += '</div></div>';
  }

  // === CONCLUSIE ===
  var opvallend = findings.filter(function(x){return Math.abs(x.z)>1});
  var sterk = opvallend.filter(function(x){var rev=REVERSE_KEYS.indexOf(x.key)>=0; return rev?x.z<-1:x.z>1});
  var zwak = opvallend.filter(function(x){var rev=REVERSE_KEYS.indexOf(x.key)>=0; return rev?x.z>1:x.z<-1});

  h += '<div style="padding:12px 14px;background:rgba(251,191,36,.04);border-radius:10px;border-left:3px solid var(--wn);margin-bottom:6px">';
  h += '<div style="font:600 12px DM Sans,sans-serif;color:var(--wn);margin-bottom:6px;display:flex;align-items:center;gap:5px"><span class="mi mi-sm" style="font-size:15px">summarize</span> Samenvatting</div>';
  h += '<div style="font-size:11px;color:var(--tx);line-height:1.9">';

  if(sterk.length > 0){
    h += '<span style="color:var(--ac)">Sterke punten:</span> '+sterk.map(function(x){return '<b>'+getIndicator(x.key).naam+'</b>'}).join(', ')+'.<br>';
  }
  if(zwak.length > 0){
    h += '<span style="color:var(--dn)">Aandachtspunten:</span> '+zwak.map(function(x){return '<b>'+getIndicator(x.key).naam+'</b>'}).join(', ')+'.<br>';
  }
  var gemiddeld = findings.filter(function(x){return Math.abs(x.z)<0.5});
  if(gemiddeld.length > 0){
    h += '<span style="color:var(--ai)">Gemiddeld:</span> '+gemiddeld.map(function(x){return getIndicator(x.key).naam}).join(', ')+'.';
  }

  h += '</div></div>';

  // Disclaimer
  h += '<div style="padding:4px 10px;font-size:9px;color:var(--mt)"><span class="mi mi-sm" style="font-size:10px;vertical-align:-1px">info</span> Analyse op basis van CBS open data '+_activeYear+'. Vergelijking t.o.v. landelijk gemiddelde van alle '+typeLabel.toLowerCase()+'. Z-scores > |1| zijn opvallend, > |2| uitzonderlijk.</div>';

  h += '</div>';
  return h;
}

// Backwards compat — oude aanroepen
function buildAreaStatsHtml(latlng){
  return buildMultiLevelStatsHtml(latlng);
}

// ============================================================
// BAG PANDEN WMS
// ============================================================
function togglePandLayer(on){
  if(!_map) return;
  if(on){
    if(_pandWmsLayer) return;
    _pandWmsLayer = L.tileLayer.wms(PDOK_BAG_WMS, {
      layers:'pand',format:'image/png',transparent:true,
      version:'1.1.1',opacity:0.6,maxZoom:22,tileSize:256,minZoom:13
    }).addTo(_map);
    fixLayerOrder();
    dimChoroplethLayers(true);
    if(_map.getZoom() < 16){
      toast('BAG panden actief \u2014 zoom in voor details');
    } else {
      toast('BAG panden actief');
    }
  } else {
    if(_pandWmsLayer){_map.removeLayer(_pandWmsLayer);_pandWmsLayer=null}
    // Herstel choropleth alleen als BAG adressen ook uit staan
    if(!_layerState.bag) dimChoroplethLayers(false);
  }
}

function pandGetFeatureInfo(e){
  var size = _map.getSize();
  var bounds = _map.getBounds();
  var sw = bounds.getSouthWest(), ne = bounds.getNorthEast();
  var bbox = sw.lng+','+sw.lat+','+ne.lng+','+ne.lat;
  var pt = _map.latLngToContainerPoint(e.latlng);
  var url = PDOK_BAG_WMS+'?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo'+
    '&FORMAT=image/png&TRANSPARENT=true'+
    '&QUERY_LAYERS=pand&LAYERS=pand'+
    '&INFO_FORMAT=application/json&FEATURE_COUNT=1&BUFFER=12'+
    '&X='+Math.round(pt.x)+'&Y='+Math.round(pt.y)+
    '&SRS=EPSG:4326&WIDTH='+size.x+'&HEIGHT='+size.y+'&BBOX='+bbox;
  fetch(url).then(function(r){return r.json()}).then(function(d){
    if(!d.features||!d.features.length) return;
    var p = d.features[0].properties;
    document.getElementById('infoBuurtNaam').innerHTML = '<span class="mi mi-sm">apartment</span> BAG Pand';
    var html = '';
    if(p.bouwjaar) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">event</span> Bouwjaar</span><span class="info-val">'+p.bouwjaar+'</span></div>';
    if(p.gebruiksdoel) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">category</span> Gebruiksdoel</span><span class="info-val">'+p.gebruiksdoel+'</span></div>';
    if(p.aantal_verblijfsobjecten) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">door_front</span> VBO\'s</span><span class="info-val">'+p.aantal_verblijfsobjecten+'</span></div>';
    if(p.oppervlakte_min && p.oppervlakte_max){
      var opp = p.oppervlakte_min === p.oppervlakte_max ? p.oppervlakte_min+' m\u00b2' : p.oppervlakte_min+' \u2013 '+p.oppervlakte_max+' m\u00b2';
      html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">square_foot</span> Oppervlakte</span><span class="info-val">'+opp+'</span></div>';
    }
    if(p.status) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">info</span> Status</span><span class="info-val" style="color:'+bagStatusToColor(p.status)+'">'+p.status+'</span></div>';
    if(p.identificatie) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">tag</span> Pand ID</span><span class="info-val" style="font-size:9px">'+p.identificatie+'</span></div>';
    // CBS statistieken van het gebied
    html += buildAreaStatsHtml(e.latlng);
    document.getElementById('infoContent').innerHTML = html;
    document.getElementById('infoPanel').classList.add('show');
  }).catch(function(){});
}

// ============================================================
// PDOK ZOEKBALK
// ============================================================
var _searchTimer = null, _searchAbort = null;

function setupSearch(){
  var inp = document.getElementById('searchInput');
  var res = document.getElementById('searchResults');

  inp.addEventListener('input', function(){
    var q = inp.value.trim();
    if(q.length < 2){ res.style.display='none'; return; }
    if(_searchTimer) clearTimeout(_searchTimer);
    if(_searchAbort) try{_searchAbort.abort()}catch(x){}

    _searchTimer = setTimeout(function(){
      var ac = new AbortController();
      _searchAbort = ac;
      fetch(PDOK_SUGGEST + encodeURIComponent(q) + '&rows=7', {signal:ac.signal})
        .then(function(r){return r.json()})
        .then(function(d){
          if(!d.response||!d.response.docs||!d.response.docs.length){res.style.display='none';return}
          var html = '';
          d.response.docs.forEach(function(doc){
            html += '<div class="search-item" data-id="'+doc.id+'">';
            html += '<div style="color:var(--tx);font-weight:500">'+doc.weergavenaam+'</div>';
            html += '<div style="font-size:10px;color:var(--mt);margin-top:2px"><span class="mi mi-sm" style="font-size:11px;vertical-align:-2px">label</span> '+doc.type+'</div>';
            html += '</div>';
          });
          res.innerHTML = html;
          res.style.display = 'block';
          res.querySelectorAll('.search-item').forEach(function(el){
            el.addEventListener('click', function(){
              selectSearchResult(el.dataset.id, el.querySelector('div').textContent);
              res.style.display = 'none';
              inp.value = '';
            });
          });
        })
        .catch(function(){});
    }, 300);
  });

  document.addEventListener('click', function(e){
    if(!inp.contains(e.target) && !res.contains(e.target)) res.style.display = 'none';
  });
}

function selectSearchResult(id, label){
  fetch(PDOK_LOOKUP + encodeURIComponent(id))
    .then(function(r){return r.json()})
    .then(function(d){
      if(!d.response||!d.response.docs||!d.response.docs.length) return;
      var doc = d.response.docs[0];
      if(doc.centroide_ll){
        var m = doc.centroide_ll.match(/POINT\(([^ ]+) ([^ ]+)\)/);
        if(m){
          var lng = parseFloat(m[1]), lat = parseFloat(m[2]);
          if(_searchMarker){_map.removeLayer(_searchMarker)}
          _searchMarker = L.marker([lat, lng]).addTo(_map).bindPopup('<b>'+(label||doc.weergavenaam)+'</b>').openPopup();
          _map.setView([lat, lng], 16);
          logEvent('zoek', label || doc.weergavenaam);
        }
      }
    })
    .catch(function(){});
}

// ============================================================
// FEATURE INFO PANEL (hover + click)
// ============================================================
function showFeatureInfo(p, cfg, type, isClick, geoFeature){
  // Zorg dat nationalStats altijd berekend is (nodig voor AI interpretatie)
  if(!_nationalStats || Object.keys(_nationalStats).length === 0) computeNationalStats();

  var name = p[cfg.nameField] || p[cfg.codeField] || '-';
  var typeIcon = type === 'buurten' ? 'grid_on' : (type === 'wijken' ? 'grid_view' : 'domain');
  var typeLabel = type === 'buurten' ? 'Buurt' : (type === 'wijken' ? 'Wijk' : 'Gemeente');
  document.getElementById('infoBuurtNaam').innerHTML = '<span class="mi mi-sm">'+typeIcon+'</span> '+name;
  var html = '';

  // Gebiedsinfo header
  html += '<div style="padding:6px 10px;background:rgba(57,255,20,.04);border-radius:8px;margin-bottom:8px">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0">';
  html += '<span style="font-size:11px;color:var(--mt)"><span class="mi mi-sm" style="font-size:13px;color:var(--ac);vertical-align:-2px">label</span> Type</span>';
  html += '<span style="font:700 11px Space Mono,monospace;color:var(--ac)">'+typeLabel+'</span></div>';
  if(isClick) {
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0">';
    html += '<span style="font-size:11px;color:var(--mt)"><span class="mi mi-sm" style="font-size:13px;color:var(--ai);vertical-align:-2px">tag</span> Code</span>';
    html += '<span style="font:700 11px Space Mono,monospace;color:var(--ai)">'+(p[cfg.codeField]||'-')+'</span></div>';
  }
  if(type !== 'gemeenten' && p.gemeentenaam){
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0">';
    html += '<span style="font-size:11px;color:var(--mt)"><span class="mi mi-sm" style="font-size:13px;color:var(--cyan);vertical-align:-2px">domain</span> Gemeente</span>';
    html += '<span style="font:700 11px Space Mono,monospace;color:var(--cyan)">'+p.gemeentenaam+'</span></div>';
  }
  // Kerncijfers: inwoners, huishoudens, woningen
  var kernRows = [];
  if(p.aantal_inwoners && p.aantal_inwoners > 0) kernRows.push({icon:'groups', label:'Inwoners', val:p.aantal_inwoners.toLocaleString('nl-NL'), color:'var(--tx)'});
  if(p.huishoudens && p.huishoudens > 0) kernRows.push({icon:'family_restroom', label:'Huishoudens', val:p.huishoudens.toLocaleString('nl-NL'), color:'var(--tx)'});
  if(p.woningvoorraad && p.woningvoorraad > 0) kernRows.push({icon:'location_city', label:'Woningen', val:p.woningvoorraad.toLocaleString('nl-NL'), color:'var(--tx)'});
  if(p.koopwoningen !== undefined && p.koopwoningen !== null && p.woningvoorraad > 0){
    var ka = Math.round(p.woningvoorraad * p.koopwoningen / 100);
    kernRows.push({icon:'key', label:'Koopwoningen', val:ka.toLocaleString('nl-NL')+' ('+p.koopwoningen+'%)', color:'var(--ac)'});
  }
  if(p.huurwoningen !== undefined && p.huurwoningen !== null && p.woningvoorraad > 0){
    var ha = Math.round(p.woningvoorraad * p.huurwoningen / 100);
    kernRows.push({icon:'real_estate_agent', label:'Huurwoningen', val:ha.toLocaleString('nl-NL')+' ('+p.huurwoningen+'%)', color:'var(--wn)'});
  }

  // BAG adressen: totaal uit prefetch indexes, of on-demand ophalen
  if(geoFeature){
    var gemCode = p.gemeentecode || '';
    var bagStats = getBagStatsForFeature(geoFeature, type);
    if(bagStats.total !== null){
      kernRows.push({icon:'location_on', label:'BAG Adressen', val:bagStats.total.toLocaleString('nl-NL'), color:'var(--ai)'});
    } else {
      // Nog niet in index — toon placeholder en haal on-demand op
      kernRows.push({icon:'location_on', label:'BAG Adressen', val:'<span id="bagOnDemandCount" style="opacity:.5">tellen...</span>', color:'var(--ai)'});
      // Start on-demand fetch voor dit gebied
      fetchBagCountOnDemand(geoFeature, type, function(count){
        var el = document.getElementById('bagOnDemandCount');
        if(el) el.outerHTML = count.toLocaleString('nl-NL');
      });
    }
    // Extra: gemeente totaal als context bij wijken/buurten
    if(type !== 'gemeenten' && _bagIndex && gemCode && _bagIndex[gemCode] && bagStats.total === null){
      kernRows.push({icon:'domain', label:'BAG Gem. Totaal', val:_bagIndex[gemCode].count.toLocaleString('nl-NL')+' ('+escapeHtml(_bagIndex[gemCode].naam||gemCode)+')', color:'rgba(56,189,248,.6)'});
    }
  }

  kernRows.forEach(function(r){
    html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0">';
    html += '<span style="font-size:11px;color:var(--mt)"><span class="mi mi-sm" style="font-size:13px;color:'+r.color+';vertical-align:-2px">'+r.icon+'</span> '+r.label+'</span>';
    html += '<span style="font:700 11px Space Mono,monospace;color:'+r.color+'">'+r.val+'</span></div>';
  });
  html += '</div>';

  // Bij hover: toon actieve indicatoren
  // Bij klik: toon ALLE beschikbare indicatoren
  var indicatorKeys = isClick ? INDICATORS.map(function(fm){return fm.key}) : _activeIndicators;
  var findings = [];

  // Groepeer indicatoren per categorie
  var categories = [
    {label:'Bevolking', icon:'groups', color:'var(--ac)', keys:['aantal_inwoners','mannen','vrouwen','0_15','15_25','25_45','45_65','65plus','bevolkingsdichtheid','huishoudens','gem_huishouden_grootte']},
    {label:'Woningen', icon:'home', color:'var(--wn)', keys:['woningvoorraad','gem_woz_waarde','koopwoningen','huurwoningen','pct_eengezins']},
    {label:'Energie', icon:'bolt', color:'var(--cyan)', keys:['gem_aardgas','gem_elektriciteit']},
    {label:'Economie', icon:'payments', color:'var(--ai)', keys:['gem_inkomen_inwoner','arbeidsparticipatie','bedrijfsvestigingen','personenautos']},
    {label:'Voorzieningen', icon:'local_hospital', color:'#f59e0b', keys:['afstand_huisarts','afstand_supermarkt']}
  ];

  if(isClick){
    // UITGEBREID: alle indicatoren per categorie
    categories.forEach(function(cat){
      var catHtml = '';
      var catCount = 0;
      cat.keys.forEach(function(k){
        var v = p[k];
        if(v !== undefined && v !== null){
          catHtml += buildCompareHtml(k, v);
          catCount++;
          var ns = _nationalStats[k];
          if(ns && ns.stddev > 0){
            findings.push({level:typeLabel, naam:name, key:k, val:v, z:(v-ns.avg)/ns.stddev, avg:ns.avg, stddev:ns.stddev});
          }
        }
      });
      if(catCount > 0){
        html += '<div style="padding-top:6px;border-top:1px solid var(--glass-bd);margin-top:4px">';
        html += '<div style="font:600 10px DM Sans,sans-serif;color:'+cat.color+';margin-bottom:4px;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="font-size:13px">'+cat.icon+'</span> '+cat.label+' <span style="font-weight:400;color:var(--mt)">('+catCount+')</span></div>';
        html += catHtml + '</div>';
      }
    });
  } else {
    // Hover: alleen actieve indicatoren
    html += '<div style="padding-top:6px;border-top:1px solid var(--glass-bd)">';
    _activeIndicators.forEach(function(k){
      var v = p[k];
      if(v !== undefined && v !== null){
        html += buildCompareHtml(k, v);
        var ns = _nationalStats[k];
        if(ns && ns.stddev > 0){
          findings.push({level:typeLabel, naam:name, key:k, val:v, z:(v-ns.avg)/ns.stddev, avg:ns.avg, stddev:ns.stddev});
        }
      }
    });
    html += '</div>';
  }

  // AI Data-analyse bij klik
  if(isClick && findings.length > 0){
    html += buildFullAnalysis(findings, p, typeLabel, name);
  }

  document.getElementById('infoContent').innerHTML = html;
  document.getElementById('infoPanel').classList.add('show');
  if(isClick) logEvent(type.replace(/en$/,'')+'_klik', name);
}

// ============================================================
// HELPERS
// ============================================================
function quantileBreaks(sorted, n){
  var breaks = [];
  for(var i=1;i<n;i++) breaks.push(sorted[Math.floor(i*sorted.length/n)]);
  return breaks;
}
function getColor(val, breaks, colors){
  for(var i=0;i<breaks.length;i++){if(val<=breaks[i]) return colors[i]}
  return colors[colors.length-1];
}
function getIndicator(key){
  for(var i=0;i<INDICATORS.length;i++){if(INDICATORS[i].key===key) return INDICATORS[i]}
  return {key:key,naam:key,eenheid:'',icon:'bar_chart'};
}
function formatVal(v){
  if(v===null||v===undefined) return '-';
  if(v>=10000) return (v/1000).toFixed(0)+'k';
  if(v>=100) return Math.round(v).toLocaleString('nl-NL');
  if(v>=10) return v.toFixed(0);
  return v.toFixed(1);
}

// ============================================================
// LEGEND & STATS
// ============================================================
function updateLegend(breaks, colors){
  var el = document.getElementById('legend');
  var html = '';
  var labels = ['< '+formatVal(breaks[0])];
  for(var i=0;i<breaks.length-1;i++) labels.push(formatVal(breaks[i])+' \u2013 '+formatVal(breaks[i+1]));
  labels.push('> '+formatVal(breaks[breaks.length-1]));
  for(var i=0;i<colors.length;i++)
    html += '<div class="legend-row"><div class="legend-color" style="background:'+colors[i]+'"></div><span>'+(labels[i]||'')+'</span></div>';
  el.innerHTML = html;
}

function updateStats(vals, type){
  // Stats worden nu per indicator getoond via updateActiveStats()
}

// ============================================================
// UI CONTROLS
// ============================================================
function buildIndicatorList(){
  var el = document.getElementById('indicatorList');
  var html = '';
  var yearInds = _yearIndicators[_activeYear];
  var avSet = yearInds ? new Set(yearInds) : null;
  INDICATORS.forEach(function(fm){
    var hasData = !avSet || avSet.has(fm.key);
    if(!hasData) return; // Verberg indicatoren zonder data voor dit jaar
    var isActive = _activeIndicators.indexOf(fm.key) >= 0;
    var isPrimary = _activeIndicators[0] === fm.key;
    var cls = isPrimary ? 'ind-item primary' : (isActive ? 'ind-item active' : 'ind-item');
    html += '<div class="'+cls+'" data-ind="'+fm.key+'" onclick="toggleIndicator(\''+fm.key+'\')">';
    html += '<div class="ind-icon"><span class="mi">'+fm.icon+'</span></div>';
    html += '<span class="ind-name">'+fm.naam+'</span>';
    html += '<span class="ind-unit">'+fm.eenheid+'</span>';
    html += '<span class="ind-badge">KAART</span>';
    html += '</div>';
  });
  el.innerHTML = html;
}

function toggleIndicator(key){
  var idx = _activeIndicators.indexOf(key);
  if(idx >= 0){
    // Minimaal 1 indicator actief houden
    if(_activeIndicators.length <= 1){toast('Minimaal 1 indicator actief');return}
    _activeIndicators.splice(idx, 1);
    logEvent('indicator_uit', key);
  } else {
    _activeIndicators.push(key);
    logEvent('indicator_aan', key);
  }
  buildIndicatorList();
  updateMap();
  updateActiveStats();
}

function setPrimaryIndicator(key){
  var idx = _activeIndicators.indexOf(key);
  if(idx < 0) return;
  _activeIndicators.splice(idx, 1);
  _activeIndicators.unshift(key);
  logEvent('indicator_primair', key);
  buildIndicatorList();
  updateMap();
  updateActiveStats();
}

function getActiveData(){
  // Meest gedetailleerde beschikbare data (ongeacht of laag actief is)
  // Dit zorgt dat nationalStats altijd berekend kan worden
  if(_buurtData) return _buurtData;
  if(_wijkData) return _wijkData;
  return _gemeenteData;
}

// Bereken landelijke stats per indicator voor de actieve data
function computeNationalStats(){
  var data = getActiveData();
  if(!data){_nationalStats={};return}
  _nationalStats = {};
  INDICATORS.forEach(function(fm){
    var vals = [];
    data.features.forEach(function(f){
      var v = f.properties[fm.key];
      if(v !== undefined && v !== null && v >= 0) vals.push(v);
    });
    if(!vals.length) return;
    vals.sort(function(a,b){return a-b});
    var n = vals.length;
    var sum = vals.reduce(function(a,b){return a+b},0);
    var mean = sum / n;
    var median = vals[Math.floor(n/2)];
    var variance = vals.reduce(function(a,b){return a+(b-mean)*(b-mean)},0)/n;
    var stddev = Math.sqrt(variance);
    // Skewness (Pearson)
    var skewSum = vals.reduce(function(a,b){var d=(b-mean)/stddev;return a+d*d*d},0);
    var skewness = stddev > 0 ? skewSum/n : 0;
    var distType = 'normaal';
    if(Math.abs(skewness) < 0.5) distType = 'normaal';
    else if(skewness > 0) distType = 'rechts scheef';
    else distType = 'links scheef';
    // Percentilen voor bar
    var p10 = vals[Math.floor(n*0.1)], p90 = vals[Math.floor(n*0.9)];
    _nationalStats[fm.key] = {min:vals[0],max:vals[n-1],avg:mean,median:median,stddev:stddev,count:n,skewness:skewness,distType:distType,p10:p10,p90:p90};
  });
}

// Genereer SVG normaalverdeling curve met positie-marker
function buildDistSvg(zScore, distType){
  var w=220,h=56,pad=5;
  var pts=[];
  // Bel-curve genereren (of scheef als distType aangeeft)
  var skew = distType==='rechts scheef'?0.6:(distType==='links scheef'?-0.6:0);
  for(var i=0;i<=40;i++){
    var x = -3.5 + i*7/40;
    var xs = x - skew;
    var y = Math.exp(-0.5*xs*xs)/2.5066; // normaal PDF
    pts.push({x:pad+(i/40)*(w-2*pad), y:h-pad-y*(h-2*pad)*2.8});
  }
  var path = 'M'+pts[0].x+','+((h-pad))+' ';
  pts.forEach(function(p){path+='L'+p.x+','+p.y+' '});
  path += 'L'+pts[pts.length-1].x+','+(h-pad)+' Z';
  // Marker positie: z-score naar x
  var zClamped = Math.max(-3.5,Math.min(3.5,zScore));
  var mx = pad+((zClamped+3.5)/7)*(w-2*pad);
  // Kleur zones (sigma)
  var svg = '<svg width="'+w+'" height="'+h+'" viewBox="0 0 '+w+' '+h+'" style="display:block;margin:2px 0">';
  // Vulling met gradient
  svg += '<defs><linearGradient id="gc'+Math.abs(Math.round(zScore*100))+'" x1="0" y1="0" x2="1" y2="0">';
  svg += '<stop offset="0%" stop-color="#ef4444" stop-opacity="0.3"/>';
  svg += '<stop offset="15%" stop-color="#fbbf24" stop-opacity="0.3"/>';
  svg += '<stop offset="35%" stop-color="#38bdf8" stop-opacity="0.3"/>';
  svg += '<stop offset="65%" stop-color="#38bdf8" stop-opacity="0.3"/>';
  svg += '<stop offset="85%" stop-color="#fbbf24" stop-opacity="0.3"/>';
  svg += '<stop offset="100%" stop-color="#ef4444" stop-opacity="0.3"/>';
  svg += '</linearGradient></defs>';
  svg += '<path d="'+path+'" fill="url(#gc'+Math.abs(Math.round(zScore*100))+')" stroke="rgba(226,232,240,0.3)" stroke-width="1"/>';
  // Sigma lijnen
  [-2,-1,0,1,2].forEach(function(s){
    var sx=pad+((s+3.5)/7)*(w-2*pad);
    var op=s===0?0.5:0.15;
    svg+='<line x1="'+sx+'" y1="'+(pad)+'" x2="'+sx+'" y2="'+(h-pad)+'" stroke="rgba(226,232,240,'+op+')" stroke-width="'+(s===0?1.5:0.5)+'" stroke-dasharray="'+(s===0?'':'2,2')+'"/>';
  });
  // Waarde marker
  svg += '<line x1="'+mx+'" y1="2" x2="'+mx+'" y2="'+(h-2)+'" stroke="#39ff14" stroke-width="2"/>';
  svg += '<circle cx="'+mx+'" cy="6" r="3" fill="#39ff14"/>';
  // Sigma labels
  svg += '<text x="'+pad+'" y="'+(h-1)+'" font-size="8" fill="rgba(226,232,240,0.5)" font-family="Space Mono,monospace">-3\u03c3</text>';
  svg += '<text x="'+(w-pad-18)+'" y="'+(h-1)+'" font-size="8" fill="rgba(226,232,240,0.5)" font-family="Space Mono,monospace">+3\u03c3</text>';
  svg += '</svg>';
  return svg;
}

// AI-achtige menselijke uitleg per indicator — alsof je het aan een kind uitlegt
function humanExplain(key, val, z, ns, fm){
  var abs = Math.abs(z);
  var h = z >= 0 ? 'meer' : 'minder';
  var hb = z >= 0 ? 'hoger' : 'lager';
  var v = formatVal(val);
  var gem = formatVal(ns.avg);

  // Per indicator: context-rijke uitleg in gewone mensentaal
  if(key === 'aantal_inwoners'){
    if(abs < 0.5) return 'Hier wonen ongeveer evenveel mensen als in een gemiddeld Nederlands gebied.';
    if(z > 0) return 'Dit is een druk gebied \u2014 hier wonen '+h+' mensen dan in de meeste andere gebieden. Denk aan een levendige wijk met veel buren.';
    return 'Dit is een rustig gebied met relatief weinig inwoners. Denk aan een klein dorp of buitenwijk.';
  }
  if(key === 'gem_woz_waarde'){
    var euros = val * 1000;
    if(abs < 0.5) return 'De huizen hier kosten ongeveer wat een gemiddeld huis in Nederland kost (\u00b1\u20ac'+Math.round(ns.avg*1000).toLocaleString('nl-NL')+').';
    if(z > 1.5) return 'De huizen hier zijn flink duurder dan gemiddeld. Dit is een populair of gewild woongebied \u2014 vergelijkbaar met de duurdere wijken in grote steden.';
    if(z > 0) return 'De huizen hier zijn iets duurder dan gemiddeld in Nederland. Een prettige buurt waar mensen graag wonen.';
    if(z < -1.5) return 'De huizen hier zijn een stuk goedkoper dan gemiddeld. Dat kan komen door de locatie, het type woningen of de voorzieningen in de buurt.';
    return 'De huizen hier zijn iets goedkoper dan het Nederlands gemiddelde.';
  }
  if(key === 'gem_inkomen_inwoner'){
    if(abs < 0.5) return 'De mensen hier verdienen ongeveer evenveel als een gemiddelde Nederlander.';
    if(z > 1.5) return 'Hier wonen mensen met duidelijk hogere inkomens. Denk aan een welvarende wijk met tweeverdieners of hogere functies.';
    if(z > 0) return 'De inkomens zijn hier iets hoger dan gemiddeld \u2014 de meeste bewoners zitten financieel goed.';
    if(z < -1.5) return 'De inkomens zijn hier lager dan in de meeste andere buurten. Dat kan komen door meer uitkeringsgerechtigden, studenten of gepensioneerden.';
    return 'De inkomens zijn hier iets lager dan gemiddeld in Nederland.';
  }
  if(key === 'koopwoningen'){
    if(abs < 0.5) return 'Er is hier een gezonde mix van koop- en huurwoningen, net als in de meeste Nederlandse buurten.';
    if(z > 1) return 'Hier staan vooral koopwoningen \u2014 de meeste bewoners zijn eigenaar van hun huis. Typisch voor een rustige, gevestigde buurt.';
    if(z < -1) return 'Hier wordt veel gehuurd. Denk aan een stedelijke buurt met flats of sociale woningbouw.';
    return z > 0 ? 'Iets meer koopwoningen dan gemiddeld.' : 'Iets meer huurwoningen dan gemiddeld.';
  }
  if(key === '65plus'){
    if(abs < 0.5) return 'De leeftijdsverdeling is hier normaal \u2014 een gezonde mix van jong en oud.';
    if(z > 1.5) return 'Dit is een vergrijzende buurt \u2014 hier wonen opvallend veel 65-plussers. Mogelijk een rustig woongebied dat populair is bij gepensioneerden.';
    if(z > 0) return 'Er wonen hier iets meer ouderen dan gemiddeld.';
    if(z < -1) return 'Dit is een jonge buurt \u2014 weinig 65-plussers. Waarschijnlijk veel gezinnen of jonge stellen.';
    return 'Iets minder 65-plussers dan gemiddeld.';
  }
  if(key === 'bevolkingsdichtheid'){
    if(abs < 0.5) return 'Een normaal bebouwd gebied, niet te druk en niet te leeg.';
    if(z > 1.5) return 'Een dichtbebouwde stadswijk \u2014 veel mensen op weinig ruimte. Denk aan een buurt met flats, appartementen en weinig tuinen.';
    if(z > 0) return 'Iets drukker bebouwd dan gemiddeld, maar nog ruim vergeleken met de binnenstad.';
    if(z < -1.5) return 'Een heel ruim en open gebied \u2014 veel groen, grote kavels of agrarisch land. Typisch voor het platteland.';
    return 'Iets minder dicht bebouwd dan gemiddeld.';
  }
  if(key === 'gem_aardgas'){
    if(abs < 0.5) return 'Het gasverbruik is hier gemiddeld voor Nederland.';
    if(z > 1.5) return 'Hier wordt veel gas verstookt! Dat kan betekenen dat de woningen ouder of slecht ge\u00efsoleerd zijn, of dat er veel met gas gekookt en verwarmd wordt.';
    if(z > 0) return 'Het gasverbruik is iets hoger dan gemiddeld \u2014 mogelijk oudere woningen met minder isolatie.';
    if(z < -1.5) return 'Heel weinig gasverbruik \u2014 dit wijst op nieuwbouw, goede isolatie, of woningen met een warmtepomp. Goed voor het milieu!';
    return 'Iets minder gasverbruik dan gemiddeld \u2014 redelijk energiezuinig.';
  }
  if(key === 'gem_elektriciteit'){
    if(abs < 0.5) return 'Het stroomverbruik is hier normaal.';
    if(z > 1) return 'Hier wordt meer stroom gebruikt dan gemiddeld. Mogelijk grotere woningen, meer apparaten, of elektrisch verwarmen.';
    if(z < -1) return 'Laag stroomverbruik \u2014 mogelijk kleinere woningen of bewust zuinige bewoners.';
    return z > 0 ? 'Iets meer stroomverbruik dan gemiddeld.' : 'Iets minder stroomverbruik dan gemiddeld.';
  }
  if(key === 'gem_huishouden_grootte'){
    if(abs < 0.5) return 'De huishoudens zijn hier gemiddeld van grootte.';
    if(z > 1) return 'Hier wonen veel gezinnen \u2014 de huishoudens zijn groter dan gemiddeld. Denk aan gezinnen met kinderen.';
    if(z < -1) return 'Hier wonen veel alleenstaanden of stellen zonder kinderen \u2014 de huishoudens zijn klein.';
    return z > 0 ? 'Iets grotere huishoudens dan gemiddeld.' : 'Iets kleinere huishoudens dan gemiddeld.';
  }
  if(key === 'arbeidsparticipatie'){
    if(abs < 0.5) return 'Ongeveer evenveel mensen werken hier als in de rest van Nederland.';
    if(z > 1) return 'Hier werken veel mensen \u2014 een actieve buurt met veel tweeverdieners. Goed teken voor de lokale economie.';
    if(z < -1) return 'Minder mensen werken hier dan gemiddeld. Dat kan komen door vergrijzing, studenten, of een hoger percentage uitkeringsgerechtigden.';
    return z > 0 ? 'Iets meer werkenden dan gemiddeld.' : 'Iets minder werkenden dan gemiddeld.';
  }
  if(key === 'afstand_huisarts'){
    if(abs < 0.5) return 'De huisarts is op een normale afstand \u2014 niet ver, niet dichtbij.';
    if(z > 1) return 'De huisarts is hier ver weg. Bewoners moeten verder rijden voor medische zorg \u2014 typisch voor dunbevolkte gebieden.';
    if(z < -1) return 'De huisarts is heel dichtbij \u2014 handig, vooral voor ouderen en gezinnen met kleine kinderen.';
    return z > 0 ? 'De huisarts is iets verder weg dan gemiddeld.' : 'De huisarts is dichterbij dan gemiddeld.';
  }
  if(key === 'afstand_supermarkt'){
    if(abs < 0.5) return 'De supermarkt is op een normale afstand.';
    if(z > 1) return 'De dichtstbijzijnde supermarkt is ver weg \u2014 boodschappen doen zonder auto is lastig hier.';
    if(z < -1) return 'Heel handig: de supermarkt is vlakbij! Lekker voor als je snel iets nodig hebt.';
    return z > 0 ? 'De supermarkt is iets verder dan gemiddeld.' : 'De supermarkt is iets dichterbij dan gemiddeld.';
  }
  if(key === 'huishoudens' || key === 'woningvoorraad'){
    if(abs < 0.5) return 'Een gemiddeld aantal voor een Nederlands gebied.';
    if(z > 1) return 'Een groot gebied met veel '+(key==='huishoudens'?'huishoudens':'woningen')+' \u2014 waarschijnlijk een stadswijk of groot dorp.';
    if(z < -1) return 'Een klein gebied met weinig '+(key==='huishoudens'?'huishoudens':'woningen')+' \u2014 waarschijnlijk een rustig buurtje.';
    return z > 0 ? 'Iets meer dan gemiddeld.' : 'Iets minder dan gemiddeld.';
  }
  if(key === 'bedrijfsvestigingen'){
    if(abs < 0.5) return 'Een normale mix van wonen en werken.';
    if(z > 1) return 'Hier zijn veel bedrijven gevestigd \u2014 een ondernemend en economisch actief gebied.';
    if(z < -1) return 'Weinig bedrijven hier \u2014 dit is vooral een woongebied.';
    return z > 0 ? 'Iets meer bedrijvigheid dan gemiddeld.' : 'Iets minder bedrijvigheid dan gemiddeld.';
  }
  if(key === 'huurwoningen'){
    if(abs < 0.5) return 'Een normale verdeling van huur- en koopwoningen.';
    if(z > 1) return 'Hier wordt veel gehuurd \u2014 typisch voor een buurt met sociale woningbouw of studentenflats.';
    if(z < -1) return 'Weinig huurwoningen \u2014 de meeste bewoners zijn huiseigenaar.';
    return z > 0 ? 'Iets meer huurwoningen dan gemiddeld.' : 'Iets minder huurwoningen dan gemiddeld.';
  }
  if(key === 'pct_eengezins'){
    if(abs < 0.5) return 'Een normale mix van eengezins- en meergezinswoningen.';
    if(z > 1) return 'Vooral rijtjeshuizen en vrijstaande woningen hier \u2014 een typische gezinsbuurt met tuinen.';
    if(z < -1) return 'Weinig eengezinswoningen \u2014 hier staan vooral flats en appartementen.';
    return z > 0 ? 'Iets meer eengezinswoningen dan gemiddeld.' : 'Meer appartementen dan gemiddeld.';
  }
  if(key === 'personenautos'){
    if(abs < 0.5) return 'Een normaal aantal auto\'s voor dit soort gebied.';
    if(z > 1) return 'Veel auto\'s in deze buurt \u2014 bewoners zijn afhankelijk van de auto, waarschijnlijk omdat het OV minder goed bereikbaar is.';
    if(z < -1) return 'Weinig auto\'s \u2014 bewoners fietsen, lopen of pakken het OV. Typisch voor een goed bereikbare stadswijk.';
    return z > 0 ? 'Iets meer auto\'s dan gemiddeld.' : 'Iets minder auto\'s dan gemiddeld.';
  }
  // Leeftijdsgroepen
  if(key === '0_15'){
    if(abs < 0.5) return 'Een normaal percentage kinderen \u2014 een gemiddelde mix van gezinnen.';
    if(z > 1) return 'Veel kinderen in deze buurt! Een echte gezinsbuurt, waarschijnlijk met scholen en speeltuinen in de buurt.';
    if(z < -1) return 'Weinig kinderen \u2014 hier wonen vooral volwassenen en ouderen.';
    return z > 0 ? 'Iets meer kinderen dan gemiddeld.' : 'Iets minder kinderen dan gemiddeld.';
  }
  if(key === '15_25'){
    if(abs < 0.5) return 'Een normaal percentage jongeren.';
    if(z > 1) return 'Veel jongeren! Mogelijk een studentenwijk of een buurt populair bij starters.';
    if(z < -1) return 'Weinig jongeren \u2014 een gevestigde buurt met vooral volwassenen en ouderen.';
    return z > 0 ? 'Iets meer jongeren dan gemiddeld.' : 'Iets minder jongeren dan gemiddeld.';
  }
  if(key === '25_45'){
    if(abs < 0.5) return 'Een normaal aandeel werkende volwassenen.';
    if(z > 1) return 'Veel jonge werkenden \u2014 een dynamische buurt met carrièremakers en jonge gezinnen.';
    if(z < -1) return 'Minder jonge werkenden dan gemiddeld \u2014 waarschijnlijk een oudere of meer vergrijsde buurt.';
    return z > 0 ? 'Iets meer 25-45 jarigen.' : 'Iets minder 25-45 jarigen.';
  }
  if(key === '45_65'){
    if(abs < 0.5) return 'Een normaal aandeel 45-65 jarigen.';
    if(z > 1) return 'Veel 45-plussers \u2014 een gevestigde buurt waar mensen al langere tijd wonen.';
    if(z < -1) return 'Minder 45-65 jarigen \u2014 een jongere buurt.';
    return z > 0 ? 'Iets meer 45-65 jarigen.' : 'Iets minder 45-65 jarigen.';
  }
  if(key === 'mannen' || key === 'vrouwen'){
    if(abs < 0.5) return 'Een normale verhouding.';
    return z > 0 ? 'Iets meer '+fm.naam.toLowerCase()+' dan gemiddeld.' : 'Iets minder '+fm.naam.toLowerCase()+' dan gemiddeld.';
  }
  // Fallback
  if(abs < 0.5) return 'Dit is een gemiddelde waarde voor Nederland.';
  if(z > 0) return 'Dit is '+hb+' dan in de meeste andere gebieden.';
  return 'Dit is '+hb+' dan in de meeste andere gebieden.';
}

// Interpreteer z-score in menselijke taal
function interpretZScore(z, key, fm){
  var abs = Math.abs(z);
  var richting = z >= 0 ? 'hoog' : 'laag';
  var isReverse = REVERSE_KEYS.indexOf(key) >= 0;
  // Bij "afstand" indicatoren is lager = beter
  if(isReverse){ richting = z >= 0 ? 'ver' : 'dichtbij'; }

  if(abs < 0.5) return '<span style="color:var(--ai)">Gemiddeld</span> \u2014 typisch voor Nederland';
  if(abs < 1.0) return '<span style="color:var(--ai)">Licht '+richting+'</span> \u2014 binnen normaal bereik';
  if(abs < 1.5) return '<span style="color:var(--wn)">Bovengemiddeld '+richting+'</span> \u2014 top '+(z>0?'30':'30')+'%';
  if(abs < 2.0) return '<span style="color:var(--wn)">'+(richting==='hoog'||richting==='ver'?'Hoog':'Laag')+'</span> \u2014 top '+(z>0?'7':'7')+'%';
  if(abs < 2.5) return '<span style="color:var(--dn)">Zeer '+(richting==='hoog'||richting==='ver'?'hoog':'laag')+'</span> \u2014 top 2%';
  return '<span style="color:var(--dn)">Extreem '+(richting==='hoog'||richting==='ver'?'hoog':'laag')+'</span> \u2014 uitzonderlijk (<1%)';
}

// Bouw vergelijking HTML voor een indicator waarde vs landelijk
function buildCompareHtml(key, val){
  var ns = _nationalStats[key];
  if(!ns || val === undefined || val === null || val < 0) return '';
  var fm = getIndicator(key);
  var pctDiff = ns.avg > 0 ? ((val - ns.avg) / ns.avg * 100) : 0;
  var pctSign = pctDiff >= 0 ? '+' : '';
  var diffClass = pctDiff >= 0 ? 'up' : 'dn';
  var diffLabel = pctDiff >= 0 ? 'boven' : 'onder';
  var zScore = ns.stddev > 0 ? ((val - ns.avg) / ns.stddev) : 0;
  // Positie op de balk (0-100%)
  var range = ns.max - ns.min;
  var pos = range > 0 ? Math.min(100, Math.max(0, (val - ns.min) / range * 100)) : 50;
  var avgPos = range > 0 ? Math.min(100, Math.max(0, (ns.avg - ns.min) / range * 100)) : 50;

  var html = '<div style="margin-bottom:12px;padding:10px 12px;background:rgba(15,20,35,.5);border-radius:10px;border-left:3px solid '+getBarColor(zScore)+'">';
  // Regel 1: naam + waarde
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
  html += '<span style="font:600 13px \'DM Sans\',sans-serif;color:var(--tx);display:flex;align-items:center;gap:5px"><span class="mi" style="font-size:16px;color:var(--ai)">'+fm.icon+'</span>'+fm.naam+'</span>';
  html += '<span style="font:700 15px \'Space Mono\',monospace;color:var(--ac)">'+formatVal(val)+' <span style="font-size:10px;font-weight:400;color:var(--mt)">'+fm.eenheid+'</span></span>';
  html += '</div>';
  // Regel 2: vergelijking
  html += '<div style="font-size:12px;color:var(--mt);margin-bottom:4px;line-height:1.5">';
  html += '<span class="'+diffClass+'" style="font-weight:700">'+pctSign+pctDiff.toFixed(0)+'%</span> '+diffLabel+' gemiddeld';
  html += ' <span style="opacity:.6">(gem. '+formatVal(ns.avg)+' '+fm.eenheid+')</span>';
  html += ' &middot; <span style="opacity:.6">z = '+zScore.toFixed(1)+'</span>';
  html += '</div>';
  // Normaalverdeling SVG
  html += buildDistSvg(zScore, ns.distType);
  // Korte statistische interpretatie
  html += '<div style="font-size:11px;color:var(--mt);margin-top:3px;line-height:1.5">'+interpretZScore(zScore, key, fm)+'</div>';
  // Menselijke uitleg (kindertaal)
  html += '<div style="font-size:11px;color:var(--tx);margin-top:4px;padding:6px 10px;background:rgba(57,255,20,.03);border-radius:6px;border-left:2px solid rgba(57,255,20,.15);line-height:1.6">';
  html += '<span class="mi mi-sm" style="font-size:13px;color:var(--ac);vertical-align:-2px">lightbulb</span> ';
  html += humanExplain(key, val, zScore, ns, fm);
  html += '</div>';
  // Bar met positie
  html += '<div class="info-bar" style="height:6px;margin:6px 0 0;border-radius:3px">';
  html += '<div class="info-bar-fill" style="width:'+pos+'%;background:'+getBarColor(zScore)+';border-radius:3px"></div>';
  html += '<div class="info-bar-marker" style="left:'+avgPos+'%;top:-2px;height:10px;width:2px;background:var(--tx);opacity:.5" title="Gem: '+formatVal(ns.avg)+'"></div>';
  html += '</div>';
  // min — max
  html += '<div style="display:flex;justify-content:space-between;margin-top:3px">';
  html += '<span style="font:400 9px \'Space Mono\',monospace;color:var(--mt);opacity:.6">'+formatVal(ns.min)+'</span>';
  html += '<span style="font:400 9px \'Space Mono\',monospace;color:var(--mt);opacity:.6">'+formatVal(ns.max)+'</span>';
  html += '</div>';
  html += '</div>';
  return html;
}

function getBarColor(z){
  if(z > 1.5) return 'var(--up)';
  if(z > 0.5) return 'var(--ac2)';
  if(z > -0.5) return 'var(--ai)';
  if(z > -1.5) return 'var(--wn)';
  return 'var(--dn)';
}

function updateActiveStats(){
  computeNationalStats();
}

function updateMap(){
  if(_layerState.gemeenten && _gemeenteData) renderChoropleth('gemeenten');
  if(_layerState.buurten && _buurtData) renderChoropleth('buurten');
  if(_layerState.wijken && _wijkData) renderChoropleth('wijken');
  updateActiveStats();
}

// ============================================================
// MULTI-SELECT DROPDOWNS
// ============================================================
var _selectedGemeenten = [];  // Geselecteerde gemeentenamen
var _selectedWijken = [];     // Geselecteerde wijknamen
var _selectedBuurten = [];    // Geselecteerde buurtnamen
var _allWijkNamen = [];       // Alle beschikbare wijknamen
var _allBuurtNamen = [];      // Alle beschikbare buurtnamen

function getMsIds(wrapId){
  if(wrapId==='msGemeente') return {dd:'msGemDropdown',opts:'msGemOptions',label:'msGemLabel',chips:'msGemChips'};
  if(wrapId==='msWijk') return {dd:'msWijkDropdown',opts:'msWijkOptions',label:'msWijkLabel',chips:'msWijkChips'};
  return {dd:'msBuurtDropdown',opts:'msBuurtOptions',label:'msBuurtLabel',chips:'msBuurtChips'};
}

function toggleMsDropdown(wrapId){
  var ids = getMsIds(wrapId);
  var dd = document.getElementById(ids.dd);
  var wasOpen = dd.classList.contains('open');
  // Sluit alle dropdowns
  document.querySelectorAll('.ms-dropdown').forEach(function(d){ d.classList.remove('open'); });
  if(!wasOpen){
    dd.classList.add('open');
    dd.querySelector('.ms-search').focus();
  }
}

function filterMsOptions(wrapId, query){
  var ids = getMsIds(wrapId);
  var optsEl = document.getElementById(ids.opts);
  var q = query.toLowerCase().trim();
  var items = optsEl.children;
  for(var i = 0; i < items.length; i++){
    var text = items[i].getAttribute('data-name').toLowerCase();
    items[i].style.display = (!q || text.indexOf(q) >= 0) ? '' : 'none';
  }
}

function getMsArr(wrapId){
  if(wrapId==='msGemeente') return _selectedGemeenten;
  if(wrapId==='msWijk') return _selectedWijken;
  return _selectedBuurten;
}

function toggleMsOption(wrapId, name){
  var arr = getMsArr(wrapId);
  var idx = arr.indexOf(name);
  if(idx >= 0) arr.splice(idx, 1);
  else arr.push(name);
  updateMsUI(wrapId);
  onFilterChange();
}

function removeMsChip(wrapId, name){
  var arr = getMsArr(wrapId);
  var idx = arr.indexOf(name);
  if(idx >= 0) arr.splice(idx, 1);
  updateMsUI(wrapId);
  onFilterChange();
}

function updateMsUI(wrapId){
  var ids = getMsIds(wrapId);
  var arr = getMsArr(wrapId);
  var label = document.getElementById(ids.label);
  var chipsEl = document.getElementById(ids.chips);
  var optsEl = document.getElementById(ids.opts);
  var typeLabel = wrapId==='msGemeente'?'gemeenten':(wrapId==='msWijk'?'wijken':'buurten');

  // Label
  if(arr.length === 0) label.textContent = 'Alle '+typeLabel;
  else if(arr.length === 1) label.textContent = arr[0];
  else label.textContent = arr.length + ' ' + typeLabel;

  // Chips
  var ch = '';
  arr.forEach(function(n){
    ch += '<span class="ms-chip" onclick="removeMsChip(\''+wrapId+'\',\''+n.replace(/'/g,"\\'")+'\')">' + n + ' <span class="mi">close</span></span>';
  });
  chipsEl.innerHTML = ch;

  // Options selected state
  var items = optsEl.children;
  for(var i = 0; i < items.length; i++){
    var n = items[i].getAttribute('data-name');
    items[i].classList.toggle('selected', arr.indexOf(n) >= 0);
  }

  // Toon knoppen als er iets geselecteerd is
  var hasSelection = _selectedGemeenten.length > 0 || _selectedWijken.length > 0 || _selectedBuurten.length > 0;
  var btn = document.getElementById('loadSelectionBtn');
  if(btn) btn.style.display = hasSelection ? 'flex' : 'none';
  var cmpBtn = document.getElementById('compareBtn');
  if(cmpBtn) cmpBtn.style.display = (_selectedGemeenten.length >= 2 || _selectedWijken.length >= 2 || _selectedBuurten.length >= 2) ? 'flex' : 'none';

  // BAG adres-aantallen tonen voor geselecteerde gemeenten
  updateBagSelectionInfo();
}

function updateBagSelectionInfo(){
  var el = document.getElementById('bagSelectionInfo');
  var txt = document.getElementById('bagSelectionText');
  if(!el || !txt) return;
  if(_selectedGemeenten.length === 0 || !_bagIndex || !_gemeenteData){
    el.style.display = 'none';
    return;
  }
  // Zoek codes voor geselecteerde namen
  var totalBag = 0;
  var beschikbaar = 0;
  _gemeenteData.features.forEach(function(f){
    var p = f.properties;
    if(!p.gemeentenaam || _selectedGemeenten.indexOf(p.gemeentenaam) < 0) return;
    var code = p.gemeentecode;
    if(code && _bagIndex[code]){
      totalBag += _bagIndex[code].count;
      beschikbaar++;
    }
  });
  if(beschikbaar > 0){
    el.style.display = 'flex';
    txt.textContent = totalBag.toLocaleString('nl-NL')+' BAG adressen beschikbaar ('+beschikbaar+'/'+_selectedGemeenten.length+' gemeenten)';
  } else {
    el.style.display = 'flex';
    txt.textContent = 'Geen BAG data beschikbaar voor deze gemeenten';
    txt.parentElement.style.color = 'var(--mt)';
  }
}

function buildGemeenteFilter(){
  var sorted = Array.from(_gemeenteNamen).sort();
  document.getElementById('sGemeenten').textContent = sorted.length;
  // Maak naam->code lookup
  var naamToCode = {};
  if(_gemeenteData){
    _gemeenteData.features.forEach(function(f){
      var p = f.properties;
      if(p.gemeentenaam && p.gemeentecode) naamToCode[p.gemeentenaam] = p.gemeentecode;
    });
  }
  var optsEl = document.getElementById('msGemOptions');
  var html = '';
  sorted.forEach(function(g){
    var code = naamToCode[g] || '';
    var bagInfo = '';
    if(_bagIndex && code && _bagIndex[code]){
      var cnt = _bagIndex[code].count;
      bagInfo = '<span style="font:400 9px Space Mono,monospace;color:var(--ai);margin-left:auto;flex-shrink:0">'+cnt.toLocaleString('nl-NL')+' adr.</span>';
    }
    html += '<div class="ms-opt" data-name="'+g+'" onclick="toggleMsOption(\'msGemeente\',\''+g.replace(/'/g,"\\'")+'\')" style="display:flex;align-items:center;gap:4px">';
    html += '<span class="ms-check"><span class="mi" style="font-size:10px">check</span></span>';
    html += '<span>'+g+'</span>'+bagInfo+'</div>';
  });
  optsEl.innerHTML = html;
}

function buildWijkFilter(){
  if(!_wijkData) return;
  // Bouw naam-naar-code mapping
  var wijkNaamToCode = {};
  var names = new Set();
  _wijkData.features.forEach(function(f){
    var n = f.properties.wijknaam;
    var g = f.properties.gemeentenaam;
    var code = f.properties.wijkcode || '';
    if(n){
      if(_selectedGemeenten.length === 0 || _selectedGemeenten.indexOf(g) >= 0){
        var display = n + ' ('+g+')';
        names.add(display);
        if(code) wijkNaamToCode[display] = code;
      }
    }
  });
  _allWijkNamen = Array.from(names).sort();
  var optsEl = document.getElementById('msWijkOptions');
  var html = '';
  _allWijkNamen.forEach(function(n){
    var code = wijkNaamToCode[n] || '';
    var bagInfo = '';
    if(code && _bagWijkIndex[code]){
      var cnt = _bagWijkIndex[code].count;
      bagInfo = '<span style="font:400 8px Space Mono,monospace;color:var(--ai);margin-left:auto;flex-shrink:0">'+cnt.toLocaleString('nl-NL')+' adr.</span>';
    }
    html += '<div class="ms-opt" data-name="'+n.replace(/"/g,'&quot;')+'" onclick="toggleMsOption(\'msWijk\',\''+n.replace(/'/g,"\\'")+'\')" style="display:flex;align-items:center;gap:4px">';
    html += '<span class="ms-check"><span class="mi" style="font-size:10px">check</span></span>';
    html += '<span style="font-size:10px;flex:1">'+n+'</span>'+bagInfo+'</div>';
  });
  optsEl.innerHTML = html;
  // Trigger subarea prefetch als nog niet gestart
  if(Object.keys(_bagWijkIndex).length === 0 && !_bagSubPrefetching && _bagIndex && Object.keys(_bagIndex).length > 0){
    setTimeout(prefetchBagSubareaCounts, 1000);
  }
}

function buildBuurtFilter(){
  if(!_buurtData) return;
  var buurtNaamToCode = {};
  var names = new Set();
  _buurtData.features.forEach(function(f){
    var n = f.properties.buurtnaam;
    var g = f.properties.gemeentenaam;
    var code = f.properties.buurtcode || '';
    if(n){
      if(_selectedGemeenten.length === 0 || _selectedGemeenten.indexOf(g) >= 0){
        var display = n + ' ('+g+')';
        names.add(display);
        if(code) buurtNaamToCode[display] = code;
      }
    }
  });
  _allBuurtNamen = Array.from(names).sort();
  var optsEl = document.getElementById('msBuurtOptions');
  var html = '';
  _allBuurtNamen.forEach(function(n){
    var code = buurtNaamToCode[n] || '';
    var bagInfo = '';
    if(code && _bagBuurtIndex[code]){
      var cnt = _bagBuurtIndex[code].count;
      bagInfo = '<span style="font:400 8px Space Mono,monospace;color:var(--ai);margin-left:auto;flex-shrink:0">'+cnt.toLocaleString('nl-NL')+' adr.</span>';
    }
    html += '<div class="ms-opt" data-name="'+n.replace(/"/g,'&quot;')+'" onclick="toggleMsOption(\'msBuurt\',\''+n.replace(/'/g,"\\'")+'\')" style="display:flex;align-items:center;gap:4px">';
    html += '<span class="ms-check"><span class="mi" style="font-size:10px">check</span></span>';
    html += '<span style="font-size:10px;flex:1">'+n+'</span>'+bagInfo+'</div>';
  });
  optsEl.innerHTML = html;
  // Trigger subarea prefetch als nog niet gestart
  if(Object.keys(_bagBuurtIndex).length === 0 && !_bagSubPrefetching && _bagIndex && Object.keys(_bagIndex).length > 0){
    setTimeout(prefetchBagSubareaCounts, 1000);
  }
}

function getSelectedGemeenteFilter(){
  // Retourneert 'all' of Set van gemeentenamen
  if(_selectedGemeenten.length === 0) return 'all';
  return new Set(_selectedGemeenten);
}

function getSelectedWijkFilter(){
  if(_selectedWijken.length === 0) return 'all';
  var names = new Set();
  _selectedWijken.forEach(function(n){
    var m = n.match(/^(.+?) \(/);
    if(m) names.add(m[1]);
    else names.add(n);
  });
  return names;
}

function getSelectedBuurtFilter(){
  if(_selectedBuurten.length === 0) return 'all';
  // Extract buurtnaam zonder ' (gemeente)' suffix
  var names = new Set();
  _selectedBuurten.forEach(function(n){
    var m = n.match(/^(.+?) \(/);
    if(m) names.add(m[1]);
    else names.add(n);
  });
  return names;
}

function onFilterChange(){
  // Cascade: wijk- en buurtfilter opnieuw opbouwen bij gemeente-wijziging
  if(_wijkData) buildWijkFilter();
  if(_buurtData) buildBuurtFilter();
  updateMap();
  updateActiveStats();
  // Zoom naar meest specifieke selectie
  zoomToSelection();
  // Laad data automatisch als het kan
  autoLoadForSelection();
}

function autoLoadForSelection(){
  // Automatisch buurt/wijkdata laden als er een gemeente geselecteerd is
  if(_selectedGemeenten.length > 0 && !_buurtData){
    fetch(BUURTEN_URL).then(function(r){return r.json()}).then(function(d){
      _buurtData = d;
      document.getElementById('dsBuurten').textContent = d.features.length.toLocaleString('nl-NL') + ' features';
      buildBuurtFilter();
    }).catch(function(){});
  }
  if(_selectedGemeenten.length > 0 && !_wijkData){
    fetch(WIJKEN_URL).then(function(r){return r.json()}).then(function(d){
      _wijkData = d;
      document.getElementById('dsWijken').textContent = d.features.length.toLocaleString('nl-NL') + ' features';
      buildWijkFilter();
    }).catch(function(){});
  }
}

// Klik op kaart om gemeente/buurt/wijk toe te voegen aan selectie
var _selectionHighlights = []; // Array van {layer, originalStyle} voor visuele highlight

function toggleMapSelection(props, type, clickedLayer, parentLayer){
  var name, arr;
  if(type === 'gemeenten'){
    name = props.gemeentenaam;
    arr = _selectedGemeenten;
  } else if(type === 'buurten'){
    name = props.buurtnaam;
    if(props.gemeentenaam) name = props.buurtnaam + ' (' + props.gemeentenaam + ')';
    arr = _selectedBuurten;
  } else if(type === 'wijken'){
    name = props.wijknaam;
    if(props.gemeentenaam) name = props.wijknaam + ' (' + props.gemeentenaam + ')';
    arr = _selectedWijken;
  } else return;

  if(!name) return;

  var idx = arr.indexOf(name);
  if(idx >= 0){
    // Deselecteer: verwijder uit array
    arr.splice(idx, 1);
    toast('\u2796 ' + name + ' verwijderd');
    // Verwijder visuele highlight
    removeSelectionHighlight(clickedLayer);
    if(parentLayer) parentLayer.resetStyle(clickedLayer);
  } else {
    // Selecteer: voeg toe
    arr.push(name);
    toast('\u2795 ' + name + ' geselecteerd (' + arr.length + ')');
    // Voeg visuele highlight toe
    addSelectionHighlight(clickedLayer);
  }

  // Update UI: filters, chips, vergelijk-knop
  if(type === 'gemeenten') buildGemeenteFilter();
  else if(type === 'wijken') buildWijkFilter();
  else if(type === 'buurten') buildBuurtFilter();

  // Vergelijk-knop: ook voor wijken
  updateCompareButton();

  logEvent('kaart_selectie', type + ': ' + name + ' (' + arr.length + ' geselecteerd)');
}

function addSelectionHighlight(layer){
  if(!layer) return;
  try {
    layer.setStyle({
      weight: 3.5,
      color: '#39ff14',
      opacity: 1,
      dashArray: '',
      fillOpacity: 0.8
    });
    layer.bringToFront();
    _selectionHighlights.push(layer);
  } catch(e){}
}

function removeSelectionHighlight(layer){
  if(!layer) return;
  var idx = _selectionHighlights.indexOf(layer);
  if(idx >= 0) _selectionHighlights.splice(idx, 1);
}

// Herstel alle selectie-highlights na re-render (renderChoropleth verwijdert oude lagen)
function reapplySelectionHighlights(){
  _selectionHighlights = [];
  var allSelected = {
    gemeenten: new Set(_selectedGemeenten),
    wijken: new Set(_selectedWijken.map(function(n){ return n.replace(/ \(.*\)$/,''); })),
    buurten: new Set(_selectedBuurten.map(function(n){ return n.replace(/ \(.*\)$/,''); }))
  };

  function highlightLayer(layerGroup, nameKey, selSet){
    if(!layerGroup || !selSet.size) return;
    layerGroup.eachLayer(function(sub){
      if(!sub.feature) return;
      var featureName = sub.feature.properties[nameKey];
      if(featureName && selSet.has(featureName)){
        try {
          sub.setStyle({weight:3.5, color:'#39ff14', opacity:1, fillOpacity:0.8});
          sub.bringToFront();
          _selectionHighlights.push(sub);
        } catch(e){}
      }
    });
  }

  highlightLayer(_gemeenteLayer, 'gemeentenaam', allSelected.gemeenten);
  highlightLayer(_wijkLayer, 'wijknaam', allSelected.wijken);
  highlightLayer(_buurtLayer, 'buurtnaam', allSelected.buurten);
}

function updateCompareButton(){
  var cmpBtn = document.getElementById('compareBtn');
  var total = _selectedGemeenten.length + _selectedWijken.length + _selectedBuurten.length;
  // Vergelijk als ≥2 van hetzelfde type, OF ≥2 totaal
  var canCompare = _selectedGemeenten.length >= 2 || _selectedWijken.length >= 2 || _selectedBuurten.length >= 2;
  if(cmpBtn){
    cmpBtn.style.display = canCompare ? 'flex' : 'none';
    if(canCompare){
      var label = '';
      if(_selectedBuurten.length >= 2) label = _selectedBuurten.length + ' buurten';
      else if(_selectedWijken.length >= 2) label = _selectedWijken.length + ' wijken';
      else label = _selectedGemeenten.length + ' gemeenten';
      cmpBtn.innerHTML = '<span class="mi mi-sm">compare_arrows</span> Vergelijk ' + label;
    }
  }
  // Toon selectie-indicator op kaart
  updateSelectionBadge(total);
}

function updateSelectionBadge(count){
  var badge = document.getElementById('selectionBadge');
  if(!badge){
    // Maak floating badge
    badge = document.createElement('div');
    badge.id = 'selectionBadge';
    badge.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:1100;background:rgba(10,15,26,.92);backdrop-filter:blur(12px);border:1px solid rgba(57,255,20,.4);border-radius:24px;padding:8px 16px;display:none;align-items:center;gap:8px;font:500 12px "DM Sans",sans-serif;color:#e2e8f0;box-shadow:0 4px 20px rgba(0,0,0,.5)';
    document.body.appendChild(badge);
  }
  if(count === 0){
    badge.style.display = 'none';
    return;
  }
  badge.style.display = 'flex';
  var parts = [];
  if(_selectedGemeenten.length) parts.push(_selectedGemeenten.length + ' gem.');
  if(_selectedWijken.length) parts.push(_selectedWijken.length + ' wijken');
  if(_selectedBuurten.length) parts.push(_selectedBuurten.length + ' buurten');
  var canCompare = _selectedGemeenten.length >= 2 || _selectedWijken.length >= 2 || _selectedBuurten.length >= 2;
  badge.innerHTML = '<span class="mi" style="color:#39ff14;font-size:16px">check_circle</span> ' +
    '<span>' + parts.join(' + ') + ' geselecteerd</span>' +
    (canCompare ? ' <button onclick="showComparisonReport()" style="background:#39ff14;color:#0a0f1a;border:none;border-radius:12px;padding:4px 12px;font:700 11px \'DM Sans\',sans-serif;cursor:pointer;margin-left:4px">Vergelijk</button>' : '') +
    ' <button onclick="clearAllSelections()" style="background:none;border:none;color:#94a3b8;cursor:pointer;font-size:14px;padding:2px 4px" title="Selectie wissen"><span class="mi" style="font-size:16px">close</span></button>';
}

function clearAllSelections(){
  _selectedGemeenten = [];
  _selectedWijken = [];
  _selectedBuurten = [];
  _selectionHighlights = [];
  buildGemeenteFilter();
  if(_wijkData) buildWijkFilter();
  if(_buurtData) buildBuurtFilter();
  updateCompareButton();
  // Re-render om highlights te verwijderen
  if(_layerState.gemeenten) renderChoropleth('gemeenten');
  if(_layerState.wijken) renderChoropleth('wijken');
  if(_layerState.buurten) renderChoropleth('buurten');
  toast('Selectie gewist');
}

function zoomToSelection(){
  // Zoom naar meest specifieke niveau: buurt > wijk > gemeente
  var hasGem = _selectedGemeenten.length > 0;
  var hasWijk = _selectedWijken.length > 0;
  var hasBuurt = _selectedBuurten.length > 0;
  if(!hasGem && !hasWijk && !hasBuurt) return;

  var bounds = [];

  // Buurt-niveau: meest specifiek
  if(hasBuurt && _buurtData){
    var buurtSet = getSelectedBuurtFilter();
    var gemSet = hasGem ? new Set(_selectedGemeenten) : null;
    _buurtData.features.forEach(function(f){
      var p = f.properties;
      if(!p.buurtnaam || !buurtSet.has(p.buurtnaam)) return;
      if(gemSet && !gemSet.has(p.gemeentenaam)) return;
      if(f.geometry) try{ bounds.push(L.geoJSON(f).getBounds()); }catch(e){}
    });
  }
  // Wijk-niveau
  else if(hasWijk && _wijkData){
    var wijkSet = getSelectedWijkFilter();
    var gemSet2 = hasGem ? new Set(_selectedGemeenten) : null;
    _wijkData.features.forEach(function(f){
      var p = f.properties;
      if(!p.wijknaam || wijkSet === 'all') return;
      // Wijk namen bevatten ' (gemeente)' suffix — match raw naam
      if(!wijkSet.has(p.wijknaam)) return;
      if(gemSet2 && !gemSet2.has(p.gemeentenaam)) return;
      if(f.geometry) try{ bounds.push(L.geoJSON(f).getBounds()); }catch(e){}
    });
  }
  // Gemeente-niveau
  else if(hasGem && _gemeenteData){
    var gemNames = new Set(_selectedGemeenten);
    _gemeenteData.features.forEach(function(f){
      if(gemNames.has(f.properties.gemeentenaam) && f.geometry){
        try{ bounds.push(L.geoJSON(f).getBounds()); }catch(e){}
      }
    });
  }

  if(bounds.length){
    var combined = bounds[0];
    bounds.forEach(function(b){ combined.extend(b); });
    _map.fitBounds(combined,{padding:[20,20]});
  }
}

// Laad alle data voor de selectie
function loadSelection(){
  toast('Data laden voor selectie...');
  // 1. Buurtdata laden als dat nog niet is gebeurd
  var p1 = _buurtData ? Promise.resolve() : fetch(BUURTEN_URL).then(function(r){return r.json()}).then(function(d){
    _buurtData = d;
    document.getElementById('dsBuurten').textContent = d.features.length.toLocaleString('nl-NL') + ' features';
    buildBuurtFilter();
  });
  // 2. Wijkdata laden
  var p2 = _wijkData ? Promise.resolve() : fetch(WIJKEN_URL).then(function(r){return r.json()}).then(function(d){
    _wijkData = d;
    document.getElementById('dsWijken').textContent = d.features.length.toLocaleString('nl-NL') + ' features';
    buildWijkFilter();
  });

  Promise.all([p1, p2]).then(function(){
    // Render choropleth met alle data
    if(!_layerState.buurten){
      _layerState.buurten = true;
      document.querySelector('[data-layer="buurten"]').classList.add('active');
    }
    renderChoropleth('buurten');
    // Wijken ook renderen
    if(!_layerState.wijken){
      _layerState.wijken = true;
      document.querySelector('[data-layer="wijken"]').classList.add('active');
    }
    renderChoropleth('wijken');
    updateActiveStats();

    // BAG vector tiles hoeven niet opnieuw geladen te worden
    // (tiles worden automatisch per viewport geladen door PDOK)
    // Zoom naar selectie
    zoomToSelection();
    toast('Data geladen \u2714');
  }).catch(function(e){
    toast('Fout bij laden: '+e.message);
    console.error('loadSelection error:', e);
  });
}

// Sluit dropdowns bij klik buiten
document.addEventListener('click', function(e){
  if(!e.target.closest('.ms-wrap')){
    document.querySelectorAll('.ms-dropdown').forEach(function(d){ d.classList.remove('open'); });
  }
});

// Compat wrapper voor oude code
function filterGemeente(){ onFilterChange(); }

function switchTab(tab){
  document.querySelectorAll('.tab').forEach(function(t){t.classList.toggle('active',t.dataset.tab===tab)});
  document.querySelectorAll('.pane').forEach(function(p){p.classList.toggle('active',p.id==='p-'+tab)});
}

function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('hidden');
  setTimeout(function(){if(_map)_map.invalidateSize()},400);
}

// Uitleg per indicator
var INDICATOR_UITLEG = {
  'aantal_inwoners': 'Totaal aantal geregistreerde inwoners in het gebied. Gebaseerd op de BRP (Basisregistratie Personen).',
  'mannen': 'Aantal mannelijke inwoners geregistreerd in het gebied.',
  'vrouwen': 'Aantal vrouwelijke inwoners geregistreerd in het gebied.',
  '0_15': 'Percentage van de bevolking jonger dan 15 jaar. Indicator voor gezinnen met jonge kinderen.',
  '15_25': 'Percentage 15-24 jarigen. Hoog percentage kan wijzen op studentenpopulatie.',
  '25_45': 'Percentage 25-44 jarigen. De werkende en gezinsvormende leeftijdsgroep.',
  '45_65': 'Percentage 45-64 jarigen. Vaak gevestigde bewoners met stabiel inkomen.',
  '65plus': 'Percentage 65-plussers. Hoog percentage duidt op vergrijzing en hogere zorgbehoefte.',
  'bevolkingsdichtheid': 'Inwoners per vierkante kilometer. Stedelijke gebieden: >2500, landelijk: <500.',
  'huishoudens': 'Totaal aantal huishoudens (alleenstaand, samenwonend, gezin) in het gebied.',
  'gem_huishouden_grootte': 'Gemiddeld aantal personen per huishouden. Landelijk circa 2,1. Lager = meer alleenstaanden.',
  'woningvoorraad': 'Totaal aantal woningen in het gebied, ongeacht of ze bewoond zijn.',
  'gem_woz_waarde': 'Gemiddelde WOZ-waarde (Wet Waardering Onroerende Zaken) van woningen. Bepalend voor OZB belasting.',
  'koopwoningen': 'Percentage woningen in eigendom. Hoger = meer vermogensopbouw bij bewoners.',
  'huurwoningen': 'Percentage huurwoningen (sociaal + vrije sector). Hoger = meer doorstroom.',
  'pct_eengezins': 'Percentage eengezinswoningen (rijtjes, twee-onder-een-kap, vrijstaand). Typisch voor suburbaan.',
  'gem_aardgas': 'Gemiddeld jaarlijks aardgasverbruik per woning in m\u00b3. Hoger = mogelijk slecht ge\u00efsoleerd.',
  'gem_elektriciteit': 'Gemiddeld jaarlijks elektriciteitsverbruik per woning in kWh. Inclusief warmtepompen.',
  'gem_inkomen_inwoner': 'Gemiddeld besteedbaar inkomen per inwoner. Inclusief lonen, uitkeringen en pensioenen.',
  'arbeidsparticipatie': 'Netto arbeidsparticipatie: percentage 15-74 jarigen dat minimaal 12 uur per week werkt.',
  'bedrijfsvestigingen': 'Aantal geregistreerde bedrijfsvestigingen (KvK). Indicator voor lokale economische activiteit.',
  'personenautos': 'Totaal aantal geregistreerde personenauto\'s. Indicator voor mobiliteit en autobezit.',
  'afstand_huisarts': 'Gemiddelde afstand tot dichtstbijzijnde huisartsenpraktijk in km. >2 km = aandachtspunt.',
  'afstand_supermarkt': 'Gemiddelde afstand tot dichtstbijzijnde grote supermarkt in km. >3 km = voedselwoestijn.'
};

function renderIndicatorDefs(){
  var el = document.getElementById('indicatorDefs');
  // Alleen indicatoren tonen die beschikbaar zijn voor het actieve jaar
  var yearInds = _yearIndicators[_activeYear];
  var avSet = yearInds ? new Set(yearInds) : null;
  var available = INDICATORS.filter(function(fm){ return !avSet || avSet.has(fm.key); });

  // Zorg dat nationalStats berekend is
  if(!_nationalStats || Object.keys(_nationalStats).length === 0) computeNationalStats();

  // Groepeer per categorie
  var categories = [
    {label:'Bevolking', icon:'groups', color:'var(--ac)', keys:['aantal_inwoners','mannen','vrouwen','0_15','15_25','25_45','45_65','65plus','bevolkingsdichtheid','huishoudens','gem_huishouden_grootte']},
    {label:'Woningen & Vastgoed', icon:'home', color:'var(--wn)', keys:['woningvoorraad','gem_woz_waarde','koopwoningen','huurwoningen','pct_eengezins']},
    {label:'Energie', icon:'bolt', color:'var(--cyan)', keys:['gem_aardgas','gem_elektriciteit']},
    {label:'Economie', icon:'payments', color:'var(--ai)', keys:['gem_inkomen_inwoner','arbeidsparticipatie','bedrijfsvestigingen','personenautos']},
    {label:'Voorzieningen', icon:'local_hospital', color:'#f59e0b', keys:['afstand_huisarts','afstand_supermarkt']}
  ];

  var html = '<div style="font:500 10px \'Space Mono\',monospace;color:var(--ac);margin-bottom:8px">'+available.length+'/'+INDICATORS.length+' indicatoren beschikbaar voor '+_activeYear+'</div>';

  categories.forEach(function(cat){
    var catInds = available.filter(function(fm){ return cat.keys.indexOf(fm.key) > -1; });
    if(catInds.length === 0) return;

    html += '<div style="margin-top:8px;margin-bottom:4px;font:700 10px \'DM Sans\',sans-serif;color:'+cat.color+';display:flex;align-items:center;gap:4px;text-transform:uppercase;letter-spacing:.5px">';
    html += '<span class="mi mi-sm" style="color:'+cat.color+'">'+cat.icon+'</span> '+cat.label+' ('+catInds.length+')</div>';

    catInds.forEach(function(fm){
      var ns = _nationalStats[fm.key];
      var uitleg = INDICATOR_UITLEG[fm.key] || '';
      var isActive = _activeIndicators.indexOf(fm.key) >= 0;

      html += '<div style="padding:6px 4px;border-bottom:1px solid var(--glass-bd);cursor:pointer;transition:background .15s" ';
      html += 'onmouseenter="this.querySelector(\'.ind-tooltip\').style.display=\'block\'" ';
      html += 'onmouseleave="this.querySelector(\'.ind-tooltip\').style.display=\'none\'">';

      // Hoofdrij
      html += '<div style="display:flex;align-items:center;gap:6px">';
      html += '<span class="mi mi-sm" style="color:'+(isActive ? 'var(--ac)' : cat.color)+';flex-shrink:0">'+fm.icon+'</span>';
      html += '<div style="flex:1;min-width:0">';
      html += '<div style="font:600 11px \'DM Sans\',sans-serif;color:'+(isActive ? 'var(--ac)' : 'var(--tx)')+'">'+fm.naam;
      if(isActive) html += ' <span style="font-size:8px;background:rgba(57,255,20,.15);color:var(--ac);padding:1px 5px;border-radius:4px;vertical-align:1px">actief</span>';
      html += '</div>';
      html += '<div style="font-size:9px;color:var(--mt)">'+fm.eenheid+'</div>';
      html += '</div>';

      // Mini-stats
      if(ns){
        html += '<div style="display:flex;gap:4px;flex-shrink:0">';
        html += '<span style="font:400 9px \'Space Mono\',monospace;color:var(--mt);background:var(--glass);padding:1px 4px;border-radius:3px" title="Landelijk gemiddelde">\u00f8 '+fmtStat(ns.avg, fm.key)+'</span>';
        html += '</div>';
      }
      html += '</div>';

      // Tooltip (verborgen, verschijnt bij hover)
      html += '<div class="ind-tooltip" style="display:none;margin-top:6px;padding:8px;background:rgba(10,15,26,.8);border-radius:8px;border:1px solid var(--glass-bd)">';
      // Uitleg
      if(uitleg) html += '<div style="font-size:10px;color:var(--tx);margin-bottom:6px;line-height:1.5">'+uitleg+'</div>';

      if(ns){
        // Stats grid
        html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-bottom:6px">';
        html += '<div style="text-align:center;padding:4px;background:rgba(57,255,20,.06);border-radius:4px"><div style="font-size:8px;color:var(--mt)">Gemiddeld</div><div style="font:700 11px \'Space Mono\',monospace;color:var(--ac)">'+fmtStat(ns.avg, fm.key)+'</div></div>';
        html += '<div style="text-align:center;padding:4px;background:rgba(56,189,248,.06);border-radius:4px"><div style="font-size:8px;color:var(--mt)">Mediaan</div><div style="font:700 11px \'Space Mono\',monospace;color:var(--ai)">'+fmtStat(ns.median, fm.key)+'</div></div>';
        html += '<div style="text-align:center;padding:4px;background:rgba(251,191,36,.06);border-radius:4px"><div style="font-size:8px;color:var(--mt)">Std.dev</div><div style="font:700 11px \'Space Mono\',monospace;color:var(--wn)">'+fmtStat(ns.stddev, fm.key)+'</div></div>';
        html += '</div>';

        // Min/Max + range
        html += '<div style="display:flex;justify-content:space-between;font-size:9px;margin-bottom:4px">';
        html += '<span style="color:var(--dn)">Min: '+fmtStat(ns.min, fm.key)+'</span>';
        html += '<span style="color:var(--mt)">|</span>';
        html += '<span style="color:var(--up)">Max: '+fmtStat(ns.max, fm.key)+'</span>';
        html += '</div>';

        // Visuele balk: P10 — Gem — P90
        html += '<div style="position:relative;height:8px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden">';
        var range = ns.max - ns.min || 1;
        var avgPct = ((ns.avg - ns.min) / range * 100).toFixed(1);
        var p10Pct = ns.p10 ? ((ns.p10 - ns.min) / range * 100).toFixed(1) : '10';
        var p90Pct = ns.p90 ? ((ns.p90 - ns.min) / range * 100).toFixed(1) : '90';
        html += '<div style="position:absolute;left:'+p10Pct+'%;right:'+(100-parseFloat(p90Pct))+'%;height:100%;background:rgba(57,255,20,.15);border-radius:4px"></div>';
        html += '<div style="position:absolute;left:'+avgPct+'%;top:0;width:2px;height:100%;background:var(--ac)"></div>';
        html += '</div>';
        html += '<div style="display:flex;justify-content:space-between;font-size:8px;color:var(--mt);margin-top:2px">';
        html += '<span>P10: '+fmtStat(ns.p10, fm.key)+'</span>';
        html += '<span>P90: '+fmtStat(ns.p90, fm.key)+'</span>';
        html += '</div>';

        // Distributie info
        html += '<div style="font-size:8px;color:var(--mt);margin-top:4px">';
        html += 'Distributie: '+ns.distType+' \u00b7 n='+ns.count+' gemeenten';
        if(Math.abs(ns.skewness) > 0.5) html += ' \u00b7 scheefheid: '+(ns.skewness > 0 ? '+' : '')+ns.skewness.toFixed(2);
        html += '</div>';
      } else {
        html += '<div style="font-size:9px;color:var(--mt);font-style:italic">Geen landelijke statistieken beschikbaar voor dit jaar</div>';
      }
      html += '</div>'; // end tooltip
      html += '</div>'; // end indicator row
    });
  });

  // Ontbrekende indicatoren
  var missing = INDICATORS.filter(function(fm){ return avSet && !avSet.has(fm.key); });
  if(missing.length > 0){
    html += '<div style="margin-top:10px;padding:8px;background:rgba(239,68,68,.06);border-radius:8px;border:1px solid rgba(239,68,68,.15)">';
    html += '<div style="font:600 9px \'DM Sans\',sans-serif;color:var(--dn);margin-bottom:4px">Niet beschikbaar in '+_activeYear+' ('+missing.length+')</div>';
    html += '<div style="font-size:9px;color:var(--mt);line-height:1.6">';
    missing.forEach(function(fm){
      html += '<span style="display:inline-flex;align-items:center;gap:3px;margin:1px 4px 1px 0;padding:1px 6px;background:rgba(239,68,68,.05);border-radius:3px;opacity:.6">';
      html += '<span class="mi" style="font-size:10px">'+fm.icon+'</span> '+fm.naam+'</span>';
    });
    html += '</div></div>';
  }

  el.innerHTML = html;
}

function fmtStat(v, key){
  if(v == null || v === undefined) return '\u2014';
  if(typeof v !== 'number') return String(v);
  if(key === 'gem_woz_waarde') return '\u20ac'+Math.round(v/1000)+'k';
  if(key === 'gem_inkomen_inwoner') return '\u20ac'+Math.round(v/1000)+'k';
  if(key === 'afstand_huisarts' || key === 'afstand_supermarkt') return v.toFixed(1)+'km';
  if(key === 'gem_aardgas') return Math.round(v)+'m\u00b3';
  if(key === 'gem_elektriciteit') return Math.round(v)+'kWh';
  if(v >= 10000) return v.toLocaleString('nl-NL');
  if(v >= 100) return Math.round(v).toLocaleString('nl-NL');
  if(v >= 10) return v.toFixed(1);
  if(v >= 1) return v.toFixed(1);
  return v.toFixed(2);
}

function toast(msg){
  var el = document.getElementById('toast');
  el.innerHTML = '<span class="mi mi-sm" style="vertical-align:-3px;margin-right:6px">notifications</span>' + msg;
  el.classList.add('show');
  clearTimeout(el._tid);
  el._tid = setTimeout(function(){el.classList.remove('show')},3000);
}

// ============================================================
// GEBRUIKSLOG (localStorage)
// ============================================================
var LOG_KEY = 'geoinzicht_log';
var LOG_MAX = 500; // max events bewaren

function logEvent(type, detail){
  try {
    var log = JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
    var entry = {
      ts: new Date().toISOString(),
      type: type,
      detail: detail || '',
      zoom: _map ? _map.getZoom() : null,
      center: _map ? [_map.getCenter().lat.toFixed(4), _map.getCenter().lng.toFixed(4)] : null
    };
    log.push(entry);
    // Beperk tot max entries
    if(log.length > LOG_MAX) log = log.slice(log.length - LOG_MAX);
    localStorage.setItem(LOG_KEY, JSON.stringify(log));
  } catch(e){ console.warn('Log error:', e); }
}

function getLog(){
  try { return JSON.parse(localStorage.getItem(LOG_KEY) || '[]'); }
  catch(e){ return []; }
}

function renderLogView(){
  var log = getLog();
  var countEl = document.getElementById('logCount');
  var entriesEl = document.getElementById('logEntries');
  if(countEl) countEl.textContent = log.length + ' events';
  if(!entriesEl) return;

  if(log.length === 0){
    entriesEl.innerHTML = '<div style="text-align:center;padding:24px 0;color:var(--mt)"><span class="mi" style="font-size:28px;opacity:.4;display:block;margin-bottom:8px">history</span>Nog geen activiteit gelogd</div>';
    return;
  }

  var typeIcons = {
    'app_open': 'launch', 'adres_klik': 'location_on', 'buurt_klik': 'place',
    'wijk_klik': 'map', 'gemeente_klik': 'public', 'indicator_aan': 'toggle_on',
    'indicator_uit': 'toggle_off', 'indicator_primair': 'star',
    'bag_laden': 'downloading', 'bag_klaar': 'check_circle',
    'rapport_export': 'print', 'log_export': 'download',
    'bag_toggle': 'layers', 'basemap': 'map', 'zoek': 'search'
  };
  var typeColors = {
    'app_open': 'var(--ac)', 'adres_klik': 'var(--ai)', 'buurt_klik': 'var(--cyan)',
    'wijk_klik': 'var(--cyan)', 'gemeente_klik': 'var(--cyan)',
    'indicator_aan': 'var(--up)', 'indicator_uit': 'var(--dn)', 'indicator_primair': 'var(--wn)',
    'bag_laden': 'var(--ai)', 'bag_klaar': 'var(--up)',
    'rapport_export': 'var(--ac)', 'log_export': 'var(--mt)',
    'bag_toggle': 'var(--ai)', 'basemap': 'var(--mt)', 'zoek': 'var(--mt)'
  };

  var html = '';
  // Nieuwste eerst
  for(var i = log.length - 1; i >= 0; i--){
    var e = log[i];
    var d = new Date(e.ts);
    var tijd = d.toLocaleDateString('nl-NL',{day:'2-digit',month:'short'}) + ' ' + d.toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    var icon = typeIcons[e.type] || 'info';
    var color = typeColors[e.type] || 'var(--mt)';
    html += '<div style="display:flex;gap:6px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.04);align-items:flex-start">';
    html += '<span class="mi" style="font-size:12px;color:'+color+';flex-shrink:0;margin-top:1px">'+icon+'</span>';
    html += '<div style="flex:1;min-width:0">';
    html += '<div style="font-size:9px;color:var(--mt);opacity:.7">'+tijd+'</div>';
    html += '<div style="font-size:10px;color:var(--tx);word-break:break-word">'+escapeHtml(e.type.replace(/_/g,' '));
    if(e.detail) html += ' <span style="color:var(--mt)">— '+escapeHtml(String(e.detail))+'</span>';
    html += '</div>';
    if(e.zoom) html += '<div style="font-size:8px;color:var(--mt);opacity:.5">zoom '+e.zoom+'</div>';
    html += '</div></div>';
  }
  entriesEl.innerHTML = html;
}

function escapeHtml(s){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function exportLog(){
  var log = getLog();
  if(log.length === 0){ toast('Geen logdata om te exporteren'); return; }
  // CSV export
  var csv = 'Tijdstip;Type;Detail;Zoom;Lat;Lng\n';
  log.forEach(function(e){
    var center = e.center || ['',''];
    csv += e.ts + ';' + e.type + ';' + (e.detail||'').replace(/;/g,',') + ';' + (e.zoom||'') + ';' + center[0] + ';' + center[1] + '\n';
  });
  var blob = new Blob(['\ufeff' + csv], {type:'text/csv;charset=utf-8'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'geoinzicht_log_' + new Date().toISOString().substring(0,10) + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  logEvent('log_export', log.length + ' events');
  toast('Log geëxporteerd als CSV');
}

function clearLog(){
  if(!confirm('Alle logdata wissen? Dit kan niet ongedaan worden.')) return;
  localStorage.removeItem(LOG_KEY);
  renderLogView();
  toast('Log gewist');
}

// ============================================================
// ANALYTICS — Offline-first met IndexedDB + SQL Server sync
// ============================================================
// Data wordt ALTIJD lokaal opgeslagen in IndexedDB.
// Als de Flask API (analytics_api.py) bereikbaar is, worden
// ongesyncde records automatisch naar SQL Server gepusht.
// Zo gaat er nooit data verloren, ongeacht of de server draait.

var ANALYTICS_API = 'http://localhost:5000/api';
var _visitorId = null;
var _sessionId = null;
var _analyticsReady = false;
var _analyticsDb = null;       // IndexedDB reference
var _apiOnline = false;        // Is Flask API bereikbaar?
var _syncInterval = null;      // Sync timer
var _syncBusy = false;         // Voorkom dubbele syncs

// --------------- IndexedDB Setup ---------------
function openAnalyticsDB(){
  return new Promise(function(resolve, reject){
    var req = indexedDB.open('geoinzicht_analytics', 3);
    req.onupgradeneeded = function(e){
      var db = e.target.result;
      // Sessions store
      if(!db.objectStoreNames.contains('sessions')){
        var ss = db.createObjectStore('sessions', {keyPath:'session_id'});
        ss.createIndex('synced', 'synced', {unique:false});
      }
      // Events store
      if(!db.objectStoreNames.contains('events')){
        var es = db.createObjectStore('events', {autoIncrement:true});
        es.createIndex('synced', 'synced', {unique:false});
        es.createIndex('session_id', 'session_id', {unique:false});
      }
      // Emails store
      if(!db.objectStoreNames.contains('emails')){
        var ms = db.createObjectStore('emails', {autoIncrement:true});
        ms.createIndex('synced', 'synced', {unique:false});
      }
      // Feedback store
      if(!db.objectStoreNames.contains('feedback')){
        var fs = db.createObjectStore('feedback', {autoIncrement:true});
        fs.createIndex('synced', 'synced', {unique:false});
      }
      // Uploads store (v3)
      if(!db.objectStoreNames.contains('uploads')){
        var us = db.createObjectStore('uploads', {keyPath:'upload_id'});
        us.createIndex('synced', 'synced', {unique:false});
        us.createIndex('uploaded_at', 'uploaded_at', {unique:false});
      }
    };
    req.onsuccess = function(e){
      _analyticsDb = e.target.result;
      resolve(_analyticsDb);
    };
    req.onerror = function(e){
      console.warn('IndexedDB open fout:', e.target.error);
      reject(e.target.error);
    };
  });
}

// --------------- IndexedDB Helpers ---------------
function idbPut(storeName, record){
  return new Promise(function(resolve, reject){
    if(!_analyticsDb){ resolve(); return; }
    try {
      var tx = _analyticsDb.transaction(storeName, 'readwrite');
      var store = tx.objectStore(storeName);
      var req = store.put(record);
      req.onsuccess = function(){ resolve(req.result); };
      req.onerror = function(e){ reject(e.target.error); };
    } catch(e){ reject(e); }
  });
}

function idbAdd(storeName, record){
  return new Promise(function(resolve, reject){
    if(!_analyticsDb){ resolve(); return; }
    try {
      var tx = _analyticsDb.transaction(storeName, 'readwrite');
      var store = tx.objectStore(storeName);
      var req = store.add(record);
      req.onsuccess = function(){ resolve(req.result); };
      req.onerror = function(e){ reject(e.target.error); };
    } catch(e){ reject(e); }
  });
}

function idbGetAllByIndex(storeName, indexName, value){
  return new Promise(function(resolve, reject){
    if(!_analyticsDb){ resolve([]); return; }
    try {
      var tx = _analyticsDb.transaction(storeName, 'readonly');
      var store = tx.objectStore(storeName);
      var idx = store.index(indexName);
      var req = idx.openCursor(IDBKeyRange.only(value));
      var results = [];
      req.onsuccess = function(e){
        var cursor = e.target.result;
        if(cursor){
          results.push({key: cursor.primaryKey, value: cursor.value});
          cursor.continue();
        } else {
          resolve(results);
        }
      };
      req.onerror = function(e){ reject(e.target.error); };
    } catch(e){ reject(e); }
  });
}

function idbGetAll(storeName){
  return new Promise(function(resolve, reject){
    if(!_analyticsDb){ resolve([]); return; }
    try {
      var tx = _analyticsDb.transaction(storeName, 'readonly');
      var store = tx.objectStore(storeName);
      var req = store.getAll();
      req.onsuccess = function(){ resolve(req.result || []); };
      req.onerror = function(e){ reject(e.target.error); };
    } catch(e){ reject(e); }
  });
}

function idbMarkSynced(storeName, key){
  return new Promise(function(resolve, reject){
    if(!_analyticsDb){ resolve(); return; }
    try {
      var tx = _analyticsDb.transaction(storeName, 'readwrite');
      var store = tx.objectStore(storeName);
      var getReq = store.get(key);
      getReq.onsuccess = function(){
        var rec = getReq.result;
        if(rec){
          rec.synced = 1;
          store.put(rec);
        }
        resolve();
      };
      getReq.onerror = function(e){ reject(e.target.error); };
    } catch(e){ reject(e); }
  });
}

function idbCount(storeName){
  return new Promise(function(resolve){
    if(!_analyticsDb){ resolve(0); return; }
    try {
      var tx = _analyticsDb.transaction(storeName, 'readonly');
      var req = tx.objectStore(storeName).count();
      req.onsuccess = function(){ resolve(req.result); };
      req.onerror = function(){ resolve(0); };
    } catch(e){ resolve(0); }
  });
}

// --------------- Visitor & Session IDs ---------------
function getVisitorId(){
  var vid = localStorage.getItem('geoinzicht_vid');
  if(!vid){
    vid = 'v_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2,9);
    localStorage.setItem('geoinzicht_vid', vid);
  }
  return vid;
}

function getSessionId(){
  if(!_sessionId){
    _sessionId = 's_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2,6);
  }
  return _sessionId;
}

// --------------- Bezoekersinfo ---------------
function collectVisitorInfo(){
  var nav = navigator;
  var scr = screen;
  return {
    visitor_id: getVisitorId(),
    session_id: getSessionId(),
    user_agent: nav.userAgent || '',
    platform: nav.platform || (nav.userAgentData && nav.userAgentData.platform) || '',
    language: nav.language || nav.userLanguage || '',
    languages: (nav.languages || []).join(','),
    screen_w: scr.width, screen_h: scr.height,
    viewport_w: window.innerWidth, viewport_h: window.innerHeight,
    pixel_ratio: window.devicePixelRatio || 1,
    color_depth: scr.colorDepth || scr.pixelDepth || 0,
    connection_type: nav.connection ? nav.connection.effectiveType || nav.connection.type || '' : '',
    cores: nav.hardwareConcurrency || 0,
    memory: nav.deviceMemory || 0,
    touch: 'ontouchstart' in window || nav.maxTouchPoints > 0,
    referrer: document.referrer || '',
    url: location.href,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || '',
    canvas_hash: getCanvasFingerprint(),
    gpu: getGPUInfo(),
    visit_count: parseInt(localStorage.getItem('geoinzicht_visits') || '0') + 1,
  };
}

function getCanvasFingerprint(){
  try {
    var c = document.createElement('canvas');
    c.width = 200; c.height = 50;
    var ctx = c.getContext('2d');
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillText('GeoInzicht\ud83c\uddf3\ud83c\uddf1', 2, 2);
    var d = c.toDataURL();
    var hash = 0;
    for(var i = 0; i < d.length; i++){
      hash = ((hash << 5) - hash) + d.charCodeAt(i);
      hash |= 0;
    }
    return hash.toString(16);
  } catch(e){ return ''; }
}

function getGPUInfo(){
  try {
    var c = document.createElement('canvas');
    var gl = c.getContext('webgl') || c.getContext('experimental-webgl');
    if(!gl) return '';
    var ext = gl.getExtension('WEBGL_debug_renderer_info');
    return ext ? gl.getParameter(ext.UNMASKED_RENDERER_WEBGL) : gl.getParameter(gl.RENDERER);
  } catch(e){ return ''; }
}

// --------------- IP / Geo ---------------
function getVisitorIP(){
  return fetch('https://api.ipify.org?format=json')
    .then(function(r){ return r.json(); })
    .then(function(d){ return d.ip; })
    .catch(function(){
      return fetch('https://ipapi.co/json/')
        .then(function(r){ return r.json(); })
        .then(function(d){ return {ip:d.ip, city:d.city, region:d.region, country:d.country_name, isp:d.org, lat:d.latitude, lng:d.longitude}; })
        .catch(function(){ return null; });
    });
}

function getIPGeo(ip){
  return fetch('https://ipapi.co/' + ip + '/json/')
    .then(function(r){ return r.json(); })
    .then(function(d){ return {city:d.city||'', region:d.region||'', country:d.country_name||'', isp:d.org||'', lat:d.latitude||0, lng:d.longitude||0}; })
    .catch(function(){ return {}; });
}

// --------------- API Online Check ---------------
function checkApiOnline(){
  return fetch(ANALYTICS_API + '/health', {method:'GET', signal: AbortSignal.timeout(3000)})
    .then(function(r){ _apiOnline = r.ok; return _apiOnline; })
    .catch(function(){ _apiOnline = false; return false; });
}

// --------------- Sync Engine ---------------
async function syncToServer(){
  if(_syncBusy || !_apiOnline || !_analyticsDb) return;
  _syncBusy = true;
  var totalSynced = 0;
  try {
    // 1. Sync sessions
    var unsyncedSessions = await idbGetAllByIndex('sessions', 'synced', 0);
    for(var i = 0; i < unsyncedSessions.length; i++){
      var s = unsyncedSessions[i];
      var rec = Object.assign({}, s.value);
      delete rec.synced;
      try {
        var r = await fetch(ANALYTICS_API + '/session', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(rec)
        });
        if(r.ok){
          await idbMarkSynced('sessions', s.key);
          totalSynced++;
        }
      } catch(e){ _apiOnline = false; break; }
    }

    // 2. Sync events (batch van max 50)
    if(_apiOnline){
      var unsyncedEvents = await idbGetAllByIndex('events', 'synced', 0);
      var batch = [];
      var batchKeys = [];
      for(var j = 0; j < unsyncedEvents.length && j < 200; j++){
        var ev = Object.assign({}, unsyncedEvents[j].value);
        delete ev.synced;
        batch.push(ev);
        batchKeys.push(unsyncedEvents[j].key);
      }
      if(batch.length > 0){
        try {
          var r2 = await fetch(ANALYTICS_API + '/events', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(batch)
          });
          if(r2.ok){
            for(var k = 0; k < batchKeys.length; k++){
              await idbMarkSynced('events', batchKeys[k]);
            }
            totalSynced += batch.length;
          }
        } catch(e){ _apiOnline = false; }
      }
    }

    // 3. Sync emails
    if(_apiOnline){
      var unsyncedEmails = await idbGetAllByIndex('emails', 'synced', 0);
      for(var m = 0; m < unsyncedEmails.length; m++){
        var em = Object.assign({}, unsyncedEmails[m].value);
        delete em.synced;
        try {
          var r3 = await fetch(ANALYTICS_API + '/email', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(em)
          });
          if(r3.ok){
            await idbMarkSynced('emails', unsyncedEmails[m].key);
            totalSynced++;
          }
        } catch(e){ _apiOnline = false; break; }
      }
    }

    // 4. Sync feedback
    if(_apiOnline){
      var unsyncedFeedback = await idbGetAllByIndex('feedback', 'synced', 0);
      for(var n = 0; n < unsyncedFeedback.length; n++){
        var fb = Object.assign({}, unsyncedFeedback[n].value);
        delete fb.synced;
        try {
          var r4 = await fetch(ANALYTICS_API + '/feedback', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(fb)
          });
          if(r4.ok){
            await idbMarkSynced('feedback', unsyncedFeedback[n].key);
            totalSynced++;
          }
        } catch(e){ _apiOnline = false; break; }
      }
    }

    if(totalSynced > 0){
      console.log('Analytics sync: ' + totalSynced + ' records naar SQL Server gestuurd');
    }
  } catch(e){
    console.warn('Analytics sync error:', e.message);
  }
  _syncBusy = false;
}

// Start sync interval: check elke 30 sec of API online is, sync als dat zo is
function startSyncEngine(){
  // Check direct
  checkApiOnline().then(function(online){
    if(online) syncToServer();
  });
  // Daarna elke 30 seconden
  _syncInterval = setInterval(function(){
    checkApiOnline().then(function(online){
      if(online) syncToServer();
    });
  }, 30000);
}

// --------------- Init Analytics ---------------
async function initAnalytics(){
  try {
    // Open IndexedDB
    await openAnalyticsDB();

    _visitorId = getVisitorId();
    _sessionId = getSessionId();

    // Verzamel info
    var info = collectVisitorInfo();
    localStorage.setItem('geoinzicht_visits', info.visit_count);

    // IP ophalen (async, niet blokkerend)
    var ip = '';
    var geo = {};
    try {
      var ipResult = await getVisitorIP();
      if(typeof ipResult === 'string'){
        ip = ipResult;
        geo = await getIPGeo(ip);
      } else if(ipResult && ipResult.ip){
        ip = ipResult.ip;
        geo = ipResult;
      }
    } catch(e){ /* IP ophalen mislukt, geen probleem */ }

    // Sessie record
    var session = {
      visitor_id: _visitorId,
      session_id: _sessionId,
      ip_address: ip,
      city: geo.city || '',
      region: geo.region || '',
      country: geo.country || '',
      isp: geo.isp || '',
      ip_lat: geo.lat || null,
      ip_lng: geo.lng || null,
      user_agent: info.user_agent.substring(0, 500),
      platform: info.platform,
      language: info.language,
      languages: info.languages,
      screen_w: info.screen_w, screen_h: info.screen_h,
      viewport_w: info.viewport_w, viewport_h: info.viewport_h,
      pixel_ratio: info.pixel_ratio,
      color_depth: info.color_depth,
      connection_type: info.connection_type,
      cores: info.cores,
      memory_gb: info.memory,
      touch_device: info.touch,
      referrer: info.referrer.substring(0, 500),
      page_url: info.url.substring(0, 500),
      timezone: info.timezone,
      canvas_hash: info.canvas_hash,
      gpu: (info.gpu || '').substring(0, 200),
      visit_count: info.visit_count,
      started_at: new Date().toISOString(),
      ended_at: null,
      duration_seconds: null,
      synced: 0   // 0 = niet gesynct, 1 = gesynct naar SQL Server
    };

    // Altijd opslaan in IndexedDB
    await idbPut('sessions', session);
    _analyticsReady = true;
    console.log('Analytics: sessie opgeslagen in IndexedDB', _sessionId);

    // Start sync engine
    startSyncEngine();

  } catch(e){
    console.warn('Analytics init error:', e.message);
    // Zelfs als IDB faalt, markeer als ready zodat events niet verloren gaan
    _analyticsReady = true;
  }
}

// --------------- Track Events ---------------
function trackEvent(type, detail){
  if(!_analyticsReady) return;
  var evt = {
    visitor_id: _visitorId,
    session_id: _sessionId,
    event_type: type,
    event_detail: typeof detail === 'object' ? JSON.stringify(detail) : String(detail || ''),
    zoom: _map ? _map.getZoom() : null,
    center_lat: _map ? parseFloat(_map.getCenter().lat.toFixed(5)) : null,
    center_lng: _map ? parseFloat(_map.getCenter().lng.toFixed(5)) : null,
    timestamp: new Date().toISOString(),
    synced: 0
  };
  // Fire-and-forget naar IndexedDB
  idbAdd('events', evt).catch(function(e){ console.warn('Event IDB fout:', e); });
}

// --------------- Sessie-einde ---------------
function trackSessionEnd(){
  if(!_analyticsReady || !_analyticsDb) return;
  var duration = Math.round((Date.now() - _appStartTime) / 1000);

  // Update sessie in IndexedDB
  try {
    var tx = _analyticsDb.transaction('sessions', 'readwrite');
    var store = tx.objectStore('sessions');
    var getReq = store.get(_sessionId);
    getReq.onsuccess = function(){
      var rec = getReq.result;
      if(rec){
        rec.ended_at = new Date().toISOString();
        rec.duration_seconds = duration;
        rec.synced = 0; // Opnieuw syncen nodig
        store.put(rec);
      }
    };
  } catch(e){}

  // Probeer ook direct naar API te sturen (sendBeacon)
  try {
    var url = ANALYTICS_API + '/session-end';
    var data = JSON.stringify({
      session_id: _sessionId,
      duration_seconds: duration,
      ended_at: new Date().toISOString()
    });
    if(navigator.sendBeacon){
      navigator.sendBeacon(url, new Blob([data], {type:'application/json'}));
    } else {
      fetch(url, {method:'POST', body:data, headers:{'Content-Type':'application/json'}, keepalive:true}).catch(function(){});
    }
  } catch(e){}
}

// Voeg analytics tracking toe aan bestaand logEvent
var _origLogEvent = logEvent;
logEvent = function(type, detail){
  _origLogEvent(type, detail);
  trackEvent(type, detail);
};

// Track page visibility changes
document.addEventListener('visibilitychange', function(){
  if(document.hidden){
    trackEvent('tab_hidden', '');
  } else {
    trackEvent('tab_visible', '');
  }
});

// Track sessie-einde
window.addEventListener('beforeunload', trackSessionEnd);

// E-mail opslaan (altijd in IndexedDB, sync later)
function saveEmailToAnalytics(email){
  if(!email) return;
  return idbAdd('emails', {
    visitor_id: _visitorId,
    session_id: _sessionId,
    email: email,
    collected_at: new Date().toISOString(),
    session_duration_min: Math.round((Date.now() - _appStartTime) / 60000),
    synced: 0
  }).catch(function(e){ console.warn('Email IDB fout:', e); });
}

// Feedback opslaan (altijd in IndexedDB, sync later)
function saveFeedbackToAnalytics(text, email, year){
  if(!text) return;
  return idbAdd('feedback', {
    visitor_id: _visitorId,
    session_id: _sessionId,
    text: text,
    email: email || '',
    year: year || _activeYear,
    session_duration_min: Math.round((Date.now() - _appStartTime) / 60000),
    submitted_at: new Date().toISOString(),
    synced: 0
  }).catch(function(e){ console.warn('Feedback IDB fout:', e); });
}

// ============================================================
// ADMIN DASHBOARD — Beveiligd met wachtwoord
// ============================================================
// Admin is alleen toegankelijk met ?admin in URL + correct wachtwoord.
// Wachtwoord-hash wordt opgeslagen bij eerste keer instellen.
// Data komt uit IndexedDB (altijd beschikbaar) OF SQL Server API.

var _isAdmin = new URLSearchParams(location.search).has('admin');
var _adminUnlocked = false;
var ADMIN_HASH_KEY = 'geoinzicht_admin_hash';

// Simpele hash functie (sha-256 via SubtleCrypto)
async function hashPassword(pw){
  var enc = new TextEncoder().encode(pw);
  var hashBuffer = await crypto.subtle.digest('SHA-256', enc);
  var hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(function(b){ return b.toString(16).padStart(2,'0'); }).join('');
}

async function checkAdminPassword(pw){
  var stored = localStorage.getItem(ADMIN_HASH_KEY);
  if(!stored){
    // Eerste keer: sla wachtwoord op
    var h = await hashPassword(pw);
    localStorage.setItem(ADMIN_HASH_KEY, h);
    return true;
  }
  var h2 = await hashPassword(pw);
  return h2 === stored;
}

function showAdminLogin(){
  var logPane = document.getElementById('p-log');
  if(!logPane) return;
  var tabLog = document.getElementById('tabLog');
  if(tabLog) tabLog.style.display = '';

  var firstTime = !localStorage.getItem(ADMIN_HASH_KEY);
  logPane.innerHTML =
    '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px;padding:24px">' +
    '<span class="mi" style="font-size:48px;color:var(--ac);margin-bottom:12px">admin_panel_settings</span>' +
    '<div style="font:700 14px \'Space Mono\',monospace;color:var(--ac);margin-bottom:8px">Admin Dashboard</div>' +
    '<div style="font-size:11px;color:var(--mt);margin-bottom:16px;text-align:center">' +
      (firstTime ? 'Stel een admin wachtwoord in.<br>Dit wordt lokaal opgeslagen.' : 'Voer je admin wachtwoord in.') +
    '</div>' +
    '<div style="display:flex;gap:6px;align-items:center">' +
    '<input type="password" id="adminPwInput" placeholder="Wachtwoord" ' +
      'style="background:var(--s2);border:1px solid var(--br);border-radius:6px;padding:8px 12px;color:var(--tx);font-size:12px;width:180px" ' +
      'onkeydown="if(event.key===\'Enter\')verifyAdminPw()">' +
    '<button class="btn btn-p" onclick="verifyAdminPw()" style="font-size:11px;padding:8px 14px">' +
      (firstTime ? '<span class="mi mi-sm">lock</span> Instellen' : '<span class="mi mi-sm">lock_open</span> Inloggen') +
    '</button></div>' +
    '<div id="adminPwError" style="font-size:10px;color:var(--dn);margin-top:8px;display:none"></div>' +
    '</div>';

  // Focus input
  setTimeout(function(){ var inp = document.getElementById('adminPwInput'); if(inp) inp.focus(); }, 100);
}

async function verifyAdminPw(){
  var inp = document.getElementById('adminPwInput');
  var errEl = document.getElementById('adminPwError');
  if(!inp) return;
  var pw = inp.value.trim();
  if(!pw){
    errEl.textContent = 'Voer een wachtwoord in';
    errEl.style.display = '';
    return;
  }
  if(pw.length < 4){
    errEl.textContent = 'Minimaal 4 tekens';
    errEl.style.display = '';
    return;
  }
  var ok = await checkAdminPassword(pw);
  if(ok){
    _adminUnlocked = true;
    renderAdminDashboard();
  } else {
    errEl.textContent = 'Onjuist wachtwoord';
    errEl.style.display = '';
    inp.value = '';
    inp.focus();
  }
}

function renderAdminDashboard(){
  if(!_isAdmin) return;
  if(!_adminUnlocked){
    showAdminLogin();
    return;
  }

  // Toon admin tab
  var tabLog = document.getElementById('tabLog');
  if(tabLog) tabLog.style.display = '';
  var logPane = document.getElementById('p-log');
  if(!logPane) return;

  logPane.innerHTML =
    '<div class="sh"><span class="mi">admin_panel_settings</span> Admin Dashboard</div>' +
    '<div class="card" style="margin-bottom:8px">' +
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">' +
        '<span style="font:700 12px \'Space Mono\',monospace;color:var(--ac)">Bezoekers Analytics</span>' +
        '<div style="display:flex;gap:4px;align-items:center">' +
          '<span id="adminSyncStatus" style="font-size:9px;color:var(--mt)"></span>' +
          '<button class="btn btn-s" onclick="forceSync()" style="font-size:9px;padding:3px 8px" title="Forceer sync naar SQL Server"><span class="mi mi-sm" style="font-size:11px">sync</span> Sync</button>' +
          '<button class="btn btn-s" onclick="refreshAdminData()" style="font-size:9px;padding:3px 8px"><span class="mi mi-sm" style="font-size:11px">refresh</span> Ververs</button>' +
          '<button class="btn btn-s" onclick="exportAdminCSV()" style="font-size:9px;padding:3px 8px"><span class="mi mi-sm" style="font-size:11px">download</span> CSV</button>' +
        '</div>' +
      '</div>' +
      '<div id="adminStats" style="font-size:11px;color:var(--mt)">Laden...</div>' +
    '</div>' +
    '<div class="sh"><span class="mi">people</span> Recente Sessies</div>' +
    '<div id="adminSessions" class="card" style="font-size:10px;max-height:300px;overflow-y:auto">Laden...</div>' +
    '<div class="sh"><span class="mi">mail</span> E-mailadressen</div>' +
    '<div id="adminEmails" class="card" style="font-size:10px;max-height:200px;overflow-y:auto">Laden...</div>' +
    '<div class="sh"><span class="mi">upload_file</span> Gebruikers Uploads <span id="adminUploadCount" style="font:400 9px \'Space Mono\',monospace;color:var(--mt);text-transform:none;letter-spacing:0"></span></div>' +
    '<div id="adminUploads" class="card" style="font-size:10px;max-height:350px;overflow-y:auto">Laden...</div>' +
    '<div class="sh"><span class="mi">timeline</span> Recente Events</div>' +
    '<div id="adminEvents" class="card" style="font-size:10px;max-height:300px;overflow-y:auto">Laden...</div>' +
    '<div class="sh"><span class="mi">settings</span> Admin Instellingen</div>' +
    '<div class="card" style="font-size:10px">' +
      '<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">' +
        '<button class="btn btn-s" onclick="resetAdminPassword()" style="font-size:9px;padding:3px 8px"><span class="mi mi-sm" style="font-size:11px">key</span> Wachtwoord wijzigen</button>' +
        '<button class="btn btn-s" onclick="clearLocalAnalytics()" style="font-size:9px;padding:3px 8px;border-color:var(--dn);color:var(--dn)"><span class="mi mi-sm" style="font-size:11px">delete_sweep</span> Lokale data wissen</button>' +
      '</div>' +
    '</div>';

  refreshAdminData();
}

async function forceSync(){
  var statusEl = document.getElementById('adminSyncStatus');
  if(statusEl) statusEl.innerHTML = '<span style="color:var(--wn)">Syncen...</span>';
  await checkApiOnline();
  if(_apiOnline){
    await syncToServer();
    if(statusEl) statusEl.innerHTML = '<span style="color:var(--ac)">Gesynct \u2714</span>';
    refreshAdminData();
  } else {
    if(statusEl) statusEl.innerHTML = '<span style="color:var(--dn)">API offline</span>';
    toast('SQL Server API niet bereikbaar. Start: python analytics_api.py');
  }
}

function resetAdminPassword(){
  if(!confirm('Wachtwoord wijzigen? Het huidige wachtwoord wordt verwijderd.')) return;
  localStorage.removeItem(ADMIN_HASH_KEY);
  _adminUnlocked = false;
  showAdminLogin();
  toast('Stel een nieuw admin wachtwoord in');
}

function clearLocalAnalytics(){
  if(!confirm('Alle lokale analytics data wissen uit IndexedDB?\nData die al naar SQL Server is gesynct blijft daar behouden.')) return;
  if(!_analyticsDb) return;
  var stores = ['sessions','events','emails','feedback'];
  var tx = _analyticsDb.transaction(stores, 'readwrite');
  stores.forEach(function(name){ tx.objectStore(name).clear(); });
  tx.oncomplete = function(){
    toast('Lokale analytics data gewist');
    refreshAdminData();
  };
}

async function refreshAdminData(){
  var statsEl = document.getElementById('adminStats');
  var sessEl = document.getElementById('adminSessions');
  var emailEl = document.getElementById('adminEmails');
  var evtEl = document.getElementById('adminEvents');
  var statusEl = document.getElementById('adminSyncStatus');
  if(!statsEl) return;

  try {
    // Probeer data uit SQL Server (als online), anders IndexedDB
    var sessions = [];
    var emails = [];
    var events = [];
    var stats = null;
    var dataSource = 'IndexedDB';

    if(_apiOnline){
      try {
        stats = await fetch(ANALYTICS_API + '/admin/stats').then(function(r){ return r.json(); });
        sessions = await fetch(ANALYTICS_API + '/admin/sessions?limit=100').then(function(r){ return r.json(); });
        emails = await fetch(ANALYTICS_API + '/admin/emails').then(function(r){ return r.json(); });
        events = await fetch(ANALYTICS_API + '/admin/events?limit=200').then(function(r){ return r.json(); });
        dataSource = 'SQL Server';
      } catch(e){
        _apiOnline = false;
      }
    }

    // Fallback: data uit IndexedDB
    if(!_apiOnline || !stats){
      sessions = await idbGetAll('sessions');
      sessions.sort(function(a,b){ return (b.started_at||'').localeCompare(a.started_at||''); });
      emails = await idbGetAll('emails');
      emails.sort(function(a,b){ return (b.collected_at||'').localeCompare(a.collected_at||''); });
      events = await idbGetAll('events');
      events.sort(function(a,b){ return (b.timestamp||'').localeCompare(a.timestamp||''); });
      events = events.slice(0, 200);
      dataSource = 'IndexedDB';

      // Bereken stats uit lokale data
      var visitors = {};
      var today = new Date().toISOString().substring(0,10);
      var todaySess = 0;
      sessions.forEach(function(s){
        if(s.visitor_id) visitors[s.visitor_id] = true;
        if(s.started_at && s.started_at.substring(0,10) === today) todaySess++;
      });

      var countries = {};
      var cities = {};
      sessions.forEach(function(s){
        if(s.country){ countries[s.country] = (countries[s.country]||0) + 1; }
        if(s.city){ cities[s.city] = (cities[s.city]||0) + 1; }
      });

      stats = {
        unique_visitors: Object.keys(visitors).length,
        today_sessions: todaySess,
        total_sessions: sessions.length,
        total_emails: emails.length,
        total_events: events.length,
        top_countries: Object.entries(countries).sort(function(a,b){return b[1]-a[1]}).slice(0,10).map(function(e){return {country:e[0],count:e[1]}}),
        top_cities: Object.entries(cities).sort(function(a,b){return b[1]-a[1]}).slice(0,10).map(function(e){return {city:e[0],count:e[1]}}),
      };
    }

    // Sync status
    var unsyncCount = 0;
    try {
      var us = await idbGetAllByIndex('sessions','synced',0);
      var ue = await idbGetAllByIndex('events','synced',0);
      var um = await idbGetAllByIndex('emails','synced',0);
      var uf = await idbGetAllByIndex('feedback','synced',0);
      unsyncCount = us.length + ue.length + um.length + uf.length;
    } catch(e){}

    if(statusEl){
      var syncHtml = '<span style="color:' + (_apiOnline ? 'var(--ac)' : 'var(--dn)') + '">\u25cf ' + (_apiOnline ? 'Online' : 'Offline') + '</span>';
      if(unsyncCount > 0){
        syncHtml += ' \u00b7 <span style="color:var(--wn)">' + unsyncCount + ' ongesynct</span>';
      }
      syncHtml += ' \u00b7 <span style="color:var(--mt)">' + dataSource + '</span>';
      statusEl.innerHTML = syncHtml;
    }

    // Stats
    var uniqueVisitors = stats.unique_visitors || 0;
    var todaySessions = stats.today_sessions || 0;
    var countriesMap = {};
    var citiesMap = {};
    (stats.top_countries || []).forEach(function(c){ countriesMap[c.country] = c.count; });
    (stats.top_cities || []).forEach(function(c){ citiesMap[c.city] = c.count; });

    statsEl.innerHTML = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">' +
      '<div style="background:rgba(57,255,20,.08);border-radius:8px;padding:10px;text-align:center"><div style="font:700 18px \'Space Mono\',monospace;color:var(--ac)">'+uniqueVisitors+'</div><div style="font-size:9px;color:var(--mt)">Unieke bezoekers</div></div>' +
      '<div style="background:rgba(56,189,248,.08);border-radius:8px;padding:10px;text-align:center"><div style="font:700 18px \'Space Mono\',monospace;color:var(--ai)">'+todaySessions+'</div><div style="font-size:9px;color:var(--mt)">Vandaag</div></div>' +
      '<div style="background:rgba(251,191,36,.08);border-radius:8px;padding:10px;text-align:center"><div style="font:700 18px \'Space Mono\',monospace;color:var(--wn)">'+(stats.total_sessions||sessions.length)+'</div><div style="font-size:9px;color:var(--mt)">Totaal sessies</div></div>' +
      '<div style="background:rgba(239,68,68,.08);border-radius:8px;padding:10px;text-align:center"><div style="font:700 18px \'Space Mono\',monospace;color:#ef4444">'+(stats.total_emails||emails.length)+'</div><div style="font-size:9px;color:var(--mt)">E-mails</div></div>' +
      '</div>' +
      '<div style="font-size:10px;color:var(--mt)"><b>Landen:</b> ' + Object.entries(countriesMap).sort(function(a,b){return b[1]-a[1]}).map(function(e){return e[0]+' ('+e[1]+')'}).join(', ') + '</div>' +
      '<div style="font-size:10px;color:var(--mt);margin-top:4px"><b>Steden:</b> ' + Object.entries(citiesMap).sort(function(a,b){return b[1]-a[1]}).slice(0,10).map(function(e){return e[0]+' ('+e[1]+')'}).join(', ') + '</div>';

    // Sessies
    var sessHtml = '';
    sessions.slice(0,50).forEach(function(s){
      var t = s.started_at ? new Date(s.started_at) : null;
      var tijd = t ? t.toLocaleDateString('nl-NL',{day:'2-digit',month:'short'}) + ' ' + t.toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit'}) : '';
      var browser = parseBrowser(s.user_agent || '');
      var syncBadge = s.synced === 0 ? ' <span style="color:var(--wn);font-size:8px" title="Nog niet gesynct">\u25cf</span>' : '';
      sessHtml += '<div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,.05)">' +
        '<div style="display:flex;justify-content:space-between;align-items:center">' +
        '<span style="color:var(--ac);font:500 10px \'Space Mono\',monospace">'+escapeHtml(s.ip_address||'lokaal')+'</span>' +
        '<span style="color:var(--mt);font-size:9px">'+tijd+syncBadge+'</span></div>' +
        '<div style="font-size:9px;color:var(--tx);margin-top:2px">'+escapeHtml(browser)+' \u00b7 '+escapeHtml(s.platform||'')+' \u00b7 '+(s.screen_w||'?')+'x'+(s.screen_h||'?')+(s.touch_device?' \u00b7 \u261f Touch':'')+'</div>' +
        '<div style="font-size:9px;color:var(--mt)">'+escapeHtml((s.city||'')+(s.region?' , '+s.region:'')+(s.country?' , '+s.country:''))+' \u00b7 Bezoek #'+(s.visit_count||1)+'</div>' +
        (s.referrer ? '<div style="font-size:8px;color:var(--mt);opacity:.6">ref: '+escapeHtml(s.referrer.substring(0,80))+'</div>' : '') +
        '</div>';
    });
    sessEl.innerHTML = sessHtml || '<div style="color:var(--mt);text-align:center;padding:12px">Geen sessies gevonden</div>';

    // Emails
    var emailHtml = '';
    emails.forEach(function(e){
      var t = e.collected_at ? new Date(e.collected_at) : null;
      var tijd = t ? t.toLocaleDateString('nl-NL') + ' ' + t.toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit'}) : '';
      emailHtml += '<div style="padding:4px 0;border-bottom:1px solid rgba(255,255,255,.05);display:flex;justify-content:space-between">' +
        '<span style="color:var(--ai)">'+escapeHtml(e.email||'')+'</span>' +
        '<span style="color:var(--mt);font-size:9px">'+tijd+' \u00b7 '+(e.session_duration_min||0)+' min</span></div>';
    });
    emailEl.innerHTML = emailHtml || '<div style="color:var(--mt);text-align:center;padding:12px">Geen e-mails</div>';

    // Events
    var evtHtml = '';
    events.slice(0,100).forEach(function(e){
      var t = e.timestamp ? new Date(e.timestamp) : null;
      var tijd = t ? t.toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '';
      evtHtml += '<div style="padding:2px 0;border-bottom:1px solid rgba(255,255,255,.03);display:flex;gap:6px">' +
        '<span style="color:var(--mt);font-size:9px;flex-shrink:0;width:55px">'+tijd+'</span>' +
        '<span style="color:var(--ac);font-size:9px;flex-shrink:0;width:80px">'+escapeHtml(e.event_type||'')+'</span>' +
        '<span style="color:var(--tx);font-size:9px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+escapeHtml((e.event_detail||'').substring(0,100))+'</span></div>';
    });
    evtEl.innerHTML = evtHtml || '<div style="color:var(--mt);text-align:center;padding:12px">Geen events</div>';

    // Uploads
    var uplEl = document.getElementById('adminUploads');
    var uplCountEl = document.getElementById('adminUploadCount');
    if(uplEl){
      var uploads = [];
      // Haal uit IndexedDB
      try { uploads = await idbGetAll('uploads'); } catch(e){}
      // Sorteer op datum (nieuwste eerst)
      uploads.sort(function(a,b){ return (b.uploaded_at||'').localeCompare(a.uploaded_at||''); });

      if(uplCountEl) uplCountEl.textContent = uploads.length + ' uploads';

      var uplHtml = '';
      uploads.forEach(function(u){
        var t = u.uploaded_at ? new Date(u.uploaded_at) : null;
        var tijd = t ? t.toLocaleDateString('nl-NL',{day:'2-digit',month:'short',year:'numeric'}) + ' ' + t.toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit'}) : '';
        var syncBadge = u.synced ? '' : ' <span style="color:var(--wn);font-size:8px" title="Nog niet gesynct">\u25cf</span>';
        var onMap = false;
        for(var i=0;i<_uploadLayers.length;i++){ if(_uploadLayers[i].upload_id===u.upload_id){ onMap=true; break; } }

        uplHtml += '<div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,.05)">' +
          '<div style="display:flex;align-items:center;gap:8px">' +
            '<div style="width:28px;height:28px;background:'+(u.color||'#e11d48')+';border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0">' +
              '<span class="mi" style="font-size:14px;color:#fff;font-variation-settings:\'FILL\' 1">'+(u.icon||'location_on')+'</span></div>' +
            '<div style="flex:1">' +
              '<div style="font:600 11px \'DM Sans\',sans-serif;color:var(--tx)">'+escapeHtml(u.name||u.filename||'Upload')+'</div>' +
              '<div style="font-size:9px;color:var(--mt)">' +
                (u.row_count||0)+' locaties \u00b7 '+tijd+syncBadge +
                (onMap ? ' \u00b7 <span style="color:var(--ac)">op kaart</span>' : '') +
              '</div>' +
              (u.description ? '<div style="font-size:9px;color:var(--st);margin-top:2px;font-style:italic">'+escapeHtml(u.description.substring(0,80))+'</div>' : '') +
              (u.visitor_id ? '<div style="font-size:8px;color:var(--mt);opacity:.6">Bezoeker: '+escapeHtml(u.visitor_id.substring(0,12))+'</div>' : '') +
            '</div>' +
            '<button class="btn btn-s" onclick="adminShowUploadData(\''+escapeHtml(u.upload_id)+'\')" style="font-size:9px;padding:2px 6px" title="Bekijk data">' +
              '<span class="mi mi-sm" style="font-size:11px">table_view</span></button>' +
            '<button class="btn btn-s" onclick="adminReplotUpload(\''+escapeHtml(u.upload_id)+'\')" style="font-size:9px;padding:2px 6px" title="Opnieuw op kaart">' +
              '<span class="mi mi-sm" style="font-size:11px">add_location</span></button>' +
            '<button class="btn btn-s" onclick="deleteUploadPermanent(\''+escapeHtml(u.upload_id)+'\')" style="font-size:9px;padding:2px 6px;border-color:var(--dn);color:var(--dn)" title="Permanent verwijderen">' +
              '<span class="mi mi-sm" style="font-size:11px">delete_forever</span></button>' +
          '</div>' +
        '</div>';
      });
      uplEl.innerHTML = uplHtml || '<div style="color:var(--mt);text-align:center;padding:12px">Geen uploads</div>';
    }

  } catch(e){
    statsEl.innerHTML = '<div style="color:var(--dn)">Fout bij laden: '+escapeHtml(e.message)+'</div>';
    console.error('Admin dashboard error:', e);
  }
}

function parseBrowser(ua){
  if(!ua) return 'Onbekend';
  if(ua.indexOf('Firefox') > -1) return 'Firefox';
  if(ua.indexOf('Edg/') > -1) return 'Edge';
  if(ua.indexOf('OPR/') > -1 || ua.indexOf('Opera') > -1) return 'Opera';
  if(ua.indexOf('Chrome') > -1) return 'Chrome';
  if(ua.indexOf('Safari') > -1) return 'Safari';
  return 'Overig';
}

// Admin: bekijk upload data in popup
function adminShowUploadData(uploadId){
  idbGetAll('uploads').then(function(uploads){
    var rec = null;
    for(var i=0;i<uploads.length;i++){ if(uploads[i].upload_id===uploadId){ rec=uploads[i]; break; } }
    if(!rec){ toast('Upload niet gevonden'); return; }

    var cols = rec.columns || [];
    var data = rec.data || [];
    var html = '<div style="font-family:DM Sans,sans-serif;padding:16px;max-width:600px;max-height:500px;overflow:auto">';
    html += '<div style="font:700 14px \'DM Sans\',sans-serif;color:var(--ac);margin-bottom:4px">'+escapeHtml(rec.name||rec.filename||'Upload')+'</div>';
    if(rec.description) html += '<div style="font-size:10px;color:var(--st);margin-bottom:6px;font-style:italic">'+escapeHtml(rec.description)+'</div>';
    html += '<div style="font-size:10px;color:var(--mt);margin-bottom:10px">'+data.length+' rijen \u00b7 '+cols.length+' kolommen \u00b7 '+new Date(rec.uploaded_at).toLocaleString('nl-NL')+'</div>';
    html += '<table style="width:100%;font-size:9px;border-collapse:collapse">';
    html += '<tr>';
    cols.forEach(function(c){ if(c!=='_lat'&&c!=='_lng') html += '<th style="padding:3px 6px;border-bottom:1px solid var(--br);text-align:left;color:var(--ac);font-size:8px">'+escapeHtml(c)+'</th>'; });
    html += '</tr>';
    data.slice(0,50).forEach(function(r){
      html += '<tr>';
      cols.forEach(function(c){ if(c!=='_lat'&&c!=='_lng') html += '<td style="padding:2px 6px;border-bottom:1px solid rgba(255,255,255,.03);color:var(--tx)">'+escapeHtml(String(r[c]||'').substring(0,40))+'</td>'; });
      html += '</tr>';
    });
    if(data.length > 50) html += '<tr><td colspan="'+cols.length+'" style="padding:6px;color:var(--mt);text-align:center">... en '+(data.length-50)+' meer rijen</td></tr>';
    html += '</table></div>';

    // Toon in een modal-achtige overlay
    var overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:pointer';
    overlay.onclick = function(){ document.body.removeChild(overlay); };
    var card = document.createElement('div');
    card.style.cssText = 'background:var(--p);border:1px solid var(--br);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.5);cursor:default';
    card.onclick = function(e){ e.stopPropagation(); };
    card.innerHTML = html;
    overlay.appendChild(card);
    document.body.appendChild(overlay);
  });
}

// Admin: herplaats upload op kaart
function adminReplotUpload(uploadId){
  // Check of al op kaart
  for(var i=0;i<_uploadLayers.length;i++){
    if(_uploadLayers[i].upload_id === uploadId){
      toast('Upload staat al op de kaart');
      try{ _map.fitBounds(_uploadLayers[i].layer.getBounds(), {padding:[40,40], maxZoom:14}); }catch(e){}
      return;
    }
  }
  idbGetAll('uploads').then(function(uploads){
    var rec = null;
    for(var i=0;i<uploads.length;i++){ if(uploads[i].upload_id===uploadId){ rec=uploads[i]; break; } }
    if(!rec){ toast('Upload niet gevonden'); return; }
    var layerInfo = renderUploadMarkers(rec);
    _uploadLayers.push(layerInfo);
    updateUploadLayerList();
    try{ _map.fitBounds(layerInfo.layer.getBounds(), {padding:[40,40], maxZoom:14}); }catch(e){}
    toast(layerInfo.count + ' markers op kaart geplaatst');
  });
}

async function exportAdminCSV(){
  try {
    var sessions = [];
    if(_apiOnline){
      try {
        sessions = await fetch(ANALYTICS_API + '/admin/sessions?limit=1000').then(function(r){ return r.json(); });
      } catch(e){ _apiOnline = false; }
    }
    if(!sessions.length){
      sessions = await idbGetAll('sessions');
    }
    if(!sessions.length){ toast('Geen data'); return; }
    var keys = Object.keys(sessions[0]).filter(function(k){ return k !== 'synced'; });
    var csv = keys.join(';') + '\n';
    sessions.forEach(function(s){
      csv += keys.map(function(k){ return String(s[k]||'').replace(/;/g,',').replace(/\n/g,' '); }).join(';') + '\n';
    });
    var blob = new Blob(['\ufeff' + csv], {type:'text/csv;charset=utf-8'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'geoinzicht_sessions_' + new Date().toISOString().substring(0,10) + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toast('Admin CSV geëxporteerd');
  } catch(e){ toast('Export fout: '+e.message); }
}

// ============================================================
// GEBRUIKERS DATA UPLOAD (CSV/Excel naar kaart)
// ============================================================
var _uploadData = null;      // Geparsede rijen [{lat,lng,...}] — tijdelijk voor preview
var _uploadColumns = [];     // Kolomnamen — tijdelijk voor preview
var _uploadFileName = '';    // Bestandsnaam van huidige upload
var _uploadLayers = [];      // Array van {upload_id, name, layer, icon, color, count, data, columns, labelCol}
var _uploadSelectedIcon = 'location_on';
var _uploadSelectedColor = '#e11d48';

var UPLOAD_ICONS = [
  {id:'location_on', label:'Pin'},
  {id:'home', label:'Huis'},
  {id:'store', label:'Winkel'},
  {id:'business', label:'Bedrijf'},
  {id:'school', label:'School'},
  {id:'local_hospital', label:'Ziekenhuis'},
  {id:'restaurant', label:'Restaurant'},
  {id:'directions_car', label:'Auto'},
  {id:'park', label:'Park'},
  {id:'warning', label:'Waarschuwing'},
  {id:'star', label:'Ster'},
  {id:'flag', label:'Vlag'},
  {id:'person', label:'Persoon'},
  {id:'bolt', label:'Bliksem'}
];

var UPLOAD_COLORS = [
  '#e11d48','#dc2626','#ea580c','#d97706','#65a30d','#16a34a',
  '#0891b2','#2563eb','#7c3aed','#c026d3','#475569','#0f172a'
];

function initUploadUI(){
  // Icoon picker
  var iconEl = document.getElementById('iconPicker');
  if(iconEl){
    iconEl.innerHTML = UPLOAD_ICONS.map(function(ic){
      var sel = ic.id === _uploadSelectedIcon ? 'border-color:#39ff14;background:rgba(57,255,20,.15)' : '';
      return '<div onclick="selectUploadIcon(\''+ic.id+'\')" title="'+ic.label+'" style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:6px;border:1.5px solid var(--br);cursor:pointer;'+sel+'"><span class="mi" style="font-size:16px;color:'+_uploadSelectedColor+'">'+ic.id+'</span></div>';
    }).join('');
  }
  // Kleur picker
  var colorEl = document.getElementById('colorPicker');
  if(colorEl){
    colorEl.innerHTML = UPLOAD_COLORS.map(function(c){
      var sel = c === _uploadSelectedColor ? 'border:2px solid #39ff14;transform:scale(1.2)' : 'border:2px solid transparent';
      return '<div onclick="selectUploadColor(\''+c+'\')" style="width:20px;height:20px;border-radius:50%;background:'+c+';cursor:pointer;'+sel+'" title="'+c+'"></div>';
    }).join('');
  }
}

function selectUploadIcon(id){
  _uploadSelectedIcon = id;
  initUploadUI();
}

function selectUploadColor(c){
  _uploadSelectedColor = c;
  initUploadUI();
}

function handleUploadDrop(e){
  var files = e.dataTransfer.files;
  if(files.length > 0) handleUploadFile(files[0]);
}

function handleUploadFile(file){
  if(!file) return;
  _uploadFileName = file.name;
  var ext = file.name.split('.').pop().toLowerCase();

  if(ext === 'csv' || ext === 'tsv'){
    var reader = new FileReader();
    reader.onload = function(e){ parseCSV(e.target.result, file.name, ext === 'tsv' ? '\t' : null); };
    reader.readAsText(file);
  } else if(ext === 'xlsx' || ext === 'xls'){
    // Gebruik SheetJS (XLSX) library — lazy load
    loadSheetJS(function(){
      var reader = new FileReader();
      reader.onload = function(e){
        try {
          var wb = XLSX.read(e.target.result, {type:'array'});
          var ws = wb.Sheets[wb.SheetNames[0]];
          var csv = XLSX.utils.sheet_to_csv(ws);
          parseCSV(csv, file.name);
        } catch(err){
          toast('Excel leesfout: ' + err.message);
        }
      };
      reader.readAsArrayBuffer(file);
    });
  } else {
    toast('Niet ondersteund formaat. Gebruik .csv, .xlsx of .xls');
  }
}

function loadSheetJS(callback){
  if(typeof XLSX !== 'undefined'){ callback(); return; }
  var s = document.createElement('script');
  s.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
  s.onload = callback;
  s.onerror = function(){ toast('Fout bij laden Excel-lezer'); };
  document.head.appendChild(s);
}

function parseCSV(text, fileName, separator){
  var lines = text.trim().split('\n');
  if(lines.length < 2){ toast('Bestand is leeg of heeft geen data'); return; }

  // Detecteer separator als niet opgegeven
  if(!separator){
    var firstLine = lines[0];
    if(firstLine.split(';').length > firstLine.split(',').length) separator = ';';
    else if(firstLine.split('\t').length > firstLine.split(',').length) separator = '\t';
    else separator = ',';
  }

  // Parse header
  var headers = parseCSVLine(lines[0], separator);
  _uploadColumns = headers;

  // Parse rijen
  var rows = [];
  for(var i = 1; i < lines.length; i++){
    if(!lines[i].trim()) continue;
    var vals = parseCSVLine(lines[i], separator);
    var row = {};
    headers.forEach(function(h, j){ row[h] = vals[j] || ''; });
    rows.push(row);
  }

  // Detecteer lat/lng kolommen
  var latCol = findColumn(headers, ['lat','latitude','breedtegraad','y','lat_wgs84']);
  var lngCol = findColumn(headers, ['lng','lon','longitude','lengtegraad','x','lng_wgs84','long']);

  if(!latCol || !lngCol){
    toast('Geen lat/lng kolommen gevonden. Bestand moet "lat" en "lng" (of "latitude"/"longitude") kolommen bevatten om op de kaart te plotten.');
    return;
  }

  // Parse coördinaten
  var validRows = [];
  rows.forEach(function(r){
    var lat = parseFloat(String(r[latCol]).replace(',','.'));
    var lng = parseFloat(String(r[lngCol]).replace(',','.'));
    if(!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180){
      r._lat = lat;
      r._lng = lng;
      validRows.push(r);
    }
  });

  if(validRows.length === 0){
    toast('Geen geldige coördinaten gevonden in bestand');
    return;
  }

  _uploadData = validRows;

  // Toon UI
  document.getElementById('uploadIconSection').style.display = '';
  document.getElementById('uploadInfoSection').style.display = '';
  document.getElementById('uploadPreview').style.display = '';
  document.getElementById('uploadRowCount').textContent = validRows.length + ' van ' + rows.length + ' rijen met coördinaten';

  // Vul naam voor met bestandsnaam (zonder extensie)
  var nameEl = document.getElementById('uploadDatasetName');
  if(nameEl && !nameEl.value){
    var baseName = (_uploadFileName || '').replace(/\.[^.]+$/, '');
    nameEl.value = baseName;
  }

  // Label dropdown vullen
  var labelSel = document.getElementById('uploadLabelCol');
  labelSel.innerHTML = '<option value="">Geen label</option>';
  headers.forEach(function(h){
    if(h === latCol || h === lngCol) return;
    labelSel.innerHTML += '<option value="'+escapeHtml(h)+'">'+escapeHtml(h)+'</option>';
  });
  // Auto-select eerste niet-coord kolom
  var firstNonCoord = headers.filter(function(h){return h!==latCol && h!==lngCol})[0];
  if(firstNonCoord) labelSel.value = firstNonCoord;

  // Preview tabel
  var previewTable = document.getElementById('uploadPreviewTable');
  var thHtml = '<thead><tr>' + headers.map(function(h){return '<th style="padding:4px 6px;font-size:9px;white-space:nowrap">'+escapeHtml(h)+'</th>'}).join('') + '</tr></thead>';
  var tbHtml = '<tbody>';
  validRows.slice(0,10).forEach(function(r){
    tbHtml += '<tr>' + headers.map(function(h){
      var v = String(r[h]||'').substring(0,30);
      return '<td style="padding:3px 6px;font-size:9px;white-space:nowrap">'+escapeHtml(v)+'</td>';
    }).join('') + '</tr>';
  });
  if(validRows.length > 10) tbHtml += '<tr><td colspan="'+headers.length+'" style="padding:4px;text-align:center;color:var(--mt);font-size:9px">... en '+(validRows.length-10)+' meer</td></tr>';
  tbHtml += '</tbody>';
  previewTable.innerHTML = thHtml + tbHtml;

  initUploadUI();
  toast(validRows.length + ' locaties geladen uit ' + fileName);
  logEvent('upload_csv', fileName + ': ' + validRows.length + ' rijen');
}

function parseCSVLine(line, sep){
  // Eenvoudige CSV parser die quoted velden ondersteunt
  var result = [];
  var current = '';
  var inQuotes = false;
  for(var i = 0; i < line.length; i++){
    var c = line[i];
    if(c === '"'){
      if(inQuotes && i+1 < line.length && line[i+1] === '"'){ current += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if(c === sep && !inQuotes){
      result.push(current.trim());
      current = '';
    } else {
      current += c;
    }
  }
  result.push(current.trim());
  return result;
}

function findColumn(headers, candidates){
  for(var i=0;i<candidates.length;i++){
    for(var j=0;j<headers.length;j++){
      if(headers[j].toLowerCase().trim() === candidates[i]) return headers[j];
    }
  }
  return null;
}

function addUploadToMap(){
  if(!_uploadData || !_uploadData.length){ toast('Geen data om te tonen'); return; }

  var labelCol = document.getElementById('uploadLabelCol').value;
  var icon = _uploadSelectedIcon;
  var color = _uploadSelectedColor;
  var datasetName = (document.getElementById('uploadDatasetName').value || '').trim();
  var datasetDesc = (document.getElementById('uploadDatasetDesc').value || '').trim();
  // Naam is verplicht
  if(!datasetName){
    toast('Geef de dataset een naam');
    document.getElementById('uploadDatasetName').focus();
    document.getElementById('uploadDatasetName').style.borderColor = '#ef4444';
    return;
  }
  var layerName = datasetName;

  // Check duplicaat: zelfde filename → overschrijf bestaande
  var existingId = null;
  var isOverwrite = false;
  if(_uploadFileName){
    // Zoek in huidige layers op kaart
    for(var i = _uploadLayers.length - 1; i >= 0; i--){
      if(_uploadLayers[i].name === _uploadFileName || _uploadLayers[i].name === layerName){
        existingId = _uploadLayers[i].upload_id;
        // Verwijder oude kaartlaag
        if(_map.hasLayer(_uploadLayers[i].layer)) _map.removeLayer(_uploadLayers[i].layer);
        _uploadLayers.splice(i, 1);
        isOverwrite = true;
        break;
      }
    }
  }

  var uploadId = existingId || ('upl_' + Date.now() + '_' + Math.random().toString(36).substring(2,8));

  // Bewaar data persistent in IndexedDB
  var uploadRecord = {
    upload_id: uploadId,
    name: layerName,
    description: datasetDesc,
    filename: _uploadFileName || '',
    icon: icon,
    color: color,
    label_column: labelCol,
    columns: _uploadColumns.slice(),
    data: _uploadData.map(function(r){
      var clean = {};
      _uploadColumns.forEach(function(c){ if(r[c] !== undefined) clean[c] = r[c]; });
      clean._lat = r._lat;
      clean._lng = r._lng;
      return clean;
    }),
    row_count: _uploadData.length,
    uploaded_at: new Date().toISOString(),
    visitor_id: _visitorId || '',
    session_id: _sessionId || '',
    synced: 0
  };

  // Sla op in IndexedDB (put overschrijft bij zelfde upload_id)
  idbPut('uploads', uploadRecord).then(function(){
    // Sync naar server
    syncUploadToServer(uploadRecord);
  });

  // Log het overschrijven
  if(isOverwrite){
    logEvent('upload_overschreven', layerName + ': ' + _uploadData.length + ' rijen (was: ' + uploadId + ')');
  }

  // Render de markers op de kaart
  var layerInfo = renderUploadMarkers(uploadRecord);
  _uploadLayers.push(layerInfo);

  // Zoom naar data
  var bounds = _uploadData.map(function(r){ return [r._lat, r._lng]; });
  if(bounds.length > 0){
    try{ _map.fitBounds(bounds, {padding:[40,40], maxZoom:14}); }catch(e){}
  }

  // Update actieve uploads lijst
  updateUploadLayerList();
  updateSavedUploadsList();

  toast(layerInfo.count + ' markers op kaart geplaatst \u00b7 ' + (isOverwrite ? 'Overschreven' : 'Data opgeslagen'));
  logEvent('upload_kaart', layerName + ': ' + layerInfo.count + ' markers' + (isOverwrite ? ' (overschreven)' : ''));

  // Toon upload rapport
  showUploadReport(uploadRecord);

  // Reset upload state (data is opgeslagen, preview kan weg)
  _uploadData = null;
  _uploadColumns = [];
  _uploadFileName = '';
  document.getElementById('uploadPreview').style.display = 'none';
  document.getElementById('uploadIconSection').style.display = 'none';
  document.getElementById('uploadInfoSection').style.display = 'none';
  document.getElementById('uploadFileInput').value = '';
  document.getElementById('uploadDatasetName').value = '';
  document.getElementById('uploadDatasetDesc').value = '';
  document.getElementById('uploadDatasetName').style.borderColor = '';
}

// Upload rapport — statistieken over geüploade dataset
function showUploadReport(rec){
  var data = rec.data || [];
  var cols = rec.columns || [];
  if(!data.length) return;

  // Bereken statistieken
  var numCols = [];
  var catCols = [];
  var dateCols = [];
  cols.forEach(function(col){
    if(col === '_lat' || col === '_lng') return;
    var numCount = 0, total = 0, min = Infinity, max = -Infinity;
    var vals = {};
    var dateCount = 0;
    data.forEach(function(r){
      var v = r[col];
      if(v === undefined || v === null || v === '') return;
      var n = parseFloat(String(v).replace(',','.'));
      if(!isNaN(n) && isFinite(n)){ numCount++; total += n; min = Math.min(min,n); max = Math.max(max,n); }
      var sv = String(v).trim();
      vals[sv] = (vals[sv]||0) + 1;
      if(/^\d{4}-\d{2}-\d{2}/.test(sv)) dateCount++;
    });
    var nonEmpty = data.filter(function(r){ return r[col] !== undefined && r[col] !== null && r[col] !== ''; }).length;
    var uniqueCount = Object.keys(vals).length;
    if(dateCount > nonEmpty * 0.5){
      dateCols.push({name:col, count:nonEmpty, unique:uniqueCount});
    } else if(numCount > nonEmpty * 0.5 && numCount > 2){
      numCols.push({name:col, count:numCount, avg:total/numCount, min:min, max:max, sum:total});
    } else if(nonEmpty > 0){
      // Top 5 waarden
      var sorted = Object.entries(vals).sort(function(a,b){ return b[1]-a[1]; });
      catCols.push({name:col, count:nonEmpty, unique:uniqueCount, top5:sorted.slice(0,5)});
    }
  });

  // Geografische spreiding
  var lats = data.map(function(r){ return r._lat; }).filter(Boolean);
  var lngs = data.map(function(r){ return r._lng; }).filter(Boolean);
  var minLat = Math.min.apply(null,lats), maxLat = Math.max.apply(null,lats);
  var minLng = Math.min.apply(null,lngs), maxLng = Math.max.apply(null,lngs);
  var centerLat = ((minLat+maxLat)/2).toFixed(4);
  var centerLng = ((minLng+maxLng)/2).toFixed(4);

  // Bouw rapport HTML
  var h = '<div style="font-family:DM Sans,sans-serif;padding:20px;max-width:560px;max-height:70vh;overflow-y:auto">';
  h += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">';
  h += '<div style="width:36px;height:36px;background:'+(rec.color||'var(--ac)')+';border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0">';
  h += '<span class="mi" style="font-size:20px;color:#fff;font-variation-settings:\'FILL\' 1">'+(rec.icon||'location_on')+'</span></div>';
  h += '<div><div style="font:700 16px \'DM Sans\',sans-serif;color:var(--ac)">'+escapeHtml(rec.name||'Upload')+'</div>';
  if(rec.description) h += '<div style="font-size:11px;color:var(--st);font-style:italic;margin-top:2px">'+escapeHtml(rec.description)+'</div>';
  h += '</div></div>';

  // Overzicht
  h += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px">';
  h += '<div style="background:rgba(255,255,255,.03);border:1px solid var(--br);border-radius:8px;padding:10px;text-align:center">';
  h += '<div style="font:700 18px \'Space Mono\',monospace;color:var(--ac)">'+data.length.toLocaleString('nl-NL')+'</div>';
  h += '<div style="font-size:9px;color:var(--mt)">Locaties</div></div>';
  h += '<div style="background:rgba(255,255,255,.03);border:1px solid var(--br);border-radius:8px;padding:10px;text-align:center">';
  h += '<div style="font:700 18px \'Space Mono\',monospace;color:var(--st)">'+cols.filter(function(c){return c!=='_lat'&&c!=='_lng'}).length+'</div>';
  h += '<div style="font-size:9px;color:var(--mt)">Kolommen</div></div>';
  h += '<div style="background:rgba(255,255,255,.03);border:1px solid var(--br);border-radius:8px;padding:10px;text-align:center">';
  h += '<div style="font:700 18px \'Space Mono\',monospace;color:var(--tx)">'+((maxLat-minLat).toFixed(2))+'°</div>';
  h += '<div style="font-size:9px;color:var(--mt)">Lat-spreiding</div></div>';
  h += '</div>';

  // Geografisch
  h += '<div style="margin-bottom:12px">';
  h += '<div style="font:700 11px \'DM Sans\',sans-serif;color:var(--ac);margin-bottom:6px"><span class="mi" style="font-size:13px;vertical-align:-2px">map</span> Geografisch</div>';
  h += '<div style="font-size:10px;color:var(--mt);line-height:1.6">';
  h += 'Centrum: <span style="font-family:Space Mono,monospace;color:var(--tx)">'+centerLat+', '+centerLng+'</span><br>';
  h += 'Bereik: <span style="font-family:Space Mono,monospace;color:var(--tx)">'+minLat.toFixed(4)+'–'+maxLat.toFixed(4)+' N, '+minLng.toFixed(4)+'–'+maxLng.toFixed(4)+' E</span>';
  h += '</div></div>';

  // Numerieke kolommen
  if(numCols.length){
    h += '<div style="margin-bottom:12px">';
    h += '<div style="font:700 11px \'DM Sans\',sans-serif;color:var(--ac);margin-bottom:6px"><span class="mi" style="font-size:13px;vertical-align:-2px">calculate</span> Numerieke kolommen</div>';
    h += '<table style="width:100%;border-collapse:collapse;font-size:9px">';
    h += '<tr style="border-bottom:1px solid var(--br)">';
    h += '<th style="padding:4px 6px;text-align:left;color:var(--mt)">Kolom</th>';
    h += '<th style="padding:4px 6px;text-align:right;color:var(--mt)">Min</th>';
    h += '<th style="padding:4px 6px;text-align:right;color:var(--mt)">Gem.</th>';
    h += '<th style="padding:4px 6px;text-align:right;color:var(--mt)">Max</th>';
    h += '<th style="padding:4px 6px;text-align:right;color:var(--mt)">Totaal</th></tr>';
    numCols.forEach(function(nc){
      h += '<tr style="border-bottom:1px solid rgba(255,255,255,.03)">';
      h += '<td style="padding:3px 6px;color:var(--tx)">'+escapeHtml(nc.name)+'</td>';
      h += '<td style="padding:3px 6px;text-align:right;font-family:Space Mono,monospace;color:var(--st)">'+nc.min.toLocaleString('nl-NL',{maximumFractionDigits:1})+'</td>';
      h += '<td style="padding:3px 6px;text-align:right;font-family:Space Mono,monospace;color:var(--ac)">'+nc.avg.toLocaleString('nl-NL',{maximumFractionDigits:1})+'</td>';
      h += '<td style="padding:3px 6px;text-align:right;font-family:Space Mono,monospace;color:var(--st)">'+nc.max.toLocaleString('nl-NL',{maximumFractionDigits:1})+'</td>';
      h += '<td style="padding:3px 6px;text-align:right;font-family:Space Mono,monospace;color:var(--tx)">'+nc.sum.toLocaleString('nl-NL',{maximumFractionDigits:1})+'</td>';
      h += '</tr>';
    });
    h += '</table></div>';
  }

  // Categorische kolommen (top waarden)
  if(catCols.length){
    h += '<div style="margin-bottom:12px">';
    h += '<div style="font:700 11px \'DM Sans\',sans-serif;color:var(--ac);margin-bottom:6px"><span class="mi" style="font-size:13px;vertical-align:-2px">category</span> Categorieën</div>';
    catCols.forEach(function(cc){
      h += '<div style="margin-bottom:8px">';
      h += '<div style="font:600 10px \'DM Sans\',sans-serif;color:var(--tx);margin-bottom:3px">'+escapeHtml(cc.name)+' <span style="color:var(--mt);font-weight:400">('+cc.unique+' uniek)</span></div>';
      var maxVal = cc.top5.length ? cc.top5[0][1] : 1;
      cc.top5.forEach(function(tv){
        var pct = Math.round(tv[1]/data.length*100);
        var barW = Math.max(4, Math.round(tv[1]/maxVal*100));
        h += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:2px">';
        h += '<div style="width:90px;font-size:9px;color:var(--st);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex-shrink:0" title="'+escapeHtml(tv[0])+'">'+escapeHtml(tv[0].substring(0,15))+'</div>';
        h += '<div style="flex:1;height:12px;background:rgba(255,255,255,.05);border-radius:3px;overflow:hidden"><div style="width:'+barW+'%;height:100%;background:var(--ac);border-radius:3px"></div></div>';
        h += '<div style="font:500 9px \'Space Mono\',monospace;color:var(--mt);width:50px;text-align:right">'+tv[1]+' ('+pct+'%)</div>';
        h += '</div>';
      });
      if(cc.unique > 5) h += '<div style="font-size:8px;color:var(--mt);margin-top:2px">... en '+(cc.unique-5)+' meer</div>';
      h += '</div>';
    });
    h += '</div>';
  }

  // Datum kolommen
  if(dateCols.length){
    h += '<div style="margin-bottom:12px">';
    h += '<div style="font:700 11px \'DM Sans\',sans-serif;color:var(--ac);margin-bottom:4px"><span class="mi" style="font-size:13px;vertical-align:-2px">calendar_month</span> Datumkolommen</div>';
    dateCols.forEach(function(dc){
      h += '<div style="font-size:10px;color:var(--st)">'+escapeHtml(dc.name)+': '+dc.count+' waarden, '+dc.unique+' unieke datums</div>';
    });
    h += '</div>';
  }

  // Bestandsinfo
  h += '<div style="border-top:1px solid var(--br);padding-top:8px;margin-top:8px;font-size:9px;color:var(--mt)">';
  h += '<span class="mi" style="font-size:11px;vertical-align:-2px">info</span> ';
  h += 'Bestand: '+escapeHtml(rec.filename||'—')+' · ';
  h += 'Upload ID: '+escapeHtml(rec.upload_id.substring(0,16))+'... · ';
  h += new Date(rec.uploaded_at).toLocaleString('nl-NL');
  h += '</div>';

  h += '</div>';

  // Toon in overlay
  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:pointer;animation:fadeIn .2s';
  overlay.onclick = function(){ document.body.removeChild(overlay); };
  var card = document.createElement('div');
  card.style.cssText = 'background:var(--p);border:1px solid var(--br);border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.5);cursor:default;max-width:90vw';
  card.onclick = function(e){ e.stopPropagation(); };
  card.innerHTML = h;
  overlay.appendChild(card);
  document.body.appendChild(overlay);

  logEvent('upload_rapport', rec.name + ': ' + data.length + ' loc, ' + numCols.length + ' num, ' + catCols.length + ' cat');
}

// Render markers op kaart vanuit een upload record
function renderUploadMarkers(rec){
  var markers = L.layerGroup();
  var data = rec.data || [];
  var labelCol = rec.label_column || '';
  var icon = rec.icon || 'location_on';
  var color = rec.color || '#e11d48';
  var cols = rec.columns || [];

  data.forEach(function(r){
    var lat = r._lat, lng = r._lng;
    if(!lat || !lng) return;

    var markerIcon = L.divIcon({
      className: 'upload-marker',
      html: '<div style="display:flex;align-items:center;justify-content:center;width:32px;height:32px;background:'+color+';border-radius:50% 50% 50% 0;transform:rotate(-45deg);box-shadow:0 2px 8px rgba(0,0,0,.4);border:2px solid #fff"><span class="mi" style="font-size:16px;color:#fff;transform:rotate(45deg);font-variation-settings:\'FILL\' 1">'+icon+'</span></div>',
      iconSize: [32,32],
      iconAnchor: [16,32],
      popupAnchor: [0,-32]
    });

    var marker = L.marker([lat,lng], {icon:markerIcon});

    // Popup met alle data
    var popupHtml = '<div style="font-family:DM Sans,sans-serif;font-size:11px;max-width:250px">';
    if(labelCol && r[labelCol]){
      popupHtml += '<div style="font:700 13px \'DM Sans\',sans-serif;color:#0f172a;margin-bottom:6px">'+escapeHtml(String(r[labelCol]))+'</div>';
    }
    cols.forEach(function(col){
      if(col === '_lat' || col === '_lng') return;
      var val = r[col];
      if(val === undefined || val === null || val === '') return;
      popupHtml += '<div style="display:flex;justify-content:space-between;gap:8px;padding:2px 0;border-bottom:1px solid #f1f5f9">';
      popupHtml += '<span style="color:#64748b;font-size:10px">'+escapeHtml(col)+'</span>';
      popupHtml += '<span style="font:500 10px \'Space Mono\',monospace;color:#0f172a;text-align:right">'+escapeHtml(String(val).substring(0,50))+'</span>';
      popupHtml += '</div>';
    });
    popupHtml += '</div>';
    marker.bindPopup(popupHtml, {maxWidth:300});

    if(labelCol && r[labelCol]){
      marker.bindTooltip(String(r[labelCol]).substring(0,30), {
        permanent: false, direction: 'top', offset: [0,-34], className: 'upload-tooltip'
      });
    }

    markers.addLayer(marker);
  });

  markers.addTo(_map);

  return {
    upload_id: rec.upload_id,
    name: rec.name || rec.filename || 'Upload',
    layer: markers,
    icon: icon,
    color: color,
    count: data.length,
    columns: cols,
    labelCol: labelCol
  };
}

// Sync upload naar SQL Server
function syncUploadToServer(rec){
  if(!_apiOnline) return;
  try {
    fetch(ANALYTICS_API + '/upload', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        upload_id: rec.upload_id,
        visitor_id: rec.visitor_id || '',
        session_id: rec.session_id || '',
        name: rec.name || '',
        description: rec.description || '',
        filename: rec.filename || '',
        icon: rec.icon,
        color: rec.color,
        label_column: rec.label_column || '',
        columns_json: JSON.stringify(rec.columns || []),
        data_json: JSON.stringify(rec.data || []),
        row_count: rec.row_count || 0,
        uploaded_at: rec.uploaded_at
      })
    }).then(function(r){
      if(r.ok){
        // Markeer als gesynct
        rec.synced = 1;
        idbPut('uploads', rec);
      }
    }).catch(function(){});
  } catch(e){}
}

// Laad alle opgeslagen uploads bij app start
function loadSavedUploads(){
  idbGetAll('uploads').then(function(uploads){
    if(!uploads || !uploads.length){
      updateSavedUploadsList();
      return;
    }
    uploads.sort(function(a,b){ return (a.uploaded_at||'').localeCompare(b.uploaded_at||''); });
    uploads.forEach(function(rec){
      var layerInfo = renderUploadMarkers(rec);
      _uploadLayers.push(layerInfo);
    });
    if(_uploadLayers.length > 0){
      updateUploadLayerList();
      toast(_uploadLayers.length + ' opgeslagen upload(s) geladen');
    }
    updateSavedUploadsList();
  }).catch(function(e){ console.warn('Uploads laden mislukt:', e); });
}

function updateUploadLayerList(){
  var section = document.getElementById('uploadActiveSection');
  var list = document.getElementById('uploadLayerList');
  if(!section || !list) return;

  if(_uploadLayers.length === 0){
    section.style.display = 'none';
    return;
  }
  section.style.display = '';

  list.innerHTML = _uploadLayers.map(function(ul, idx){
    return '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.05)">' +
      '<div style="width:24px;height:24px;background:'+ul.color+';border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0"><span class="mi" style="font-size:14px;color:#fff">'+ul.icon+'</span></div>' +
      '<div style="flex:1">' +
        '<div style="font:600 11px \'DM Sans\',sans-serif;color:var(--tx)">'+escapeHtml(ul.name)+'</div>' +
        '<div style="font-size:9px;color:var(--mt)">'+ul.count+' locaties</div>' +
      '</div>' +
      '<button class="btn btn-s" onclick="toggleUploadLayer('+idx+')" style="font-size:9px;padding:2px 6px" title="Toon/verberg">' +
        '<span class="mi mi-sm" style="font-size:11px">'+(_map.hasLayer(ul.layer)?'visibility':'visibility_off')+'</span></button>' +
      '<button class="btn btn-s" onclick="zoomToUploadLayer('+idx+')" style="font-size:9px;padding:2px 6px" title="Zoom naar">' +
        '<span class="mi mi-sm" style="font-size:11px">zoom_in</span></button>' +
      '<button class="btn btn-s" onclick="removeUploadLayer('+idx+')" style="font-size:9px;padding:2px 6px" title="Verberg (data blijft bewaard)">' +
        '<span class="mi mi-sm" style="font-size:11px">visibility_off</span></button>' +
    '</div>';
  }).join('');
}

function updateSavedUploadsList(){
  var section = document.getElementById('uploadSavedSection');
  var list = document.getElementById('uploadSavedList');
  if(!section || !list) return;

  idbGetAll('uploads').then(function(uploads){
    if(!uploads || !uploads.length){
      section.style.display = 'none';
      return;
    }
    section.style.display = '';
    uploads.sort(function(a,b){ return (b.uploaded_at||'').localeCompare(a.uploaded_at||''); });

    list.innerHTML = uploads.map(function(u){
      var t = u.uploaded_at ? new Date(u.uploaded_at) : null;
      var datum = t ? t.toLocaleDateString('nl-NL',{day:'2-digit',month:'short'}) : '';
      var onMap = false;
      for(var i=0;i<_uploadLayers.length;i++){ if(_uploadLayers[i].upload_id===u.upload_id){ onMap=true; break; } }

      return '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.05)">' +
        '<div style="width:22px;height:22px;background:'+(u.color||'#e11d48')+';border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0">' +
          '<span class="mi" style="font-size:12px;color:#fff;font-variation-settings:\'FILL\' 1">'+(u.icon||'location_on')+'</span></div>' +
        '<div style="flex:1">' +
          '<div style="font:600 10px \'DM Sans\',sans-serif;color:var(--tx)">'+escapeHtml(u.name||u.filename||'Upload')+'</div>' +
          '<div style="font-size:9px;color:var(--mt)">'+(u.row_count||0)+' loc \u00b7 '+datum+
            (onMap ? ' \u00b7 <span style="color:var(--ac)">\u25cf op kaart</span>' : '') +
          '</div>' +
        '</div>' +
        (onMap ? '' : '<button class="btn btn-s" onclick="adminReplotUpload(\''+escapeHtml(u.upload_id)+'\')" style="font-size:9px;padding:2px 6px" title="Toon op kaart"><span class="mi mi-sm" style="font-size:11px">add_location</span></button>') +
      '</div>';
    }).join('');
  }).catch(function(){
    section.style.display = 'none';
  });
}

function toggleUploadLayer(idx){
  var ul = _uploadLayers[idx];
  if(!ul) return;
  if(_map.hasLayer(ul.layer)){
    _map.removeLayer(ul.layer);
  } else {
    ul.layer.addTo(_map);
  }
  updateUploadLayerList();
}

function zoomToUploadLayer(idx){
  var ul = _uploadLayers[idx];
  if(!ul || !ul.layer) return;
  try {
    var bounds = ul.layer.getBounds();
    _map.fitBounds(bounds, {padding:[40,40], maxZoom:14});
  } catch(e){}
}

function removeUploadLayer(idx){
  var ul = _uploadLayers[idx];
  if(!ul) return;
  if(_map.hasLayer(ul.layer)) _map.removeLayer(ul.layer);
  _uploadLayers.splice(idx, 1);
  updateUploadLayerList();
  updateSavedUploadsList();
  toast('Upload van kaart verwijderd \u00b7 Data bewaard');
}

// Permanent verwijderen (alleen admin)
function deleteUploadPermanent(uploadId){
  if(!confirm('Weet je zeker dat je deze upload permanent wilt verwijderen? Dit kan niet ongedaan worden.')) return;
  // Verwijder van kaart
  for(var i = _uploadLayers.length - 1; i >= 0; i--){
    if(_uploadLayers[i].upload_id === uploadId){
      if(_map.hasLayer(_uploadLayers[i].layer)) _map.removeLayer(_uploadLayers[i].layer);
      _uploadLayers.splice(i, 1);
    }
  }
  updateUploadLayerList();
  // Verwijder uit IndexedDB
  if(_analyticsDb){
    try {
      var tx = _analyticsDb.transaction('uploads', 'readwrite');
      tx.objectStore('uploads').delete(uploadId);
    } catch(e){}
  }
  // Verwijder uit SQL Server
  if(_apiOnline){
    fetch(ANALYTICS_API + '/admin/upload/' + encodeURIComponent(uploadId), {method:'DELETE'}).catch(function(){});
  }
  toast('Upload permanent verwijderd');
  updateSavedUploadsList();
  // Ververs admin dashboard als dat open is
  if(_adminUnlocked) refreshAdminData();
}

function clearUploadData(){
  _uploadData = null;
  _uploadColumns = [];
  _uploadFileName = '';
  document.getElementById('uploadPreview').style.display = 'none';
  document.getElementById('uploadIconSection').style.display = 'none';
  document.getElementById('uploadInfoSection').style.display = 'none';
  document.getElementById('uploadFileInput').value = '';
  document.getElementById('uploadDatasetName').value = '';
  document.getElementById('uploadDatasetDesc').value = '';
}

// ============================================================
// ACHTERGROND CBS DATA LADEN (buurten + wijken)
// ============================================================
function loadBackgroundCbsData(){
  var progEl = document.getElementById('cbsBgProgress');
  var bgText = document.getElementById('cbsBgText');
  var bgPct = document.getElementById('cbsBgPct');
  var bgBar = document.getElementById('cbsBgBar');
  var bgDetail = document.getElementById('cbsBgDetail');
  progEl.style.display = 'block';

  var steps = [];
  if(!_buurtData) steps.push({type:'buurten', url:BUURTEN_URL, label:'Buurtdata'});
  if(!_wijkData) steps.push({type:'wijken', url:WIJKEN_URL, label:'Wijkdata'});
  if(steps.length === 0){
    progEl.style.display = 'none';
    return;
  }

  var totalSteps = steps.length;
  var currentStep = 0;

  function loadNext(){
    if(currentStep >= steps.length){
      bgText.textContent = 'Alle data geladen \u2714';
      bgPct.textContent = '100%';
      bgBar.style.width = '100%';
      bgDetail.textContent = (_buurtData ? _buurtData.features.length : 0) + ' buurten + ' + (_wijkData ? _wijkData.features.length : 0) + ' wijken';
      setTimeout(function(){ progEl.style.display = 'none'; }, 3000);
      // Herbereken nationale stats en herbouw filters
      computeNationalStats();
      if(_buurtData) buildBuurtFilter();
      if(_wijkData) buildWijkFilter();
      // Render actieve lagen
      if(_layerState.buurten && _buurtData) renderChoropleth('buurten');
      if(_layerState.wijken && _wijkData) renderChoropleth('wijken');
      updateActiveStats();
      toast('Buurt- en wijkdata geladen op achtergrond \u2714');
      return;
    }
    var step = steps[currentStep];
    var pctBase = (currentStep / totalSteps) * 100;
    bgText.textContent = step.label + ' laden...';
    bgPct.textContent = Math.round(pctBase) + '%';
    bgBar.style.width = pctBase + '%';
    bgDetail.textContent = step.type === 'buurten' ? '~14 MB ophalen...' : '~4 MB ophalen...';

    fetch(step.url).then(function(r){
      if(!r.ok) throw new Error(step.type+' niet beschikbaar ('+r.status+')');
      return r.json();
    }).then(function(d){
      if(step.type === 'buurten'){
        _buurtData = d;
        document.getElementById('dsBuurten').textContent = d.features.length.toLocaleString('nl-NL') + ' features';
        buildBuurtFilter();
      } else {
        _wijkData = d;
        document.getElementById('dsWijken').textContent = d.features.length.toLocaleString('nl-NL') + ' features';
        buildWijkFilter();
      }
      currentStep++;
      var pctDone = (currentStep / totalSteps) * 100;
      bgPct.textContent = Math.round(pctDone) + '%';
      bgBar.style.width = pctDone + '%';
      bgDetail.textContent = d.features.length.toLocaleString('nl-NL') + ' ' + step.type + ' geladen';
      loadNext();
    }).catch(function(e){
      console.warn('Achtergrond laden ' + step.type + ' mislukt:', e);
      bgDetail.textContent = 'Fout: ' + e.message;
      currentStep++;
      loadNext();
    });
  }
  loadNext();
}

// ============================================================
// GEMEENTEN VERGELIJKINGSRAPPORT
// ============================================================
function countBagForArea(areaFeature, areaType){
  // Tel BAG adressen via prefetch indexes (geen in-memory data meer)
  var result = {count:0, bouwjaren:[], oppervlaktes:[], gebruiksdoelen:{}};
  if(!areaFeature) return result;
  var p = areaFeature.properties || {};

  if(areaType === 'gemeenten' && _bagIndex){
    var code = p.gemeentecode || '';
    if(_bagIndex[code]) result.count = _bagIndex[code].count || 0;
  } else if(areaType === 'wijken' && _bagWijkIndex){
    var wCode = p.wijkcode || '';
    if(_bagWijkIndex[wCode]) result.count = _bagWijkIndex[wCode].count || 0;
  } else if(areaType === 'buurten' && _bagBuurtIndex){
    var bCode = p.buurtcode || '';
    if(_bagBuurtIndex[bCode]) result.count = _bagBuurtIndex[bCode].count || 0;
  }
  return result;
}

function showComparisonReport(){
  // Zorg dat nationalStats berekend is
  if(!_nationalStats || Object.keys(_nationalStats).length === 0) computeNationalStats();

  // Bepaal wat we vergelijken: buurten of gemeenten
  var compareType = 'gemeenten';
  var compareLabel = 'gemeenten';
  var items = [];
  var nameField = 'gemeentenaam';

  if(_selectedBuurten.length >= 2 && _buurtData){
    compareType = 'buurten';
    compareLabel = 'buurten';
    nameField = 'buurtnaam';
    var buurtFilter = getSelectedBuurtFilter();
    var gemFilter = getSelectedGemeenteFilter();
    var seen = new Set();
    _buurtData.features.forEach(function(f){
      var p = f.properties;
      if(!p.buurtnaam) return;
      if(buurtFilter !== 'all' && !buurtFilter.has(p.buurtnaam)) return;
      if(gemFilter !== 'all' && !gemFilter.has(p.gemeentenaam)) return;
      var key = p.buurtcode || p.buurtnaam;
      if(!seen.has(key)){ seen.add(key); items.push(f); }
    });
  } else if(_selectedWijken.length >= 2 && _wijkData){
    compareType = 'wijken';
    compareLabel = 'wijken';
    nameField = 'wijknaam';
    var wijkFilter = getSelectedWijkFilter();
    var gemFilter2 = getSelectedGemeenteFilter();
    var seen = new Set();
    _wijkData.features.forEach(function(f){
      var p = f.properties;
      if(!p.wijknaam) return;
      if(wijkFilter !== 'all' && !wijkFilter.has(p.wijknaam)) return;
      if(gemFilter2 !== 'all' && !gemFilter2.has(p.gemeentenaam)) return;
      var key = p.wijkcode || p.wijknaam;
      if(!seen.has(key)){ seen.add(key); items.push(f); }
    });
  } else if(_selectedGemeenten.length >= 2 && _gemeenteData){
    var seen = new Set();
    _selectedGemeenten.forEach(function(naam){
      _gemeenteData.features.forEach(function(f){
        var code = f.properties.gemeentecode || f.properties.gemeentenaam;
        if(f.properties.gemeentenaam === naam && !seen.has(code)){
          seen.add(code);
          items.push(f);
        }
      });
    });
  }

  if(items.length < 2){
    toast('Selecteer minimaal 2 gebieden om te vergelijken');
    return;
  }

  // BAG adressen tellen per item
  var hasBag = (_bagIndex && Object.keys(_bagIndex).length > 0) || (_bagWijkIndex && Object.keys(_bagWijkIndex).length > 0) || (_bagBuurtIndex && Object.keys(_bagBuurtIndex).length > 0);
  var bagStats = {};
  if(hasBag){
    items.forEach(function(g){
      var name = g.properties[nameField] || g.properties.gemeentenaam || '-';
      bagStats[name] = countBagForArea(g, compareType);
    });
  }

  // ALLE indicatoren
  var allInds = INDICATORS.slice();
  var activeInds = allInds.filter(function(fm){
    for(var i=0;i<items.length;i++){
      if(items[i].properties[fm.key] != null) return true;
    }
    return false;
  });

  // Categoriseer
  var categories = [
    {label:'Bevolking', icon:'groups', color:'#16a34a', bg:'#f0fdf4', keys:['aantal_inwoners','mannen','vrouwen','0_15','15_25','25_45','45_65','65plus','bevolkingsdichtheid','huishoudens','gem_huishouden_grootte']},
    {label:'Woningen & Vastgoed', icon:'home', color:'#2563eb', bg:'#eff6ff', keys:['woningvoorraad','gem_woz_waarde','koopwoningen','huurwoningen','pct_eengezins']},
    {label:'Energie & Duurzaamheid', icon:'bolt', color:'#0891b2', bg:'#ecfeff', keys:['gem_aardgas','gem_elektriciteit']},
    {label:'Economie & Inkomen', icon:'payments', color:'#d97706', bg:'#fffbeb', keys:['gem_inkomen_inwoner','arbeidsparticipatie','bedrijfsvestigingen','personenautos']},
    {label:'Voorzieningen', icon:'local_hospital', color:'#7c3aed', bg:'#f5f3ff', keys:['afstand_huisarts','afstand_supermarkt']}
  ];

  var reverseSet = new Set(REVERSE_KEYS);

  // Kleuren per item (max 8)
  var itemColors = ['#2563eb','#dc2626','#16a34a','#d97706','#7c3aed','#0891b2','#e11d48','#65a30d'];

  // ===== Bouw rapport HTML =====
  var html = '<!DOCTYPE html><html lang="nl"><head>';
  html += '<meta charset="UTF-8"><title>GeoInzicht Vergelijkingsrapport</title>';
  html += '<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" rel="stylesheet">';
  html += '<style>';
  html += '*{margin:0;padding:0;box-sizing:border-box}';
  html += 'body{font-family:"DM Sans",sans-serif;background:#f8fafc;color:#1e293b;padding:0;max-width:1100px;margin:0 auto}';
  html += '.mi{font-family:"Material Symbols Rounded";font-weight:normal;font-style:normal;font-size:16px;line-height:1;display:inline-block;vertical-align:-3px;font-variation-settings:"FILL" 1}';
  html += '.header{background:linear-gradient(135deg,#0a0f1a 0%,#1e293b 100%);color:#e2e8f0;padding:32px;border-radius:0 0 16px 16px;margin-bottom:24px}';
  html += '.header h1{font:700 26px "Space Mono",monospace;color:#39ff14;margin-bottom:8px;text-shadow:0 0 20px rgba(57,255,20,.3)}';
  html += '.header .sub{font-size:13px;color:#94a3b8;line-height:1.6}';
  html += '.header .logo{display:flex;align-items:center;gap:12px;margin-bottom:16px}';
  html += '.header .logo-text{font:700 18px "Space Mono",monospace;color:#39ff14}';
  html += '.content{padding:0 24px 24px}';
  html += '.section{margin-bottom:28px}';
  html += '.section-title{font:700 15px "DM Sans",sans-serif;display:flex;align-items:center;gap:8px;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid}';
  html += '.card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.08);border:1px solid #e2e8f0;margin-bottom:12px}';
  html += 'table{width:100%;border-collapse:collapse;font-size:12px}';
  html += 'th{background:#f1f5f9;font:600 11px "DM Sans",sans-serif;text-align:left;padding:8px 10px;border-bottom:2px solid #e2e8f0;position:sticky;top:0;white-space:nowrap}';
  html += 'td{padding:6px 10px;border-bottom:1px solid #f1f5f9;font:400 11px "Space Mono",monospace;vertical-align:top}';
  html += 'tr:hover td{background:#f8fafc}';
  html += '.cat-header td{background:#f1f5f9;font:700 11px "DM Sans",sans-serif;color:#475569;padding:6px 10px;border:none}';
  html += '.best{background:#dcfce7 !important;color:#16a34a;font-weight:700}';
  html += '.worst{background:#fef2f2 !important;color:#dc2626}';
  html += '.ind-name{font:500 11px "DM Sans",sans-serif;color:#1e293b;white-space:nowrap}';
  html += '.ind-unit{font-size:9px;color:#94a3b8;margin-left:4px}';
  html += '.bar-bg{background:#e2e8f0;border-radius:3px;height:6px;width:100%;margin-top:3px}';
  html += '.bar-fill{height:6px;border-radius:3px}';
  html += '.z-badge{display:inline-block;padding:1px 6px;border-radius:8px;font:700 9px "Space Mono",monospace;margin-left:4px}';
  html += '.z-pos{background:#dcfce7;color:#16a34a}.z-neg{background:#fef2f2;color:#dc2626}.z-neu{background:#f1f5f9;color:#64748b}';
  html += '.insight-box{padding:12px;border-radius:8px;margin-bottom:8px;font-size:11px;line-height:1.7}';
  html += '.footer{padding:16px 24px;text-align:center;font-size:10px;color:#94a3b8;border-top:1px solid #e2e8f0;margin-top:8px}';
  html += '.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}';
  html += '.chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px}';
  html += '.score-circle{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font:700 14px "Space Mono",monospace;flex-shrink:0}';
  html += '.legend-item{display:flex;align-items:center;gap:6px;font-size:10px;color:#475569}';
  html += '.legend-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}';
  html += '@media print{body{padding:0}.header,.card,.cat-header td,.best,.worst,.z-pos,.z-neg,.score-circle{-webkit-print-color-adjust:exact;print-color-adjust:exact}}';
  html += '@media(max-width:700px){.summary-grid,.chart-grid{grid-template-columns:1fr}}';
  html += '</style></head><body>';

  // ===== HEADER =====
  html += '<div class="header">';
  html += '<div class="logo">';
  html += globeLogoSvg(40);
  html += '<div><div class="logo-text">GeoInzicht</div><div style="font-size:10px;color:#64748b">Data Consultants</div></div>';
  html += '</div>';
  html += '<h1>Vergelijkingsrapport</h1>';
  html += '<div class="sub">';
  html += 'CBS Kerncijfers '+_activeYear+' &middot; <b>'+items.length+' '+compareLabel+'</b> &middot; '+activeInds.length+' indicatoren';
  if(hasBag){
    var totalBag = 0;
    for(var bn in bagStats) totalBag += bagStats[bn].count;
    if(totalBag > 0) html += ' &middot; '+totalBag.toLocaleString('nl-NL')+' BAG adressen';
  }
  html += '<br>Gegenereerd: '+new Date().toLocaleString('nl-NL')+' &middot; Bron: CBS/PDOK/BAG Kadaster';
  html += '</div></div>';

  html += '<div class="content">';

  // Legenda
  html += '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:16px">';
  items.forEach(function(g, idx){
    var name = g.properties[nameField] || g.properties.gemeentenaam || '-';
    html += '<div class="legend-item"><div class="legend-dot" style="background:'+itemColors[idx % itemColors.length]+'"></div><b>'+name+'</b></div>';
  });
  html += '</div>';

  // ===== 1. OVERZICHTSKAARTJES =====
  html += '<div class="section">';
  html += '<div class="section-title" style="color:#16a34a;border-color:#bbf7d0"><span class="mi" style="color:#16a34a">dashboard</span> Overzicht</div>';
  html += '<div class="summary-grid">';
  items.forEach(function(g, idx){
    var p = g.properties;
    var displayName = p[nameField] || p.gemeentenaam || '-';
    var subName = (compareType === 'buurten' || compareType === 'wijken') ? (p.gemeentenaam || '') : '';
    var color = itemColors[idx % itemColors.length];
    var zScores = [];
    activeInds.forEach(function(fm){
      var v = p[fm.key]; var ns = _nationalStats[fm.key];
      if(v == null || !ns || !ns.stddev || ns.stddev === 0) return;
      var z = (v - ns.avg) / ns.stddev;
      if(reverseSet.has(fm.key)) z = -z;
      zScores.push(z);
    });
    var avgZ = zScores.length > 0 ? zScores.reduce(function(a,b){return a+b},0) / zScores.length : 0;
    var scoreColor = avgZ > 0.3 ? '#16a34a' : (avgZ < -0.3 ? '#dc2626' : '#64748b');
    var scoreBg = avgZ > 0.3 ? '#dcfce7' : (avgZ < -0.3 ? '#fef2f2' : '#f1f5f9');
    var scoreLabel = avgZ > 0.5 ? 'Bovengemiddeld' : (avgZ < -0.5 ? 'Ondergemiddeld' : 'Gemiddeld');

    html += '<div class="card" style="display:flex;gap:12px;align-items:flex-start;border-top:3px solid '+color+'">';
    html += '<div class="score-circle" style="background:'+scoreBg+';color:'+scoreColor+'">'+(avgZ >= 0 ? '+' : '')+avgZ.toFixed(1)+'</div>';
    html += '<div style="flex:1">';
    html += '<div style="font:700 14px \'DM Sans\',sans-serif;color:#0f172a">'+displayName+'</div>';
    if(subName) html += '<div style="font-size:10px;color:#94a3b8">'+subName+'</div>';
    html += '<div style="font-size:10px;color:'+scoreColor+';margin-top:2px">'+scoreLabel+' (z-score: '+(avgZ >= 0 ? '+' : '')+avgZ.toFixed(2)+')</div>';
    // Kerngetallen
    html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px">';
    var keyMetrics = [{k:'aantal_inwoners',l:'Inwoners',fmt:function(v){return v?v.toLocaleString('nl-NL'):'?'}},{k:'woningvoorraad',l:'Woningen',fmt:function(v){return v?v.toLocaleString('nl-NL'):'?'}},{k:'gem_woz_waarde',l:'WOZ',fmt:function(v){return v?'\u20ac'+Math.round(v/1000)+'k':'?'}},{k:'gem_inkomen_inwoner',l:'Inkomen',fmt:function(v){return v?'\u20ac'+Math.round(v/1000)+'k':'?'}},{k:'koopwoningen',l:'Koop',fmt:function(v){return v!=null?v+'%':'?'}}];
    keyMetrics.forEach(function(m){
      var val = p[m.k];
      html += '<div style="font-size:9px;background:#f1f5f9;padding:2px 6px;border-radius:4px"><span style="color:#94a3b8">'+m.l+':</span> <b style="color:#0f172a">'+m.fmt(val)+'</b></div>';
    });
    // BAG adressen
    var bs = bagStats[displayName];
    if(bs && bs.count > 0){
      html += '<div style="font-size:9px;background:#eff6ff;padding:2px 6px;border-radius:4px;border:1px solid #bfdbfe"><span style="color:#2563eb">BAG:</span> <b style="color:#1e40af">'+bs.count.toLocaleString('nl-NL')+' adressen</b></div>';
    }
    html += '</div>';
    // Sterke/zwakke punten
    var sterke = []; var zwakke = [];
    activeInds.forEach(function(fm){
      var v = p[fm.key]; var ns = _nationalStats[fm.key];
      if(v == null || !ns || !ns.stddev) return;
      var z = (v - ns.avg) / ns.stddev;
      if(reverseSet.has(fm.key)) z = -z;
      if(z > 1.2) sterke.push(fm.naam);
      else if(z < -1.2) zwakke.push(fm.naam);
    });
    if(sterke.length) html += '<div style="font-size:9px;color:#16a34a;margin-top:4px"><b>Sterk:</b> '+sterke.slice(0,5).join(', ')+'</div>';
    if(zwakke.length) html += '<div style="font-size:9px;color:#dc2626;margin-top:2px"><b>Let op:</b> '+zwakke.slice(0,5).join(', ')+'</div>';
    html += '</div></div>';
  });
  html += '</div></div>';

  // ===== 2. GRAFIEKEN =====
  html += '<div class="section">';
  html += '<div class="section-title" style="color:#0891b2;border-color:#a5f3fc"><span class="mi" style="color:#0891b2">bar_chart</span> Grafieken</div>';
  html += '<div class="chart-grid">';

  // Helper: SVG horizontale staafgrafiek
  function buildBarChart(title, dataItems, unit, formatFn){
    if(!dataItems.length) return '';
    var maxVal = Math.max.apply(null, dataItems.map(function(d){return d.value||0}));
    if(maxVal <= 0) return '';
    var barH = 24;
    var gap = 6;
    var labelW = 110;
    var chartW = 380;
    var svgH = dataItems.length * (barH + gap) + 10;
    var s = '<div class="card"><div style="font:600 12px \'DM Sans\',sans-serif;color:#475569;margin-bottom:8px">'+title+'</div>';
    s += '<svg width="100%" viewBox="0 0 '+chartW+' '+svgH+'" xmlns="http://www.w3.org/2000/svg" style="max-width:'+chartW+'px">';
    dataItems.forEach(function(d, i){
      var y = i * (barH + gap);
      var barW = maxVal > 0 ? ((d.value / maxVal) * (chartW - labelW - 60)) : 0;
      s += '<text x="0" y="'+(y+16)+'" font-family="DM Sans,sans-serif" font-size="10" fill="#475569">'+d.label.substring(0,18)+'</text>';
      s += '<rect x="'+labelW+'" y="'+y+'" width="'+barW+'" height="'+barH+'" rx="4" fill="'+d.color+'" opacity="0.8"/>';
      var valText = formatFn ? formatFn(d.value) : d.value.toLocaleString('nl-NL');
      if(unit) valText += ' '+unit;
      s += '<text x="'+(labelW + barW + 5)+'" y="'+(y+16)+'" font-family="Space Mono,monospace" font-size="10" font-weight="700" fill="'+d.color+'">'+valText+'</text>';
    });
    s += '</svg></div>';
    return s;
  }

  // Chart 1: Inwoners
  var inwData = [];
  items.forEach(function(g, idx){
    var v = g.properties.aantal_inwoners;
    if(v != null) inwData.push({label: g.properties[nameField]||'-', value:v, color:itemColors[idx%itemColors.length]});
  });
  html += buildBarChart('Aantal Inwoners', inwData, '', function(v){return v.toLocaleString('nl-NL')});

  // Chart 2: Woningvoorraad + BAG adressen (gestapeld)
  var wonData = [];
  items.forEach(function(g, idx){
    var name = g.properties[nameField]||'-';
    var won = g.properties.woningvoorraad;
    var bs = bagStats[name];
    var bagCnt = bs ? bs.count : 0;
    if(won || bagCnt) wonData.push({label:name, won:won||0, bag:bagCnt, color:itemColors[idx%itemColors.length]});
  });
  if(wonData.length){
    var maxWon = Math.max.apply(null, wonData.map(function(d){return Math.max(d.won, d.bag)}));
    if(maxWon > 0){
      var barH2 = 28; var gap2 = 8; var labelW2 = 110; var chartW2 = 380;
      var svgH2 = wonData.length * (barH2*2 + gap2) + 10;
      html += '<div class="card"><div style="font:600 12px \'DM Sans\',sans-serif;color:#475569;margin-bottom:4px">Woningvoorraad vs BAG Adressen</div>';
      html += '<div style="font-size:9px;color:#94a3b8;margin-bottom:8px;display:flex;gap:12px"><span>\u25a0 CBS Woningvoorraad</span><span style="opacity:.6">\u25a0 BAG Adressen (geladen)</span></div>';
      html += '<svg width="100%" viewBox="0 0 '+chartW2+' '+svgH2+'" xmlns="http://www.w3.org/2000/svg" style="max-width:'+chartW2+'px">';
      wonData.forEach(function(d, i){
        var y = i * (barH2*2 + gap2);
        var bW1 = maxWon > 0 ? (d.won / maxWon * (chartW2 - labelW2 - 70)) : 0;
        var bW2 = maxWon > 0 ? (d.bag / maxWon * (chartW2 - labelW2 - 70)) : 0;
        html += '<text x="0" y="'+(y+14)+'" font-family="DM Sans,sans-serif" font-size="10" fill="#475569">'+d.label.substring(0,18)+'</text>';
        // Woningvoorraad bar
        html += '<rect x="'+labelW2+'" y="'+y+'" width="'+bW1+'" height="'+(barH2-2)+'" rx="3" fill="'+d.color+'" opacity="0.85"/>';
        html += '<text x="'+(labelW2+bW1+4)+'" y="'+(y+14)+'" font-family="Space Mono,monospace" font-size="9" font-weight="700" fill="'+d.color+'">'+(d.won?d.won.toLocaleString('nl-NL'):'?')+'</text>';
        // BAG bar
        var y2 = y + barH2;
        html += '<rect x="'+labelW2+'" y="'+y2+'" width="'+bW2+'" height="'+(barH2-2)+'" rx="3" fill="'+d.color+'" opacity="0.35"/>';
        if(d.bag > 0){
          html += '<text x="'+(labelW2+bW2+4)+'" y="'+(y2+14)+'" font-family="Space Mono,monospace" font-size="9" fill="'+d.color+'" opacity="0.7">'+d.bag.toLocaleString('nl-NL')+' BAG</text>';
        }
      });
      html += '</svg></div>';
    }
  }

  // Chart 3: WOZ-waarde
  var wozData = [];
  items.forEach(function(g, idx){
    var v = g.properties.gem_woz_waarde;
    if(v != null) wozData.push({label: g.properties[nameField]||'-', value:v, color:itemColors[idx%itemColors.length]});
  });
  html += buildBarChart('Gem. WOZ-waarde', wozData, '', function(v){return '\u20ac'+Math.round(v/1000)+'k'});

  // Chart 4: Leeftijdsopbouw (grouped bar)
  var leeftijdKeys = [{k:'0_15',l:'0-14'},{k:'15_25',l:'15-24'},{k:'25_45',l:'25-44'},{k:'45_65',l:'45-64'},{k:'65plus',l:'65+'}];
  var hasLeeftijd = items.some(function(g){ return leeftijdKeys.some(function(lk){ return g.properties[lk.k] != null; }); });
  if(hasLeeftijd){
    var gBarH = 18; var gGap = 4; var groupGap = 12; var gLabelW = 50; var gChartW = 380;
    var gSvgH = leeftijdKeys.length * (items.length * (gBarH + gGap) + groupGap) + 20;
    html += '<div class="card"><div style="font:600 12px \'DM Sans\',sans-serif;color:#475569;margin-bottom:8px">Leeftijdsopbouw (%)</div>';
    html += '<svg width="100%" viewBox="0 0 '+gChartW+' '+gSvgH+'" xmlns="http://www.w3.org/2000/svg" style="max-width:'+gChartW+'px">';
    var gY = 0;
    leeftijdKeys.forEach(function(lk){
      html += '<text x="0" y="'+(gY+14)+'" font-family="DM Sans,sans-serif" font-size="10" font-weight="600" fill="#64748b">'+lk.l+'</text>';
      items.forEach(function(g, idx){
        var v = g.properties[lk.k] || 0;
        var bW = v * ((gChartW - gLabelW - 50) / 50); // max ~50%
        var c = itemColors[idx%itemColors.length];
        html += '<rect x="'+gLabelW+'" y="'+gY+'" width="'+bW+'" height="'+gBarH+'" rx="3" fill="'+c+'" opacity="0.8"/>';
        html += '<text x="'+(gLabelW+bW+4)+'" y="'+(gY+13)+'" font-family="Space Mono,monospace" font-size="9" fill="'+c+'">'+v+'%</text>';
        gY += gBarH + gGap;
      });
      gY += groupGap;
    });
    html += '</svg></div>';
  }

  // Chart 5: Energie
  var gasData = [];
  items.forEach(function(g, idx){
    var v = g.properties.gem_aardgas;
    if(v != null) gasData.push({label: g.properties[nameField]||'-', value:v, color:itemColors[idx%itemColors.length]});
  });
  html += buildBarChart('Gem. Gasverbruik', gasData, 'm\u00b3/jaar');

  // Chart 6: Inkomen
  var inkData = [];
  items.forEach(function(g, idx){
    var v = g.properties.gem_inkomen_inwoner;
    if(v != null) inkData.push({label: g.properties[nameField]||'-', value:v, color:itemColors[idx%itemColors.length]});
  });
  html += buildBarChart('Gem. Inkomen per Inwoner', inkData, '', function(v){return '\u20ac'+Math.round(v/1000)+'k'});

  // Chart 7: Radar/spider chart (z-scores voor 6 kernthema\'s)
  var radarKeys = [
    {k:'gem_woz_waarde',l:'WOZ'},
    {k:'gem_inkomen_inwoner',l:'Inkomen'},
    {k:'arbeidsparticipatie',l:'Arbeid'},
    {k:'bevolkingsdichtheid',l:'Dichtheid'},
    {k:'koopwoningen',l:'Koop%'},
    {k:'afstand_huisarts',l:'Huisarts',rev:true}
  ];
  var hasRadar = items.every(function(g){ return radarKeys.filter(function(rk){ return g.properties[rk.k]!=null; }).length >= 4; });
  if(hasRadar){
    var cx=190, cy=160, R=120, angles=radarKeys.length;
    html += '<div class="card" style="grid-column:1/-1"><div style="font:600 12px \'DM Sans\',sans-serif;color:#475569;margin-bottom:8px">Radardiagram (z-scores)</div>';
    html += '<svg width="100%" viewBox="0 0 380 330" xmlns="http://www.w3.org/2000/svg" style="max-width:380px;margin:0 auto;display:block">';
    // Grid circles
    for(var ring=1;ring<=3;ring++){
      var rr = R * ring / 3;
      html += '<circle cx="'+cx+'" cy="'+cy+'" r="'+rr+'" fill="none" stroke="#e2e8f0" stroke-width="1"/>';
    }
    // Axes + labels
    radarKeys.forEach(function(rk, i){
      var angle = (Math.PI*2*i/angles) - Math.PI/2;
      var x2 = cx + Math.cos(angle)*R;
      var y2 = cy + Math.sin(angle)*R;
      html += '<line x1="'+cx+'" y1="'+cy+'" x2="'+x2+'" y2="'+y2+'" stroke="#e2e8f0" stroke-width="1"/>';
      var lx = cx + Math.cos(angle)*(R+18);
      var ly = cy + Math.sin(angle)*(R+18);
      html += '<text x="'+lx+'" y="'+ly+'" text-anchor="middle" dominant-baseline="middle" font-family="DM Sans,sans-serif" font-size="9" font-weight="600" fill="#475569">'+rk.l+'</text>';
    });
    // Data polygons
    items.forEach(function(g, idx){
      var c = itemColors[idx%itemColors.length];
      var pts = [];
      radarKeys.forEach(function(rk, i){
        var v = g.properties[rk.k];
        var ns = _nationalStats[rk.k];
        var z = 0;
        if(v!=null && ns && ns.stddev > 0){
          z = (v - ns.avg)/ns.stddev;
          if(rk.rev) z = -z;
        }
        // Normaliseer z-score naar 0-1 range: z=-2 -> 0, z=0 -> 0.5, z=2 -> 1
        var norm = Math.max(0, Math.min(1, (z + 2) / 4));
        var angle = (Math.PI*2*i/angles) - Math.PI/2;
        var px = cx + Math.cos(angle)*(R*norm);
        var py = cy + Math.sin(angle)*(R*norm);
        pts.push(px.toFixed(1)+','+py.toFixed(1));
      });
      html += '<polygon points="'+pts.join(' ')+'" fill="'+c+'" fill-opacity="0.15" stroke="'+c+'" stroke-width="2" stroke-opacity="0.8"/>';
      pts.forEach(function(pt){
        var xy = pt.split(',');
        html += '<circle cx="'+xy[0]+'" cy="'+xy[1]+'" r="3" fill="'+c+'"/>';
      });
    });
    html += '</svg></div>';
  }

  // Chart 8: BAG Bouwjaar verdeling (als beschikbaar)
  var hasBagBouwjaar = false;
  for(var bn2 in bagStats){ if(bagStats[bn2].bouwjaren.length > 10){ hasBagBouwjaar = true; break; } }
  if(hasBagBouwjaar){
    // Bouwjaar histogram per decennium
    var decades = ['<1920','1920','1930','1940','1950','1960','1970','1980','1990','2000','2010','2020+'];
    var decadeRanges = [[0,1920],[1920,1930],[1930,1940],[1940,1950],[1950,1960],[1960,1970],[1970,1980],[1980,1990],[1990,2000],[2000,2010],[2010,2020],[2020,2100]];
    var decadeData = {};
    items.forEach(function(g, idx){
      var name = g.properties[nameField]||'-';
      var bs = bagStats[name];
      if(!bs || bs.bouwjaren.length < 10) return;
      decadeData[name] = {color: itemColors[idx%itemColors.length], counts:[]};
      decadeRanges.forEach(function(dr){
        var cnt = bs.bouwjaren.filter(function(bj){return bj >= dr[0] && bj < dr[1]}).length;
        decadeData[name].counts.push(cnt);
      });
    });
    if(Object.keys(decadeData).length > 0){
      var maxDec = 0;
      for(var dn in decadeData) decadeData[dn].counts.forEach(function(c){if(c>maxDec)maxDec=c});
      var dBarW = 22; var dGap = 3; var dChartW = decades.length*(dBarW*items.length + dGap*items.length + 8) + 40;
      var dChartH = 180; var dLabelH = 25;
      html += '<div class="card" style="grid-column:1/-1"><div style="font:600 12px \'DM Sans\',sans-serif;color:#475569;margin-bottom:8px">BAG Bouwjaarverdeling per Decennium</div>';
      html += '<svg width="100%" viewBox="0 0 '+dChartW+' '+(dChartH+dLabelH+10)+'" xmlns="http://www.w3.org/2000/svg" style="max-width:'+dChartW+'px">';
      // Grid lines
      for(var gl=0;gl<=4;gl++){
        var gy = dChartH - (dChartH * gl/4);
        html += '<line x1="30" y1="'+gy+'" x2="'+dChartW+'" y2="'+gy+'" stroke="#e2e8f0" stroke-width="0.5"/>';
        html += '<text x="26" y="'+(gy+3)+'" text-anchor="end" font-family="Space Mono,monospace" font-size="8" fill="#94a3b8">'+Math.round(maxDec*gl/4)+'</text>';
      }
      var dx = 35;
      decades.forEach(function(dec, di){
        var itemIdx = 0;
        for(var dn2 in decadeData){
          var dd = decadeData[dn2];
          var cnt = dd.counts[di] || 0;
          var bh = maxDec > 0 ? (cnt / maxDec * (dChartH - 10)) : 0;
          html += '<rect x="'+dx+'" y="'+(dChartH - bh)+'" width="'+dBarW+'" height="'+bh+'" rx="2" fill="'+dd.color+'" opacity="0.75"/>';
          dx += dBarW + dGap;
          itemIdx++;
        }
        html += '<text x="'+(dx - (dBarW*items.length + dGap*items.length)/2)+'" y="'+(dChartH + 14)+'" text-anchor="middle" font-family="DM Sans,sans-serif" font-size="8" fill="#64748b">'+dec+'</text>';
        dx += 8;
      });
      html += '</svg></div>';
    }
  }

  html += '</div></div>';

  // ===== 3. DATA TABEL =====
  html += '<div class="section">';
  html += '<div class="section-title" style="color:#2563eb;border-color:#bfdbfe"><span class="mi" style="color:#2563eb">table_chart</span> Vergelijkingstabel</div>';
  html += '<div class="card" style="overflow-x:auto;padding:0">';
  html += '<table><thead><tr><th style="min-width:180px">Indicator</th>';
  items.forEach(function(g, idx){
    var label = g.properties[nameField] || g.properties.gemeentenaam || '-';
    if((compareType === 'buurten' || compareType === 'wijken') && g.properties.gemeentenaam) label += '<br><span style="font-size:8px;color:#94a3b8;font-weight:400">'+g.properties.gemeentenaam+'</span>';
    html += '<th style="min-width:110px;text-align:center;border-top:3px solid '+itemColors[idx%itemColors.length]+'">'+label+'</th>';
  });
  html += '<th style="min-width:80px;text-align:center">NL gem.</th><th style="min-width:60px;text-align:center">Verschil</th></tr></thead><tbody>';

  // BAG adressen rij (als beschikbaar)
  if(hasBag){
    var anyBag = false;
    for(var bn3 in bagStats){ if(bagStats[bn3].count > 0) anyBag = true; }
    if(anyBag){
      html += '<tr class="cat-header"><td colspan="'+(items.length+3)+'" style="background:#eff6ff;color:#2563eb;font:700 11px \'DM Sans\',sans-serif;border-left:3px solid #2563eb">BAG Adressen (geladen)</td></tr>';
      html += '<tr><td class="ind-name">BAG adressen<span class="ind-unit">geladen</span></td>';
      items.forEach(function(g, idx){
        var name = g.properties[nameField]||'-';
        var bs = bagStats[name];
        var v = bs ? bs.count : 0;
        html += '<td style="text-align:center;color:#2563eb;font-weight:'+(v>0?'700':'400')+'">'+(v>0?v.toLocaleString('nl-NL'):'\u2014')+'</td>';
      });
      html += '<td style="color:#94a3b8;text-align:center">\u2014</td><td style="color:#94a3b8;text-align:center">\u2014</td></tr>';
      // Gem bouwjaar
      html += '<tr><td class="ind-name">Gem. bouwjaar BAG<span class="ind-unit">jaar</span></td>';
      items.forEach(function(g){
        var name = g.properties[nameField]||'-';
        var bs = bagStats[name];
        if(bs && bs.bouwjaren.length > 0){
          var avg = Math.round(bs.bouwjaren.reduce(function(a,b){return a+b},0)/bs.bouwjaren.length);
          html += '<td style="text-align:center">'+avg+'</td>';
        } else {
          html += '<td style="text-align:center;color:#94a3b8">\u2014</td>';
        }
      });
      html += '<td style="color:#94a3b8;text-align:center">\u2014</td><td style="color:#94a3b8;text-align:center">\u2014</td></tr>';
      // Gem oppervlakte
      html += '<tr><td class="ind-name">Gem. oppervlakte BAG<span class="ind-unit">m\u00b2</span></td>';
      items.forEach(function(g){
        var name = g.properties[nameField]||'-';
        var bs = bagStats[name];
        if(bs && bs.oppervlaktes.length > 0){
          var avg = Math.round(bs.oppervlaktes.reduce(function(a,b){return a+b},0)/bs.oppervlaktes.length);
          html += '<td style="text-align:center">'+avg+' m\u00b2</td>';
        } else {
          html += '<td style="text-align:center;color:#94a3b8">\u2014</td>';
        }
      });
      html += '<td style="color:#94a3b8;text-align:center">\u2014</td><td style="color:#94a3b8;text-align:center">\u2014</td></tr>';
    }
  }

  categories.forEach(function(cat){
    var catInds = activeInds.filter(function(fm){ return cat.keys.indexOf(fm.key) > -1; });
    if(catInds.length === 0) return;
    html += '<tr class="cat-header"><td colspan="'+(items.length+3)+'" style="background:'+cat.bg+';color:'+cat.color+';font:700 11px \'DM Sans\',sans-serif;border-left:3px solid '+cat.color+'"><span class="mi" style="font-size:13px;vertical-align:-2px;color:'+cat.color+'">'+cat.icon+'</span> '+cat.label+' ('+catInds.length+')</td></tr>';

    catInds.forEach(function(fm){
      html += '<tr><td class="ind-name">'+fm.naam+'<span class="ind-unit">'+fm.eenheid+'</span></td>';
      var vals = [];
      items.forEach(function(g){ var v = g.properties[fm.key]; vals.push(v != null ? v : null); });
      var numeric = vals.filter(function(v){return v != null});
      var isReverse = reverseSet.has(fm.key);
      var bestVal = numeric.length > 0 ? (isReverse ? Math.min.apply(null,numeric) : Math.max.apply(null,numeric)) : null;
      var worstVal = numeric.length > 0 ? (isReverse ? Math.max.apply(null,numeric) : Math.min.apply(null,numeric)) : null;
      var minVal = numeric.length > 0 ? Math.min.apply(null,numeric) : 0;
      var maxVal = numeric.length > 0 ? Math.max.apply(null,numeric) : 1;

      vals.forEach(function(v){
        if(v == null){
          html += '<td style="color:#94a3b8;text-align:center">\u2014</td>';
        } else {
          var cls = '';
          if(numeric.length >= 2 && bestVal !== worstVal){
            if(v === bestVal) cls = ' class="best"';
            else if(v === worstVal) cls = ' class="worst"';
          }
          var pct = maxVal > minVal ? ((v - minVal) / (maxVal - minVal) * 100) : 50;
          var barColor = v === bestVal ? '#22c55e' : (v === worstVal ? '#ef4444' : '#60a5fa');
          html += '<td'+cls+' style="text-align:center">'+formatCompareVal(v, fm.key);
          html += '<div class="bar-bg"><div class="bar-fill" style="width:'+pct+'%;background:'+barColor+'"></div></div></td>';
        }
      });
      var ns = _nationalStats[fm.key];
      html += '<td style="color:#64748b;text-align:center;font-size:10px">'+(ns ? formatCompareVal(ns.avg, fm.key) : '\u2014')+'</td>';
      if(numeric.length >= 2){
        var diff = Math.abs(Math.max.apply(null,numeric) - Math.min.apply(null,numeric));
        html += '<td style="color:#94a3b8;text-align:center;font-size:9px">\u0394 '+formatCompareVal(diff, fm.key)+'</td>';
      } else {
        html += '<td style="color:#94a3b8;text-align:center">\u2014</td>';
      }
      html += '</tr>';
    });
  });
  html += '</tbody></table></div></div>';

  // ===== 4. AI GEBIEDSANALYSE =====
  html += '<div class="section">';
  html += '<div class="section-title" style="color:#7c3aed;border-color:#ddd6fe"><span class="mi" style="color:#7c3aed">psychology</span> AI Gebiedsanalyse</div>';
  items.forEach(function(g, idx){
    var p = g.properties;
    var displayName = p[nameField] || p.gemeentenaam || '-';
    var color = itemColors[idx%itemColors.length];
    html += '<div class="card" style="border-left:3px solid '+color+'">';
    html += '<div style="font:700 14px \'DM Sans\',sans-serif;color:#0f172a;margin-bottom:8px">'+displayName+'</div>';

    var profiel = '';
    if(p.aantal_inwoners) profiel += p.aantal_inwoners.toLocaleString('nl-NL')+' inwoners';
    if(p.bevolkingsdichtheid) profiel += ', '+Math.round(p.bevolkingsdichtheid)+'/km\u00b2';
    if(p.huishoudens) profiel += ', '+p.huishoudens.toLocaleString('nl-NL')+' huishoudens';
    if(p.gem_huishouden_grootte) profiel += ' (gem. '+p.gem_huishouden_grootte+' pers.)';
    if(profiel) html += '<div style="font-size:11px;color:#475569;margin-bottom:8px;padding:6px 8px;background:#f8fafc;border-radius:6px">'+profiel+'</div>';

    if(p['0_15'] || p['15_25'] || p['25_45'] || p['45_65'] || p['65plus']){
      var parts = [];
      if(p['0_15']) parts.push('0-14: '+p['0_15']+'%');
      if(p['15_25']) parts.push('15-24: '+p['15_25']+'%');
      if(p['25_45']) parts.push('25-44: '+p['25_45']+'%');
      if(p['45_65']) parts.push('45-64: '+p['45_65']+'%');
      if(p['65plus']) parts.push('65+: '+p['65plus']+'%');
      html += '<div style="font-size:10px;color:#475569;margin-bottom:6px"><b>Leeftijdsopbouw:</b> '+parts.join(' \u00b7 ')+'</div>';
    }

    // BAG samenvatting per gebied
    var bs = bagStats[displayName];
    if(bs && bs.count > 0){
      html += '<div style="font-size:10px;color:#2563eb;margin-bottom:6px;padding:4px 8px;background:#eff6ff;border-radius:4px">';
      html += '<b>BAG:</b> '+bs.count.toLocaleString('nl-NL')+' adressen';
      if(bs.bouwjaren.length > 0){
        var avgBj = Math.round(bs.bouwjaren.reduce(function(a,b){return a+b},0)/bs.bouwjaren.length);
        html += ' \u00b7 gem. bouwjaar '+avgBj;
      }
      if(bs.oppervlaktes.length > 0){
        var avgOpp = Math.round(bs.oppervlaktes.reduce(function(a,b){return a+b},0)/bs.oppervlaktes.length);
        html += ' \u00b7 gem. '+avgOpp+' m\u00b2';
      }
      if(Object.keys(bs.gebruiksdoelen).length > 0){
        var topDoel = Object.entries(bs.gebruiksdoelen).sort(function(a,b){return b[1]-a[1]});
        html += ' \u00b7 '+topDoel.slice(0,3).map(function(d){return d[0]+' ('+d[1]+')'}).join(', ');
      }
      html += '</div>';
    }

    var insights = [];
    if(p.gem_woz_waarde != null || p.gem_inkomen_inwoner != null){
      var wozZ = calcZ(p.gem_woz_waarde, 'gem_woz_waarde');
      var inkZ = calcZ(p.gem_inkomen_inwoner, 'gem_inkomen_inwoner');
      var koopZ = calcZ(p.koopwoningen, 'koopwoningen');
      if(wozZ > 0.5 && inkZ > 0.5) insights.push({icon:'\ud83d\udcb0', color:'#16a34a', text:'Welvarend gebied: WOZ-waarde \u20ac'+Math.round((p.gem_woz_waarde||0)/1000)+'k en inkomen \u20ac'+Math.round((p.gem_inkomen_inwoner||0)/1000)+'k liggen boven het landelijk gemiddelde.'});
      else if(wozZ < -0.5 && inkZ < -0.5) insights.push({icon:'\u26a0\ufe0f', color:'#dc2626', text:'Sociaaleconomisch kwetsbaar: WOZ-waarde en inkomen liggen onder het gemiddelde.'});
      else if(wozZ > 0.5 && inkZ < -0.5) insights.push({icon:'\ud83c\udfe0', color:'#d97706', text:'Hoge vastgoedwaarde maar relatief laag inkomen. Mogelijke gentrificatie.'});
      if(koopZ > 0.8) insights.push({icon:'\ud83d\udd11', color:'#16a34a', text:'Veel koopwoningen ('+p.koopwoningen+'%). Stabiele woonomgeving.'});
      else if(koopZ < -0.8) insights.push({icon:'\ud83c\udfe2', color:'#2563eb', text:'Veel huurwoningen ('+(p.huurwoningen||'?')+'%). Meer doorstroom en sociale huur.'});
    }
    var oudZ = calcZ(p['65plus'], '65plus');
    var jongZ = calcZ(p['0_15'], '0_15');
    if(oudZ > 1) insights.push({icon:'\ud83d\udc74', color:'#d97706', text:'Vergrijzend: '+p['65plus']+'% is 65+. Hogere zorgvraag.'});
    if(jongZ > 1) insights.push({icon:'\ud83d\udc76', color:'#16a34a', text:'Jong gezinsgebied: '+p['0_15']+'% is 0-14 jaar.'});
    var gasZ = calcZ(p.gem_aardgas, 'gem_aardgas');
    if(gasZ > 1) insights.push({icon:'\ud83d\udd25', color:'#dc2626', text:'Hoog gasverbruik ('+p.gem_aardgas+' m\u00b3/jaar). Energietransitie-potentieel.'});
    else if(gasZ < -0.8) insights.push({icon:'\u2744\ufe0f', color:'#0891b2', text:'Laag gasverbruik ('+p.gem_aardgas+' m\u00b3/jaar). Goede isolatie of warmtenet.'});
    var arbZ = calcZ(p.arbeidsparticipatie, 'arbeidsparticipatie');
    if(arbZ > 0.5 && calcZ(p.gem_inkomen_inwoner,'gem_inkomen_inwoner') > 0.5) insights.push({icon:'\ud83d\udcbc', color:'#16a34a', text:'Economisch sterk: hoge arbeidsparticipatie ('+(p.arbeidsparticipatie||'?')+'%) + bovengemiddeld inkomen.'});
    else if(arbZ < -0.5) insights.push({icon:'\u26a0\ufe0f', color:'#dc2626', text:'Lage arbeidsparticipatie ('+(p.arbeidsparticipatie||'?')+'%).'});
    var haZ = calcZ(p.afstand_huisarts, 'afstand_huisarts', true);
    var smZ = calcZ(p.afstand_supermarkt, 'afstand_supermarkt', true);
    if(haZ < -1) insights.push({icon:'\ud83c\udfe5', color:'#dc2626', text:'Grote afstand tot huisarts ('+(p.afstand_huisarts||'?')+' km).'});
    if(smZ < -1) insights.push({icon:'\ud83d\uded2', color:'#dc2626', text:'Grote afstand tot supermarkt ('+(p.afstand_supermarkt||'?')+' km).'});
    if(haZ > 0.5 && smZ > 0.5) insights.push({icon:'\u2705', color:'#16a34a', text:'Goede bereikbaarheid: huisarts '+(p.afstand_huisarts||'?')+' km, supermarkt '+(p.afstand_supermarkt||'?')+' km.'});
    var dichthZ = calcZ(p.bevolkingsdichtheid, 'bevolkingsdichtheid');
    var eenZ = calcZ(p.pct_eengezins, 'pct_eengezins');
    if(dichthZ > 1 && eenZ < -0.5) insights.push({icon:'\ud83c\udfd9\ufe0f', color:'#475569', text:'Stedelijk karakter: hoge dichtheid ('+(p.bevolkingsdichtheid||'?')+'/km\u00b2), weinig eengezinswoningen.'});
    else if(dichthZ < -0.5 && eenZ > 0.5) insights.push({icon:'\ud83c\udfe1', color:'#475569', text:'Suburbaan/landelijk: lage dichtheid, veel eengezinswoningen ('+(p.pct_eengezins||'?')+'%).'});

    if(insights.length > 0){
      insights.forEach(function(ins){
        html += '<div class="insight-box" style="background:'+ins.color+'08;border-left:3px solid '+ins.color+'">';
        html += '<span style="font-size:14px">'+ins.icon+'</span> <span style="color:'+ins.color+';font-weight:600">'+ins.text+'</span></div>';
      });
    } else {
      html += '<div style="font-size:11px;color:#94a3b8;padding:8px">Geen opvallende afwijkingen van het landelijk gemiddelde.</div>';
    }
    html += '</div>';
  });
  html += '</div>';

  // ===== 5. GROOTSTE VERSCHILLEN =====
  html += '<div class="section">';
  html += '<div class="section-title" style="color:#d97706;border-color:#fde68a"><span class="mi" style="color:#d97706">compare_arrows</span> Grootste Verschillen</div>';
  html += '<div class="card">';
  var diffs = [];
  activeInds.forEach(function(fm){
    var vals = items.map(function(g){ return g.properties[fm.key]; }).filter(function(v){ return v != null; });
    if(vals.length < 2) return;
    var range = Math.max.apply(null,vals) - Math.min.apply(null,vals);
    var ns = _nationalStats[fm.key];
    var relDiff = ns && ns.stddev > 0 ? range / ns.stddev : 0;
    diffs.push({key:fm.key, naam:fm.naam, eenheid:fm.eenheid, range:range, relDiff:relDiff});
  });
  diffs.sort(function(a,b){ return b.relDiff - a.relDiff; });

  if(diffs.length > 0){
    html += '<table><thead><tr><th>Indicator</th><th style="text-align:center">Verschil</th><th style="text-align:center">Relatief (\u03c3)</th>';
    items.forEach(function(g,idx){ html += '<th style="text-align:center;border-top:3px solid '+itemColors[idx%itemColors.length]+'">'+((g.properties[nameField]||'').substring(0,15))+'</th>'; });
    html += '</tr></thead><tbody>';
    diffs.slice(0,12).forEach(function(d,didx){
      var bgAlpha = Math.max(0.02, 0.12 - didx * 0.01);
      html += '<tr style="background:rgba(217,119,6,'+bgAlpha+')">';
      html += '<td class="ind-name">'+d.naam+'<span class="ind-unit">'+d.eenheid+'</span></td>';
      html += '<td style="text-align:center;font:700 11px \'Space Mono\',monospace;color:#d97706">'+formatCompareVal(d.range, d.key)+'</td>';
      html += '<td style="text-align:center"><span class="z-badge '+(d.relDiff > 1 ? 'z-neg' : 'z-neu')+'">'+d.relDiff.toFixed(1)+'\u03c3</span></td>';
      items.forEach(function(g){
        var v = g.properties[d.key];
        html += '<td style="text-align:center;font:400 10px \'Space Mono\',monospace">'+(v != null ? formatCompareVal(v, d.key) : '\u2014')+'</td>';
      });
      html += '</tr>';
    });
    html += '</tbody></table>';
  } else {
    html += '<div style="text-align:center;color:#94a3b8;padding:12px">Onvoldoende data voor vergelijking</div>';
  }
  html += '</div></div>';

  // ===== 6. AI EINDINTERPRETATIE =====
  html += '<div class="section">';
  html += '<div class="section-title" style="color:#e11d48;border-color:#fecdd3"><span class="mi" style="color:#e11d48">auto_awesome</span> Conclusie &amp; Interpretatie</div>';
  html += '<div class="card" style="border-left:3px solid #e11d48;background:linear-gradient(135deg,#fff 0%,#fdf2f8 100%)">';

  // Genereer AI interpretatie op basis van data
  var names = items.map(function(g){ return g.properties[nameField]||'-'; });
  var interpretatie = '';

  // Welk gebied scoort het best overall?
  var scores = items.map(function(g, idx){
    var zArr = [];
    activeInds.forEach(function(fm){
      var v = g.properties[fm.key]; var ns = _nationalStats[fm.key];
      if(v==null || !ns || !ns.stddev) return;
      var z = (v-ns.avg)/ns.stddev;
      if(reverseSet.has(fm.key)) z = -z;
      zArr.push(z);
    });
    return {name: g.properties[nameField]||'-', avgZ: zArr.length>0 ? zArr.reduce(function(a,b){return a+b},0)/zArr.length : 0, props: g.properties};
  });
  scores.sort(function(a,b){ return b.avgZ - a.avgZ; });

  interpretatie += '<div style="font:600 13px \'DM Sans\',sans-serif;color:#0f172a;margin-bottom:12px">Vergelijking van '+names.join(', ')+'</div>';

  // Overall ranking
  interpretatie += '<div style="margin-bottom:12px">';
  interpretatie += '<div style="font:600 11px \'DM Sans\',sans-serif;color:#475569;margin-bottom:6px">Totaalranking (op basis van z-scores over alle indicatoren):</div>';
  scores.forEach(function(s, i){
    var medal = i === 0 ? '\ud83e\udd47' : (i === 1 ? '\ud83e\udd48' : (i === 2 ? '\ud83e\udd49' : (i+1)+'.'));
    var zLabel = s.avgZ > 0.3 ? 'bovengemiddeld' : (s.avgZ < -0.3 ? 'ondergemiddeld' : 'gemiddeld');
    interpretatie += '<div style="font-size:12px;margin-bottom:4px">'+medal+' <b>'+s.name+'</b> \u2014 z-score '+(s.avgZ>=0?'+':'')+s.avgZ.toFixed(2)+' ('+zLabel+')</div>';
  });
  interpretatie += '</div>';

  // Vergelijkende analyse
  if(diffs.length > 0){
    interpretatie += '<div style="margin-bottom:12px">';
    interpretatie += '<div style="font:600 11px \'DM Sans\',sans-serif;color:#475569;margin-bottom:6px">Grootste onderlinge verschillen:</div>';
    diffs.slice(0,5).forEach(function(d){
      var valsPerItem = items.map(function(g){return {name:g.properties[nameField]||'-', val:g.properties[d.key]}}).filter(function(x){return x.val!=null});
      if(valsPerItem.length < 2) return;
      valsPerItem.sort(function(a,b){return b.val-a.val});
      var highest = valsPerItem[0];
      var lowest = valsPerItem[valsPerItem.length-1];
      interpretatie += '<div style="font-size:11px;margin-bottom:4px;line-height:1.6">';
      interpretatie += '\u2022 <b>'+d.naam+'</b>: '+highest.name+' ('+formatCompareVal(highest.val, d.key)+') scoort '+d.relDiff.toFixed(1)+'\u03c3 hoger dan '+lowest.name+' ('+formatCompareVal(lowest.val, d.key)+'). ';
      if(d.relDiff > 2) interpretatie += '<span style="color:#dc2626">Dit is een zeer groot verschil.</span>';
      else if(d.relDiff > 1) interpretatie += '<span style="color:#d97706">Dit is een significant verschil.</span>';
      else interpretatie += '<span style="color:#64748b">Matig verschil.</span>';
      interpretatie += '</div>';
    });
    interpretatie += '</div>';
  }

  // Thematische vergelijking
  interpretatie += '<div style="margin-bottom:12px">';
  interpretatie += '<div style="font:600 11px \'DM Sans\',sans-serif;color:#475569;margin-bottom:6px">Thematische analyse:</div>';

  // Welvaart
  var wozVals = items.map(function(g){return {n:g.properties[nameField],v:g.properties.gem_woz_waarde}}).filter(function(x){return x.v!=null});
  var inkVals = items.map(function(g){return {n:g.properties[nameField],v:g.properties.gem_inkomen_inwoner}}).filter(function(x){return x.v!=null});
  if(wozVals.length > 1){
    wozVals.sort(function(a,b){return b.v-a.v});
    interpretatie += '<div style="font-size:11px;margin-bottom:4px">\ud83c\udfe0 <b>Vastgoed:</b> '+wozVals[0].n+' heeft de hoogste WOZ-waarde (\u20ac'+Math.round(wozVals[0].v/1000)+'k) vs. '+wozVals[wozVals.length-1].n+' (\u20ac'+Math.round(wozVals[wozVals.length-1].v/1000)+'k). ';
    var wozDiffPct = Math.round((wozVals[0].v - wozVals[wozVals.length-1].v) / wozVals[wozVals.length-1].v * 100);
    interpretatie += 'Verschil: '+wozDiffPct+'%.</div>';
  }

  // Demografie
  var oudVals = items.map(function(g){return {n:g.properties[nameField],v:g.properties['65plus']}}).filter(function(x){return x.v!=null});
  if(oudVals.length > 1){
    oudVals.sort(function(a,b){return b.v-a.v});
    interpretatie += '<div style="font-size:11px;margin-bottom:4px">\ud83d\udc74 <b>Vergrijzing:</b> '+oudVals[0].n+' is het meest vergrijsd ('+oudVals[0].v+'% 65+) vs. '+oudVals[oudVals.length-1].n+' ('+oudVals[oudVals.length-1].v+'%).</div>';
  }

  // Energie
  var gasVals = items.map(function(g){return {n:g.properties[nameField],v:g.properties.gem_aardgas}}).filter(function(x){return x.v!=null});
  if(gasVals.length > 1){
    gasVals.sort(function(a,b){return b.v-a.v});
    interpretatie += '<div style="font-size:11px;margin-bottom:4px">\ud83d\udd25 <b>Energieverbruik:</b> '+gasVals[0].n+' verbruikt het meeste gas ('+Math.round(gasVals[0].v)+' m\u00b3) vs. '+gasVals[gasVals.length-1].n+' ('+Math.round(gasVals[gasVals.length-1].v)+' m\u00b3). ';
    var gasDiffPct = Math.round((gasVals[0].v - gasVals[gasVals.length-1].v) / gasVals[gasVals.length-1].v * 100);
    interpretatie += 'Verschil: '+gasDiffPct+'%.</div>';
  }

  // BAG interpretatie
  if(hasBag){
    var bagItems = items.map(function(g){return {n:g.properties[nameField], bs:bagStats[g.properties[nameField]||'-']}}).filter(function(x){return x.bs && x.bs.count > 0});
    if(bagItems.length > 1){
      interpretatie += '<div style="font-size:11px;margin-bottom:4px">\ud83c\udfe2 <b>BAG Woningbestand:</b> ';
      bagItems.forEach(function(bi, i){
        if(i > 0) interpretatie += ', ';
        interpretatie += bi.n+': '+bi.bs.count.toLocaleString('nl-NL')+' adressen';
        if(bi.bs.bouwjaren.length > 0){
          var avg = Math.round(bi.bs.bouwjaren.reduce(function(a,b){return a+b},0)/bi.bs.bouwjaren.length);
          interpretatie += ' (gem. bouwjaar '+avg+')';
        }
      });
      interpretatie += '.</div>';
    }
  }
  interpretatie += '</div>';

  // Conclusie
  interpretatie += '<div style="padding:10px 12px;background:rgba(225,29,72,.06);border-radius:8px;margin-top:8px">';
  interpretatie += '<div style="font:600 11px \'DM Sans\',sans-serif;color:#e11d48;margin-bottom:6px">\ud83d\udcca Samenvatting</div>';
  var best = scores[0]; var worst = scores[scores.length-1];
  interpretatie += '<div style="font-size:11px;line-height:1.8;color:#475569">';
  interpretatie += 'Van de vergeleken gebieden scoort <b style="color:#16a34a">'+best.name+'</b> het best over alle CBS-indicatoren heen';
  if(best.avgZ > 0.5) interpretatie += ' en ligt bovengemiddeld vergeleken met het landelijk gemiddelde';
  interpretatie += '. ';
  if(worst.avgZ < -0.3){
    interpretatie += '<b style="color:#dc2626">'+worst.name+'</b> scoort het laagst en verdient mogelijk extra aandacht op het gebied van ';
    // Zoek zwakste thema\'s
    var weakThemes = [];
    categories.forEach(function(cat){
      var catZ = [];
      cat.keys.forEach(function(k){
        var v = worst.props[k]; var ns = _nationalStats[k];
        if(v==null || !ns || !ns.stddev) return;
        var z = (v-ns.avg)/ns.stddev;
        if(reverseSet.has(k)) z = -z;
        catZ.push(z);
      });
      if(catZ.length > 0){
        var avg = catZ.reduce(function(a,b){return a+b},0)/catZ.length;
        if(avg < -0.5) weakThemes.push(cat.label.toLowerCase());
      }
    });
    interpretatie += weakThemes.length > 0 ? weakThemes.join(', ')+'.' : 'diverse thema\'s.';
  } else {
    interpretatie += 'Alle gebieden scoren relatief dicht bij het landelijk gemiddelde.';
  }
  if(diffs.length > 0 && diffs[0].relDiff > 1.5){
    interpretatie += ' Het grootste verschil zit in <b>'+diffs[0].naam.toLowerCase()+'</b> ('+diffs[0].relDiff.toFixed(1)+'\u03c3).';
  }
  interpretatie += '</div></div>';

  html += interpretatie;
  html += '</div></div>';

  // ===== FOOTER =====
  html += '<div class="footer">';
  html += '<div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:4px">';
  html += '<div style="width:20px;height:20px;background:linear-gradient(135deg,#39ff14,#22c55e);border-radius:5px;display:flex;align-items:center;justify-content:center"><span style="font-family:\'Material Symbols Rounded\';font-size:12px;color:#0a0f1a;font-variation-settings:\'FILL\' 1">public</span></div>';
  html += '<span style="font:700 11px \'Space Mono\',monospace;color:#16a34a">GeoInzicht</span> <span style="color:#94a3b8">&middot;</span> <span style="color:#64748b;font-size:10px">Data Consultants</span>';
  html += '</div>';
  html += 'GeoInzicht v7.4 &middot; Data Consultants &middot; CBS/PDOK '+_activeYear+' &middot; '+new Date().toLocaleDateString('nl-NL');
  html += '<div style="font-size:9px;color:#cbd5e1;margin-top:4px">Dit rapport is automatisch gegenereerd op basis van CBS kerncijfers en BAG data. De AI-interpretatie is indicatief.</div>';
  html += '</div>';

  html += '</div></body></html>';

  var w = window.open('','_blank','width=1100,height=800');
  if(w){
    w.document.write(html);
    w.document.close();
  } else {
    toast('Popup geblokkeerd \u2014 sta popups toe');
  }
  var reportNames = compareType === 'buurten' ? _selectedBuurten : (compareType === 'wijken' ? _selectedWijken : _selectedGemeenten);
  logEvent('vergelijking_export', reportNames.join(', '));
}

// Helper: z-score berekenen
function calcZ(value, key, isReverse){
  if(value == null) return 0;
  var ns = _nationalStats[key];
  if(!ns || !ns.stddev || ns.stddev === 0) return 0;
  var z = (value - ns.avg) / ns.stddev;
  return isReverse ? -z : z;
}

function formatCompareVal(v, key){
  if(v == null) return '\u2014';
  if(typeof v !== 'number') return String(v);
  if(key === 'gem_woz_waarde') return '\u20ac' + Math.round(v/1000) + 'k';
  if(key === 'gem_inkomen_inwoner') return '\u20ac' + Math.round(v/1000) + 'k';
  if(key === 'afstand_huisarts' || key === 'afstand_supermarkt') return v.toFixed(1) + ' km';
  if(key === 'gem_aardgas') return Math.round(v) + ' m\u00b3';
  if(key === 'gem_elektriciteit') return Math.round(v) + ' kWh';
  if(v >= 10000) return v.toLocaleString('nl-NL');
  if(v >= 100) return Math.round(v).toLocaleString('nl-NL');
  if(v >= 10) return v.toFixed(1);
  if(v >= 1) return v.toFixed(1);
  return v.toFixed(2);
}

// ============================================================
// FEEDBACK POPUP (na 30 minuten)
// ============================================================
var FEEDBACK_KEY = 'geoinzicht_feedback';
var FEEDBACK_SHOWN_KEY = 'geoinzicht_feedback_shown';

function initFeedbackTimer(){
  // Toon maar 1x
  if(localStorage.getItem(FEEDBACK_SHOWN_KEY)) return;
  // 30 minuten = 1800000 ms
  setTimeout(function(){
    if(!localStorage.getItem(FEEDBACK_SHOWN_KEY)){
      document.getElementById('feedbackOverlay').style.display = 'block';
      logEvent('feedback_getoond', '30 min timer');
    }
  }, 30 * 60 * 1000);
}

function submitFeedback(){
  var text = document.getElementById('feedbackText').value.trim();
  var email = document.getElementById('feedbackEmail').value.trim();
  if(!text && !email){ toast('Vul een mening of e-mailadres in'); return; }
  var feedback = {
    ts: new Date().toISOString(),
    text: text,
    email: email,
    year: _activeYear,
    sessionDuration: Math.round((Date.now() - _appStartTime) / 60000) + ' min'
  };
  try {
    var existing = JSON.parse(localStorage.getItem(FEEDBACK_KEY) || '[]');
    existing.push(feedback);
    localStorage.setItem(FEEDBACK_KEY, JSON.stringify(existing));
  } catch(e){}
  // Sla op in IndexedDB (sync naar SQL Server als online)
  if(email) saveEmailToAnalytics(email);
  saveFeedbackToAnalytics(text, email, _activeYear);
  localStorage.setItem(FEEDBACK_SHOWN_KEY, '1');
  logEvent('feedback_verstuurd', text.substring(0,100));
  closeFeedback();
  toast('Bedankt voor je feedback! \u2764');
}

function closeFeedback(){
  document.getElementById('feedbackOverlay').style.display = 'none';
  localStorage.setItem(FEEDBACK_SHOWN_KEY, '1');
}

var _appStartTime = Date.now();

// ============================================================
// RAPPORT EXPORT (PRINT/PDF)
// ============================================================

// Statische globe SVG logo (gebaseerd op logo.svg, zonder animaties)
function globeLogoSvg(size){
  var s = size || 52;
  var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="'+s+'" height="'+s+'" viewBox="0 0 1000 1000" style="flex-shrink:0">';
  svg += '<defs>';
  svg += '<radialGradient id="gs3d" cx="38%" cy="32%" r="65%"><stop offset="0%" stop-color="#1a5c2a" stop-opacity="0.7"/><stop offset="50%" stop-color="#092810" stop-opacity="0.45"/><stop offset="100%" stop-color="#041a08" stop-opacity="0.2"/></radialGradient>';
  svg += '<radialGradient id="gspec" cx="35%" cy="28%" r="35%"><stop offset="0%" stop-color="#39ff14" stop-opacity="0.12"/><stop offset="100%" stop-color="transparent"/></radialGradient>';
  svg += '<radialGradient id="gland" cx="38%" cy="32%" r="65%"><stop offset="0%" stop-color="#2aff4e" stop-opacity="0.35"/><stop offset="50%" stop-color="#1a8c2e" stop-opacity="0.25"/><stop offset="100%" stop-color="#0d4a18" stop-opacity="0.18"/></radialGradient>';
  svg += '<clipPath id="ggc"><circle cx="500" cy="500" r="380"/></clipPath>';
  svg += '</defs>';
  // 3D bol
  svg += '<circle cx="500" cy="500" r="380" fill="url(#gs3d)"/>';
  svg += '<circle cx="500" cy="500" r="380" fill="url(#gspec)"/>';
  // Grid
  svg += '<g clip-path="url(#ggc)" opacity="0.08" stroke="#39ff14" fill="none" stroke-width="1">';
  svg += '<ellipse cx="500" cy="380" rx="375" ry="64"/><ellipse cx="500" cy="500" rx="380" ry="72"/><ellipse cx="500" cy="620" rx="375" ry="64"/>';
  svg += '<ellipse cx="500" cy="500" rx="100" ry="380"/><ellipse cx="500" cy="500" rx="220" ry="380"/><ellipse cx="500" cy="500" rx="330" ry="380"/>';
  svg += '</g>';
  // Globe outline
  svg += '<circle cx="500" cy="500" r="380" fill="none" stroke="#39ff14" stroke-width="2" opacity="0.2"/>';
  // Continenten (vereenvoudigd)
  svg += '<g clip-path="url(#ggc)" fill="url(#gland)" stroke="#39ff14" stroke-width="0.8" stroke-opacity="0.4">';
  // Europa
  svg += '<path d="M389,378 L403,365 L430,340 L453,328 L470,309 L491,271 L500,253 L508,241 L523,230 L541,234 L561,256 L580,273 L596,310 L591,338 L579,360 L547,383 L523,370 L500,356 L478,336 L459,315 L440,307 L423,319 L404,337 L387,363Z"/>';
  // Afrika
  svg += '<path d="M316,522 L321,485 L340,444 L378,405 L411,387 L460,377 L500,377 L531,405 L575,424 L624,464 L670,516 L716,595 L741,625 L726,687 L694,741 L661,785 L616,824 L567,833 L533,807 L521,770 L507,723 L471,643 L442,607 L413,591 L386,560 L347,534Z"/>';
  // Noord-Amerika
  svg += '<path d="M122,317 L161,276 L215,237 L275,215 L313,172 L357,129 L386,114 L405,105 L422,88 L400,97 L378,105 L261,222 L213,258 L137,294Z"/>';
  // Zuid-Amerika
  svg += '<path d="M86,432 L84,489 L101,517 L137,572 L164,639 L207,725 L211,756 L193,777 L193,785 L114,666 L90,592 L83,546 L81,473Z"/>';
  // Azië
  svg += '<path d="M607,336 L631,292 L658,245 L672,199 L661,159 L630,129 L655,125 L718,142 L875,367 L875,443 L849,428 L815,382 L781,366 L762,404 L720,387 L675,353 L632,333Z"/>';
  svg += '</g>';
  // Data netwerk lijnen
  svg += '<g clip-path="url(#ggc)" stroke="#39ff14" stroke-width="1.2" opacity="0.2">';
  svg += '<line x1="477" y1="275" x2="609" y2="245"/><line x1="609" y1="245" x2="632" y2="419"/>';
  svg += '<line x1="477" y1="275" x2="183" y2="254"/><line x1="632" y1="419" x2="770" y2="423"/>';
  svg += '<line x1="770" y1="423" x2="809" y2="216"/><line x1="609" y1="245" x2="809" y2="216"/>';
  svg += '<line x1="632" y1="419" x2="452" y2="597"/><line x1="452" y1="597" x2="689" y2="637"/>';
  svg += '<line x1="689" y1="637" x2="616" y2="797"/><line x1="183" y1="254" x2="178" y2="730"/>';
  svg += '</g>';
  // Data punten (gloeiende nodes)
  svg += '<g fill="#39ff14">';
  svg += '<circle cx="477" cy="275" r="8" opacity="0.9"/><circle cx="609" cy="245" r="7" opacity="0.85"/>';
  svg += '<circle cx="632" cy="419" r="7" opacity="0.85"/><circle cx="183" cy="254" r="8" opacity="0.9"/>';
  svg += '<circle cx="809" cy="216" r="7" opacity="0.85"/><circle cx="770" cy="423" r="6" opacity="0.8"/>';
  svg += '<circle cx="452" cy="597" r="6" opacity="0.8"/><circle cx="689" cy="637" r="6" opacity="0.75"/>';
  svg += '<circle cx="178" cy="730" r="6" opacity="0.75"/><circle cx="616" cy="797" r="6" opacity="0.7"/>';
  svg += '</g>';
  // Orbit ring
  svg += '<g transform="translate(500,500) rotate(-8)">';
  svg += '<ellipse rx="440" ry="110" fill="none" stroke="#39ff14" stroke-width="1.5" opacity="0.15"/>';
  svg += '</g>';
  svg += '</svg>';
  return svg;
}

function printInfoPanel(){
  var locationName = document.getElementById('infoBuurtNaam').textContent || 'GeoInzicht Rapport';
  var content = document.getElementById('infoContent').innerHTML;
  if(!content || !content.trim()){
    toast('Geen data om te exporteren \u2014 klik eerst op een locatie');
    return;
  }
  // Resolve CSS variabelen naar hardcoded kleuren voor print (licht thema)
  var colorMap = {
    'var(--ac)':'#16a34a','var(--ac2)':'#22c55e','var(--ai)':'#0284c7',
    'var(--tx)':'#1e293b','var(--mt)':'#64748b','var(--up)':'#16a34a',
    'var(--dn)':'#dc2626','var(--wn)':'#d97706','var(--cyan)':'#0891b2',
    'var(--bg)':'#ffffff','var(--p)':'#ffffff','var(--glass-bd)':'#e2e8f0',
    'var(--glass)':'rgba(241,245,249,0.85)','var(--bd)':'#cbd5e1'
  };
  var pc = content;
  for(var cv in colorMap) pc = pc.split(cv).join(colorMap[cv]);
  // Donkere achtergronden omzetten naar licht
  pc = pc.replace(/rgba\(15,20,35,[^)]+\)/g,'rgba(241,245,249,0.85)');
  pc = pc.replace(/rgba\(10,15,26,[^)]+\)/g,'rgba(248,250,252,0.9)');
  pc = pc.replace(/rgba\(45,58,77,[^)]+\)/g,'#e2e8f0');
  pc = pc.replace(/rgba\(57,255,20,0\.0[0-9]+\)/g,'rgba(22,163,74,0.08)');
  pc = pc.replace(/rgba\(56,189,248,0\.0[0-9]+\)/g,'rgba(2,132,199,0.06)');
  pc = pc.replace(/rgba\(100,116,139,0\.0[0-9]+\)/g,'rgba(100,116,139,0.06)');
  pc = pc.replace(/rgba\(251,191,36,0\.0[0-9]+\)/g,'rgba(217,119,6,0.06)');
  pc = pc.replace(/rgba\(255,255,255,0\.0[0-9]+\)/g,'rgba(241,245,249,0.4)');
  // SVG labels donkerder voor print
  pc = pc.replace(/fill="rgba\(226,232,240,[\d.]+\)"/g,'fill="rgba(30,41,59,0.7)"');
  pc = pc.replace(/stroke="rgba\(226,232,240,[\d.]+\)"/g,'stroke="rgba(100,116,139,0.3)"');

  var now = new Date();
  var dateStr = now.toLocaleDateString('nl-NL',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});

  var html = '<!DOCTYPE html><html lang="nl"><head>';
  html += '<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">';
  html += '<title>GeoInzicht Rapport \u2014 '+locationName+'</title>';
  html += '<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">';
  html += '<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" rel="stylesheet">';
  html += '<style>';
  // Material icons
  html += '.mi{font-family:"Material Symbols Rounded";font-weight:normal;font-style:normal;font-size:18px;line-height:1;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;-webkit-font-smoothing:antialiased;font-variation-settings:"FILL" 1,"wght" 400,"GRAD" 0,"opsz" 24}';
  html += '.mi-sm{font-size:14px}';
  // Print-optimized base
  html += '*{box-sizing:border-box}';
  html += 'body{font-family:"DM Sans",sans-serif;color:#1e293b;background:#fff;margin:0;padding:20px 28px;max-width:820px;margin:0 auto;line-height:1.5;font-size:11px}';
  html += 'h1{font:700 22px "Space Mono",monospace;color:#0f172a;margin:0}';
  html += 'h3{font:700 13px "Space Mono",monospace;color:#0f172a;margin:12px 0 6px}';
  // Info rows
  html += '.info-row{display:flex;justify-content:space-between;padding:4px 0;font-size:11px;border-bottom:1px solid #e2e8f0}';
  html += '.info-row:last-child{border:none}';
  html += '.info-val{font:700 11px "Space Mono",monospace;color:#0284c7}';
  // Bars
  html += '.info-bar{height:5px;background:#e2e8f0;border-radius:3px;margin-top:3px;position:relative;overflow:visible}';
  html += '.info-bar-fill{height:100%;border-radius:3px}';
  html += '.info-bar-marker{position:absolute;top:-2px;width:2px;height:9px;background:#334155;border-radius:1px;transform:translateX(-1px)}';
  html += '.up{color:#16a34a}.dn{color:#dc2626}';
  // SVG
  html += 'svg{display:block;margin:4px 0;max-width:100%}';
  // Header/footer
  html += '.rh{border-bottom:3px solid #16a34a;padding-bottom:14px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:flex-end}';
  html += '.rf{border-top:2px solid #e2e8f0;padding-top:10px;margin-top:20px;font-size:8px;color:#94a3b8;display:flex;justify-content:space-between}';
  // Print
  html += '@media print{body{padding:8px 12px;font-size:10px}@page{margin:1.2cm;size:A4}svg{page-break-inside:avoid}.rh{page-break-after:avoid}}';
  // Geen animaties in rapport
  html += '@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}';
  html += '</style></head><body>';

  // Header met logo en branding
  html += '<div class="rh">';
  html += '<div style="display:flex;align-items:center;gap:14px">';
  // Inline SVG globe logo — statische versie van logo.svg
  html += globeLogoSvg(52);
  html += '<div>';
  html += '<h1 style="background:linear-gradient(135deg,#16a34a,#0284c7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">GeoInzicht</h1>';
  html += '<div style="font:900 10px Space Mono,monospace;color:#16a34a;letter-spacing:3px;margin-top:2px">DATA CONSULTANTS</div>';
  html += '<div style="font:400 9px DM Sans,sans-serif;color:#94a3b8;margin-top:1px">Statistisch Rapport</div>';
  html += '</div></div>';
  html += '<div style="text-align:right;font-size:10px;color:#64748b">';
  html += '<div style="font-weight:600;color:#0f172a;font-size:12px">'+locationName+'</div>';
  html += '<div>'+dateStr+'</div>';
  html += '<div>GeoInzicht v6.4</div></div></div>';

  // Content
  html += '<div>'+pc+'</div>';

  // Footer met branding
  html += '<div class="rf">';
  html += '<div><b>Databronnen:</b> CBS Kerncijfers wijken en buurten 2022 | BAG Basisregistratie Adressen en Gebouwen (Kadaster) | PDOK Locatieserver</div>';
  html += '<div style="white-space:nowrap;text-align:right"><b style="color:#16a34a;font-size:9px;letter-spacing:2px">DATA CONSULTANTS</b><br>GeoInzicht v6.4</div></div>';

  html += '<script>window.onload=function(){setTimeout(function(){window.print()},500)}<\/script>';
  html += '</body></html>';

  var w = window.open('','_blank');
  if(w){
    w.document.write(html);
    w.document.close();
    logEvent('rapport_export', locationName);
  } else {
    toast('Pop-up geblokkeerd \u2014 sta pop-ups toe voor deze site');
  }
}

// ============================================================
// STARTUP
// ============================================================
async function init(){
  var loadMsg = document.getElementById('loadMsg');
  var loadSub = document.getElementById('loadSub');
  var loadBar = document.getElementById('loadProgress');

  try {
    loadMsg.textContent = 'Kaart initialiseren...';
    loadBar.style.width = '10%';
    initMap();
    buildYearButtons();
    buildIndicatorList();
    buildBasemapButtons();
    buildBagStatusButtons();
    renderIndicatorDefs();
    setupSearch();

    // BAG index laden (aantallen per gemeente — voor dropdown counts)
    // Vector tiles: geen bulk cache meer nodig — PDOK serveert tiles on-demand
    loadBagIndex();

    // Stap 1: Gemeenten laden (0.9 MB — snel)
    loadMsg.textContent = 'Gemeentedata laden...';
    loadSub.textContent = 'CBS gemeentedata ophalen (0.9 MB)';
    loadBar.style.width = '30%';

    var resp = await fetch(GEMEENTEN_URL);
    if(!resp.ok) throw new Error('Gemeentedata fout: ' + resp.status);

    loadMsg.textContent = 'Gemeenten verwerken...';
    loadBar.style.width = '60%';
    _gemeenteData = await resp.json();

    // Gemeenten indexeren voor filter
    _gemeenteData.features.forEach(function(f){
      if(f.properties.gemeentenaam) _gemeenteNamen.add(f.properties.gemeentenaam);
    });
    // Wacht op BAG index voor adres-aantallen in dropdown
    await loadBagIndex();
    buildGemeenteFilter();
    document.getElementById('sBuurten').textContent = _gemeenteData.features.length.toLocaleString('nl-NL');

    loadMsg.textContent = 'Kaart renderen...';
    loadBar.style.width = '90%';
    renderChoropleth('gemeenten');
    updateActiveStats();

    // Dataset metadata + indicatoren filteren op beschikbaarheid
    var meta = _gemeenteData.metadata || {};
    var availInds = meta.indicators || [];
    _yearIndicators[_activeYear] = availInds;
    updateYearInfo(_activeYear, meta);
    filterIndicatorsByYear(availInds);
    document.getElementById('dsGemeenten').textContent = _gemeenteData.features.length.toLocaleString('nl-NL') + ' features';
    document.getElementById('dsJaar').textContent = meta.year || _activeYear;
    document.getElementById('dsGenerated').textContent = meta.generated ? meta.generated.substring(0,10) : '\u2014';

    loadBar.style.width = '100%';
    loadMsg.textContent = 'Klaar!';
    loadSub.textContent = _gemeenteData.features.length.toLocaleString('nl-NL') + ' gemeenten geladen (' + availInds.length + ' indicatoren)';
    setTimeout(function(){document.getElementById('loadingOverlay').style.display='none'},600);

    if(window.innerWidth <= 900){
      document.getElementById('sidebar').classList.add('hidden');
      document.getElementById('closeSidebar').style.display = 'block';
    }
    toast(_gemeenteData.features.length.toLocaleString('nl-NL') + ' gemeenten geladen');
    logEvent('app_open', _gemeenteData.features.length + ' gemeenten');

    // Start achtergrond laden van buurten en wijken na 1.5s
    setTimeout(function(){ loadBackgroundCbsData(); }, 1500);

    // BAG aantallen prefetchen als de index niet compleet is
    setTimeout(function(){ prefetchBagCounts(); }, 3000);

    // Start feedback timer (30 min)
    initFeedbackTimer();

    // Start analytics (IndexedDB + sync naar SQL Server als online)
    initAnalytics().then(function(){
      // Laad opgeslagen uploads na IndexedDB klaar is
      loadSavedUploads();
    }).catch(function(e){ console.warn('Analytics start error:', e); });

    // Admin dashboard renderen als ?admin in URL (beveiligd met wachtwoord)
    renderAdminDashboard();
  } catch(e){
    console.error('Init error:', e);
    loadMsg.textContent = 'Fout bij opstarten';
    loadSub.textContent = e.message;
    loadBar.style.width = '100%';
    loadBar.style.background = 'var(--dn)';
  }
}

init();
</script>
</body>
</html>
