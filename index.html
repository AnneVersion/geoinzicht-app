<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GeoInzicht">
<link rel="manifest" href="manifest.json">
<title>GeoInzicht — CBS Buurtdata</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 48'%3E%3Crect y='0' width='64' height='16' fill='%23AE1C28'/%3E%3Crect y='16' width='64' height='16' fill='%23FFF'/%3E%3Crect y='32' width='64' height='16' fill='%2321468B'/%3E%3C/svg%3E">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root{--bg:#0a0f1a;--p:rgba(15,20,35,.85);--p2:rgba(25,32,52,.7);--bd:rgba(55,65,90,.5);--tx:#e2e8f0;--mt:#64748b;--ac:#39ff14;--ac2:#22c55e;--up:#22c55e;--dn:#ef4444;--pu:#39ff14;--ai:#38bdf8;--wn:#fbbf24;--cyan:#06b6d4;--radius:12px;--glass:rgba(20,28,50,.6);--glass-bd:rgba(80,100,140,.15);--shadow:0 8px 32px rgba(0,0,0,.4)}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--tx);overflow:hidden;height:100vh;height:100dvh}
.app{display:flex;height:100vh;height:100dvh}

/* Material Icons */
.mi{font-family:'Material Symbols Rounded';font-weight:normal;font-style:normal;font-size:18px;line-height:1;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;-webkit-font-smoothing:antialiased;font-variation-settings:'FILL' 1,'wght' 400,'GRAD' 0,'opsz' 24}
.mi-sm{font-size:14px}
.mi-lg{font-size:22px}

/* Sidebar with glass effect */
.sidebar{width:360px;background:var(--p);backdrop-filter:blur(20px) saturate(1.5);-webkit-backdrop-filter:blur(20px) saturate(1.5);display:flex;flex-direction:column;overflow:hidden;z-index:100;transition:transform .4s cubic-bezier(.4,0,.2,1)}
.sidebar.hidden{transform:translateX(-100%);position:absolute;height:100%}
.sidebar-footer{padding:14px 16px;text-align:center;flex-shrink:0;background:rgba(10,15,26,.5)}
.neon-text{font:900 15px 'Space Mono',monospace;color:#39ff14;text-shadow:0 0 7px #39ff14,0 0 10px #39ff14,0 0 21px #39ff14,0 0 42px #0fa,0 0 82px #0fa;letter-spacing:3px;animation:neonPulse 2s ease-in-out infinite alternate}
@keyframes neonPulse{from{text-shadow:0 0 5px #39ff14,0 0 10px #39ff14,0 0 20px #39ff14,0 0 40px #0fa}to{text-shadow:0 0 10px #39ff14,0 0 20px #39ff14,0 0 40px #39ff14,0 0 80px #0fa,0 0 120px #0fa}}

.map-wrap{flex:1;position:relative}
#map{width:100%;height:100%}

/* Header */
.header{padding:14px 16px;display:flex;align-items:center;gap:12px;background:rgba(10,15,26,.4)}
.sb-logo{font-family:'Space Mono',monospace;font-size:17px;font-weight:700;background:linear-gradient(135deg,#39ff14 0%,#22c55e 50%,#06b6d4 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.header-right{margin-left:auto;display:flex;gap:6px;align-items:center}

/* Search */
.search-wrap{padding:10px 14px;position:relative}
.search-wrap input{background:var(--glass);color:var(--tx);border:none;border-radius:10px;padding:10px 12px 10px 36px;font:400 13px 'DM Sans',sans-serif;width:100%;outline:none;transition:all .3s cubic-bezier(.4,0,.2,1);backdrop-filter:blur(10px)}
.search-wrap input:focus{box-shadow:0 0 0 2px rgba(57,255,20,.2),0 0 20px rgba(57,255,20,.05)}
.search-wrap input::placeholder{color:var(--mt);transition:opacity .2s}
.search-wrap input:focus::placeholder{opacity:.5}
.search-wrap .s-icon{position:absolute;left:24px;top:50%;transform:translateY(-50%);color:var(--mt);transition:color .3s}
.search-wrap input:focus ~ .s-icon,.search-wrap input:focus + .s-icon{color:var(--ac)}
.search-results{display:none;position:absolute;left:14px;right:14px;top:50px;background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:10px;max-height:220px;overflow-y:auto;z-index:200;box-shadow:var(--shadow);animation:slideDown .2s ease-out}
@keyframes slideDown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.search-item{padding:10px 12px;cursor:pointer;font-size:12px;border-bottom:1px solid var(--glass-bd);transition:all .15s ease}
.search-item:hover{background:rgba(57,255,20,.08);padding-left:16px}
.search-item:last-child{border:none}

/* Tabs */
.tabs{display:flex;background:rgba(10,15,26,.3)}
.tab{flex:1;padding:12px 8px;text-align:center;font-size:11px;font-weight:600;color:var(--mt);cursor:pointer;border-bottom:2px solid transparent;transition:all .3s cubic-bezier(.4,0,.2,1);letter-spacing:.3px;text-transform:uppercase;position:relative}
.tab.active{color:var(--ac);border-bottom-color:var(--ac)}
.tab:hover{color:var(--tx);background:rgba(255,255,255,.02)}
.tab.active::after{content:'';position:absolute;bottom:-1px;left:20%;right:20%;height:2px;background:var(--ac);filter:blur(4px)}

/* Panes */
.pane{display:none;flex:1;overflow-y:auto;padding:16px;scroll-behavior:smooth}
.pane::-webkit-scrollbar{width:4px}
.pane::-webkit-scrollbar-track{background:transparent}
.pane::-webkit-scrollbar-thumb{background:var(--glass-bd);border-radius:4px}
.pane::-webkit-scrollbar-thumb:hover{background:var(--ac)}
.pane.active{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* Section headers */
.sh{font:700 11px 'Space Mono',monospace;color:var(--ac);text-transform:uppercase;letter-spacing:1px;margin:16px 0 8px;display:flex;align-items:center;gap:6px}
.sh:first-child{margin-top:0}
.sh .mi{font-size:16px;color:var(--ac)}

/* Glass cards */
.card{background:var(--glass);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:none;border-radius:var(--radius);padding:14px;margin-bottom:10px;transition:all .3s cubic-bezier(.4,0,.2,1)}
.card:hover{box-shadow:0 4px 20px rgba(0,0,0,.2)}

/* Stats */
.stat-row{display:flex;gap:10px;margin-bottom:10px}
.stat{flex:1;background:var(--glass);backdrop-filter:blur(8px);border:none;border-radius:10px;padding:12px 8px;text-align:center;transition:all .3s ease}
.stat:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(57,255,20,.1)}
.stat b{display:block;font:700 20px 'Space Mono',monospace;color:var(--ac);transition:transform .2s}
.stat:hover b{transform:scale(1.05)}
.stat small{font-size:10px;color:var(--mt);letter-spacing:.3px}

/* Buttons */
.btn{border:none;border-radius:8px;padding:7px 14px;font:600 11px 'DM Sans',sans-serif;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);display:inline-flex;align-items:center;gap:5px;position:relative;overflow:hidden}
.btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.05),transparent);opacity:0;transition:opacity .2s}
.btn:hover::before{opacity:1}
.btn:active{transform:scale(.96)}
.btn-p{background:linear-gradient(135deg,var(--ac),var(--ac2));color:#000;font-weight:700}.btn-p:hover{box-shadow:0 4px 20px rgba(57,255,20,.3)}
.btn-o{background:transparent;color:var(--ac)}.btn-o:hover{background:rgba(57,255,20,.08);box-shadow:0 0 20px rgba(57,255,20,.1)}
.btn-s{background:var(--glass);color:var(--tx)}.btn-s:hover{background:rgba(255,255,255,.08)}
.btn-s.active{color:var(--ac);background:rgba(57,255,20,.1);box-shadow:0 0 12px rgba(57,255,20,.08)}

/* Select */
select{background:var(--glass);color:var(--tx);border:none;border-radius:10px;padding:10px 12px;font:500 13px 'DM Sans',sans-serif;width:100%;outline:none;appearance:none;-webkit-appearance:none;cursor:pointer;transition:all .3s ease;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2364748b'%3E%3Cpath d='M2 4l4 4 4-4'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
select:focus{box-shadow:0 0 0 2px rgba(57,255,20,.15)}
select:hover{background:rgba(30,40,65,.7)}
select option{background:var(--bg);color:var(--tx)}

/* Legend */
.legend{display:flex;flex-direction:column;gap:3px;margin-top:8px}
.legend-row{display:flex;align-items:center;gap:8px;font-size:11px;padding:2px 0;transition:opacity .2s}
.legend-row:hover{opacity:.8}
.legend-color{width:28px;height:14px;border-radius:4px;transition:transform .2s}
.legend-row:hover .legend-color{transform:scaleX(1.1)}

/* Progress */
.progress{height:4px;background:rgba(45,58,77,.5);border-radius:4px;overflow:hidden;margin:6px 0}
.progress-bar{height:100%;background:linear-gradient(90deg,var(--ac),var(--ac2));border-radius:4px;transition:width .4s cubic-bezier(.4,0,.2,1)}

/* Toast */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);color:var(--tx);border:1px solid var(--glass-bd);border-radius:12px;padding:12px 24px;font-size:13px;font-weight:500;z-index:999;opacity:0;transition:all .4s cubic-bezier(.4,0,.2,1);pointer-events:none;box-shadow:var(--shadow)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* Info panel */
.info-panel{position:absolute;top:12px;right:12px;background:var(--glass);backdrop-filter:blur(20px) saturate(1.5);-webkit-backdrop-filter:blur(20px) saturate(1.5);border:none;border-radius:var(--radius);padding:18px;z-index:500;min-width:320px;max-width:420px;max-height:calc(100vh - 40px);overflow-y:scroll;display:none;box-shadow:var(--shadow);animation:slideIn .3s cubic-bezier(.4,0,.2,1);overscroll-behavior:contain}
@keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
.info-panel.show{display:block}
.info-panel::-webkit-scrollbar{width:6px}
.info-panel::-webkit-scrollbar-track{background:transparent}
.info-panel::-webkit-scrollbar-thumb{background:rgba(57,255,20,.15);border-radius:3px}
.info-panel::-webkit-scrollbar-thumb:hover{background:rgba(57,255,20,.3)}
.info-panel h3{font:700 14px 'Space Mono',monospace;color:var(--ac);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.info-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px;border-bottom:1px solid rgba(55,65,90,.3);transition:background .15s}
.info-row:hover{background:rgba(255,255,255,.02);padding-left:4px}
.info-row:last-child{border:none}
.info-val{font:700 12px 'Space Mono',monospace;color:var(--ai)}
.info-compare{font-size:10px;color:var(--mt);margin-top:2px;display:flex;align-items:center;gap:4px}
.info-compare .up{color:var(--up)}
.info-compare .dn{color:var(--dn)}
.info-bar{height:4px;background:rgba(45,58,77,.5);border-radius:2px;margin-top:3px;position:relative;overflow:visible}
.info-bar-fill{height:100%;border-radius:2px;transition:width .3s}
.info-bar-marker{position:absolute;top:-3px;width:2px;height:10px;background:var(--ac);border-radius:1px;transform:translateX(-1px)}
.info-dist{font:400 9px 'Space Mono',monospace;color:var(--mt);padding:2px 5px;border-radius:3px;background:rgba(45,58,77,.3);display:inline-block;margin-top:2px}

/* Sidebar toggle */
.sidebar-toggle{position:absolute;top:12px;left:12px;z-index:600;background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:none;border-radius:10px;width:40px;height:40px;display:none;place-items:center;cursor:pointer;color:var(--ac);font-size:20px;transition:all .3s;box-shadow:var(--shadow)}
.sidebar-toggle:hover{background:rgba(57,255,20,.1)}

/* Loading */
.loading-overlay{position:fixed;inset:0;background:rgba(10,15,26,.97);z-index:9999;display:grid;place-items:center}
.loading-overlay .inner{text-align:center}
.loading-overlay .spinner{width:52px;height:52px;border:3px solid var(--glass-bd);border-top-color:var(--ac);border-radius:50%;animation:spin .8s cubic-bezier(.4,0,.2,1) infinite;margin:0 auto 20px;filter:drop-shadow(0 0 8px rgba(57,255,20,.3))}
.loading-overlay .msg{font:600 15px 'DM Sans',sans-serif;color:var(--tx)}
.loading-overlay .sub{font-size:12px;color:var(--mt);margin-top:8px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Responsive */
@media(max-width:900px){
  .sidebar{width:100%;position:absolute;height:100%;z-index:500}
  .sidebar.hidden{transform:translateX(-100%)}
  .sidebar-toggle{display:grid}
}
@media(max-width:600px){.sidebar{width:100%}.stat-row{flex-wrap:wrap}.stat{min-width:calc(50% - 5px)}}

/* Indicator list */
.indicator-list{display:flex;flex-direction:column;gap:3px;max-height:320px;overflow-y:auto;padding-right:4px}
.indicator-list::-webkit-scrollbar{width:3px}
.indicator-list::-webkit-scrollbar-thumb{background:var(--glass-bd);border-radius:3px}
.ind-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:8px;cursor:pointer;transition:all .2s ease;border:none;font-size:12px;user-select:none;-webkit-user-select:none}
.ind-item:hover{background:rgba(255,255,255,.04)}
.ind-item.active{background:rgba(57,255,20,.06)}
.ind-item.primary{background:rgba(57,255,20,.1);box-shadow:0 0 12px rgba(57,255,20,.08)}
.ind-item .ind-icon{width:28px;height:28px;border-radius:7px;display:grid;place-items:center;background:var(--glass);border:none;flex-shrink:0;transition:all .2s}
.ind-item.active .ind-icon{background:rgba(57,255,20,.1);color:var(--ac)}
.ind-item.primary .ind-icon{background:rgba(57,255,20,.2);color:var(--ac)}
.ind-item .ind-icon .mi{font-size:15px;color:var(--mt);transition:color .2s}
.ind-item.active .ind-icon .mi,.ind-item.primary .ind-icon .mi{color:var(--ac)}
.ind-item .ind-name{font-weight:500;color:var(--mt);transition:color .2s;flex:1}
.ind-item.active .ind-name,.ind-item.primary .ind-name{color:var(--tx)}
.ind-item .ind-unit{font:400 9px 'Space Mono',monospace;color:var(--mt);opacity:.6}
.ind-item .ind-badge{font:700 8px 'Space Mono',monospace;padding:2px 5px;border-radius:4px;background:rgba(57,255,20,.15);color:var(--ac);display:none;letter-spacing:.5px;flex-shrink:0}
.ind-item.primary .ind-badge{display:block}

/* (stats zijn nu in de tooltip i.p.v. sidebar) */

/* Animated gradient border on active buttons */
@property --angle{syntax:'<angle>';initial-value:0deg;inherits:false}
@keyframes borderSpin{to{--angle:360deg}}
.btn-s.active{position:relative;background:rgba(57,255,20,.08)}
.btn-s.active::after{content:'';position:absolute;inset:-1px;border-radius:9px;padding:1px;background:conic-gradient(from var(--angle),transparent 40%,#39ff14 50%,transparent 60%);-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;animation:borderSpin 3s linear infinite;pointer-events:none}

/* Shimmer on stat cards */
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
.stat:hover{background:linear-gradient(90deg,var(--glass) 0%,rgba(57,255,20,.06) 50%,var(--glass) 100%);background-size:200% 100%;animation:shimmer 2s ease-in-out}

/* Glow pulse on section headers */
.sh .mi{transition:all .3s;filter:drop-shadow(0 0 0px transparent)}
.sh:hover .mi{filter:drop-shadow(0 0 6px rgba(57,255,20,.5));transform:scale(1.1)}

/* Glasmorphism hover lift */
.card{transition:all .3s cubic-bezier(.4,0,.2,1)}
.card:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,.3),0 0 0 1px rgba(57,255,20,.06);background:rgba(25,35,55,.65)}

/* Active tab glow */
.tab.active{text-shadow:0 0 10px rgba(57,255,20,.3)}

/* Search glow when typing */
.search-wrap input:not(:placeholder-shown){box-shadow:0 0 0 1px rgba(57,255,20,.12),0 0 20px rgba(57,255,20,.04)}

/* Info panel entrance */
.info-panel.show{animation:slideIn .3s cubic-bezier(.4,0,.2,1),infoPulse .4s ease-out}
@keyframes infoPulse{0%{box-shadow:0 0 0 0 rgba(57,255,20,.2)}100%{box-shadow:var(--shadow)}}

/* Indicator list items - micro interaction */
.ind-item{transition:all .2s cubic-bezier(.4,0,.2,1)}
.ind-item:hover{transform:translateX(4px)}
.ind-item.primary{border-left:2px solid var(--ac);animation:glowIn .4s ease-out}
@keyframes glowIn{from{border-left-color:transparent;box-shadow:none}to{border-left-color:var(--ac);box-shadow:0 0 12px rgba(57,255,20,.08)}}

/* Sidebar separator lines with gradient fade */
.sh::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--glass-bd),transparent);margin-left:8px}

/* Loading dot animation for toasts */
@keyframes dotPulse{0%,100%{opacity:.3}50%{opacity:1}}

/* Leaflet overrides */
.leaflet-control-zoom a{background:var(--glass) !important;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);color:var(--tx) !important;border-color:var(--glass-bd) !important;transition:all .2s !important}
.leaflet-control-zoom a:hover{background:rgba(57,255,20,.15) !important;color:var(--ac) !important}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="inner">
    <img src="logo.svg" alt="Data Consultants" style="width:160px;height:160px;margin:0 auto 20px;display:block;filter:drop-shadow(0 0 30px rgba(57,255,20,.3))">
    <div class="sb-logo" style="font-size:24px;text-align:center;margin-bottom:4px">GeoInzicht</div>
    <div style="font:600 11px 'Space Mono',monospace;color:var(--mt);text-align:center;letter-spacing:2px;margin-bottom:20px">DATA CONSULTANTS</div>
    <div class="msg" id="loadMsg">Laden...</div>
    <div class="sub" id="loadSub">Gemeentedata ophalen</div>
    <div class="progress" style="width:260px;margin-top:14px"><div class="progress-bar" id="loadProgress" style="width:0%"></div></div>
  </div>
</div>

<div class="app">
  <div class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()"><span class="mi">menu</span></div>

  <div class="sidebar" id="sidebar">
    <div class="header">
      <div style="display:flex;align-items:center;gap:10px">
        <img src="logo.svg" alt="DC" style="width:52px;height:52px;filter:drop-shadow(0 0 12px rgba(57,255,20,.3))">
        <div>
          <div class="sb-logo">GeoInzicht</div>
          <span style="font-size:9px;color:var(--mt);letter-spacing:.5px">CBS buurtdata op de kaart</span>
        </div>
      </div>
      <div class="header-right">
        <button class="btn btn-s" onclick="toggleSidebar()" style="display:none;padding:6px 10px" id="closeSidebar"><span class="mi mi-sm">close</span></button>
      </div>
    </div>

    <!-- Zoekbalk -->
    <div class="search-wrap">
      <span class="mi mi-sm s-icon">search</span>
      <input type="text" id="searchInput" placeholder="Zoek adres, buurt, gemeente..." autocomplete="off">
      <div class="search-results" id="searchResults"></div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="kaart" onclick="switchTab('kaart')"><span class="mi mi-sm" style="vertical-align:-3px">map</span> Kaart</div>
      <div class="tab" data-tab="info" onclick="switchTab('info')"><span class="mi mi-sm" style="vertical-align:-3px">info</span> Info</div>
    </div>

    <!-- KAART TAB -->
    <div class="pane active" id="p-kaart">
      <div class="sh"><span class="mi">layers</span> Lagen</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-s active" data-layer="gemeenten" onclick="toggleLayer('gemeenten')"><span class="mi mi-sm">domain</span> Gemeenten</button>
        <button class="btn btn-s" data-layer="buurten" onclick="toggleLayer('buurten')"><span class="mi mi-sm">grid_on</span> Buurten</button>
        <button class="btn btn-s" data-layer="wijken" onclick="toggleLayer('wijken')"><span class="mi mi-sm">grid_view</span> Wijken</button>
        <button class="btn btn-s" data-layer="bag" onclick="toggleLayer('bag')"><span class="mi mi-sm">location_on</span> BAG Adressen</button>
        <button class="btn btn-s" data-layer="panden" onclick="toggleLayer('panden')"><span class="mi mi-sm">apartment</span> BAG Panden</button>
      </div>

      <div class="sh" id="bagStatusSection" style="display:none"><span class="mi">filter_alt</span> BAG Status filter</div>
      <div id="bagStatusBtns" style="display:none;gap:5px;flex-wrap:wrap;margin-bottom:4px"></div>
      <div id="bagCacheInfo" style="display:none;font:400 9px 'Space Mono',monospace;color:var(--mt);margin-bottom:8px;display:flex;align-items:center;gap:6px">
        <span class="mi mi-sm" style="color:var(--ai)">sd_storage</span>
        <span id="bagCacheText">Cache: 0 adressen</span>
        <button class="btn btn-s" onclick="clearBagCache();toast('BAG cache gewist');loadBagVectors()" style="font-size:9px;padding:2px 8px;margin-left:auto"><span class="mi mi-sm" style="font-size:11px">delete</span> Wis cache</button>
      </div>
      <div id="bagLoadProgress" style="display:none;margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px">
          <span style="font:500 10px 'DM Sans',sans-serif;color:var(--ai);display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="font-size:13px">downloading</span> <span id="bagLoadText">Adressen laden...</span></span>
          <span id="bagLoadPct" style="font:700 10px 'Space Mono',monospace;color:var(--ac)">0%</span>
        </div>
        <div style="height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden">
          <div id="bagLoadBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--ac),var(--ai));border-radius:3px;transition:width .3s ease"></div>
        </div>
      </div>

      <div class="sh"><span class="mi">filter_alt</span> Filter gemeente</div>
      <select id="gemeenteFilter" onchange="filterGemeente()">
        <option value="all">Alle gemeenten</option>
      </select>

      <div class="sh"><span class="mi">palette</span> Basemap</div>
      <div style="display:flex;gap:5px;flex-wrap:wrap" id="basemapBtns"></div>

      <div class="sh"><span class="mi">bar_chart</span> Indicatoren <span style="font:400 9px 'DM Sans',sans-serif;color:var(--mt);text-transform:none;letter-spacing:0">(klik om aan/uit te zetten)</span></div>
      <div class="indicator-list" id="indicatorList"></div>

      <div class="sh"><span class="mi">gradient</span> Legenda</div>
      <div class="legend" id="legend"></div>

      <div class="sh" style="margin-top:12px"><span class="mi">analytics</span> Overzicht</div>
      <div class="stat-row">
        <div class="stat"><b id="sBuurten">0</b><small>Gebieden</small></div>
        <div class="stat"><b id="sGemeenten">0</b><small>Gemeenten</small></div>
      </div>
    </div>

    <!-- INFO TAB -->
    <div class="pane" id="p-info">
      <div class="sh"><span class="mi">info</span> Over GeoInzicht</div>
      <div class="card">
        <p style="font-size:12px;line-height:1.7;color:var(--mt)">
          CBS buurtdata op de kaart. Geometrie en statistieken vooraf samengevoegd
          vanuit PDOK WFS (CBS Wijken &amp; Buurten).
        </p>
      </div>

      <div class="sh"><span class="mi">database</span> Datasets</div>
      <div class="card" id="datasetInfo">
        <div style="font-size:11px;color:var(--mt);line-height:1.9">
          <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--glass-bd);padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ac)">domain</span> Gemeenten</span>
            <span style="font-family:'Space Mono',monospace;color:var(--ac);font-size:10px" id="dsGemeenten">&#8212;</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--glass-bd);padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ac)">grid_on</span> Buurten</span>
            <span style="font-family:'Space Mono',monospace;color:var(--ac);font-size:10px" id="dsBuurten">&#8212;</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--glass-bd);padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ac)">grid_view</span> Wijken</span>
            <span style="font-family:'Space Mono',monospace;color:var(--ac);font-size:10px" id="dsWijken">&#8212;</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--glass-bd);padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ai)">location_on</span> BAG Adressen</span>
            <span style="font-family:'Space Mono',monospace;color:var(--ai);font-size:10px">WMS live (dagelijks)</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--glass-bd);padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ai)">apartment</span> BAG Panden</span>
            <span style="font-family:'Space Mono',monospace;color:var(--ai);font-size:10px">WMS live (dagelijks)</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--glass-bd);padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--wn)">calendar_today</span> CBS Jaar</span>
            <span style="font-family:'Space Mono',monospace;color:var(--wn);font-size:10px" id="dsJaar">&#8212;</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--glass-bd);padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--mt)">schedule</span> Gegenereerd</span>
            <span style="font-family:'Space Mono',monospace;color:var(--mt);font-size:10px" id="dsGenerated">&#8212;</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0">
            <span style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ac)">bar_chart</span> Indicatoren</span>
            <span style="font-family:'Space Mono',monospace;color:var(--ac);font-size:10px">24</span>
          </div>
        </div>
      </div>

      <div class="sh"><span class="mi">hub</span> Databronnen</div>
      <div class="card">
        <div style="font-size:11px;color:var(--mt);line-height:1.7">
          <div style="padding:5px 0;border-bottom:1px solid var(--glass-bd)">
            <div style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ac)">query_stats</span> CBS Kerncijfers wijken en buurten</div>
            <div>Bron: CBS via PDOK WFS &middot; Frequentie: jaarlijks &middot; Peildatum: 1 jan 2022</div>
            <div>Indicatoren: bevolking, woningen, inkomen, energie, arbeid, voorzieningen</div>
            <div>API: <code style="font-family:'Space Mono',monospace;font-size:9px;color:var(--ai);background:rgba(56,189,248,.08);padding:1px 4px;border-radius:3px">service.pdok.nl/cbs/wijkenbuurten</code></div>
          </div>
          <div style="padding:5px 0;border-bottom:1px solid var(--glass-bd)">
            <div style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--cyan)">domain</span> BAG Basisregistratie Adressen en Gebouwen</div>
            <div>Bron: Kadaster via PDOK WMS &middot; Frequentie: <span style="color:var(--ac)">dagelijks</span></div>
            <div>9.9M verblijfsobjecten &middot; Panden met bouwjaar, oppervlakte, status</div>
            <div>API: <code style="font-family:'Space Mono',monospace;font-size:9px;color:var(--ai);background:rgba(56,189,248,.08);padding:1px 4px;border-radius:3px">service.pdok.nl/lv/bag/wms/v2_0</code></div>
          </div>
          <div style="padding:5px 0;border-bottom:1px solid var(--glass-bd)">
            <div style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ac)">search</span> PDOK Locatieserver</div>
            <div>Bron: Kadaster &middot; Frequentie: <span style="color:var(--ac)">continu</span></div>
            <div>Adres zoeken, geocodering, autocomplete</div>
            <div>API: <code style="font-family:'Space Mono',monospace;font-size:9px;color:var(--ai);background:rgba(56,189,248,.08);padding:1px 4px;border-radius:3px">api.pdok.nl/bzk/locatieserver</code></div>
          </div>
          <div style="padding:5px 0">
            <div style="color:var(--tx);font-weight:600;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--wn)">map</span> Basemaps</div>
            <div>CARTO (donker/licht) &middot; OpenStreetMap &middot; Esri Satelliet &middot; BRT Topo (Kadaster)</div>
            <div>Frequentie: <span style="color:var(--ac)">continu (live tiles)</span></div>
          </div>
        </div>
      </div>

      <div class="sh"><span class="mi">timeline</span> CBS data per jaar</div>
      <div class="card">
        <div style="font-size:11px;color:var(--mt);line-height:1.7">
          <div style="color:var(--tx);font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--wn)">help</span> Waarom jaar 2022?</div>
          CBS publiceert kerncijfers per jaar, maar niet alle indicatoren zijn
          meteen beschikbaar in het nieuwste jaar. De data wordt gefaseerd
          toegevoegd:
          <div style="margin-top:8px">
            <div style="padding:4px 0;display:flex;align-items:center;gap:6px"><span style="width:8px;height:8px;border-radius:50%;background:var(--ac);display:inline-block;flex-shrink:0"></span> <b style="color:var(--tx)">2024</b> &#8212; Alleen bevolking (inwoners, leeftijd, huishoudens)</div>
            <div style="padding:4px 0;display:flex;align-items:center;gap:6px"><span style="width:8px;height:8px;border-radius:50%;background:var(--wn);display:inline-block;flex-shrink:0"></span> <b style="color:var(--tx)">2023</b> &#8212; + WOZ, koopwoningen, woningvoorraad</div>
            <div style="padding:4px 0;display:flex;align-items:center;gap:6px"><span style="width:8px;height:8px;border-radius:50%;background:var(--up);display:inline-block;flex-shrink:0"></span> <b style="color:var(--tx)">2022</b> &#8212; + gas, elektriciteit, arbeidsparticipatie <span style="color:var(--ac);font-weight:600">(meest compleet)</span></div>
          </div>
          <div style="margin-top:8px;padding:8px 10px;background:rgba(251,191,36,.05);border-radius:8px;border-left:3px solid var(--wn);display:flex;align-items:flex-start;gap:6px">
            <span class="mi mi-sm" style="color:var(--wn);flex-shrink:0;margin-top:1px">warning</span>
            <span>Zodra CBS meer indicatoren publiceert voor een nieuwer jaar, kun je de data verversen met het build script.</span>
          </div>
        </div>
      </div>

      <div class="sh"><span class="mi">tune</span> Indicatoren</div>
      <div class="card" id="indicatorDefs" style="font-size:11px;color:var(--mt)"></div>

      <div class="sh"><span class="mi">refresh</span> Data verversen</div>
      <div class="card">
        <div style="font-size:11px;color:var(--mt);line-height:1.9">
          <div style="color:var(--tx);font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ac)">terminal</span> Stap 1: GeoJSON opnieuw genereren</div>
          <code style="display:block;background:rgba(10,15,26,.6);padding:8px 10px;border-radius:8px;font:400 10px 'Space Mono',monospace;color:var(--ai);margin:4px 0;border:1px solid var(--glass-bd)">python build_geojson.py --type buurten --year 2022</code>
          <code style="display:block;background:rgba(10,15,26,.6);padding:8px 10px;border-radius:8px;font:400 10px 'Space Mono',monospace;color:var(--ai);margin:4px 0;border:1px solid var(--glass-bd)">python build_geojson.py --type wijken --year 2022</code>
          <div style="color:var(--tx);font-weight:600;margin:10px 0 6px;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--ac)">cloud_upload</span> Stap 2: Publiceren op GitHub Pages</div>
          <code style="display:block;background:rgba(10,15,26,.6);padding:8px 10px;border-radius:8px;font:400 10px 'Space Mono',monospace;color:var(--ai);margin:4px 0;border:1px solid var(--glass-bd)">git add *.geojson<br>git commit -m "Data update"<br>git push</code>
          <div style="color:var(--tx);font-weight:600;margin:10px 0 6px;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="color:var(--wn)">swap_horiz</span> Ander jaar proberen?</div>
          <code style="display:block;background:rgba(10,15,26,.6);padding:8px 10px;border-radius:8px;font:400 10px 'Space Mono',monospace;color:var(--ai);margin:4px 0;border:1px solid var(--glass-bd)">python build_geojson.py --type buurten --year 2023</code>
          <div style="margin-top:4px;font-size:10px;color:var(--mt)">Pas daarna BUURTEN_URL / WIJKEN_URL in index.html aan.</div>
        </div>
      </div>

      <div class="sh"><span class="mi">verified</span> Bron &amp; Versie</div>
      <div class="card">
        <div style="font:700 14px 'Space Mono',monospace;color:var(--ac);display:flex;align-items:center;gap:6px"><span class="mi" style="color:var(--ac)">public</span> GeoInzicht v6.3</div>
        <div style="font-size:11px;color:var(--mt);margin-top:8px;line-height:1.7">
          Buurten + Wijken + BAG Adressen + BAG Panden + Zoeken
          <div style="margin-top:6px">
            <div style="display:flex;align-items:center;gap:4px;padding:2px 0"><span class="mi mi-sm" style="color:var(--ac)">query_stats</span> <b style="color:var(--tx)">CBS</b> &#8212; Kerncijfers wijken en buurten</div>
            <div style="display:flex;align-items:center;gap:4px;padding:2px 0"><span class="mi mi-sm" style="color:var(--cyan)">public</span> <b style="color:var(--tx)">PDOK</b> &#8212; Geometrie, BAG WMS, Locatieserver</div>
            <div style="display:flex;align-items:center;gap:4px;padding:2px 0"><span class="mi mi-sm" style="color:var(--ai)">domain</span> <b style="color:var(--tx)">Kadaster</b> &#8212; BAG verblijfsobjecten &amp; panden</div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar-footer">
      <div class="neon-text">DATA CONSULTANTS</div>
    </div>
  </div>

  <div class="map-wrap">
    <div id="map"></div>
    <div class="info-panel" id="infoPanel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <h3 id="infoBuurtNaam" style="margin:0;flex:1"><span class="mi mi-sm">place</span> -</h3>
        <div style="display:flex;gap:4px;flex-shrink:0">
          <button class="btn-s" onclick="printInfoPanel()" title="Exporteer als rapport" style="padding:4px 10px;font-size:10px;cursor:pointer;border:1px solid var(--glass-bd);background:var(--glass);color:var(--tx);border-radius:6px;display:flex;align-items:center;gap:3px"><span class="mi" style="font-size:14px">print</span>Rapport</button>
          <button class="btn-s" onclick="_infoPinned=false;document.getElementById('infoPanel').classList.remove('show')" title="Sluiten" style="padding:4px 8px;cursor:pointer;border:1px solid var(--glass-bd);background:var(--glass);color:var(--mt);border-radius:6px"><span class="mi" style="font-size:14px">close</span></button>
        </div>
      </div>
      <div id="infoContent"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
// CONFIG
// ============================================================
var GEMEENTEN_URL = 'gemeenten_2022.geojson';
var BUURTEN_URL   = 'buurten_2022.geojson';
var WIJKEN_URL    = 'wijken_2022.geojson';
var PDOK_BAG_WMS  = 'https://service.pdok.nl/lv/bag/wms/v2_0';
var PDOK_BAG_WFS  = 'https://service.pdok.nl/lv/bag/wfs/v2_0';
var PDOK_SUGGEST = 'https://api.pdok.nl/bzk/locatieserver/search/v3_1/suggest?q=';
var PDOK_LOOKUP  = 'https://api.pdok.nl/bzk/locatieserver/search/v3_1/lookup?id=';

var BASEMAPS = {
  dark:  {url:'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', naam:'Donker', icon:'dark_mode', sub:'abcd'},
  light: {url:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', naam:'Licht', icon:'light_mode', sub:'abcd'},
  osm:   {url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', naam:'OSM', icon:'map', sub:'abc'},
  sat:   {url:'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', naam:'Satelliet', icon:'satellite_alt'},
  brt:   {url:'https://service.pdok.nl/brt/achtergrondkaart/wmts/v2_0/standaard/EPSG:3857/{z}/{x}/{y}.png', naam:'BRT Topo', icon:'terrain'}
};

var INDICATORS = [
  {key:'aantal_inwoners',       naam:'Aantal inwoners',         eenheid:'personen', icon:'groups'},
  {key:'gem_woz_waarde',        naam:'Gem. WOZ-waarde',         eenheid:'x1000',    icon:'home'},
  {key:'gem_inkomen_inwoner',   naam:'Gem. inkomen/inwoner',    eenheid:'x1000',    icon:'payments'},
  {key:'koopwoningen',          naam:'Koopwoningen',            eenheid:'%',        icon:'key'},
  {key:'65plus',                naam:'65-plussers',             eenheid:'%',        icon:'elderly'},
  {key:'bevolkingsdichtheid',   naam:'Bevolkingsdichtheid',     eenheid:'/km\u00b2',icon:'density_small'},
  {key:'gem_aardgas',           naam:'Gem. aardgas',            eenheid:'m\u00b3',  icon:'local_fire_department'},
  {key:'gem_elektriciteit',     naam:'Gem. elektriciteit',      eenheid:'kWh',      icon:'bolt'},
  {key:'huishoudens',           naam:'Huishoudens',             eenheid:'aantal',   icon:'family_restroom'},
  {key:'woningvoorraad',        naam:'Woningvoorraad',          eenheid:'aantal',   icon:'location_city'},
  {key:'gem_huishouden_grootte',naam:'Gem. huishoudensgrootte', eenheid:'pers.',    icon:'group'},
  {key:'arbeidsparticipatie',   naam:'Arbeidsparticipatie',     eenheid:'%',        icon:'work'},
  {key:'bedrijfsvestigingen',   naam:'Bedrijfsvestigingen',     eenheid:'aantal',   icon:'business'},
  {key:'afstand_huisarts',      naam:'Afstand huisarts',        eenheid:'km',       icon:'local_hospital'},
  {key:'afstand_supermarkt',    naam:'Afstand supermarkt',      eenheid:'km',       icon:'shopping_cart'},
  {key:'mannen',                naam:'Mannen',                  eenheid:'personen', icon:'man'},
  {key:'vrouwen',               naam:'Vrouwen',                 eenheid:'personen', icon:'woman'},
  {key:'0_15',                  naam:'0-15 jaar',               eenheid:'%',        icon:'child_care'},
  {key:'15_25',                 naam:'15-25 jaar',              eenheid:'%',        icon:'school'},
  {key:'25_45',                 naam:'25-45 jaar',              eenheid:'%',        icon:'person'},
  {key:'45_65',                 naam:'45-65 jaar',              eenheid:'%',        icon:'person_4'},
  {key:'huurwoningen',          naam:'Huurwoningen',            eenheid:'%',        icon:'real_estate_agent'},
  {key:'pct_eengezins',         naam:'Eengezinswoningen',       eenheid:'%',        icon:'cottage'},
  {key:'personenautos',         naam:"Personenauto's",          eenheid:'aantal',   icon:'directions_car'}
];

// Actieve indicatoren (toggle aan/uit), eerste = primair (kaartkleur)
var _activeIndicators = ['gem_woz_waarde','aantal_inwoners','gem_inkomen_inwoner'];

var REVERSE_KEYS = ['afstand_huisarts','afstand_supermarkt'];
var COLORS = ['#1a2332','#1e3a5f','#1d6fa5','#22a7d3','#5ec69b','#a3d65c','#f5c842'];
var COLORS_REVERSE = COLORS.slice().reverse();

// ============================================================
// STATE
// ============================================================
var _map, _currentBasemap;
var _gemeenteData = null, _gemeenteLayer = null;
var _buurtData = null, _buurtLayer = null;
var _wijkData = null, _wijkLayer = null;
var _bagWmsLayer = null;
var _bagVectorLayer = null;
var _bagVectorData = null; // raw WFS features cache
var _bagLoading = false;
var _pandWmsLayer = null;
var _searchMarker = null;
var _infoPinned = false; // Panel vastzetten bij klik
var _gemeenteNamen = new Set();
var _layerState = {gemeenten: true, buurten: false, wijken: false, bag: false, panden: false};
var _nationalStats = {}; // Cache: {key: {min, max, avg, median, stddev, count, skewness, distType}}

// ============================================================
// MAP
// ============================================================
function initMap(){
  _map = L.map('map',{center:[52.1,5.1],zoom:8,zoomControl:false,preferCanvas:true});
  L.control.zoom({position:'bottomright'}).addTo(_map);
  setBasemap('dark');
  // Voorkom dat scrollen in het infopanel de kaart zoomt
  var infoPanel = document.getElementById('infoPanel');
  L.DomEvent.disableScrollPropagation(infoPanel);
  L.DomEvent.disableClickPropagation(infoPanel);

  _map.on('click', function(e){
    if(_map.getZoom() >= 16 && _pandWmsLayer && !_bagVectorLayer){
      _infoPinned = true;
      pandGetFeatureInfo(e);
    }
  });
}

function setBasemap(id){
  if(_currentBasemap) _map.removeLayer(_currentBasemap);
  var bm = BASEMAPS[id];
  var opts = {maxZoom:19, attribution:'&copy; OSM &copy; CARTO | PDOK'};
  if(bm.sub) opts.subdomains = bm.sub;
  _currentBasemap = L.tileLayer(bm.url, opts).addTo(_map);
  fixLayerOrder();
  document.querySelectorAll('[data-bm]').forEach(function(b){
    b.classList.toggle('active', b.dataset.bm === id);
  });
}

function buildBasemapButtons(){
  var el = document.getElementById('basemapBtns');
  var html = '';
  for(var id in BASEMAPS){
    var bm = BASEMAPS[id];
    html += '<button class="btn btn-s'+(id==='dark'?' active':'')+'" data-bm="'+id+'" onclick="setBasemap(\''+id+'\')"><span class="mi mi-sm">'+bm.icon+'</span> '+bm.naam+'</button>';
  }
  el.innerHTML = html;
}

// ============================================================
// CHOROPLETH RENDERING
// ============================================================
var LAYER_CONFIG = {
  gemeenten: {data:function(){return _gemeenteData}, nameField:'gemeentenaam', codeField:'gemeentecode', borderWeight:2, borderColor:'rgba(255,255,255,0.4)'},
  buurten:   {data:function(){return _buurtData},    nameField:'buurtnaam',    codeField:'buurtcode',    borderWeight:0.5, borderColor:'rgba(255,255,255,0.15)'},
  wijken:    {data:function(){return _wijkData},     nameField:'wijknaam',     codeField:'wijkcode',     borderWeight:1.5, borderColor:'rgba(255,255,255,0.3)'}
};

// Z-volgorde: basemap → gemeenten → wijken → buurten → BAG panden → BAG WMS → BAG vectors
function fixLayerOrder(){
  if(_currentBasemap) _currentBasemap.bringToBack();
  if(_gemeenteLayer) _gemeenteLayer.bringToFront();
  if(_wijkLayer) _wijkLayer.bringToFront();
  if(_buurtLayer) _buurtLayer.bringToFront();
  if(_pandWmsLayer) _pandWmsLayer.bringToFront();
  if(_bagWmsLayer) _bagWmsLayer.bringToFront();
  if(_bagVectorLayer) _bagVectorLayer.bringToFront();
}

function renderChoropleth(type){
  try {
  var cfg = LAYER_CONFIG[type];
  if(!cfg){console.warn('renderChoropleth: no config for',type);return}
  var data = cfg.data();
  if(!data || !_map){console.warn('renderChoropleth: no data or map',type,!!data,!!_map);return}

  // Verwijder oude laag
  if(type === 'gemeenten' && _gemeenteLayer){ _map.removeLayer(_gemeenteLayer); _gemeenteLayer = null; }
  if(type === 'buurten' && _buurtLayer){ _map.removeLayer(_buurtLayer); _buurtLayer = null; }
  if(type === 'wijken' && _wijkLayer){ _map.removeLayer(_wijkLayer); _wijkLayer = null; }

  var indicator = _activeIndicators.length > 0 ? _activeIndicators[0] : 'aantal_inwoners';
  var gemFilter = document.getElementById('gemeenteFilter').value;

  var vals = [];
  data.features.forEach(function(f){
    var p = f.properties;
    if(gemFilter !== 'all' && p.gemeentenaam !== gemFilter) return;
    var v = p[indicator];
    if(v !== undefined && v !== null && v >= 0) vals.push(v);
  });
  console.log('renderChoropleth',type,'indicator='+indicator,'vals='+vals.length,'features='+data.features.length);
  if(!vals.length){console.warn('renderChoropleth: geen waarden voor',indicator);return}

  vals.sort(function(a,b){return a-b});
  var breaks = quantileBreaks(vals, 7);
  var colors = REVERSE_KEYS.indexOf(indicator) >= 0 ? COLORS_REVERSE : COLORS;

  var newLayer = L.geoJSON(data, {
    style: function(feature){
      var p = feature.properties;
      if(gemFilter !== 'all' && p.gemeentenaam !== gemFilter)
        return {fillColor:'#111',fillOpacity:0.05,weight:0.2,color:'#222',opacity:0.2};
      var v = p[indicator];
      if(v === undefined || v === null || v < 0)
        return {fillColor:'#111',fillOpacity:0.1,weight:0.3,color:'#333',opacity:0.3};
      return {fillColor:getColor(v,breaks,colors),fillOpacity:0.65,weight:cfg.borderWeight,color:cfg.borderColor,opacity:0.5};
    },
    onEachFeature: function(feature, layer){
      layer.on('mouseover', function(e){
        // Skip hover als BAG/panden actief zijn (choropleth is gedimd)
        if(_layerState.bag || _layerState.panden) return;
        e.target.setStyle({weight:2.5,color:'#39ff14',fillOpacity:0.9});
        e.target.bringToFront();
        showFeatureInfo(e.target.feature.properties, cfg, type, false);
      });
      layer.on('mouseout', function(e){
        if(_layerState.bag || _layerState.panden) return;
        newLayer.resetStyle(e.target);
        if(!_infoPinned) document.getElementById('infoPanel').classList.remove('show');
      });
      layer.on('click', function(){
        // Click: toon info en pin het panel vast
        _infoPinned = true;
        showFeatureInfo(feature.properties, cfg, type, true);
      });
    }
  }).addTo(_map);

  if(type === 'gemeenten'){ _gemeenteLayer = newLayer; }
  if(type === 'buurten'){ _buurtLayer = newLayer; }
  if(type === 'wijken'){ _wijkLayer = newLayer; }

  // Z-ordering herstellen
  fixLayerOrder();

  // Primaire laag bepaalt legenda/stats (de meest gedetailleerde actieve laag)
  var primaryType = _layerState.buurten ? 'buurten' : (_layerState.wijken ? 'wijken' : 'gemeenten');
  if(type === primaryType){
    updateLegend(breaks, colors);
    updateActiveStats();
  }
  } catch(err){console.error('renderChoropleth ERROR:',err)}
}

// ============================================================
// LAYER TOGGLES
// ============================================================
function toggleLayer(type){
  _layerState[type] = !_layerState[type];
  document.querySelector('[data-layer="'+type+'"]').classList.toggle('active', _layerState[type]);

  if(type === 'gemeenten'){
    if(_layerState.gemeenten) renderChoropleth('gemeenten');
    else if(_gemeenteLayer){_map.removeLayer(_gemeenteLayer);_gemeenteLayer=null}
  }
  else if(type === 'buurten'){
    if(_layerState.buurten){
      if(!_buurtData){
        toast('Buurtdata laden (14.4 MB)...');
        fetch(BUURTEN_URL).then(function(r){return r.json()}).then(function(d){
          _buurtData = d;
          toast(d.features.length.toLocaleString('nl-NL') + ' buurten geladen');
          document.getElementById('dsBuurten').textContent = d.features.length.toLocaleString('nl-NL') + ' features';
          renderChoropleth('buurten');
          updateActiveStats();
        }).catch(function(e){toast('Fout laden buurten: '+e.message);_layerState.buurten=false;document.querySelector('[data-layer="buurten"]').classList.remove('active')});
      } else renderChoropleth('buurten');
    } else if(_buurtLayer){_map.removeLayer(_buurtLayer);_buurtLayer=null;updateMap()}
  }
  else if(type === 'wijken'){
    if(_layerState.wijken){
      if(!_wijkData){
        toast('Wijkdata laden (4.4 MB)...');
        fetch(WIJKEN_URL).then(function(r){return r.json()}).then(function(d){
          _wijkData = d;
          toast(d.features.length.toLocaleString('nl-NL') + ' wijken geladen');
          document.getElementById('dsWijken').textContent = d.features.length.toLocaleString('nl-NL') + ' features';
          renderChoropleth('wijken');
          updateActiveStats();
        }).catch(function(e){toast('Fout laden wijken: '+e.message);_layerState.wijken=false;document.querySelector('[data-layer="wijken"]').classList.remove('active')});
      } else renderChoropleth('wijken');
    } else if(_wijkLayer){_map.removeLayer(_wijkLayer);_wijkLayer=null;updateMap()}
  }
  else if(type === 'bag') toggleBagLayer(_layerState.bag);
  else if(type === 'panden') togglePandLayer(_layerState.panden);
}

// ============================================================
// BAG WMS
// ============================================================
var BAG_STATUSES = [
  {id:'all',     label:'Alle',              color:'#e2e8f0', match:null},
  {id:'gebruik', label:'In gebruik',        color:'#39ff14', match:['Verblijfsobject in gebruik','Verblijfsobject in gebruik (niet ingemeten)']},
  {id:'verbouw', label:'Verbouwing',        color:'#fbbf24', match:['Verbouwing verblijfsobject']},
  {id:'gevormd', label:'Gevormd',           color:'#38bdf8', match:['Verblijfsobject gevormd']},
  {id:'buiten',  label:'Buiten gebruik',    color:'#f97316', match:['Verblijfsobject buiten gebruik']},
  {id:'ingetrokken', label:'Ingetrokken',   color:'#ef4444', match:['Verblijfsobject ingetrokken']},
  {id:'niet',    label:'Niet gerealiseerd', color:'#64748b', match:['Niet gerealiseerd verblijfsobject']}
];
var _bagStatusFilter = 'all';

function bagStatusToColor(status){
  for(var i=1;i<BAG_STATUSES.length;i++){
    if(BAG_STATUSES[i].match && BAG_STATUSES[i].match.indexOf(status) >= 0) return BAG_STATUSES[i].color;
  }
  return '#64748b';
}

function buildBagStatusButtons(){
  var el = document.getElementById('bagStatusBtns');
  var html = '';
  BAG_STATUSES.forEach(function(s){
    html += '<button class="btn btn-s'+(s.id==='all'?' active':'')+'" data-bagstatus="'+s.id+'" onclick="setBagStatus(\''+s.id+'\')" style="font-size:10px;padding:5px 10px">';
    html += '<span style="width:8px;height:8px;border-radius:50%;background:'+s.color+';display:inline-block"></span> '+s.label;
    html += '</button>';
  });
  el.innerHTML = html;
}

function setBagStatus(id){
  _bagStatusFilter = id;
  document.querySelectorAll('[data-bagstatus]').forEach(function(b){
    b.classList.toggle('active', b.dataset.bagstatus === id);
  });
  // Herteken vector markers met nieuw filter
  if(_layerState.bag) renderBagVectors();
}

function matchesBagFilter(status){
  if(_bagStatusFilter === 'all') return true;
  var s = BAG_STATUSES.filter(function(b){return b.id === _bagStatusFilter})[0];
  return s && s.match && s.match.indexOf(status) >= 0;
}

function createBagWmsLayer(){
  _bagWmsLayer = L.tileLayer.wms(PDOK_BAG_WMS, {
    layers:'verblijfsobject',format:'image/png',transparent:true,
    version:'1.1.1',opacity:0.4,maxZoom:22,tileSize:256,minZoom:13
  }).addTo(_map);
  fixLayerOrder();
}

// Dynamische WMS opacity: fade uit bij lage zoom
function updateBagWmsOpacity(){
  if(!_map) return;
  var z = _map.getZoom();
  if(_bagWmsLayer) _bagWmsLayer.setOpacity(z >= 16 ? 0.4 : (z >= 14 ? 0.2 : (z >= 13 ? 0.1 : 0)));
  if(_pandWmsLayer) _pandWmsLayer.setOpacity(z >= 16 ? 0.6 : (z >= 14 ? 0.3 : (z >= 13 ? 0.15 : 0)));
}

// BAG cache key prefix
var BAG_CACHE_KEY = 'geoinzicht_bag_cache';
var BAG_CACHE_META = 'geoinzicht_bag_meta';
var _bagCache = {}; // In-memory: tileKey -> features[]
var _bagCacheLoaded = false;

// Laad cache uit localStorage bij startup
function loadBagCache(){
  if(_bagCacheLoaded) return;
  try{
    var meta = JSON.parse(localStorage.getItem(BAG_CACHE_META)||'{}');
    // Cache max 24h oud
    if(meta.ts && Date.now()-meta.ts < 86400000){
      var raw = localStorage.getItem(BAG_CACHE_KEY);
      if(raw){_bagCache = JSON.parse(raw);console.log('BAG cache geladen:',meta.count,'adressen uit',Object.keys(_bagCache).length,'tiles')}
    } else {clearBagCache()}
  }catch(e){clearBagCache()}
  _bagCacheLoaded = true;
}

function saveBagCache(){
  try{
    var count = 0;
    for(var k in _bagCache) count += _bagCache[k].length;
    localStorage.setItem(BAG_CACHE_KEY, JSON.stringify(_bagCache));
    localStorage.setItem(BAG_CACHE_META, JSON.stringify({ts:Date.now(),count:count}));
    var el = document.getElementById('bagCacheText');
    if(el) el.textContent = 'Cache: '+count.toLocaleString('nl-NL')+' adressen ('+Object.keys(_bagCache).length+' tiles)';
  }catch(e){
    // localStorage vol — verwijder oudste tiles
    console.warn('BAG cache opslaan mislukt, cache opruimen...',e.message);
    var keys = Object.keys(_bagCache);
    if(keys.length > 10){
      keys.slice(0, Math.floor(keys.length/2)).forEach(function(k){delete _bagCache[k]});
      try{saveBagCache()}catch(e2){}
    }
  }
}

function clearBagCache(){
  _bagCache = {};
  try{localStorage.removeItem(BAG_CACHE_KEY);localStorage.removeItem(BAG_CACHE_META)}catch(e){}
}

// Genereer tile-key voor een viewport bbox (afgerond op ~200m grid)
function bagTileKey(lat,lng){
  return Math.round(lat*500)+','+Math.round(lng*300);
}

// Alle gecachte features ophalen die in de huidige viewport vallen
function getCachedBagFeatures(){
  loadBagCache();
  var b = _map.getBounds();
  var features = [];
  var seen = {};
  for(var key in _bagCache){
    _bagCache[key].forEach(function(f){
      var c = f.geometry.coordinates;
      if(c[1] >= b.getSouth() && c[1] <= b.getNorth() && c[0] >= b.getWest() && c[0] <= b.getEast()){
        var id = f.properties.identificatie;
        if(!seen[id]){seen[id]=true;features.push(f)}
      }
    });
  }
  return features;
}

// Laad BAG vectordata via WFS — altijd alles in viewport laden
var BAG_MAX_FEATURES = 50000; // Max features om browser niet te crashen
var _bagLastBbox = ''; // Laatst geladen BBOX om dubbel laden te voorkomen
var _bagAbort = null; // AbortController voor lopende requests
function loadBagVectors(){
  if(!_map) return;
  // Als er al een load bezig is, annuleer die
  if(_bagLoading && _bagAbort){ _bagAbort.abort(); _bagAbort = null; _bagLoading = false; }
  loadBagCache();

  // Altijd eerst cache tonen (instant)
  var cached = getCachedBagFeatures();
  if(cached.length > 0){
    _bagVectorData = cached;
    renderBagVectors();
    updateBagStatusCountsFromData();
  }

  var b = _map.getBounds();
  var bbox = b.getSouth().toFixed(5)+','+b.getWest().toFixed(5)+','+b.getNorth().toFixed(5)+','+b.getEast().toFixed(5)+',EPSG:4326';
  var key = bagTileKey(b.getCenter().lat, b.getCenter().lng);

  // Skip als we exact dezelfde BBOX al geladen hebben
  if(bbox === _bagLastBbox) return;

  var pageSize = 2000;
  _bagLoading = true;
  _bagAbort = new AbortController();
  var signal = _bagAbort.signal;

  // UI: toon progress bar
  var progEl = document.getElementById('bagLoadProgress');
  var progText = document.getElementById('bagLoadText');
  var progPct = document.getElementById('bagLoadPct');
  var progBar = document.getElementById('bagLoadBar');
  if(progEl) progEl.style.display = 'block';
  var pagesLoaded = 0;
  var totalPages = 0;
  var totalExpected = 0;
  var allFeatures = [];

  function updateProgress(loaded, total){
    if(!progText) return;
    var pct = total > 0 ? Math.min(100, Math.round(loaded/total*100)) : 0;
    progText.textContent = loaded.toLocaleString('nl-NL')+' / '+(total>0?total.toLocaleString('nl-NL'):'?')+' adressen';
    progPct.textContent = pct+'%';
    progBar.style.width = pct+'%';
  }

  function renderCurrent(){
    _bagCache[key] = allFeatures;
    saveBagCache();
    _bagVectorData = getCachedBagFeatures();
    renderBagVectors();
    updateBagStatusCountsFromData();
  }

  function finishLoading(){
    _bagLoading = false;
    _bagLastBbox = bbox;
    if(progEl) progEl.style.display = 'none';
    var totalCached = 0; for(var k in _bagCache) totalCached += _bagCache[k].length;
    var cacheText = document.getElementById('bagCacheText');
    if(cacheText) cacheText.textContent = 'Cache: '+totalCached.toLocaleString('nl-NL')+' adressen';
    toast(allFeatures.length.toLocaleString('nl-NL')+' adressen geladen \u2714');
  }

  // Stap 1: Haal totaal op via hits (XML)
  var hitsUrl = PDOK_BAG_WFS+'?service=WFS&version=2.0.0&request=GetFeature&typeName=bag:verblijfsobject&resultType=hits&srsName=EPSG:4326&BBOX='+bbox;
  updateProgress(0, 0);

  fetch(hitsUrl,{signal:signal}).then(function(r){return r.text()}).then(function(xml){
    var m = xml.match(/numberMatched="(\d+)"/);
    totalExpected = m ? parseInt(m[1]) : 0;
    if(totalExpected === 0){ finishLoading(); return; }

    // Te veel features? Begrens en waarschuw
    var loadTotal = totalExpected;
    if(totalExpected > BAG_MAX_FEATURES){
      loadTotal = BAG_MAX_FEATURES;
      toast(totalExpected.toLocaleString('nl-NL')+' adressen in beeld \u2014 laadt eerste '+BAG_MAX_FEATURES.toLocaleString('nl-NL')+', zoom in voor alles');
    }

    totalPages = Math.ceil(loadTotal / pageSize);
    updateProgress(0, loadTotal);
    progText.textContent = '0 / '+loadTotal.toLocaleString('nl-NL')+' adressen ('+totalPages+' pagina\u2019s parallel)';

    // Stap 2: Alle pagina's parallel fetchen
    var pageResults = new Array(totalPages);
    var promises = [];
    for(var i = 0; i < totalPages; i++){
      (function(pageIdx){
        var startIdx = pageIdx * pageSize;
        var url = PDOK_BAG_WFS+'?service=WFS&version=2.0.0&request=GetFeature&typeName=bag:verblijfsobject&outputFormat=application/json&count='+pageSize+'&startIndex='+startIdx+'&srsName=EPSG:4326&BBOX='+bbox;
        var p = fetch(url,{signal:signal}).then(function(r){return r.json()}).then(function(d){
          pageResults[pageIdx] = d.features || [];
          pagesLoaded++;
          // Tel alle tot nu toe ontvangen features
          var loadedSoFar = 0;
          for(var j=0;j<pageResults.length;j++) if(pageResults[j]) loadedSoFar += pageResults[j].length;
          updateProgress(loadedSoFar, loadTotal);
          // Tussentijds renderen elke 3 pagina's of bij laatste
          if(pagesLoaded % 3 === 0 || pagesLoaded === totalPages){
            allFeatures = [];
            for(var j=0;j<pageResults.length;j++) if(pageResults[j]) allFeatures = allFeatures.concat(pageResults[j]);
            renderCurrent();
          }
        }).catch(function(e){
          console.warn('BAG WFS pagina '+pageIdx+' error:',e);
          pageResults[pageIdx] = [];
          pagesLoaded++;
        });
        promises.push(p);
      })(i);
    }

    // Stap 3: Wacht tot alles klaar is
    Promise.all(promises).then(function(){
      allFeatures = [];
      for(var j=0;j<pageResults.length;j++) if(pageResults[j]) allFeatures = allFeatures.concat(pageResults[j]);
      renderCurrent();
      finishLoading();
    });

  }).catch(function(e){
    console.warn('BAG WFS hits error:',e);
    // Fallback: laad de eerste pagina
    var url = PDOK_BAG_WFS+'?service=WFS&version=2.0.0&request=GetFeature&typeName=bag:verblijfsobject&outputFormat=application/json&count='+pageSize+'&srsName=EPSG:4326&BBOX='+bbox;
    fetch(url,{signal:signal}).then(function(r){return r.json()}).then(function(d){
      allFeatures = d.features || [];
      renderCurrent();
      finishLoading();
    }).catch(function(){ _bagLoading=false; if(progEl) progEl.style.display='none'; });
  });
}

function updateBagStatusCountsFromData(){
  var counts = {};
  (_bagVectorData||[]).forEach(function(f){
    var s = f.properties.status || 'Onbekend';
    counts[s] = (counts[s]||0) + 1;
  });
  updateBagStatusCounts(counts);
}

function renderBagVectors(){
  if(_bagVectorLayer){_map.removeLayer(_bagVectorLayer);_bagVectorLayer=null}
  if(!_bagVectorData || !_bagVectorData.length) return;
  var filtered = _bagVectorData.filter(function(f){return matchesBagFilter(f.properties.status)});
  var zoom = _map.getZoom();
  // Performance limiet bij lage zoom: sampling
  var maxMarkers = zoom >= 16 ? Infinity : (zoom >= 14 ? 5000 : (zoom >= 12 ? 2000 : 800));
  if(filtered.length > maxMarkers){
    var step = Math.ceil(filtered.length / maxMarkers);
    var sampled = [];
    for(var i = 0; i < filtered.length; i += step) sampled.push(filtered[i]);
    filtered = sampled;
  }
  // Adaptive marker grootte: continu van zoom 9 tot 20
  var radius = Math.max(0.5, Math.min(6, (zoom - 9) * 0.6));
  var weight = zoom >= 17 ? 0.8 : (zoom >= 14 ? 0.3 : 0);
  var fillOp = zoom >= 16 ? 0.85 : (zoom >= 13 ? 0.7 : 0.5);
  _bagVectorLayer = L.geoJSON({type:'FeatureCollection',features:filtered},{
    pointToLayer: function(feature, latlng){
      return L.circleMarker(latlng, {
        radius: radius,
        fillColor: bagStatusToColor(feature.properties.status),
        color: '#fff',
        weight: weight,
        fillOpacity: fillOp
      });
    },
    onEachFeature: function(feature, layer){
      layer.on('click', function(e){
        L.DomEvent.stopPropagation(e);
        _infoPinned = true;
        showBagFeatureInfo(feature.properties, e.latlng);
      });
    }
  }).addTo(_map);
  fixLayerOrder();
}

function showBagFeatureInfo(p, latlng){
  var straat = p.openbare_ruimte || '';
  var hnr = (p.huisnummer||'') + (p.huisletter||'') + (p.toevoeging?' '+p.toevoeging:'');
  document.getElementById('infoBuurtNaam').innerHTML = '<span class="mi mi-sm">location_on</span> '+((straat+' '+hnr).trim() || 'BAG Object');
  var html = '';
  // Basisgegevens
  if(p.postcode) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">mail</span> Postcode</span><span class="info-val">'+p.postcode+'</span></div>';
  if(p.woonplaats) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">location_city</span> Woonplaats</span><span class="info-val">'+p.woonplaats+'</span></div>';
  if(p.gebruiksdoel) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">category</span> Gebruiksdoel</span><span class="info-val">'+p.gebruiksdoel+'</span></div>';
  if(p.status) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">info</span> Status</span><span class="info-val" style="color:'+bagStatusToColor(p.status)+'">'+p.status+'</span></div>';
  if(p.pandstatus) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">apartment</span> Pand</span><span class="info-val" style="font-size:10px">'+p.pandstatus+'</span></div>';

  // === VERGELIJKING: dit adres vs buurt ===
  html += buildBagCompareHtml(p, latlng);

  // === CBS STATISTIEKEN: alle niveaus (buurt, wijk, gemeente, landelijk) ===
  html += buildMultiLevelStatsHtml(latlng);

  document.getElementById('infoContent').innerHTML = html;
  document.getElementById('infoPanel').classList.add('show');
}

// Bereken volledige descriptive statistics van een gesorteerde array
function calcStats(sorted){
  var n = sorted.length;
  if(!n) return null;
  var sum = sorted.reduce(function(a,b){return a+b},0);
  var mean = sum/n;
  var median = n%2===0 ? (sorted[n/2-1]+sorted[n/2])/2 : sorted[Math.floor(n/2)];
  var variance = sorted.reduce(function(a,b){return a+(b-mean)*(b-mean)},0)/n;
  var stddev = Math.sqrt(variance);
  var p10 = sorted[Math.floor(n*0.10)];
  var p25 = sorted[Math.floor(n*0.25)];
  var p75 = sorted[Math.floor(n*0.75)];
  var p90 = sorted[Math.floor(n*0.90)];
  var iqr = p75 - p25;
  var skewSum = stddev > 0 ? sorted.reduce(function(a,b){var d=(b-mean)/stddev;return a+d*d*d},0)/n : 0;
  // Coefficient of variation
  var cv = mean > 0 ? (stddev/mean*100) : 0;
  return {n:n,min:sorted[0],max:sorted[n-1],mean:mean,median:median,stddev:stddev,p10:p10,p25:p25,p75:p75,p90:p90,iqr:iqr,skewness:skewSum,cv:cv};
}

// Bereken percentielrang van een waarde in een gesorteerde array
function percentileRank(sorted, val){
  var count = 0;
  for(var i=0;i<sorted.length;i++){if(sorted[i]<=val)count++;else break}
  return Math.round(count/sorted.length*100);
}

// Controleer of een punt in een polygoon valt (ray-casting)
function pointInPolygon(lat, lng, latlngs){
  var inside = false;
  // latlngs kan genest zijn (multipolygon), pak de buitenste ring
  var ring = latlngs;
  if(ring[0] && ring[0][0] && typeof ring[0][0] !== 'number' && ring[0][0].lat !== undefined) ring = ring[0];
  for(var i=0,j=ring.length-1; i<ring.length; j=i++){
    var yi = ring[i].lat, xi = ring[i].lng;
    var yj = ring[j].lat, xj = ring[j].lng;
    if(((yi>lat)!==(yj>lat))&&(lng<(xj-xi)*(lat-yi)/(yj-yi)+xi)) inside=!inside;
  }
  return inside;
}

// Filter BAG features die in een buurt-polygoon vallen
function getBagFeaturesInBuurt(buurtLayer){
  if(!buurtLayer || !_bagVectorData || !_bagVectorData.length) return [];
  var latlngs;
  try{ latlngs = buurtLayer.getLatLngs ? buurtLayer.getLatLngs() : null; }catch(e){ return []; }
  if(!latlngs) return [];
  // Snelle bounding-box pre-filter
  var bounds;
  try{ bounds = buurtLayer.getBounds(); }catch(e){ return []; }
  var result = [];
  _bagVectorData.forEach(function(f){
    var c = f.geometry.coordinates;
    var lng = c[0], lat = c[1];
    if(lat >= bounds.getSouth() && lat <= bounds.getNorth() && lng >= bounds.getWest() && lng <= bounds.getEast()){
      if(pointInPolygon(lat, lng, latlngs)) result.push(f);
    }
  });
  return result;
}

// Vergelijk BAG adres met statistieken — eerst buurt, dan alle geladen
function buildBagCompareHtml(p, latlng){
  if(!_bagVectorData || !_bagVectorData.length) return '';
  var html = '';

  // Zoek de buurt waar dit adres in ligt
  var buurtFeature = findFeatureAtPoint(_buurtLayer, latlng);
  var buurtLayerObj = null;
  var buurtNaam = null;
  var buurtFeatures = null;

  if(_buurtLayer && buurtFeature){
    buurtNaam = buurtFeature.properties.buurtnaam || buurtFeature.properties.buurtcode || 'buurt';
    // Vind de Leaflet layer voor deze buurt
    _buurtLayer.eachLayer(function(sub){
      if(sub.feature === buurtFeature) buurtLayerObj = sub;
    });
    if(buurtLayerObj){
      buurtFeatures = getBagFeaturesInBuurt(buurtLayerObj);
    }
  }

  // Gebruik alleen buurt-adressen als beschikbaar
  var compareFeatures = (buurtFeatures && buurtFeatures.length > 5) ? buurtFeatures : _bagVectorData;
  var compareLabel = buurtFeatures && buurtFeatures.length > 5
    ? 'Buurt: '+buurtNaam+' ('+buurtFeatures.length+' adressen)'
    : 'Geladen adressen ('+_bagVectorData.length+')';
  var compareIcon = buurtFeatures && buurtFeatures.length > 5 ? 'grid_on' : 'map';
  var compareColor = 'var(--ac)';

  html += '<div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--glass-bd)">';
  html += '<div style="font:700 12px \'Space Mono\',monospace;color:'+compareColor+';margin-bottom:8px;display:flex;align-items:center;gap:5px"><span class="mi" style="font-size:16px">'+compareIcon+'</span> '+compareLabel+'</div>';

  var bouwjaren = [], oppervlaktes = [];
  compareFeatures.forEach(function(f){
    var fp = f.properties;
    if(fp.bouwjaar && fp.bouwjaar > 1000) bouwjaren.push(fp.bouwjaar);
    if(fp.oppervlakte && fp.oppervlakte > 0) oppervlaktes.push(fp.oppervlakte);
  });

  if(p.bouwjaar && bouwjaren.length > 5){
    bouwjaren.sort(function(a,b){return a-b});
    var st = calcStats(bouwjaren);
    var z = st.stddev > 0 ? (p.bouwjaar - st.mean)/st.stddev : 0;
    var pRank = percentileRank(bouwjaren, p.bouwjaar);
    html += buildFullStatCard('event','Bouwjaar',p.bouwjaar,'',st,z,pRank,'bouwjaar');
  }

  if(p.oppervlakte && oppervlaktes.length > 5){
    oppervlaktes.sort(function(a,b){return a-b});
    var st = calcStats(oppervlaktes);
    var z = st.stddev > 0 ? (p.oppervlakte - st.mean)/st.stddev : 0;
    var pRank = percentileRank(oppervlaktes, p.oppervlakte);
    html += buildFullStatCard('square_foot','Oppervlakte',p.oppervlakte,'m\u00b2',st,z,pRank,'oppervlakte');
  }

  if(bouwjaren.length <= 5 && oppervlaktes.length <= 5){
    html += '<div style="font-size:11px;color:var(--mt);padding:6px 0">Te weinig adressen ('+compareFeatures.length+') in deze buurt. Laad meer door in te zoomen op dit gebied.</div>';
  }

  html += '</div>';
  return html;
}

// Uitgebreide statistiekkaart
function buildFullStatCard(icon,label,val,unit,st,z,pRank,type){
  var h = '<div style="margin-bottom:14px;padding:12px;background:rgba(15,20,35,.5);border-radius:10px;border-left:3px solid '+getBarColor(z)+'">';
  // Header: naam + waarde
  h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
  h += '<span style="font:600 13px \'DM Sans\',sans-serif;color:var(--tx);display:flex;align-items:center;gap:5px"><span class="mi" style="font-size:16px;color:var(--ai)">'+icon+'</span>'+label+'</span>';
  h += '<span style="font:700 17px \'Space Mono\',monospace;color:var(--ac)">'+val+' <span style="font-size:11px;color:var(--mt)">'+unit+'</span></span>';
  h += '</div>';

  // Normaalverdeling SVG
  var distType = Math.abs(st.skewness)<0.5?'normaal':(st.skewness>0?'rechts scheef':'links scheef');
  h += buildDistSvg(z, distType);

  // Percentiel + z-score badges
  h += '<div style="display:flex;gap:8px;margin:6px 0;align-items:center">';
  h += '<div style="padding:4px 10px;border-radius:6px;background:rgba(57,255,20,.08);font:700 12px Space Mono,monospace;color:var(--ac)">P'+pRank+'</div>';
  h += '<div style="font-size:11px;color:var(--mt);line-height:1.4">';
  if(type==='bouwjaar'){
    h += pRank>=50 ? 'Nieuwer dan '+pRank+'% van de panden' : 'Ouder dan '+(100-pRank)+'% van de panden';
  } else {
    h += pRank>=50 ? 'Groter dan '+pRank+'% van de adressen' : 'Kleiner dan '+(100-pRank)+'% van de adressen';
  }
  h += '</div></div>';

  // Statistieken tabel
  h += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:5px;margin:8px 0;font-size:10px">';
  var cells = [
    {l:'Gemiddeld',v:Math.round(st.mean),c:'var(--ai)'},
    {l:'Mediaan',v:Math.round(st.median),c:'var(--ai)'},
    {l:'Std.dev (\u03c3)',v:st.stddev<10?st.stddev.toFixed(1):Math.round(st.stddev),c:'var(--wn)'},
    {l:'z-score',v:z.toFixed(2),c:getBarColor(z)},
    {l:'P10',v:Math.round(st.p10),c:'var(--mt)'},
    {l:'P25 (Q1)',v:Math.round(st.p25),c:'var(--mt)'},
    {l:'P75 (Q3)',v:Math.round(st.p75),c:'var(--mt)'},
    {l:'P90',v:Math.round(st.p90),c:'var(--mt)'},
    {l:'Min',v:st.min,c:'var(--mt)'},
    {l:'Max',v:st.max,c:'var(--mt)'},
    {l:'IQR',v:Math.round(st.iqr),c:'var(--mt)'},
    {l:'CV',v:st.cv.toFixed(0)+'%',c:'var(--mt)'}
  ];
  cells.forEach(function(c){
    h += '<div style="text-align:center;padding:4px 3px;background:rgba(255,255,255,.03);border-radius:5px">';
    h += '<div style="color:var(--mt);font-size:9px;white-space:nowrap">'+c.l+'</div>';
    h += '<div style="font:700 11px Space Mono,monospace;color:'+c.c+'">'+c.v+'</div></div>';
  });
  h += '</div>';

  // Interpretatie blok
  h += '<div style="padding:8px 10px;background:rgba(56,189,248,.04);border-radius:8px;border-left:2px solid var(--ai);margin-top:6px">';
  h += '<div style="font:600 11px \'DM Sans\',sans-serif;color:var(--ai);margin-bottom:4px;display:flex;align-items:center;gap:4px"><span class="mi mi-sm" style="font-size:15px">school</span> Wat betekent dit?</div>';
  h += '<div style="font-size:11px;color:var(--mt);line-height:1.7">';

  // Z-score uitleg
  h += '<b style="color:var(--tx)">z-score = '+z.toFixed(2)+'</b>: ';
  if(Math.abs(z)<0.5) h += 'Deze waarde is <b style="color:var(--ai)">heel gemiddeld</b>. ';
  else if(Math.abs(z)<1) h += 'Licht '+(z>0?'boven':'onder')+' gemiddeld, maar <b style="color:var(--ai)">binnen normaal bereik</b> (68% van alle waarden). ';
  else if(Math.abs(z)<2) h += '<b style="color:var(--wn)">'+(z>0?'Boven':'Onder')+'gemiddeld</b>. Valt buiten het bereik waar 68% van de waarden ligt. ';
  else h += '<b style="color:var(--dn)">Uitzonderlijk '+(z>0?'hoog':'laag')+'</b>. Valt buiten 95% van alle waarden. ';

  // Standaarddeviatie uitleg
  h += '<br>\u03c3 = '+Math.round(st.stddev)+': ';
  if(st.cv < 15) h += 'Lage spreiding \u2014 de '+label.toLowerCase()+'s in deze buurt zijn <b style="color:var(--ai)">heel uniform</b>. ';
  else if(st.cv < 30) h += 'Gemiddelde spreiding \u2014 er is een <b style="color:var(--ai)">normale variatie</b> in '+label.toLowerCase()+'s. ';
  else h += 'Hoge spreiding \u2014 er is <b style="color:var(--wn)">veel variatie</b> in '+label.toLowerCase()+'s (CV='+st.cv.toFixed(0)+'%). ';

  // Verdeling
  h += '<br>Verdeling: <b style="color:var(--tx)">'+distType+'</b>';
  if(distType==='rechts scheef') h += ' \u2014 er zijn enkele uitschieters naar boven.';
  else if(distType==='links scheef') h += ' \u2014 er zijn enkele uitschieters naar beneden.';
  else h += ' \u2014 de waarden zijn symmetrisch verdeeld rond het gemiddelde.';

  // Context-specifieke uitleg
  if(type==='bouwjaar'){
    h += '<br><b style="color:var(--tx)">IQR = '+Math.round(st.iqr)+' jaar</b>: de middelste 50% van de panden is gebouwd tussen '+Math.round(st.p25)+' en '+Math.round(st.p75)+'.';
  } else {
    h += '<br><b style="color:var(--tx)">IQR = '+Math.round(st.iqr)+' m\u00b2</b>: de middelste 50% van de adressen heeft '+Math.round(st.p25)+'\u2013'+Math.round(st.p75)+' m\u00b2.';
  }

  h += '</div></div>';
  h += '</div>';
  return h;
}

function updateBagStatusCounts(counts){
  document.querySelectorAll('[data-bagstatus]').forEach(function(btn){
    var id = btn.dataset.bagstatus;
    var s = BAG_STATUSES.filter(function(b){return b.id===id})[0];
    var n = 0;
    if(id === 'all'){
      for(var k in counts) n += counts[k];
    } else if(s && s.match){
      s.match.forEach(function(m){n += counts[m]||0});
    }
    // Voeg count badge toe
    var badge = btn.querySelector('.bag-count');
    if(!badge){badge = document.createElement('span');badge.className='bag-count';badge.style.cssText='font:700 9px Space Mono,monospace;opacity:.6;margin-left:3px';btn.appendChild(badge);}
    badge.textContent = n > 0 ? '('+n+')' : '';
  });
}

function dimChoroplethLayers(dim){
  // Dim choropleth maar houd kleuren zichtbaar (WOZ etc.)
  var opacity = dim ? 0.35 : 0.65;
  var borderOp = dim ? 0.25 : 0.5;
  [_gemeenteLayer, _wijkLayer, _buurtLayer].forEach(function(layer){
    if(!layer) return;
    layer.eachLayer(function(sub){
      try{
        var s = sub.options;
        sub.setStyle({fillOpacity:opacity, opacity:borderOp});
      }catch(e){}
    });
  });
}

function toggleBagLayer(on){
  if(!_map) return;
  var statusSection = document.getElementById('bagStatusSection');
  var statusBtns = document.getElementById('bagStatusBtns');
  if(on){
    if(_bagWmsLayer) return;
    // WMS als subtiele achtergrond (alle adressen)
    createBagWmsLayer();
    statusSection.style.display = '';
    statusBtns.style.display = 'flex';
    document.getElementById('bagCacheInfo').style.display = 'flex';
    dimChoroplethLayers(true);
    // Panden als context
    if(!_layerState.panden){
      _layerState.panden = true;
      document.querySelector('[data-layer="panden"]').classList.add('active');
      togglePandLayer(true);
    }
    if(_map.getZoom() < 16){
      toast('BAG adressen actief \u2014 zoom in voor individuele adressen');
    }
    // WFS vectordata laden voor het viewport
    loadBagVectors();
    // Herlaad bij pan/zoom
    _map.on('moveend', onBagMoveEnd);
  } else {
    _map.off('moveend', onBagMoveEnd);
    if(_bagWmsLayer){_map.removeLayer(_bagWmsLayer);_bagWmsLayer=null}
    if(_bagVectorLayer){_map.removeLayer(_bagVectorLayer);_bagVectorLayer=null}
    _bagVectorData = null;
    statusSection.style.display = 'none';
    statusBtns.style.display = 'none';
    document.getElementById('bagCacheInfo').style.display = 'none';
    dimChoroplethLayers(false);
  }
}

function onBagMoveEnd(){
  if(_layerState.bag) loadBagVectors();
  updateBagWmsOpacity();
}

// bagStatusColor via bagStatusToColor() hierboven

// Zoek feature in een laag via punt-in-polygoon
function findFeatureAtPoint(layer, latlng){
  if(!layer) return null;
  var found = null;
  layer.eachLayer(function(sub){
    if(found) return;
    try{
      if(sub.getBounds && sub.getBounds().contains(latlng)){
        if(sub.getLatLngs) found = sub.feature;
      }
    }catch(e){}
  });
  return found;
}

// CBS statistieken voor een locatie — ALLE niveaus met grafieken + AI interpretatie
function buildMultiLevelStatsHtml(latlng){
  var html = '';
  var layers = [
    {layer:_buurtLayer, name:'Buurt', icon:'grid_on', state:_layerState.buurten, cfg:LAYER_CONFIG.buurten, color:'var(--ac)'},
    {layer:_wijkLayer, name:'Wijk', icon:'grid_view', state:_layerState.wijken, cfg:LAYER_CONFIG.wijken, color:'var(--wn)'},
    {layer:_gemeenteLayer, name:'Gemeente', icon:'domain', state:_layerState.gemeenten, cfg:LAYER_CONFIG.gemeenten, color:'var(--cyan)'}
  ];
  var findings = []; // Verzamel data voor de eindanalyse
  layers.forEach(function(l){
    if(!l.state || !l.layer) return;
    var feature = findFeatureAtPoint(l.layer, latlng);
    if(!feature || !feature.properties) return;
    var p = feature.properties;
    var naam = p[l.cfg.nameField] || p[l.cfg.codeField] || '-';
    html += '<div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--glass-bd)">';
    html += '<div style="font:700 12px \'Space Mono\',monospace;color:'+l.color+';margin-bottom:8px;display:flex;align-items:center;gap:5px"><span class="mi" style="font-size:16px;color:'+l.color+'">'+l.icon+'</span> '+l.name+': '+naam+'</div>';
    _activeIndicators.forEach(function(k){
      var v = p[k];
      if(v === undefined || v === null) return;
      html += buildCompareHtml(k, v);
      // Verzamel voor eindanalyse
      var ns = _nationalStats[k];
      if(ns && ns.stddev > 0){
        findings.push({level:l.name, naam:naam, key:k, val:v, z:(v-ns.avg)/ns.stddev, avg:ns.avg, stddev:ns.stddev});
      }
    });
    html += '</div>';
  });

  // === AI DATA-INTERPRETATIE (educatief) ===
  if(findings.length > 0){
    html += buildEducationalAnalysis(findings);
  }
  return html;
}

// Genereer educatieve data-interpretatie
function buildEducationalAnalysis(findings){
  var h = '<div style="margin-top:14px;padding-top:12px;border-top:2px solid rgba(57,255,20,.2)">';
  h += '<div style="font:700 13px \'Space Mono\',monospace;color:var(--ac);margin-bottom:10px;display:flex;align-items:center;gap:6px">';
  h += '<span class="mi" style="font-size:20px;color:var(--ac)">psychology</span> Data-analyse';
  h += '<span style="font:400 10px DM Sans,sans-serif;color:var(--mt);text-transform:none;letter-spacing:0">(automatisch afgeleid uit statistiek)</span>';
  h += '</div>';

  // Stap 1: Opvallende waarden identificeren
  var opvallend = findings.filter(function(f){return Math.abs(f.z)>1});
  var gemiddeld = findings.filter(function(f){return Math.abs(f.z)<=0.5});
  var licht = findings.filter(function(f){return Math.abs(f.z)>0.5 && Math.abs(f.z)<=1});

  h += '<div style="padding:10px 12px;background:rgba(57,255,20,.03);border-radius:10px;border-left:3px solid var(--ac);margin-bottom:10px">';
  h += '<div style="font:600 12px DM Sans,sans-serif;color:var(--ac);margin-bottom:6px;display:flex;align-items:center;gap:5px"><span class="mi mi-sm" style="font-size:15px">looks_one</span> Stap 1: Opvallende waarden identificeren</div>';
  h += '<div style="font-size:11px;color:var(--mt);line-height:1.8">';
  h += 'We vergelijken elke indicator met het <b style="color:var(--tx)">landelijk gemiddelde</b> en berekenen de <b style="color:var(--ai)">z-score</b> = (waarde \u2212 gemiddelde) \u00f7 standaarddeviatie.<br>';
  if(opvallend.length > 0){
    h += '<br><b style="color:var(--wn)">'+opvallend.length+' opvallende waarde'+(opvallend.length>1?'n':'')+'</b> gevonden (|z| > 1):';
    h += '<ul style="margin:4px 0 0 16px;padding:0">';
    opvallend.forEach(function(f){
      var fm = getIndicator(f.key);
      var dir = f.z > 0 ? 'hoger' : 'lager';
      h += '<li style="margin:2px 0"><b style="color:var(--tx)">'+fm.naam+'</b> = '+formatVal(f.val)+' '+fm.eenheid;
      h += ' <span style="color:'+getBarColor(f.z)+'">('+(f.z>0?'+':'')+f.z.toFixed(1)+'\u03c3 '+dir+' dan gemiddeld)</span></li>';
    });
    h += '</ul>';
  }
  if(gemiddeld.length > 0){
    h += '<br><span style="color:var(--ai)">'+gemiddeld.length+' indicator'+(gemiddeld.length>1?'en':'')+' dicht bij het gemiddelde</span> (|z| < 0.5): ';
    h += gemiddeld.map(function(f){return getIndicator(f.key).naam}).join(', ')+'.';
  }
  h += '</div></div>';

  // Stap 2: Patroonherkenning
  h += '<div style="padding:10px 12px;background:rgba(56,189,248,.03);border-radius:10px;border-left:3px solid var(--ai);margin-bottom:10px">';
  h += '<div style="font:600 12px DM Sans,sans-serif;color:var(--ai);margin-bottom:6px;display:flex;align-items:center;gap:5px"><span class="mi mi-sm" style="font-size:15px">looks_two</span> Stap 2: Patronen herkennen</div>';
  h += '<div style="font-size:11px;color:var(--mt);line-height:1.8">';

  // Zoek correlaties/patronen
  var hWoz = findings.find(function(f){return f.key==='gem_woz_waarde'});
  var hInk = findings.find(function(f){return f.key==='gem_inkomen_inwoner'});
  var hBev = findings.find(function(f){return f.key==='aantal_inwoners'});
  var hDicht = findings.find(function(f){return f.key==='bevolkingsdichtheid'});
  var hKoop = findings.find(function(f){return f.key==='koopwoningen'});
  var hGas = findings.find(function(f){return f.key==='gem_aardgas'});
  var hElek = findings.find(function(f){return f.key==='gem_elektriciteit'});
  var h65 = findings.find(function(f){return f.key==='65plus'});
  var hArb = findings.find(function(f){return f.key==='arbeidsparticipatie'});

  var patterns = [];
  // WOZ-inkomen correlatie
  if(hWoz && hInk){
    if(hWoz.z > 0.5 && hInk.z > 0.5) patterns.push('WOZ-waarde en inkomen zijn <b>beide bovengemiddeld</b> \u2014 dit wijst op een <b style="color:var(--ac)">welvarend gebied</b>.');
    else if(hWoz.z < -0.5 && hInk.z < -0.5) patterns.push('WOZ-waarde en inkomen zijn <b>beide ondergemiddeld</b> \u2014 dit wijst op een <b style="color:var(--wn)">sociaal-economisch zwakker gebied</b>.');
    else if(hWoz.z > 1 && hInk.z < 0) patterns.push('Hoge WOZ maar laag inkomen \u2014 mogelijk <b style="color:var(--wn)">gentrificatie</b>: woningen worden duurder terwijl de huidige bewoners minder verdienen.');
  }
  // Vergrijzing
  if(h65 && h65.z > 1) patterns.push('Hoog percentage 65+ ('+(h65.val).toFixed(0)+'%) \u2014 dit is een <b style="color:var(--wn)">vergrijzend gebied</b>.'+(hArb && hArb.z < -0.5 ? ' Dit verklaart ook de lagere arbeidsparticipatie.' : ''));
  // Energie
  if(hGas && hElek){
    if(hGas.z > 1) patterns.push('Hoog gasverbruik ('+formatVal(hGas.val)+' m\u00b3) \u2014 waarschijnlijk <b style="color:var(--wn)">oudere, slecht ge\u00efsoleerde woningen</b>.');
    if(hGas.z < -1) patterns.push('Laag gasverbruik \u2014 wijst op <b style="color:var(--ac)">nieuwbouw of goed ge\u00efsoleerd</b>.');
  }
  // Dichtheid vs koop
  if(hDicht && hKoop){
    if(hDicht.z > 1 && hKoop.z < -0.5) patterns.push('Hoge bevolkingsdichtheid met weinig koopwoningen \u2014 typisch <b>stedelijk huurgebied</b> (flats/appartementen).');
    if(hDicht.z < -1 && hKoop.z > 0.5) patterns.push('Lage dichtheid met veel koopwoningen \u2014 typisch <b>suburbaan</b>/dorps woongebied.');
  }

  if(patterns.length > 0){
    patterns.forEach(function(p){h+='<div style="margin:4px 0;padding-left:8px;border-left:2px solid rgba(56,189,248,.2)">'+p+'</div>'});
  } else {
    h += 'Geen sterke patronen gevonden \u2014 dit gebied scoort vrij gemiddeld op de meeste indicatoren.';
  }
  h += '</div></div>';

  // Stap 3: Conclusie
  h += '<div style="padding:10px 12px;background:rgba(251,191,36,.03);border-radius:10px;border-left:3px solid var(--wn);margin-bottom:10px">';
  h += '<div style="font:600 12px DM Sans,sans-serif;color:var(--wn);margin-bottom:6px;display:flex;align-items:center;gap:5px"><span class="mi mi-sm" style="font-size:15px">looks_3</span> Stap 3: Conclusie formuleren</div>';
  h += '<div style="font-size:11px;color:var(--mt);line-height:1.8">';

  // Gebiedsprofiel samenstellen
  var level = findings[0] ? findings[0].level : 'Gebied';
  var naam = findings[0] ? findings[0].naam : '';
  h += '<b style="color:var(--tx)">Profiel van '+level.toLowerCase()+' '+naam+':</b><br>';

  // Bouw een profiel
  var profiel = [];
  if(hWoz) profiel.push(hWoz.z>0.5?'dure woningen':(hWoz.z<-0.5?'goedkope woningen':'gemiddelde woningwaarde'));
  if(hInk) profiel.push(hInk.z>0.5?'hoge inkomens':(hInk.z<-0.5?'lage inkomens':'gemiddelde inkomens'));
  if(hDicht) profiel.push(hDicht.z>1?'zeer dicht bebouwd':(hDicht.z>0.5?'stedelijk':(hDicht.z<-0.5?'ruim/landelijk':'gemiddelde dichtheid')));
  if(hKoop) profiel.push(hKoop.z>0.5?'veel koopwoningen':(hKoop.z<-0.5?'veel huurwoningen':'mix koop/huur'));
  if(h65) profiel.push(h65.z>1?'vergrijzend':(h65.z<-0.5?'jong/gezinnen':'gemiddelde leeftijdsopbouw'));
  if(profiel.length > 0) h += 'Een gebied met '+profiel.join(', ')+'.';

  // Sterke/zwakke punten
  var sterk = opvallend.filter(function(f){
    var isReverse = REVERSE_KEYS.indexOf(f.key)>=0;
    return isReverse ? f.z<-1 : f.z>1;
  });
  var zwak = opvallend.filter(function(f){
    var isReverse = REVERSE_KEYS.indexOf(f.key)>=0;
    return isReverse ? f.z>1 : f.z<-1;
  });
  if(sterk.length>0){
    h += '<br><span style="color:var(--ac)">Sterk:</span> '+sterk.map(function(f){return getIndicator(f.key).naam}).join(', ')+'.';
  }
  if(zwak.length>0){
    h += '<br><span style="color:var(--dn)">Aandachtspunt:</span> '+zwak.map(function(f){return getIndicator(f.key).naam}).join(', ')+'.';
  }

  h += '</div></div>';

  // Methode-uitleg (educatief) — met concreet rekenvoorbeeld
  h += '<div style="padding:12px 14px;background:rgba(100,116,139,.05);border-radius:10px;border-left:3px solid var(--mt)">';
  h += '<div style="font:600 12px DM Sans,sans-serif;color:var(--mt);margin-bottom:8px;display:flex;align-items:center;gap:5px"><span class="mi" style="font-size:16px">school</span> Hoe werkt deze analyse? (uitleg voor beginners)</div>';
  h += '<div style="font-size:11px;color:var(--mt);line-height:1.8">';

  // Stap 1: Wat is een gemiddelde
  h += '<b style="color:var(--tx)">\u2776 Wat is een gemiddelde?</b><br>';
  h += 'Stel je voor: je hebt de WOZ-waarde van <b>alle</b> buurten in Nederland. Tel ze bij elkaar op en deel door het aantal buurten. Dat is het <b style="color:var(--ai)">gemiddelde</b> (\u03bc). Het vertelt je wat \u201cnormaal\u201d is.<br><br>';

  // Stap 2: Wat is spreiding
  h += '<b style="color:var(--tx)">\u2777 Hoe ver wijken buurten af?</b><br>';
  h += 'Sommige buurten zitten dicht bij het gemiddelde, andere ver ervandaan. De <b style="color:var(--wn)">standaarddeviatie</b> (\u03c3) meet hoe ver waarden gemiddeld afwijken. Een kleine \u03c3 = alles lijkt op elkaar. Een grote \u03c3 = veel verschil.<br><br>';

  // Stap 3: z-score uitleg + echt rekenvoorbeeld
  h += '<b style="color:var(--tx)">\u2778 De z-score: hoe bijzonder is dit gebied?</b><br>';
  h += 'De formule is simpel: <b style="color:var(--ai)">z = (jouw waarde \u2212 gemiddelde) \u00f7 standaarddeviatie</b><br><br>';

  // Pak het eerste opvallende finding als echt voorbeeld, of anders het eerste finding
  var voorbeeld = opvallend.length > 0 ? opvallend[0] : findings[0];
  if(voorbeeld){
    var vfm = getIndicator(voorbeeld.key);
    h += '<div style="padding:10px 12px;background:rgba(56,189,248,.06);border-radius:8px;margin:4px 0 8px;border:1px dashed rgba(56,189,248,.2)">';
    h += '<div style="font:600 11px DM Sans,sans-serif;color:var(--ai);margin-bottom:4px">\ud83d\udcdd Rekenvoorbeeld met echte data:</div>';
    h += '<div style="font-size:11px;line-height:1.9;color:var(--tx)">';
    h += 'Indicator: <b>'+vfm.naam+'</b><br>';
    h += 'Waarde van dit gebied: <b style="color:var(--ac)">'+formatVal(voorbeeld.val)+' '+vfm.eenheid+'</b><br>';
    h += 'Landelijk gemiddelde (\u03bc): <b>'+formatVal(voorbeeld.avg)+' '+vfm.eenheid+'</b><br>';
    h += 'Standaarddeviatie (\u03c3): <b>'+formatVal(voorbeeld.stddev)+' '+vfm.eenheid+'</b><br><br>';
    h += '<b>Berekening:</b><br>';
    h += '<div style="padding:8px 12px;background:rgba(57,255,20,.06);border-radius:6px;font:700 12px Space Mono,monospace;color:var(--ac);margin:4px 0">';
    h += 'z = ('+formatVal(voorbeeld.val)+' \u2212 '+formatVal(voorbeeld.avg)+') \u00f7 '+formatVal(voorbeeld.stddev);
    h += ' = '+(voorbeeld.val - voorbeeld.avg >= 0 ? '+' : '')+formatVal(voorbeeld.val - voorbeeld.avg)+' \u00f7 '+formatVal(voorbeeld.stddev);
    h += ' = <span style="color:'+(Math.abs(voorbeeld.z)>1?'var(--wn)':'var(--ai)')+'">'+voorbeeld.z.toFixed(2)+'</span>';
    h += '</div>';
    h += '<b>Betekenis:</b> ';
    if(Math.abs(voorbeeld.z) < 0.5) h += 'De z-score is bijna 0 \u2192 dit gebied is <b style="color:var(--ai)">heel gemiddeld</b> voor deze indicator.';
    else if(Math.abs(voorbeeld.z) < 1) h += 'De z-score zit tussen -1 en +1 \u2192 <b style="color:var(--ai)">normaal</b>, 68% van alle gebieden valt hierin.';
    else if(Math.abs(voorbeeld.z) < 2) h += 'De z-score is '+(voorbeeld.z>0?'boven':'onder')+' de 1 \u2192 <b style="color:var(--wn)">opvallend</b>! Dit gebied zit buiten de middelste 68% van Nederland.';
    else h += 'De z-score is '+(voorbeeld.z>0?'boven':'onder')+' de 2 \u2192 <b style="color:var(--dn)">uitzonderlijk</b>! Slechts 5% van alle gebieden wijkt zo ver af.';
    h += '</div></div>';
  }

  // Stap 4: De vuistregels
  h += '<b style="color:var(--tx)">\u2779 Vuistregels om te onthouden:</b><br>';
  h += '<div style="display:grid;grid-template-columns:auto 1fr;gap:3px 10px;margin:4px 0 6px;font-size:11px">';
  h += '<b style="color:var(--ai)">|z| < 0.5</b><span>\u2192 Gemiddeld \u2014 niets bijzonders</span>';
  h += '<b style="color:var(--ai)">|z| 0.5 \u2013 1</b><span>\u2192 Iets afwijkend, maar nog normaal</span>';
  h += '<b style="color:var(--wn)">|z| 1 \u2013 2</b><span>\u2192 Opvallend \u2014 valt buiten de \u201cnormale\u201d 68%</span>';
  h += '<b style="color:var(--dn)">|z| > 2</b><span>\u2192 Uitzonderlijk \u2014 slechts 5% wijkt zo ver af</span>';
  h += '</div>';

  // Stap 5: Patronen
  h += '<br><b style="color:var(--tx)">\u277a Patronen herkennen:</b><br>';
  h += 'Als meerdere indicatoren samen hoog of laag zijn, is er een <b>patroon</b>. Bijvoorbeeld: hoge WOZ \u00e9n hoog inkomen \u2192 welvarend gebied. Hoog gas \u2192 slecht ge\u00efsoleerd. Dit is geen AI maar bekende statistische samenhang.<br>';

  // Disclaimer
  h += '<br><div style="padding:6px 10px;background:rgba(251,191,36,.05);border-radius:6px;border-left:2px solid var(--wn)">';
  h += '<b style="color:var(--wn);font-size:10px">\u26a0 Let op:</b> <span style="font-size:10px">Dit zijn automatische berekeningen op CBS-data. De conclusies zijn indicatief \u2014 voor een volledig beeld is lokale kennis nodig.</span>';
  h += '</div>';

  h += '</div></div>';

  h += '</div>';
  return h;
}

// Backwards compat — oude aanroepen
function buildAreaStatsHtml(latlng){
  return buildMultiLevelStatsHtml(latlng);
}

// ============================================================
// BAG PANDEN WMS
// ============================================================
function togglePandLayer(on){
  if(!_map) return;
  if(on){
    if(_pandWmsLayer) return;
    _pandWmsLayer = L.tileLayer.wms(PDOK_BAG_WMS, {
      layers:'pand',format:'image/png',transparent:true,
      version:'1.1.1',opacity:0.6,maxZoom:22,tileSize:256,minZoom:13
    }).addTo(_map);
    fixLayerOrder();
    dimChoroplethLayers(true);
    if(_map.getZoom() < 16){
      toast('BAG panden actief \u2014 zoom in voor details');
    } else {
      toast('BAG panden actief');
    }
  } else {
    if(_pandWmsLayer){_map.removeLayer(_pandWmsLayer);_pandWmsLayer=null}
    // Herstel choropleth alleen als BAG adressen ook uit staan
    if(!_layerState.bag) dimChoroplethLayers(false);
  }
}

function pandGetFeatureInfo(e){
  var size = _map.getSize();
  var bounds = _map.getBounds();
  var sw = bounds.getSouthWest(), ne = bounds.getNorthEast();
  var bbox = sw.lng+','+sw.lat+','+ne.lng+','+ne.lat;
  var pt = _map.latLngToContainerPoint(e.latlng);
  var url = PDOK_BAG_WMS+'?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo'+
    '&FORMAT=image/png&TRANSPARENT=true'+
    '&QUERY_LAYERS=pand&LAYERS=pand'+
    '&INFO_FORMAT=application/json&FEATURE_COUNT=1&BUFFER=12'+
    '&X='+Math.round(pt.x)+'&Y='+Math.round(pt.y)+
    '&SRS=EPSG:4326&WIDTH='+size.x+'&HEIGHT='+size.y+'&BBOX='+bbox;
  fetch(url).then(function(r){return r.json()}).then(function(d){
    if(!d.features||!d.features.length) return;
    var p = d.features[0].properties;
    document.getElementById('infoBuurtNaam').innerHTML = '<span class="mi mi-sm">apartment</span> BAG Pand';
    var html = '';
    if(p.bouwjaar) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">event</span> Bouwjaar</span><span class="info-val">'+p.bouwjaar+'</span></div>';
    if(p.gebruiksdoel) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">category</span> Gebruiksdoel</span><span class="info-val">'+p.gebruiksdoel+'</span></div>';
    if(p.aantal_verblijfsobjecten) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">door_front</span> VBO\'s</span><span class="info-val">'+p.aantal_verblijfsobjecten+'</span></div>';
    if(p.oppervlakte_min && p.oppervlakte_max){
      var opp = p.oppervlakte_min === p.oppervlakte_max ? p.oppervlakte_min+' m\u00b2' : p.oppervlakte_min+' \u2013 '+p.oppervlakte_max+' m\u00b2';
      html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">square_foot</span> Oppervlakte</span><span class="info-val">'+opp+'</span></div>';
    }
    if(p.status) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">info</span> Status</span><span class="info-val" style="color:'+bagStatusToColor(p.status)+'">'+p.status+'</span></div>';
    if(p.identificatie) html += '<div class="info-row"><span><span class="mi mi-sm" style="vertical-align:-3px">tag</span> Pand ID</span><span class="info-val" style="font-size:9px">'+p.identificatie+'</span></div>';
    // CBS statistieken van het gebied
    html += buildAreaStatsHtml(e.latlng);
    document.getElementById('infoContent').innerHTML = html;
    document.getElementById('infoPanel').classList.add('show');
  }).catch(function(){});
}

// ============================================================
// PDOK ZOEKBALK
// ============================================================
var _searchTimer = null, _searchAbort = null;

function setupSearch(){
  var inp = document.getElementById('searchInput');
  var res = document.getElementById('searchResults');

  inp.addEventListener('input', function(){
    var q = inp.value.trim();
    if(q.length < 2){ res.style.display='none'; return; }
    if(_searchTimer) clearTimeout(_searchTimer);
    if(_searchAbort) try{_searchAbort.abort()}catch(x){}

    _searchTimer = setTimeout(function(){
      var ac = new AbortController();
      _searchAbort = ac;
      fetch(PDOK_SUGGEST + encodeURIComponent(q) + '&rows=7', {signal:ac.signal})
        .then(function(r){return r.json()})
        .then(function(d){
          if(!d.response||!d.response.docs||!d.response.docs.length){res.style.display='none';return}
          var html = '';
          d.response.docs.forEach(function(doc){
            html += '<div class="search-item" data-id="'+doc.id+'">';
            html += '<div style="color:var(--tx);font-weight:500">'+doc.weergavenaam+'</div>';
            html += '<div style="font-size:10px;color:var(--mt);margin-top:2px"><span class="mi mi-sm" style="font-size:11px;vertical-align:-2px">label</span> '+doc.type+'</div>';
            html += '</div>';
          });
          res.innerHTML = html;
          res.style.display = 'block';
          res.querySelectorAll('.search-item').forEach(function(el){
            el.addEventListener('click', function(){
              selectSearchResult(el.dataset.id, el.querySelector('div').textContent);
              res.style.display = 'none';
              inp.value = '';
            });
          });
        })
        .catch(function(){});
    }, 300);
  });

  document.addEventListener('click', function(e){
    if(!inp.contains(e.target) && !res.contains(e.target)) res.style.display = 'none';
  });
}

function selectSearchResult(id, label){
  fetch(PDOK_LOOKUP + encodeURIComponent(id))
    .then(function(r){return r.json()})
    .then(function(d){
      if(!d.response||!d.response.docs||!d.response.docs.length) return;
      var doc = d.response.docs[0];
      if(doc.centroide_ll){
        var m = doc.centroide_ll.match(/POINT\(([^ ]+) ([^ ]+)\)/);
        if(m){
          var lng = parseFloat(m[1]), lat = parseFloat(m[2]);
          if(_searchMarker){_map.removeLayer(_searchMarker)}
          _searchMarker = L.marker([lat, lng]).addTo(_map).bindPopup('<b>'+(label||doc.weergavenaam)+'</b>').openPopup();
          _map.setView([lat, lng], 16);
        }
      }
    })
    .catch(function(){});
}

// ============================================================
// FEATURE INFO PANEL (hover + click)
// ============================================================
function showFeatureInfo(p, cfg, type, isClick){
  var name = p[cfg.nameField] || p[cfg.codeField] || '-';
  document.getElementById('infoBuurtNaam').innerHTML = '<span class="mi mi-sm">place</span> '+name;
  var html = '';
  if(isClick) html += '<div class="info-row"><span>Code</span><span class="info-val">'+(p[cfg.codeField]||'-')+'</span></div>';
  if(type !== 'gemeenten') html += '<div class="info-row"><span>Gemeente</span><span class="info-val">'+(p.gemeentenaam||'-')+'</span></div>';
  html += '<div style="margin-top:8px;padding-top:6px;border-top:1px solid var(--glass-bd)">';
  _activeIndicators.forEach(function(k){
    var v = p[k];
    if(v !== undefined && v !== null) html += buildCompareHtml(k, v);
  });
  html += '</div>';
  document.getElementById('infoContent').innerHTML = html;
  document.getElementById('infoPanel').classList.add('show');
}

// ============================================================
// HELPERS
// ============================================================
function quantileBreaks(sorted, n){
  var breaks = [];
  for(var i=1;i<n;i++) breaks.push(sorted[Math.floor(i*sorted.length/n)]);
  return breaks;
}
function getColor(val, breaks, colors){
  for(var i=0;i<breaks.length;i++){if(val<=breaks[i]) return colors[i]}
  return colors[colors.length-1];
}
function getIndicator(key){
  for(var i=0;i<INDICATORS.length;i++){if(INDICATORS[i].key===key) return INDICATORS[i]}
  return {key:key,naam:key,eenheid:'',icon:'bar_chart'};
}
function formatVal(v){
  if(v===null||v===undefined) return '-';
  if(v>=10000) return (v/1000).toFixed(0)+'k';
  if(v>=100) return Math.round(v).toLocaleString('nl-NL');
  if(v>=10) return v.toFixed(0);
  return v.toFixed(1);
}

// ============================================================
// LEGEND & STATS
// ============================================================
function updateLegend(breaks, colors){
  var el = document.getElementById('legend');
  var html = '';
  var labels = ['< '+formatVal(breaks[0])];
  for(var i=0;i<breaks.length-1;i++) labels.push(formatVal(breaks[i])+' \u2013 '+formatVal(breaks[i+1]));
  labels.push('> '+formatVal(breaks[breaks.length-1]));
  for(var i=0;i<colors.length;i++)
    html += '<div class="legend-row"><div class="legend-color" style="background:'+colors[i]+'"></div><span>'+(labels[i]||'')+'</span></div>';
  el.innerHTML = html;
}

function updateStats(vals, type){
  // Stats worden nu per indicator getoond via updateActiveStats()
}

// ============================================================
// UI CONTROLS
// ============================================================
function buildIndicatorList(){
  var el = document.getElementById('indicatorList');
  var html = '';
  INDICATORS.forEach(function(fm){
    var isActive = _activeIndicators.indexOf(fm.key) >= 0;
    var isPrimary = _activeIndicators[0] === fm.key;
    var cls = isPrimary ? 'ind-item primary' : (isActive ? 'ind-item active' : 'ind-item');
    html += '<div class="'+cls+'" data-ind="'+fm.key+'" onclick="toggleIndicator(\''+fm.key+'\')">';
    html += '<div class="ind-icon"><span class="mi">'+fm.icon+'</span></div>';
    html += '<span class="ind-name">'+fm.naam+'</span>';
    html += '<span class="ind-unit">'+fm.eenheid+'</span>';
    html += '<span class="ind-badge">KAART</span>';
    html += '</div>';
  });
  el.innerHTML = html;
}

function toggleIndicator(key){
  var idx = _activeIndicators.indexOf(key);
  if(idx >= 0){
    // Minimaal 1 indicator actief houden
    if(_activeIndicators.length <= 1){toast('Minimaal 1 indicator actief');return}
    _activeIndicators.splice(idx, 1);
  } else {
    _activeIndicators.push(key);
  }
  buildIndicatorList();
  updateMap();
  updateActiveStats();
}

function setPrimaryIndicator(key){
  var idx = _activeIndicators.indexOf(key);
  if(idx < 0) return;
  _activeIndicators.splice(idx, 1);
  _activeIndicators.unshift(key);
  buildIndicatorList();
  updateMap();
  updateActiveStats();
}

function getActiveData(){
  // Meest gedetailleerde actieve laag
  if(_layerState.buurten && _buurtData) return _buurtData;
  if(_layerState.wijken && _wijkData) return _wijkData;
  if(_layerState.gemeenten && _gemeenteData) return _gemeenteData;
  return _gemeenteData || _buurtData;
}

// Bereken landelijke stats per indicator voor de actieve data
function computeNationalStats(){
  var data = getActiveData();
  if(!data){_nationalStats={};return}
  _nationalStats = {};
  INDICATORS.forEach(function(fm){
    var vals = [];
    data.features.forEach(function(f){
      var v = f.properties[fm.key];
      if(v !== undefined && v !== null && v >= 0) vals.push(v);
    });
    if(!vals.length) return;
    vals.sort(function(a,b){return a-b});
    var n = vals.length;
    var sum = vals.reduce(function(a,b){return a+b},0);
    var mean = sum / n;
    var median = vals[Math.floor(n/2)];
    var variance = vals.reduce(function(a,b){return a+(b-mean)*(b-mean)},0)/n;
    var stddev = Math.sqrt(variance);
    // Skewness (Pearson)
    var skewSum = vals.reduce(function(a,b){var d=(b-mean)/stddev;return a+d*d*d},0);
    var skewness = stddev > 0 ? skewSum/n : 0;
    var distType = 'normaal';
    if(Math.abs(skewness) < 0.5) distType = 'normaal';
    else if(skewness > 0) distType = 'rechts scheef';
    else distType = 'links scheef';
    // Percentilen voor bar
    var p10 = vals[Math.floor(n*0.1)], p90 = vals[Math.floor(n*0.9)];
    _nationalStats[fm.key] = {min:vals[0],max:vals[n-1],avg:mean,median:median,stddev:stddev,count:n,skewness:skewness,distType:distType,p10:p10,p90:p90};
  });
}

// Genereer SVG normaalverdeling curve met positie-marker
function buildDistSvg(zScore, distType){
  var w=220,h=56,pad=5;
  var pts=[];
  // Bel-curve genereren (of scheef als distType aangeeft)
  var skew = distType==='rechts scheef'?0.6:(distType==='links scheef'?-0.6:0);
  for(var i=0;i<=40;i++){
    var x = -3.5 + i*7/40;
    var xs = x - skew;
    var y = Math.exp(-0.5*xs*xs)/2.5066; // normaal PDF
    pts.push({x:pad+(i/40)*(w-2*pad), y:h-pad-y*(h-2*pad)*2.8});
  }
  var path = 'M'+pts[0].x+','+((h-pad))+' ';
  pts.forEach(function(p){path+='L'+p.x+','+p.y+' '});
  path += 'L'+pts[pts.length-1].x+','+(h-pad)+' Z';
  // Marker positie: z-score naar x
  var zClamped = Math.max(-3.5,Math.min(3.5,zScore));
  var mx = pad+((zClamped+3.5)/7)*(w-2*pad);
  // Kleur zones (sigma)
  var svg = '<svg width="'+w+'" height="'+h+'" viewBox="0 0 '+w+' '+h+'" style="display:block;margin:2px 0">';
  // Vulling met gradient
  svg += '<defs><linearGradient id="gc'+Math.abs(Math.round(zScore*100))+'" x1="0" y1="0" x2="1" y2="0">';
  svg += '<stop offset="0%" stop-color="#ef4444" stop-opacity="0.3"/>';
  svg += '<stop offset="15%" stop-color="#fbbf24" stop-opacity="0.3"/>';
  svg += '<stop offset="35%" stop-color="#38bdf8" stop-opacity="0.3"/>';
  svg += '<stop offset="65%" stop-color="#38bdf8" stop-opacity="0.3"/>';
  svg += '<stop offset="85%" stop-color="#fbbf24" stop-opacity="0.3"/>';
  svg += '<stop offset="100%" stop-color="#ef4444" stop-opacity="0.3"/>';
  svg += '</linearGradient></defs>';
  svg += '<path d="'+path+'" fill="url(#gc'+Math.abs(Math.round(zScore*100))+')" stroke="rgba(226,232,240,0.3)" stroke-width="1"/>';
  // Sigma lijnen
  [-2,-1,0,1,2].forEach(function(s){
    var sx=pad+((s+3.5)/7)*(w-2*pad);
    var op=s===0?0.5:0.15;
    svg+='<line x1="'+sx+'" y1="'+(pad)+'" x2="'+sx+'" y2="'+(h-pad)+'" stroke="rgba(226,232,240,'+op+')" stroke-width="'+(s===0?1.5:0.5)+'" stroke-dasharray="'+(s===0?'':'2,2')+'"/>';
  });
  // Waarde marker
  svg += '<line x1="'+mx+'" y1="2" x2="'+mx+'" y2="'+(h-2)+'" stroke="#39ff14" stroke-width="2"/>';
  svg += '<circle cx="'+mx+'" cy="6" r="3" fill="#39ff14"/>';
  // Sigma labels
  svg += '<text x="'+pad+'" y="'+(h-1)+'" font-size="8" fill="rgba(226,232,240,0.5)" font-family="Space Mono,monospace">-3\u03c3</text>';
  svg += '<text x="'+(w-pad-18)+'" y="'+(h-1)+'" font-size="8" fill="rgba(226,232,240,0.5)" font-family="Space Mono,monospace">+3\u03c3</text>';
  svg += '</svg>';
  return svg;
}

// Interpreteer z-score in menselijke taal
function interpretZScore(z, key, fm){
  var abs = Math.abs(z);
  var richting = z >= 0 ? 'hoog' : 'laag';
  var isReverse = REVERSE_KEYS.indexOf(key) >= 0;
  // Bij "afstand" indicatoren is lager = beter
  if(isReverse){ richting = z >= 0 ? 'ver' : 'dichtbij'; }

  if(abs < 0.5) return '<span style="color:var(--ai)">Gemiddeld</span> \u2014 typisch voor Nederland';
  if(abs < 1.0) return '<span style="color:var(--ai)">Licht '+richting+'</span> \u2014 binnen normaal bereik';
  if(abs < 1.5) return '<span style="color:var(--wn)">Bovengemiddeld '+richting+'</span> \u2014 top '+(z>0?'30':'30')+'%';
  if(abs < 2.0) return '<span style="color:var(--wn)">'+(richting==='hoog'||richting==='ver'?'Hoog':'Laag')+'</span> \u2014 top '+(z>0?'7':'7')+'%';
  if(abs < 2.5) return '<span style="color:var(--dn)">Zeer '+(richting==='hoog'||richting==='ver'?'hoog':'laag')+'</span> \u2014 top 2%';
  return '<span style="color:var(--dn)">Extreem '+(richting==='hoog'||richting==='ver'?'hoog':'laag')+'</span> \u2014 uitzonderlijk (<1%)';
}

// Bouw vergelijking HTML voor een indicator waarde vs landelijk
function buildCompareHtml(key, val){
  var ns = _nationalStats[key];
  if(!ns || val === undefined || val === null || val < 0) return '';
  var fm = getIndicator(key);
  var pctDiff = ns.avg > 0 ? ((val - ns.avg) / ns.avg * 100) : 0;
  var pctSign = pctDiff >= 0 ? '+' : '';
  var diffClass = pctDiff >= 0 ? 'up' : 'dn';
  var diffLabel = pctDiff >= 0 ? 'boven' : 'onder';
  var zScore = ns.stddev > 0 ? ((val - ns.avg) / ns.stddev) : 0;
  // Positie op de balk (0-100%)
  var range = ns.max - ns.min;
  var pos = range > 0 ? Math.min(100, Math.max(0, (val - ns.min) / range * 100)) : 50;
  var avgPos = range > 0 ? Math.min(100, Math.max(0, (ns.avg - ns.min) / range * 100)) : 50;

  var html = '<div style="margin-bottom:12px;padding:10px 12px;background:rgba(15,20,35,.5);border-radius:10px;border-left:3px solid '+getBarColor(zScore)+'">';
  // Regel 1: naam + waarde
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
  html += '<span style="font:600 13px \'DM Sans\',sans-serif;color:var(--tx);display:flex;align-items:center;gap:5px"><span class="mi" style="font-size:16px;color:var(--ai)">'+fm.icon+'</span>'+fm.naam+'</span>';
  html += '<span style="font:700 15px \'Space Mono\',monospace;color:var(--ac)">'+formatVal(val)+' <span style="font-size:10px;font-weight:400;color:var(--mt)">'+fm.eenheid+'</span></span>';
  html += '</div>';
  // Regel 2: vergelijking
  html += '<div style="font-size:12px;color:var(--mt);margin-bottom:4px;line-height:1.5">';
  html += '<span class="'+diffClass+'" style="font-weight:700">'+pctSign+pctDiff.toFixed(0)+'%</span> '+diffLabel+' gemiddeld';
  html += ' <span style="opacity:.6">(gem. '+formatVal(ns.avg)+' '+fm.eenheid+')</span>';
  html += ' &middot; <span style="opacity:.6">z = '+zScore.toFixed(1)+'</span>';
  html += '</div>';
  // Normaalverdeling SVG
  html += buildDistSvg(zScore, ns.distType);
  // Interpretatie
  html += '<div style="font-size:11px;color:var(--mt);margin-top:3px;line-height:1.5">'+interpretZScore(zScore, key, fm)+'</div>';
  // Bar met positie
  html += '<div class="info-bar" style="height:6px;margin:6px 0 0;border-radius:3px">';
  html += '<div class="info-bar-fill" style="width:'+pos+'%;background:'+getBarColor(zScore)+';border-radius:3px"></div>';
  html += '<div class="info-bar-marker" style="left:'+avgPos+'%;top:-2px;height:10px;width:2px;background:var(--tx);opacity:.5" title="Gem: '+formatVal(ns.avg)+'"></div>';
  html += '</div>';
  // min — max
  html += '<div style="display:flex;justify-content:space-between;margin-top:3px">';
  html += '<span style="font:400 9px \'Space Mono\',monospace;color:var(--mt);opacity:.6">'+formatVal(ns.min)+'</span>';
  html += '<span style="font:400 9px \'Space Mono\',monospace;color:var(--mt);opacity:.6">'+formatVal(ns.max)+'</span>';
  html += '</div>';
  html += '</div>';
  return html;
}

function getBarColor(z){
  if(z > 1.5) return 'var(--up)';
  if(z > 0.5) return 'var(--ac2)';
  if(z > -0.5) return 'var(--ai)';
  if(z > -1.5) return 'var(--wn)';
  return 'var(--dn)';
}

function updateActiveStats(){
  computeNationalStats();
}

function updateMap(){
  if(_layerState.gemeenten && _gemeenteData) renderChoropleth('gemeenten');
  if(_layerState.buurten && _buurtData) renderChoropleth('buurten');
  if(_layerState.wijken && _wijkData) renderChoropleth('wijken');
  updateActiveStats();
}

function filterGemeente(){
  updateMap();
  updateActiveStats();
  var gem = document.getElementById('gemeenteFilter').value;
  if(gem !== 'all'){
    // Gebruik beschikbare data voor bounds (buurt > wijk > gemeente)
    var src = _buurtData || _wijkData || _gemeenteData;
    if(src){
      var bounds = [];
      src.features.forEach(function(f){
        if(f.properties.gemeentenaam === gem && f.geometry){
          try{ bounds.push(L.geoJSON(f).getBounds()); }catch(e){}
        }
      });
      if(bounds.length){
        var combined = bounds[0];
        bounds.forEach(function(b){combined.extend(b)});
        _map.fitBounds(combined,{padding:[20,20]});
      }
    }
  }
}

function buildGemeenteFilter(){
  var sel = document.getElementById('gemeenteFilter');
  var sorted = Array.from(_gemeenteNamen).sort();
  // Gebruik DOM API i.p.v. innerHTML+= om issues met speciale tekens te voorkomen
  sel.innerHTML = '';
  var allOpt = document.createElement('option');
  allOpt.value = 'all';
  allOpt.textContent = 'Alle gemeenten ('+sorted.length+')';
  sel.appendChild(allOpt);
  sorted.forEach(function(g){
    var opt = document.createElement('option');
    opt.value = g;
    opt.textContent = g;
    sel.appendChild(opt);
  });
  document.getElementById('sGemeenten').textContent = sorted.length;
}

function switchTab(tab){
  document.querySelectorAll('.tab').forEach(function(t){t.classList.toggle('active',t.dataset.tab===tab)});
  document.querySelectorAll('.pane').forEach(function(p){p.classList.toggle('active',p.id==='p-'+tab)});
}

function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('hidden');
  setTimeout(function(){if(_map)_map.invalidateSize()},400);
}

function renderIndicatorDefs(){
  var el = document.getElementById('indicatorDefs');
  var html = '';
  INDICATORS.forEach(function(fm){
    html += '<div style="padding:5px 0;border-bottom:1px solid var(--glass-bd);display:flex;align-items:center;gap:6px">';
    html += '<span class="mi mi-sm" style="color:var(--ai);flex-shrink:0">'+fm.icon+'</span>';
    html += '<div><div style="font:600 11px \'DM Sans\',sans-serif;color:var(--tx)">'+fm.naam+'</div>';
    html += '<div style="font-size:9px;color:var(--mt)">'+fm.key+' \u00b7 '+fm.eenheid+'</div></div></div>';
  });
  el.innerHTML = html;
}

function toast(msg){
  var el = document.getElementById('toast');
  el.innerHTML = '<span class="mi mi-sm" style="vertical-align:-3px;margin-right:6px">notifications</span>' + msg;
  el.classList.add('show');
  clearTimeout(el._tid);
  el._tid = setTimeout(function(){el.classList.remove('show')},3000);
}

// ============================================================
// RAPPORT EXPORT (PRINT/PDF)
// ============================================================
function printInfoPanel(){
  var locationName = document.getElementById('infoBuurtNaam').textContent || 'GeoInzicht Rapport';
  var content = document.getElementById('infoContent').innerHTML;
  if(!content || !content.trim()){
    toast('Geen data om te exporteren \u2014 klik eerst op een locatie');
    return;
  }
  // Resolve CSS variabelen naar hardcoded kleuren voor print (licht thema)
  var colorMap = {
    'var(--ac)':'#16a34a','var(--ac2)':'#22c55e','var(--ai)':'#0284c7',
    'var(--tx)':'#1e293b','var(--mt)':'#64748b','var(--up)':'#16a34a',
    'var(--dn)':'#dc2626','var(--wn)':'#d97706','var(--cyan)':'#0891b2',
    'var(--bg)':'#ffffff','var(--p)':'#ffffff','var(--glass-bd)':'#e2e8f0',
    'var(--glass)':'rgba(241,245,249,0.85)','var(--bd)':'#cbd5e1'
  };
  var pc = content;
  for(var cv in colorMap) pc = pc.split(cv).join(colorMap[cv]);
  // Donkere achtergronden omzetten naar licht
  pc = pc.replace(/rgba\(15,20,35,[^)]+\)/g,'rgba(241,245,249,0.85)');
  pc = pc.replace(/rgba\(10,15,26,[^)]+\)/g,'rgba(248,250,252,0.9)');
  pc = pc.replace(/rgba\(45,58,77,[^)]+\)/g,'#e2e8f0');
  pc = pc.replace(/rgba\(57,255,20,0\.0[0-9]+\)/g,'rgba(22,163,74,0.08)');
  pc = pc.replace(/rgba\(56,189,248,0\.0[0-9]+\)/g,'rgba(2,132,199,0.06)');
  pc = pc.replace(/rgba\(100,116,139,0\.0[0-9]+\)/g,'rgba(100,116,139,0.06)');
  pc = pc.replace(/rgba\(251,191,36,0\.0[0-9]+\)/g,'rgba(217,119,6,0.06)');
  pc = pc.replace(/rgba\(255,255,255,0\.0[0-9]+\)/g,'rgba(241,245,249,0.4)');
  // SVG labels donkerder voor print
  pc = pc.replace(/fill="rgba\(226,232,240,[\d.]+\)"/g,'fill="rgba(30,41,59,0.7)"');
  pc = pc.replace(/stroke="rgba\(226,232,240,[\d.]+\)"/g,'stroke="rgba(100,116,139,0.3)"');

  var now = new Date();
  var dateStr = now.toLocaleDateString('nl-NL',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});

  var html = '<!DOCTYPE html><html lang="nl"><head>';
  html += '<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">';
  html += '<title>GeoInzicht Rapport \u2014 '+locationName+'</title>';
  html += '<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">';
  html += '<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" rel="stylesheet">';
  html += '<style>';
  // Material icons
  html += '.mi{font-family:"Material Symbols Rounded";font-weight:normal;font-style:normal;font-size:18px;line-height:1;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;-webkit-font-smoothing:antialiased;font-variation-settings:"FILL" 1,"wght" 400,"GRAD" 0,"opsz" 24}';
  html += '.mi-sm{font-size:14px}';
  // Print-optimized base
  html += '*{box-sizing:border-box}';
  html += 'body{font-family:"DM Sans",sans-serif;color:#1e293b;background:#fff;margin:0;padding:20px 28px;max-width:820px;margin:0 auto;line-height:1.5;font-size:11px}';
  html += 'h1{font:700 22px "Space Mono",monospace;color:#0f172a;margin:0}';
  html += 'h3{font:700 13px "Space Mono",monospace;color:#0f172a;margin:12px 0 6px}';
  // Info rows
  html += '.info-row{display:flex;justify-content:space-between;padding:4px 0;font-size:11px;border-bottom:1px solid #e2e8f0}';
  html += '.info-row:last-child{border:none}';
  html += '.info-val{font:700 11px "Space Mono",monospace;color:#0284c7}';
  // Bars
  html += '.info-bar{height:5px;background:#e2e8f0;border-radius:3px;margin-top:3px;position:relative;overflow:visible}';
  html += '.info-bar-fill{height:100%;border-radius:3px}';
  html += '.info-bar-marker{position:absolute;top:-2px;width:2px;height:9px;background:#334155;border-radius:1px;transform:translateX(-1px)}';
  html += '.up{color:#16a34a}.dn{color:#dc2626}';
  // SVG
  html += 'svg{display:block;margin:4px 0;max-width:100%}';
  // Header/footer
  html += '.rh{border-bottom:3px solid #16a34a;padding-bottom:14px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:flex-end}';
  html += '.rf{border-top:2px solid #e2e8f0;padding-top:10px;margin-top:20px;font-size:8px;color:#94a3b8;display:flex;justify-content:space-between}';
  // Print
  html += '@media print{body{padding:8px 12px;font-size:10px}@page{margin:1.2cm;size:A4}svg{page-break-inside:avoid}.rh{page-break-after:avoid}}';
  // Geen animaties in rapport
  html += '@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}';
  html += '</style></head><body>';

  // Header
  html += '<div class="rh">';
  html += '<div><h1 style="background:linear-gradient(135deg,#16a34a,#0284c7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">GeoInzicht</h1>';
  html += '<div style="font:600 9px Space Mono,monospace;color:#94a3b8;letter-spacing:2px;margin-top:2px">STATISTISCH RAPPORT</div></div>';
  html += '<div style="text-align:right;font-size:10px;color:#64748b">';
  html += '<div style="font-weight:600;color:#0f172a;font-size:12px">'+locationName+'</div>';
  html += '<div>'+dateStr+'</div>';
  html += '<div>GeoInzicht v6.3</div></div></div>';

  // Content
  html += '<div>'+pc+'</div>';

  // Footer
  html += '<div class="rf">';
  html += '<div><b>Databronnen:</b> CBS Kerncijfers wijken en buurten 2022 | BAG Basisregistratie Adressen en Gebouwen (Kadaster) | PDOK Locatieserver</div>';
  html += '<div style="white-space:nowrap">GeoInzicht v6.3 \u2014 Data Consultants</div></div>';

  html += '<script>window.onload=function(){setTimeout(function(){window.print()},500)}<\/script>';
  html += '</body></html>';

  var w = window.open('','_blank');
  if(w){
    w.document.write(html);
    w.document.close();
  } else {
    toast('Pop-up geblokkeerd \u2014 sta pop-ups toe voor deze site');
  }
}

// ============================================================
// STARTUP
// ============================================================
async function init(){
  var loadMsg = document.getElementById('loadMsg');
  var loadSub = document.getElementById('loadSub');
  var loadBar = document.getElementById('loadProgress');

  try {
    loadMsg.textContent = 'Kaart initialiseren...';
    loadBar.style.width = '10%';
    initMap();
    buildIndicatorList();
    buildBasemapButtons();
    buildBagStatusButtons();
    renderIndicatorDefs();
    setupSearch();

    // Stap 1: Gemeenten laden (0.9 MB — snel)
    loadMsg.textContent = 'Gemeentedata laden...';
    loadSub.textContent = 'CBS gemeentedata ophalen (0.9 MB)';
    loadBar.style.width = '30%';

    var resp = await fetch(GEMEENTEN_URL);
    if(!resp.ok) throw new Error('Gemeentedata fout: ' + resp.status);

    loadMsg.textContent = 'Gemeenten verwerken...';
    loadBar.style.width = '60%';
    _gemeenteData = await resp.json();

    // Gemeenten indexeren voor filter
    _gemeenteData.features.forEach(function(f){
      if(f.properties.gemeentenaam) _gemeenteNamen.add(f.properties.gemeentenaam);
    });
    buildGemeenteFilter();
    document.getElementById('sBuurten').textContent = _gemeenteData.features.length.toLocaleString('nl-NL');

    loadMsg.textContent = 'Kaart renderen...';
    loadBar.style.width = '90%';
    renderChoropleth('gemeenten');
    updateActiveStats();

    // Dataset metadata
    var meta = _gemeenteData.metadata || {};
    document.getElementById('dsGemeenten').textContent = _gemeenteData.features.length.toLocaleString('nl-NL') + ' features';
    document.getElementById('dsJaar').textContent = meta.year || '\u2014';
    document.getElementById('dsGenerated').textContent = meta.generated ? meta.generated.substring(0,10) : '\u2014';

    // BAG adressen NIET standaard laden — gebruiker klikt zelf op de toggle

    loadBar.style.width = '100%';
    loadMsg.textContent = 'Klaar!';
    loadSub.textContent = _gemeenteData.features.length.toLocaleString('nl-NL') + ' gemeenten geladen';
    setTimeout(function(){document.getElementById('loadingOverlay').style.display='none'},600);

    if(window.innerWidth <= 900){
      document.getElementById('sidebar').classList.add('hidden');
      document.getElementById('closeSidebar').style.display = 'block';
    }
    toast(_gemeenteData.features.length.toLocaleString('nl-NL') + ' gemeenten geladen');
  } catch(e){
    console.error('Init error:', e);
    loadMsg.textContent = 'Fout bij opstarten';
    loadSub.textContent = e.message;
    loadBar.style.width = '100%';
    loadBar.style.background = 'var(--dn)';
  }
}

init();
</script>
</body>
</html>
